// ==UserScript==
// @name        Flickr Original Link
// @namespace   https://greasyfork.org/scripts/1190-flickr-original-link
// @include 	/flickr\.com/
// @version	6.0
// @grant       GM_getValue
// @grant       GM_setValue
// @grant 	GM_addStyle
// @require 	https://code.jquery.com/jquery-3.3.1.min.js
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Flickr20Original20Link.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Flickr20Original20Link.meta.js
// ==/UserScript==
var postfix="_d.jpg",prefix="DOWNLOAD ",isChecked_openLink="",isChecked_alwaysShow="",key_openLink="flickr_openLink",key_alwaysShow="flickr_alwaysShow",value_openLink=!1,value_alwaysShow=!1,imageSizeOrder=["9k","8k","7k","6k","5k","4k","3k","2k","o","k","h","l","b","c","z"],globalObserver=null;function log(e){console.log(e)}log("Begin flickr script");function getSetting(){log("Begin get settings"),value_openLink=GM_getValue(key_openLink,!1),value_alwaysShow=GM_getValue(key_alwaysShow,!1),value_openLink?(postfix=".",isChecked_openLink=' checked="checked" ',prefix="OPEN "):(postfix="_d.",isChecked_openLink="",prefix="DOWNLOAD "),value_alwaysShow?isChecked_alwaysShow=' checked="checked" ':isChecked_alwaysShow=""}function checkAlwaysShow(){value_alwaysShow&&$("div.interaction-view").css("opacity","1"),$("div.interaction-bar").css("bottom","1.1em")}function action_single_page(){if($(".commonButton").length>0)return!1;var e=function(r){for(var c=r.match(/modelExport: {.+?"sizes":{.+?}}/i),a=c[0].match(/"width":"?\d+"?,"height":"?\d+"?,/ig),o=c[0].match(/"displayUrl":"[^"]+"/ig),i=o.length,n=0;n<i;n++)a[n]=a[n].replace(/"width":(\d+),"height":(\d+),/i,"$1 x $2"),o[n]=o[n].replace(/"displayUrl":"([^"]+)"/i,"$1").replace(/\\/g,"").replace(/(_[0-9a-z]+)\.([a-z]{3,4})/i,"$1"+postfix+"$2");var s=$(".sub-photo-right-row1").filter(":first"),l='<div><a class="commonButton bigButton" href="'+o[i-1]+'">'+prefix+a[i-1]+" px</a>";for(n=i-2;n>=i-7&&n>=0;--n)l+='<a class="commonButton smallButton" href="'+o[n]+'">'+a[n]+" px</a>";l+="</div>",s.prop("outerHTML",l+s.prop("outerHTML"))};$.get(document.URL,e)}function getLinkFromSource(e){if(e!==null){var r=e.match(/"sizes":.+?}}/ig);if(r===null)return!1;var c=e.match(/"datePosted":"\d+"/ig);c==null&&log("cannot find any dates");var a=$("div.photo-list-photo-view");type=="album"&&(a=$("div.photo-card-view div.foot")),log("Number of photo in this page: "+a.length);for(var o=0;o<a.length;o++){var i=$(a[o]);if(!(i.find(".myFuckingLink").filter(":first").length>0)){i.html(i.html()+'<a class="myFuckingLink"></a>');for(var n=0;n<imageSizeOrder.length;++n){var s=r[o].match(new RegExp('"'+imageSizeOrder[n]+'".*?:{"displayUrl":"([^"]+)","width":(\\d+),"height":(\\d+)',"i"));if(s!==null){var l=i.find(".myFuckingLink");l.attr("href",s[1].replace(/\\/g,"").replace(/(_[0-9a-z]+)\.([a-z]{3,4})/i,"$1"+postfix+"$2"));var f=c[o].match(/\d+/i),g=new Date(new Number(f)*1e3);l.attr("title",prefix+s[2]+" x "+s[3]+" | Upload: "+g.toLocaleDateString()),l.html(prefix+s[2]+" x "+s[3]);break}}}}}}function action_normal_page(e){var r=$("#content")[0],c={childList:!0,subtree:!0},a="none",o=0,i=null,n=function(s){var l=$("div.photo-list-photo-view");if(s=="album"&&(l=$("div.photo-card-view")),document.URL==a){if(l.length==o)return!1;checkAlwaysShow(),o=l.length,log("Number of thumb: "+o),getLinkFromSource(i)}else{var f=l.find("a").filter(":first");if(f.length<1)return!1;checkAlwaysShow(),i=null,a=document.URL;var g=f.attr("href");console.time("GetSource"),$("#content").append('<div id="loadingIndicator" style="position:fixed;left:5px;bottom:2em;display:block;background-color:pink;border:solid;padding:3px">Getting original link<br>Please wait...</div>'),log("Begin get source 1: "+g),$.get(g,function(h){var u=h.match(/<a\s+class=.+?entry-type.+?href='([^']+)/i)[1];u=u.replace("/albums/","/sets/"),log("Begin get source 2: "+u),$.get(u,function(d){log("Got final source: "+u),console.timeEnd("GetSource"),$("#loadingIndicator").remove(),i=d,getLinkFromSource(i)})})}};n(e),globalObserver=new MutationObserver(function(s,l){n(e)}),globalObserver.observe(r,c)}function flickr_mouseenter(){var e=$(this);if(e.find(".myFuckingLink").filter(":first").length>0)return e.off("mouseenter"),!1;var r=e.find("a").filter(":first").attr("href");if(typeof r>"u"||r===null)return!1;e.append('<a class="myFuckingLink">(Link loading...)</a>'),$.get(r,function(c){var a=c.match(/"displayUrl":"([^"]+)","width":(\d+),"height":(\d+)[^}]+}}/i),o=a[1].replace(/\\/g,"").replace(/(_[0-9a-z]+)\.([a-z]{3,4})/i,"$1"+postfix+"$2"),i=prefix+a[2]+" x "+a[3]+" Upload: ",n=e.find(".myFuckingLink");n.attr("href",o),n.attr("title",i),n.html(i)})}function action_hover_page(){var e=$("body")[0],r={childList:!0,subtree:!0},c=0;globalObserver=new MutationObserver(function(a,o){var i=$("div.photo-list-photo-view");if(i.length==c)return!1;log("Number of thumb: "+i.length),c=i.length,checkAlwaysShow(),i.mouseenter(flickr_mouseenter)}),globalObserver.observe(e,r)}function pageType(){var e="none",r=$("html").attr("class");return console.log("HTML class: "+r),r.match(/html-photo-page.+scrappy-view/i)!==null?e="single":r.match(/html-(search-photos-unified|group-pool)-page-view/i)!==null?e="hover":$("div.photo-list-photo-view").filter(":first").length>0?e="normal":$("div.photo-list-view").filter(":first").length>0&&(e="album"),console.log("Page type: "+e),e}var prevType="none",type="none",oldUrl="none",count=0;function kickStart(){oldUrl=document.URL,type=pageType(),getSetting(),checkAlwaysShow();var e=".myFuckingLink{position:absolute;z-index:999999;left:3px;bottom:0px;width:100%;display:block;color:white!important;} .myFuckingLink:hover{background-color:rgba(100, 100, 255,0.65)!important} .commonButton{display: inline-block;border-radius: 0.5em;margin: 0.2em;padding: 0.5em;font-size: 90%;height: fit-content;} .bigButton{background-color: lightgreen} .smallButton{background-color:pink}";type=="album"&&(e=".myFuckingLink{position:absolute;z-index:999999;left:5px;bottom:0px;width:100%;display:block;} .myFuckingLink:hover{background-color:rgba(100, 100, 255,0.65)!important} .commonButton{display: inline-block;border-radius: 0.5em;margin: 0.2em;padding: 0.5em;font-size: 90%;height: fit-content;} .bigButton{background-color: lightgreen} .smallButton{background-color:pink}"),GM_addStyle(e),$(".myOptionBox").remove(),$("ul.nav-menu:first").append('<li class="myOptionBox"><div style="color:pink;padding:1px"><input id="optionbox_openLink" type="checkbox"'+isChecked_openLink+'style="margin:2px"/>Open image link in browser<br><input id="optionbox_alwaysShow" type="checkbox"'+isChecked_alwaysShow+'style="margin:2px"/>Always show image information in Photostream</div></li>'),$("#optionbox_openLink").change(function(){GM_setValue(key_openLink,$(this).prop("checked"))}),$("#optionbox_alwaysShow").change(function(){GM_setValue(key_alwaysShow,$(this).prop("checked"))}),type=="single"?action_single_page():type=="normal"||type=="album"?action_normal_page(type):type=="hover"&&action_hover_page()}log("Kickstart");var timestamp="1469473824",number=new Number(timestamp),t=new Date(number*1e3);log("Time number: "+t.toLocaleDateString("vi-VN")),kickStart();var target=$("html")[0],config={childList:!1,attributes:!0},observer=new MutationObserver(function(e,r){oldUrl!=document.URL&&(globalObserver!==null&&globalObserver.disconnect(),kickStart())});observer.observe(target,config);
