// ==UserScript==
// @name              网页加速器
// @namespace         https://github.com/syhyz1990/instantpage
// @version           1.4.3
// @author            YouXiaoHou
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/instantpage.meta.js
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/instantpage.user.js
// @license           AGPL
// @homepage          https://www.youxiaohou.com/tool/install-instantpage.html
// @supportURL        https://github.com/syhyz1990/instantpage
// @require           https://unpkg.com/sweetalert2@10.16.6/dist/sweetalert2.min.js
// @resource          swalStyle https://unpkg.com/sweetalert2@10.16.6/dist/sweetalert2.min.css
// @match             *://*/*
// @noframes
// @run-at            document-idle
// @grant             GM_openInTab
// @grant             GM_setValue
// @grant             GM_getValue
// @grant             GM_registerMenuCommand
// @grant             GM_getResourceText
// @icon              data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij48cGF0aCBkPSJNMCA3OWMwLTM1LjQgMjguNS02NCA2My45LTY0LjFzNjQuMSAyOC42IDY0LjEgNjRjMCA5LjQtMi4xIDE4LjQtNS43IDI2LjUtMSAyLjMtMi4zIDQuNi0zLjYgNi43LS40LjYtMSAxLTEuNyAxSDExYy0uNyAwLTEuMy0uNC0xLjctMS0xLjMtMi4yLTIuNS00LjQtMy42LTYuN0MyLjEgOTcuNCAwIDg4LjQgMCA3OXptMjQuNC0zOS43Yy01LjIgNS4xLTkuMiAxMS4xLTEyIDE3LjgtMyA2LjktNC41IDE0LjItNC41IDIxLjhhNTUuODYgNTUuODYgMCAwIDAgNC40IDIxLjhjLjcgMS42IDEuNCAzLjIgMi4yIDQuN2g5OC44Yy44LTEuNSAxLjYtMy4xIDIuMi00LjdhNTUuODYgNTUuODYgMCAwIDAgNC40LTIxLjggNTUuODYgNTUuODYgMCAwIDAtNC40LTIxLjhjLTIuOC02LjctNi45LTEyLjctMTItMTcuOC01LjEtNS4yLTExLjEtOS4yLTE3LjgtMTJhNTUuODYgNTUuODYgMCAwIDAtMjEuOC00LjQgNTUuODYgNTUuODYgMCAwIDAtMjEuOCA0LjRjLTYuNiAyLjgtMTIuNiA2LjgtMTcuNyAxMnoiIGZpbGw9IiM0NDQiLz48cGF0aCBkPSJNMTIuNCA1Ny4xYzIuOC02LjcgNi45LTEyLjcgMTItMTcuOCA1LjEtNS4yIDExLjEtOS4yIDE3LjgtMTJBNTUuODYgNTUuODYgMCAwIDEgNjQgMjIuOWE1NS44NiA1NS44NiAwIDAgMSAyMS44IDQuNGM2LjcgMi44IDEyLjcgNi45IDE3LjggMTIgNS4yIDUuMSA5LjIgMTEuMSAxMiAxNy44YTU1Ljg2IDU1Ljg2IDAgMCAxIDQuNCAyMS44IDU1Ljg2IDU1Ljg2IDAgMCAxLTQuNCAyMS44Yy0uNyAxLjYtMS40IDMuMi0yLjIgNC43SDE0LjZjLS44LTEuNS0xLjYtMy4xLTIuMi00LjdBNTUuODYgNTUuODYgMCAwIDEgOCA3OC45Yy0uMS03LjYgMS40LTE0LjkgNC40LTIxLjh6IiBmaWxsPSIjNjQ5OTUwIi8+PHBhdGggZD0iTTc3LjUgNjAuOUM2OCA4MS4yIDY0LjkgODQuNiA2NC42IDg1Yy0xLjUgMS41LTMuNSAyLjMtNS42IDIuM3MtNC4xLS44LTUuNi0yLjNhNy45MSA3LjkxIDAgMCAxIDAtMTEuMmMuMy0uNCAzLjgtMy40IDI0LjEtMTIuOXptMC04Yy0xLjEgMC0yLjMuMi0zLjQuOEM2My4yIDU4LjggNTEgNjQuOSA0Ny44IDY4LjFjLTYuMiA2LjItNi4yIDE2LjMgMCAyMi41IDMuMSAzLjEgNy4yIDQuNyAxMS4yIDQuN3M4LjEtMS42IDExLjItNC43YzMuMi0zLjIgOS4zLTE1LjQgMTQuNC0yNi4zIDIuNi01LjYtMS43LTExLjQtNy4xLTExLjR6TTYzLjkgMjkuOGMtMjcuMiAwLTQ5LjUgMjIuNi00OS4xIDQ5LjggMCAzLjYuNSA3LjIgMS4zIDEwLjYuNCAxLjggMiAzLjEgMy45IDMuMSAyLjYgMCA0LjQtMi40IDMuOS00LjktLjctMy0xLjEtNi4yLTEuMS05LjNBNDIuMDQgNDIuMDQgMCAwIDEgMjYgNjNjMi01IDUtOS40IDguOC0xMy4yUzQzIDQzLjEgNDcuOSA0MWE0Mi4wNCA0Mi4wNCAwIDAgMSAzMi4yIDBjNC45IDIuMSA5LjMgNS4xIDEzLjEgOC45Qzk3IDUzLjYgOTkuOSA1OCAxMDIgNjNhNDIuMDQgNDIuMDQgMCAwIDEgMy4yIDE2LjFjMCAzLjItLjQgNi4zLTEuMSA5LjMtLjYgMi41IDEuMyA0LjkgMy45IDQuOSAxLjggMCAzLjUtMS4zIDMuOS0zLjEuOC0zLjYgMS4zLTcuMyAxLjMtMTEuMSAwLTI3LjMtMjIuMS00OS4zLTQ5LjMtNDkuM3oiIGZpbGw9IiM0NDQiLz48L3N2Zz4=
// ==/UserScript==
(function(){"use strict";let t={getValue(s){return GM_getValue(s)},setValue(s,n){GM_setValue(s,n)},include(s,n){s=s.replace(/[-_]/ig,"");for(let i=0,r=n.length;i<r;i++){let u=n[i];if(u!==""&&s.toLowerCase().indexOf(u.toLowerCase())>-1)return!0}return!1},addStyle(s,n,i){n=n||"style";let r=document;if(r.getElementById(s))return;let l=r.createElement(n);l.rel="stylesheet",l.id=s,n==="style"?l.innerHTML=i:l.href=i,r.head.appendChild(l)},reg:{chrome:/^https?:\/\/chrome.google.com\/webstore\/.+?\/([a-z]{32})(?=[\/#?]|$)/,chromeNew:/^https?:\/\/chromewebstore.google.com\/.+?\/([a-z]{32})(?=[\/#?]|$)/,edge:/^https?:\/\/microsoftedge.microsoft.com\/addons\/.+?\/([a-z]{32})(?=[\/#?]|$)/,firefox:/^https?:\/\/(reviewers\.)?(addons\.mozilla\.org|addons(?:-dev)?\.allizom\.org)\/.*?(?:addon|review)\/([^/<>"'?#]+)/,microsoft:/^https?:\/\/(?:apps|www).microsoft.com\/(?:store|p)\/.+?\/([a-zA-Z\d]{10,})(?=[\/#?]|$)/}};({initValue(){[{name:"setting_success_times",value:0},{name:"allow_external_links",value:!0},{name:"allow_query_links",value:!0},{name:"enable_store_link",value:!0},{name:"enable_target_self",value:!1},{name:"enable_animation",value:!1},{name:"delay_on_hover",value:65},{name:"exclude_list",value:""},{name:"exclude_keyword",value:`login
logout
register
signin
signup
signout
pay
create
edit
download
del
reset
submit
doubleclick
googleads
exit`}].forEach(n=>{t.getValue(n.name)===void 0&&t.setValue(n.name,n.value)})},registerMenuCommand(){GM_registerMenuCommand("\u{1F680} \u5DF2\u52A0\u901F\uFF1A"+t.getValue("setting_success_times")+"\u6B21",()=>{Swal.fire({showCancelButton:!0,title:"\u786E\u5B9A\u8981\u91CD\u7F6E\u52A0\u901F\u6B21\u6570\u5417\uFF1F",icon:"warning",confirmButtonText:"\u786E\u5B9A",cancelButtonText:"\u53D6\u6D88",customClass:{popup:"instant-popup"}}).then(s=>{s.isConfirmed&&(t.setValue("setting_success_times",0),history.go(0))})}),GM_registerMenuCommand("\u2699\uFE0F \u8BBE\u7F6E",()=>{let s=`<div style="font-size: 1em;">
                              <label class="instant-setting-label">\u52A0\u901F\u5916\u90E8\u94FE\u63A5<input type="checkbox" id="S-External" ${t.getValue("allow_external_links")?"checked":""} class="instant-setting-checkbox"></label>
                              <label class="instant-setting-label"><span>\u52A0\u901F\u542B\u53C2\u6570\u94FE\u63A5 <a href="https://www.youxiaohou.com/tool/install-instantpage.html#%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E">\u8BE6\u89C1</a></span><input type="checkbox" id="S-Query" ${t.getValue("allow_query_links")?"checked":""} 
                              class="instant-setting-checkbox"></label>
                              <label class="instant-setting-label">\u52A0\u901F\u6269\u5C55/\u5E94\u7528\u5546\u5E97\u94FE\u63A5<input type="checkbox" id="S-Store" ${t.getValue("enable_store_link")?"checked":""} class="instant-setting-checkbox"></label>
                              <label class="instant-setting-label">\u52A0\u901F\u94FE\u63A5\u5728\u5F53\u524D\u9875\u6253\u5F00<input type="checkbox" id="S-Target" ${t.getValue("enable_target_self")?"checked":""} class="instant-setting-checkbox"></label>
                              <label class="instant-setting-label">\u52A0\u901F\u52A8\u753B\u6548\u679C<input type="checkbox" id="S-Animate" ${t.getValue("enable_animation")?"checked":""} 
                              class="instant-setting-checkbox"></label>
                              <label class="instant-setting-label">\u94FE\u63A5\u9884\u8BFB\u5EF6\u65F6\uFF08\u6BEB\u79D2\uFF09<input type="number" min="65" id="S-Delay" value="${t.getValue("delay_on_hover")}" 
                              class="instant-setting-input"></label>
                              <label class="instant-setting-label-col">\u6392\u9664\u4E0B\u5217\u7F51\u5740 <textarea placeholder="\u5217\u8868\u4E2D\u7684\u57DF\u540D\u5C06\u4E0D\u5F00\u542F\u52A0\u901F\u5668\uFF0C\u4E00\u884C\u4E00\u4E2A\uFF0C\u4F8B\u5982\uFF1Awww.baidu.com" id="S-Exclude" class="instant-setting-textarea">${t.getValue("exclude_list")}</textarea></label>
                              <label class="instant-setting-label-col">\u6392\u9664\u4E0B\u5217\u5173\u952E\u8BCD <textarea placeholder="\u94FE\u63A5\u4E2D\u542B\u5173\u952E\u8BCD\u5C06\u4E0D\u5F00\u542F\u52A0\u901F\u5668\uFF0C\u4E00\u884C\u4E00\u4E2A\uFF0C\u4F8B\u5982\uFF1Alogout" id="S-Exclude-Word" class="instant-setting-textarea">${t.getValue("exclude_keyword")}</textarea></label>
                            </div>`;Swal.fire({title:"\u52A0\u901F\u5668\u914D\u7F6E",html:s,showCloseButton:!0,confirmButtonText:"\u4FDD\u5B58",footer:'<div style="text-align: center;font-size: 1em;">\u70B9\u51FB\u67E5\u770B <a href="https://www.youxiaohou.com/tool/install-instantpage.html" target="_blank">\u4F7F\u7528\u8BF4\u660E</a>\uFF0C\u52A9\u624B\u514D\u8D39\u5F00\u6E90\uFF0CPowered by <a href="https://www.youxiaohou.com">\u6CB9\u5C0F\u7334</a></div>',customClass:{popup:"instant-popup"}}).then(n=>{n.isConfirmed&&history.go(0)}),document.getElementById("S-External").addEventListener("change",n=>{t.setValue("allow_external_links",n.currentTarget.checked)}),document.getElementById("S-Query").addEventListener("change",n=>{t.setValue("allow_query_links",n.currentTarget.checked)}),document.getElementById("S-Store").addEventListener("change",n=>{t.setValue("enable_store_link",n.currentTarget.checked)}),document.getElementById("S-Target").addEventListener("change",n=>{t.setValue("enable_target_self",n.currentTarget.checked)}),document.getElementById("S-Animate").addEventListener("change",n=>{t.setValue("enable_animation",n.currentTarget.checked)}),document.getElementById("S-Delay").addEventListener("change",n=>{t.setValue("delay_on_hover",n.currentTarget.value)}),document.getElementById("S-Exclude").addEventListener("change",n=>{t.setValue("exclude_list",n.currentTarget.value)}),document.getElementById("S-Exclude-Word").addEventListener("change",n=>{t.setValue("exclude_keyword",n.currentTarget.value)})})},inExcludeList(){let s=t.getValue("exclude_list").split(`
`),n=location.host;return s.includes(n)},instantPage(){if(window.instantLoaded)return;let s,n;const i=new Set,r=document.createElement("link"),u=r.relList&&r.relList.supports&&r.relList.supports("prefetch")&&window.IntersectionObserver&&"isIntersecting"in IntersectionObserverEntry.prototype,l=()=>window.navigator.onLine,_="instantAllowQueryString"in document.body.dataset||t.getValue("allow_query_links"),v="instantAllowExternalLinks"in document.body.dataset||t.getValue("allow_external_links"),S="instantWhitelist"in document.body.dataset,m="instantMousedownShortcut"in document.body.dataset,h=1111,L=t.getValue("enable_animation"),V=t.getValue("enable_target_self"),T=t.getValue("enable_store_link");window.instantLoaded=!0;const k=t.getValue("exclude_keyword").split(`
`);let p=t.getValue("delay_on_hover"),b=!1,w=!1,f=!1;if("instantIntensity"in document.body.dataset){const e=document.body.dataset.instantIntensity;if(e.substr(0,9)==="mousedown")b=!0,e==="mousedown-only"&&(w=!0);else if(e.substr(0,8)==="viewport")navigator.connection&&(navigator.connection.saveData||navigator.connection.effectiveType&&navigator.connection.effectiveType.includes("2g"))||(e==="viewport"?document.documentElement.clientWidth*document.documentElement.clientHeight<45e4&&(f=!0):e==="viewport-all"&&(f=!0));else{const a=parseInt(e);Number.isNaN(a)||(p=a)}}if(u){const e={capture:!0,passive:!0};if(w||document.addEventListener("touchstart",E,e),b?m||document.addEventListener("mousedown",C,e):document.addEventListener("mouseover",I,e),m&&document.addEventListener("mousedown",z,e),f){let a;window.requestIdleCallback?a=o=>{requestIdleCallback(o,{timeout:1500})}:a=o=>{o()},a(()=>{const o=new IntersectionObserver(c=>{c.forEach(y=>{if(y.isIntersecting){const x=y.target;o.unobserve(x),g(x)}})});document.querySelectorAll("a").forEach(c=>{d(c)&&o.observe(c)})})}}function E(e){n=performance.now();const a=e.target.closest("a");d(a)&&g(a)}function I(e){if(performance.now()-n<h||!("closest"in e.target))return;const a=e.target.closest("a");d(a)&&(a.addEventListener("mouseout",O,{passive:!0}),s=setTimeout(()=>{g(a),s=void 0},p))}function C(e){const a=e.target.closest("a");d(a)&&g(a)}function O(e){e.relatedTarget&&e.target.closest("a")===e.relatedTarget.closest("a")||s&&(clearTimeout(s),s=void 0)}function z(e){if(performance.now()-n<h)return;const a=e.target.closest("a");if(e.which>1||e.metaKey||e.ctrlKey||!a)return;a.addEventListener("click",function(c){c.detail!==1337&&c.preventDefault()},{capture:!0,passive:!1,once:!0});const o=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0,detail:1337});a.dispatchEvent(o)}function d(e){if(!(!e||!e.href)&&!(t.include(e.href,k)&&!t.reg.chrome.test(e.href)&&!t.reg.chromeNew.test(e.href)&&!t.reg.edge.test(e.href)&&!t.reg.edge.test(e.href)&&!t.reg.microsoft.test(e.href))&&!(S&&!("instant"in e.dataset))&&!(!v&&e.origin!==location.origin&&!("instant"in e.dataset))&&["http:","https:"].includes(e.protocol)){if(e.protocol==="http:"&&location.protocol==="https:")if(e.href.indexOf("http://www.baidu.com/link?url")===0)e.href=e.href.replace("http","https");else return;if(!(/\.[a-zA-Z0-9]{0,5}$/i.test(e.href)&&!/(com|cn|top|ltd|net|tech|shop|vip|xyz|wang|cloud|online|site|love|art|xin|store|fun|cc|website|press|space|beer|luxe|video|ren|group|fit|yoga|org|pro|ink|biz|info|design|link|work|mobi|kim|pub|name|tv|co|asia|red|live|wiki|gov|life|world|run|show|city|gold|today|plus|cool|icu|company|chat|zone|fans|law|host|center|club|email|fund|social|team|guru|htm|html|php|asp|jsp)$/i.test(e.href))&&!(!_&&e.search&&!("instant"in e.dataset))&&!(e.hash&&e.pathname+e.search===location.pathname+location.search)&&!(e.dataset.filename||e.dataset.noInstant))return!0}}function g(e){let a=e.href;if(!l()||i.has(a))return;T&&(t.reg.chrome.test(a)&&(e.href=a.replace("chrome.google.com","chrome.crxsoso.com")),t.reg.chromeNew.test(a)&&(e.href=a.replace("chromewebstore.google.com","chrome.crxsoso.com/webstore")),t.reg.edge.test(a)&&(e.href=a.replace("microsoftedge.microsoft.com","microsoftedge.crxsoso.com")),t.reg.firefox.test(a)&&(e.href=a.replace("addons.mozilla.org","addons.crxsoso.com")),t.reg.microsoft.test(a)&&(e.href=a.replace(/(www|apps)\.microsoft\.com/,"apps.crxsoso.com")));const o=document.createElement("link");o.rel="prefetch",o.href=a,document.head.appendChild(o),i.add(a),L&&e.classList.add("link-instanted"),V&&(e.target="_self"),t.setValue("setting_success_times",t.getValue("setting_success_times")+1)}},addPluginStyle(){let s=`
                .instant-popup { font-size: 14px !important; }
                .instant-setting-label { display: flex;align-items: center;justify-content: space-between;padding-top: 15px; }
                .instant-setting-label-col { display: flex;align-items: flex-start;;padding-top: 15px;flex-direction:column }
                .instant-setting-checkbox { width: 16px;height: 16px; }
                .instant-setting-textarea { width: 100%; margin: 14px 0 0; height: 60px; resize: none; border: 1px solid #bbb; box-sizing: border-box; padding: 5px 10px; border-radius: 5px; color: #666; line-height: 1.2; }
                .instant-setting-input { border: 1px solid #bbb; box-sizing: border-box; padding: 5px 10px; border-radius: 5px; width: 100px}
                 @keyframes instantAnminate { from { opacity: 1; } 50% { opacity: 0.4 } to { opacity: 0.9; }}
                .link-instanted { animation: instantAnminate 0.6s 1; animation-fill-mode:forwards }
                .link-instanted * { animation: instantAnminate 0.6s 1; animation-fill-mode:forwards }
            `;document.head&&(t.addStyle("swal-pub-style","style",GM_getResourceText("swalStyle")),t.addStyle("instant-style","style",s)),new MutationObserver(()=>{t.addStyle("swal-pub-style","style",GM_getResourceText("swalStyle")),t.addStyle("instant-style","style",s)}).observe(document.head,{childList:!0,subtree:!0})},init(){this.initValue(),this.addPluginStyle(),this.registerMenuCommand(),!this.inExcludeList()&&this.instantPage()}}).init()})();
