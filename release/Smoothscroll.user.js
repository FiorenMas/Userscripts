// ==UserScript==
// @name Smoothscroll
// @author       Creec Winceptor
// @namespace https://greasyfork.org/users/3167
// @include     *
// @version 12
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Smoothscroll.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Smoothscroll.meta.js
// ==/UserScript==
var Smoothscroll={};Smoothscroll.Smoothness=.5,Smoothscroll.Acceleration=.5,Smoothscroll.Debug=0,Smoothscroll.Refreshrate=60,Smoothscroll.MaxRefreshrate=300,Smoothscroll.MinRefreshrate=1;function ScrollSubpixels(o,e){if(e!=null)return o.scrollsubpixels=e,e;var r=o.scrollsubpixels;return r??0}function ScrollPixels(o,e){if(e!=null)return o.scrollpixels=e,ScrollSubpixels(o,0),e;var r=o.scrollpixels;return r??0}var last=0;function AnimateScroll(o,e){var r=ScrollSubpixels(o),n=ScrollPixels(o);Smoothscroll.Debug>3&&console.log("scrollpixels: "+n),Smoothscroll.Debug>3&&(console.log("target: ",o),o==document.documentElement&&console.log("document.documentElement"));var l=0;n>0&&(l=1),n<0&&(l=-1);var t=1-Math.pow(e,-1/(e*Smoothscroll.Smoothness)),u=n*t;if(Math.abs(n)>2){var i=Math.floor(Math.abs(u))*l,c=u-i,s=Math.floor(Math.abs(r+c))*l,d=r+c-s;ScrollPixels(o,n-i-s),ScrollSubpixels(o,d);var a=i+s;Smoothscroll.Debug>1&&console.log("scrolldelta: "+a),o.style.scrollBehavior="auto",o.scrollTop=o.scrollTop+a,Smoothscroll.Debug>1&&console.log("target.scrollTop: "+o.scrollTop),o.scrollanimated=!0,RequestAnimationUpdate(function(f){AnimateScroll(o,f)})}else RequestAnimationUpdate(function(f){ScrollPixels(o,0)}),o.scrollanimated=!1}function RequestAnimationUpdate(o){var e=performance.now();window.requestAnimationFrame(()=>{var r=performance.now(),n=r-e,l=1e3/Math.max(n,1),t=Math.min(Math.max(l,Smoothscroll.MinRefreshrate),Smoothscroll.MaxRefreshrate);o(t)})}Smoothscroll.Stop=function(o){o&&ScrollPixels(o,0)},Smoothscroll.Start=function(o,e){if(o){var r=ScrollPixels(o,e);o.scrollanimated||AnimateScroll(o,Smoothscroll.Refreshrate)}},typeof module<"u"&&(module.exports=Smoothscroll);function CanScroll(o,e){if(e<0)return o.scrollTop>0;if(e>0){if(o==document.body){if(o.scrollTop==0){if(o.scrollTop=3,o.scrollTop==0)return!1;o.scrollTop=0}return Math.round(o.clientHeight+o.scrollTop)<o.offsetHeight}return Math.round(o.clientHeight+o.scrollTop)<o.scrollHeight}}function HasScrollbar(o){if(o==window||o==document)return!1;if(o==document.body)return window.getComputedStyle(document.body)["overflow-y"]!="hidden";if(o==document.documentElement)return window.innerWidth>document.documentElement.clientWidth;var e=window.getComputedStyle(o);return e["overflow-y"]!="hidden"&&e["overflow-y"]!="visible"}function Scrollable(o,e){o==document.body;var r=CanScroll(o,e);if(!r)return Smoothscroll.Debug>1&&console.log("scrollablecheck: "+r),!1;var n=HasScrollbar(o);return n?(Smoothscroll.Debug>1&&(console.log("scrollablecheck: "+r),console.log("scrollbarcheck: "+n)),!0):(Smoothscroll.Debug>1&&console.log("scrollbarcheck: "+n),!1)}function GetPath(o){return o.path?o.path:o.composedPath?o.composedPath():(Smoothscroll.Debug>1&&console.log("Smoothscroll: e.path is undefined"),null)}function GetTarget(o){var e=o.deltaY,r=GetPath(o);if(!r)return null;Smoothscroll.Debug>2&&(console.log("nodes: "),console.log(r),console.log("target: "));for(var n=0;n<r.length;n++){var l=r[n];if(Smoothscroll.Debug>2&&console.log(l),Scrollable(l,e))return Smoothscroll.Debug>2&&console.log("true"),l}return Smoothscroll.Debug>1&&console.log("false"),null}function GetStyleProperty(o,e){if(window.getComputedStyle){var r=document.defaultView.getComputedStyle(o,null).getPropertyValue(e);if(r)return parseInt(r)}else if(o.currentStyle){var r=o.currentStyle[e.encamel()];if(r)return parseInt(r)}return null}function StopScroll(o){var e=GetPath(o);if(!e)return null;for(var r=0;r<e.length;r++){var n=e[r];Smoothscroll.Stop(n)}}function StartScroll(o,e){if(o.defaultPrevented)return!0;var r=o.deltaY;if(Smoothscroll.Debug&&console.log("e: ",o),o.deltaMode&&o.deltaMode==1){var n=GetStyleProperty(e,"line-height");Smoothscroll.Debug&&console.log("line: "+n),n&&n>0&&(r=o.deltaY*n)}if(o.deltaMode&&o.deltaMode==2){var l=e.clientHeight;Smoothscroll.Debug&&console.log("page: "+l),l&&l>0&&(r=o.deltaY*l)}var t=ScrollPixels(e),u=Math.sqrt(Math.abs(t/r*Smoothscroll.Acceleration)),i=Math.round(r*u),c=t+r+i;Smoothscroll.Debug&&(console.log("scrollpixels: "+t),console.log("delta: "+r),console.log("acceleration: "+i),console.log("totalscroll: "+c)),Smoothscroll.Start(e,c),o.preventDefault()}function WheelEvent(o){var e=GetTarget(o);e&&StartScroll(o,e)}function ClickEvent(o){StopScroll(o)}function Init(){if(window.top!=window.self||window.Smoothscroll&&window.Smoothscroll.Loaded)return null;window.requestAnimationFrame||(window.requestAnimationFrame=window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame),document.documentElement.addEventListener("wheel",function(o){WheelEvent(o),Smoothscroll.Debug>0&&console.log(o)},{passive:!1}),document.documentElement.addEventListener("mousedown",function(o){ClickEvent(o),Smoothscroll.Debug>0&&console.log(o)}),window.Smoothscroll=Smoothscroll,window.Smoothscroll.Loaded=!0,console.log("Smoothscroll: loaded")}Init();
