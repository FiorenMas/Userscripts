// ==UserScript==
// @name         Soundcloud Downloader Clean
// @namespace    https://openuserjs.org/users/webketje
// @version      1.0.0
// @author       webketje
// @license      MIT
// @icon         https://a-v2.sndcdn.com/assets/images/sc-icons/favicon-2cadd14bdb.ico
// @homepageURL  https://gist.github.com/webketje/8cd2e6ae8a86dbe0533c5d2c612c42c6
// @supportURL   https://gist.github.com/webketje/8cd2e6ae8a86dbe0533c5d2c612c42c6#comments
// @noframes
// @match        https://soundcloud.com/*
// @grant        unsafeWindow
// @require      https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Soundcloud20Downloader20Clean.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Soundcloud20Downloader20Clean.meta.js
// ==/UserScript==
(function(){"use strict";var r=unsafeWindow||window,u=".soundActions.sc-button-toolbar .sc-button-group",t={debug:!1,client_id:"",dlButtonId:"scdlc-btn",modalId:"scdl-third-party-modal"},l={en:{download:"Download",downloading:"Downloading",copy:"Copy",copy_success:"Copied to clipboard",copy_failure:"Failed to copy to clipboard!",close:"Close",modal_title:"could not download this track. Use one of these third-party services instead?"},es:{download:"Descargar",downloading:"Descargando..",copy:"Copiar",copy_success:"Copiada al portapapeles",copy_failure:"\xA1No se pudo copiar al portapapeles!",close:"",modal_title:"no se pudo descargar esta banda sonora. \xBFUtilizar uno de estos servicios de terceros en su lugar?"},fr:{download:"T\xE9l\xE9charger",downloading:"T\xE9l\xE9chargement..",copy:"Copier",copy_success:"Copi\xE9 dans le presse-papiers!",copy_failure:"\xC9chec de la copie dans le presse-papiers !",close:"Fermer",modal_title:"ne peut pas t\xE9l\xE9charger ce fichier. Utiliser l\u2019un de ces services tiers ?"},nl:{download:"Downloaden",downloading:"Downloaden..",copy:"Kopi\xEBren",copy_success:"Naar klembord gekopieerd!",copy_failure:"Kopi\xEBren naar klembord mislukt!",close:"Sluiten",modal_title:"kon dit bestand niet downloaden. Een van deze externe diensten gebruiken?"},de:{download:"Herunterladen",downloading:"Herunterladen..",copy:"Kopieren",copy_success:"In die Zwischenablage kopiert",copy_failure:"Kopieren in die Zwischenablage fehlgeschlagen!",close:"Schlie\xDFen",modal_title:"konnte diesen Sound nicht herunterladen. Nutzen Sie stattdessen einen dieser Drittanbieterdienste?"},pl:{download:"\u015Aci\u0105gnij",downloading:"\u015Aci\u0105ganie..",copy:"Kopiuj",copy_success:"Skopiowano do schowka",copy_failure:"Nie uda\u0142o si\u0119 skopiowa\u0107 do schowka!!",close:"Zamknij",modal_title:"nie uda\u0142o si\u0119 pobra\u0107 tego utworu. Zamiast tego skorzysta\u0107 z jednej z us\u0142ug stron trzecich?"},it:{download:"Scaricare",downloading:"Scaricando..",copy:"Copia",copy_success:"Copiato negli appunti",copy_failure:"Impossibile copiare negli appunti!",close:"Chiudi",modal_title:"non \xE8 stato possibile scaricare questo suono. Utilizzi invece uno di questi servizi di terze parti?"},pt_BR:{download:"Baixar",downloading:"Baixando..",copy:"Copiar",copy_success:"Copiado para a \xE1rea de transfer\xEAncia",copy_failure:"Falha ao copiar para a \xE1rea de transfer\xEAncia!!",close:"Fechar",modal_title:"n\xE3o foi poss\xEDvel baixar este som. Usar um desses servi\xE7os de terceiros?"},sv:{download:"Ladda ner",downloading:"Laddar ner..",copy:"Kopiera",copy_success:"Kopierat till urklipp",copy_failure:"Det gick inte att kopiera till urklipp!",close:"St\xE4ng",modal_title:"han kunde inte ladda ner det h\xE4r ljudet. Anv\xE4nd n\xE5gon av dessa tredjepartstj\xE4nster ist\xE4llet?"}}[document.documentElement.lang||"en"];function c(){var e=new Date().toLocaleString(),n=[].slice.call(arguments),a=["SCDLC",e,"-"].join(" ");t.debug&&console.log.apply(console,[a+n[0]].concat(n.slice(1)))}function p(e,n){var a=r.XMLHttpRequest.prototype.open;r.XMLHttpRequest.prototype.open=function(){a.apply(this,arguments);var i=e.apply(this,arguments);i&&(r.XMLHttpRequest.prototype.open=a,n(i))}}t.getTrackName=function(e){return[e.user.username,e.title].join(" - ")},t.getMediaURL=function(e,n,a){if(e.media&&e.media.transcodings){var i=e.media.transcodings.filter(function(s){return s.format&&s.format.protocol==="progressive"})[0];if(i){var o=new XMLHttpRequest;o.onload=function(){var s;try{s=JSON.parse(o.responseText)}catch{}s&&s.url?n(s.url):a(!1)},o.onerror=a,o.open("GET",i.url+"?client_id="+t.client_id),o.send()}else a(!1)}else a(!1)},t.getStreamURL=function(e,n,a){var i=new XMLHttpRequest;i.onload=function(){var o=JSON.parse(i.responseText);t.getMediaURL(o,function(d){n({stream_url:d,track_name:t.getTrackName(o)})},function(){a(!1)})}.bind(this),i.onerror=function(){a(!1)},i.open("GET","https://api-v2.soundcloud.com/resolve?url="+encodeURIComponent(e)+"&client_id="+this.client_id),i.send()},t.button={download:function(e){e.preventDefault();var n=document.getElementById(t.dlButtonId);n&&(n.textContent=l.downloading),setTimeout(function(){saveAs(e.target.href,e.target.dataset.title),n&&(n.textContent=l.download)},100)},render:function(e,n,a){var i=l.download,o=document.createElement("a");return o.className="sc-button sc-button-medium sc-button-responsive sc-button-download",o.href=e,o.id=t.dlButtonId,o.textContent=i,o.title=i,o.dataset.title=n+".mp3",o.setAttribute("download",n+".mp3"),o.target="_blank",o.onclick=a,o.style.marginLeft="5px",o.style.cssFloat="left",o.style.border="1px solid orangered",o},attach:function(){var e=arguments,n=this,a=0,i=setInterval(function(){var o=document.querySelector(u);a++,o&&!document.getElementById(t.dlButtonId)?(o.insertAdjacentElement("beforeend",n.render.apply(n,e)),c("Attaching download button to element:",o),clearInterval(i)):a===50&&(c(`%c Couldn't find element "`+u+'" after 2 seconds',"color: #FF0000;"),clearInterval(i))},100)},remove:function(){var e=document.getElementById(t.dlButtonId);e&&e.parentNode.removeChild(e)}},t.modal={providers:["aHR0cHM6Ly9zY2xvdWRkb3dubG9hZGVyLm5ldA==","aHR0cHM6Ly93d3cuc291bmRjbG91ZG1wMy5vcmc=","aHR0cHM6Ly9zb3VuZGNsb3VkbWUuY29t"],render:function(e){var n=document.createElement("div"),a=this;const i=['<div class="modal g-z-index-modal-background g-opacity-transition g-z-index-overlay modalWhiteout showBackground g-backdrop-filter-grayscale" style="outline: none; padding-right: 0px; display: flex; justify-content: center;" tabindex="-1" id="scdl-third-party-modal">','<div class="modal__modal sc-border-box g-z-index-modal-content transparentBackground" style="height: auto;">','<button type="button" title="'+l.close+'" class="modal__closeButton">'+l.close+"</button>",'<div class="modal__content"><div class="tabs"><div class="tabs__content"><div class="tabs__contentSlot" style="display: block;"><article class="shareContent">','<div class="publicShare"><section class="g-modal-section sc-clearfix sc-pt-2x">','<h2 class="sc-orange">Soundcloud Downloader Clean '+l.modal_title+"</h2>",'</section><section class="g-modal-section sc-clearfix sc-pt-2x">','<h3 style="margin-bottom: 0.5rem;">'+l.download+" <em>"+e+"</em> via: </h3>",this.providers.map(s=>['<div><a href="',r.atob(s),'" target="_blank" style="display: inline-block; font-size: 14px; padding: 0.25rem 0;">',r.atob(s),"</a></div>"].join("")).join(""),'<div class="shareLink sc-clearfix publicShare__link sc-pt-2x m-showPositionOption" style="margin-top: 1rem;">','<label for="shareLink__field" style="margin-right:0.5rem;">Link</label>','<input type="text" value="'+r.location.href+'" class="shareLink__field sc-input" id="shareLink__field" readonly="readonly">','<button class="sc-button sc-button-copy">'+l.copy+"</button>",'<span class="sc-copy-feedback" style="margin-left: 1rem;"></span>',"</div>","</section></div></article></div></div></div></div></div></div>"].join("");n.innerHTML=i;var o=n.firstElementChild;return o.addEventListener("click",function(s){this===s.target||s.target.classList.contains("modal__closeButton")?a.remove():s.target.classList.contains("sc-button-copy")&&navigator.clipboard.writeText(r.location.href).then(function(){var d=o.querySelector(".sc-copy-feedback");d.innerHTML='<span style="color: green;">Copied to clipboard!</span>'},function(d){c("Failed to write URL to the clipboard.",d);var m=o.querySelector(".sc-copy-feedback");m.innerHTML='<span style="color: red;">Failed to copy to clipboard!</span>'})}),o},attach:function(){this.remove(),document.body.appendChild(this.render.apply(this,arguments))},remove:function(){var e=document.getElementById(t.modalId);e&&e.parentNode.removeChild(e)}},t.parseClientIdFromURL=function(e){var n=/client_id=([\w\d]+)&*/;return e&&e.match(n)&&e.match(n)[1]},t.getClientID=function(e){p(function(n,a){return t.parseClientIdFromURL(a)},e)},t.load=function(e){if(/^(\/(you|stations|discover|stream|upload|search|settings|.+?\/sets))/.test(r.location.pathname)){t.button.remove();return}t.getStreamURL(e,function(a){a?(c("Detected valid Soundcloud artist track URL. Requesting info..."),t.button.attach(a.stream_url,a.track_name,t.button.download)):t.button.remove()},function(){c("%c No compatible media transcoding found.","color: #FF0000;"),t.button.attach("javascript:void(0);","None",function(){var a=document.querySelector(".soundTitle__title"),i=document.querySelector(".soundTitle__username");t.modal.attach([i.textContent.trim(),"-",a.textContent.trim()].join(" "))})})},["pushState","replaceState","forward","back","go"].forEach(function(e){var n=r.history.pushState;r.history[e]=function(){n.apply(r.history,arguments),t.load(r.location.href)}}),t.debug&&(r.scdl=t),t.getClientID(function(e){c("Found Soundcloud client id:",e,". Initializing..."),t.client_id=e,t.load(r.location.href)})})();
