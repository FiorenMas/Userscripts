// ==UserScript==
// @name                ChatGPT Infinity âˆž
// @author              Adam Lui
// @namespace           https://github.com/adamlui
// @version             2025.6.10
// @license             MIT
// @icon                https://assets.chatgptinfinity.com/images/icons/infinity-symbol/circled/with-robot/icon48.png?v=8df6f33
// @icon64              https://assets.chatgptinfinity.com/images/icons/infinity-symbol/circled/with-robot/icon64.png?v=8df6f33
// @compatible          chrome
// @compatible          firefox
// @compatible          edge
// @compatible          opera
// @compatible          brave
// @compatible          vivaldi
// @compatible          waterfox
// @compatible          librewolf
// @compatible          ghost
// @compatible          qq
// @compatible          whale
// @match               *://chatgpt.com/*
// @match               *://github.com/*/chatgpt-infinity*
// @connect             cdn.jsdelivr.net
// @connect             gm.chatgptinfinity.com
// @connect             raw.githubusercontent.com
// @require             https://cdn.jsdelivr.net/npm/@kudoai/chatgpt.js@3.8.1/dist/chatgpt.min.js#sha256-/71AK4V0/J40zINYEriMeEWGIZ8qfyWMQu76ui3SBNs=
// @require             https://cdn.jsdelivr.net/gh/adamlui/chatgpt-infinity@09e04e0/chromium/extension/components/modals.js#sha256-hN+jB/TqMnrCM7EB3LuKIodb9M4604pfLWr+d3Qp/VI=
// @require             https://cdn.jsdelivr.net/gh/adamlui/chatgpt-infinity@6d883cc/chromium/extension/components/toggles.js#sha256-/4whFl+BxZilD7/ofr9MrIoJiZCa1sva28V4F/IAMVg=
// @require             https://cdn.jsdelivr.net/gh/adamlui/chatgpt-infinity@62b5899/chromium/extension/lib/browser.js#sha256-7teBecqrjkazKH6oetGyxKlBkAk5U9ota/LNCB3Q+Jw=
// @require             https://cdn.jsdelivr.net/gh/adamlui/chatgpt-infinity@c323a40/chromium/extension/lib/dom.min.js#sha256-IGNj9Eoecq7QgY7SAs75wONajgN9Wg0NmCjKTCfu9CY=
// @require             https://cdn.jsdelivr.net/gh/adamlui/chatgpt-infinity@3372987/chromium/extension/lib/infinity.js#sha256-MN1pC8s+N3Rqqj+2TmKB3Q3DyjNMmFSmdZD/4FusqyE=
// @require             https://cdn.jsdelivr.net/gh/adamlui/chatgpt-infinity@6145c0f/chromium/extension/lib/settings.js#sha256-7xKPZWrfHF2ZIlRtgcjKFLoh3NxVcXGchigmitQHPoQ=
// @require             https://cdn.jsdelivr.net/gh/adamlui/chatgpt-infinity@fdb7c91/chromium/extension/lib/styles.js#sha256-MTt9alQNJ4jyuFB+Lt6K/D1kLGwIvfgu5WJ628ZJ03s=
// @require             https://cdn.jsdelivr.net/gh/adamlui/chatgpt-infinity@c040d5d/chromium/extension/lib/sync.js#sha256-XA2p7A8i2R0MHsO4J0R2hwHSaAC/orytT3POQfeNY0I=
// @require             https://cdn.jsdelivr.net/gh/adamlui/chatgpt-infinity@8156513/chromium/extension/lib/ui.js#sha256-2yuQbliwz+uaCxUIEeTMWIH5JADHgjDBZD4/8I2T8rE=
// @resource rpgCSS     https://cdn.jsdelivr.net/gh/adamlui/ai-web-extensions@727feff/assets/styles/rising-particles/dist/gray.min.css#sha256-48sEWzNUGUOP04ur52G5VOfGZPSnZQfrF3szUr4VaRs=
// @resource rpwCSS     https://cdn.jsdelivr.net/gh/adamlui/ai-web-extensions@727feff/assets/styles/rising-particles/dist/white.min.css#sha256-6xBXczm7yM1MZ/v0o1KVFfJGehHk47KJjq8oTktH4KE=
// @grant               GM_setValue
// @grant               GM_getValue
// @grant               GM_registerMenuCommand
// @grant               GM_unregisterMenuCommand
// @grant               GM_getResourceText
// @grant               GM_xmlhttpRequest
// @grant               GM.xmlHttpRequest
// @noframes
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/chatgptinfinity.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/chatgptinfinity.meta.js
// @homepageURL         https://www.chatgptinfinity.com
// @supportURL          https://support.chatgptinfinity.com
// @contributionURL     https://github.com/sponsors/adamlui
// ==/UserScript==
(async()=>{if(location.host=="github.com"){const t=[...document.querySelectorAll(".markdown-alert")].find(e=>e.textContent.includes("Greasy Fork"));return t?t.style.display="none":void 0}window.env={browser:{language:chatgpt.getUserLanguage(),isFF:chatgpt.browser.isFirefox(),isMobile:chatgpt.browser.isMobile()},scriptManager:{name:(()=>{try{return GM_info.scriptHandler}catch{return"unknown"}})(),version:(()=>{try{return GM_info.version}catch{return"unknown"}})()},ui:{scheme:ui.getScheme()}},env.browser.isPortrait=env.browser.isMobile&&innerWidth<innerHeight,env.scriptManager.supportsTooltips=env.scriptManager.name=="Tampermonkey"&&parseInt(env.scriptManager.version.split(".")[0])>=5;const c=typeof GM<"u"&&GM.xmlHttpRequest||GM_xmlhttpRequest;window.app={version:GM_info.script.version,chatgptjsVer:/chatgpt\.js@([\d.]+)/.exec(GM_info.scriptMetaStr)[1],commitHashes:{app:"53220ff"}},app.urls={resourceHost:`https://cdn.jsdelivr.net/gh/adamlui/chatgpt-infinity@${app.commitHashes.app}`};const u={app:await new Promise(t=>c({method:"GET",url:`${app.urls.resourceHost}/assets/data/app.json`,onload:e=>t(JSON.parse(e.responseText))})),msgs:await new Promise(t=>{const e=app.urls.resourceHost+"/chromium/extension/_locales/",n=(env.browser.language?env.browser.language.replace("-","_"):"en")+"/";let a=e+n+"messages.json",s=0;function o(){c({method:"GET",url:a,onload:r})}function r(i){try{const p=JSON.parse(i.responseText),f={};for(const l in p)typeof p[l]=="object"&&"message"in p[l]&&(f[l]=p[l].message);t(f)}catch{if(s++,s==3)return t({});a=env.browser.language.includes("-")&&s==1?a.replace(/(_locales\/[^_]+)_[^_]+(\/)/,"$1$2"):e+"en/messages.json",o()}}o()})};Object.assign(app,{...u.app,urls:{...app.urls,...u.app.urls},msgs:u.msgs}),settings.load(Object.keys(settings.controls).filter(t=>t!="infinityMode")),settings.save("infinityMode",!1),config.replyLanguage||settings.save("replyLanguage",env.browser.language),config.replyTopic||settings.save("replyTopic",app.msgs.menuLabel_all),config.replyInterval||settings.save("replyInterval",7),window.toolbarMenu={state:{symbols:["\u274C","\u2714\uFE0F"],separator:env.scriptManager.name=="Tampermonkey"?" \u2014 ":": ",words:[app.msgs.state_off.toUpperCase(),app.msgs.state_on.toUpperCase()]},refresh(){if(!(typeof GM_unregisterMenuCommand>"u")){for(const t of this.entryIDs)GM_unregisterMenuCommand(t);this.register()}},register(){const t=new RegExp(`^(${app.msgs.menuLabel_all}|all|any|every)$`,"i");this.entryIDs=env.extensionActive?[GM_registerMenuCommand(`${this.state.symbols[0]} ${g(app.msgs.state_disabled)} (${app.msgs.menuLabel_extensionActive})`,()=>modals.open("about"),env.scriptManager.supportsTooltips?{title:" "}:void 0)]:Object.keys(settings.controls).map(e=>{const n=settings.controls[e],a=`${n.symbol||this.state.symbols[+settings.typeIsEnabled(e)]} ${n.label} ${n.type=="toggle"?this.state.separator+this.state.words[+settings.typeIsEnabled(e)]:n.status?` \u2014 ${n.status}`:""}`;return GM_registerMenuCommand(a,()=>{if(n.type=="toggle")settings.save(e,!config[e]),notify(`${n.label}: ${this.state.words[+settings.typeIsEnabled(e)]}`);else if(e=="replyLanguage")for(;;){let s=prompt(`${app.msgs.prompt_updateReplyLang}:`,config.replyLanguage);if(s==null)break;if(!/\d/.test(s)){s=s.length<4||s.includes("-")?s.toUpperCase():g(s),settings.save("replyLanguage",s||env.browser.language),modals.alert(app.msgs.alert_replyLangUpdated+"!",app.msgs.appName+" "+app.msgs.alert_willReplyIn+" "+(s||app.msgs.alert_yourSysLang)+".");break}}else if(e=="replyTopic"){let s=prompt(app.msgs.prompt_updateReplyTopic+" ("+app.msgs.prompt_orEnter+" 'ALL'):",config.replyTopic);s!=null&&(s=g(s.toString()),settings.save("replyTopic",!s||t.test(s)?app.msgs.menuLabel_all:s),modals.alert(`${app.msgs.alert_replyTopicUpdated}!`,`${app.msgs.appName} ${app.msgs.alert_willAnswer} `+(!s||t.test(s)?app.msgs.alert_onAllTopics:`${app.msgs.alert_onTopicOf} ${s}`)+"!"))}else if(e=="replyInterval")for(;;){const s=prompt(`${app.msgs.prompt_updateReplyInt}:`,config.replyInterval);if(s==null)break;if(!isNaN(parseInt(s,10))&&parseInt(s,10)>4){settings.save("replyInterval",parseInt(s,10)),modals.alert(app.msgs.alert_replyIntUpdated+"!",app.msgs.appName+" "+app.msgs.alert_willReplyEvery+" "+s+" "+app.msgs.unit_seconds+".");break}}sync.configToUI({updatedKey:e})},env.scriptManager.supportsTooltips?{title:n.helptip||" "}:void 0)}),["about","donate"].forEach(e=>{e=="donate"&&env.extensionActive||this.entryIDs.push(GM_registerMenuCommand(`${e=="about"?"\u{1F4A1}":"\u{1F496}"} ${app.msgs[`menuLabel_${e}`]} ${e=="about"?app.msgs.appName:""}`,()=>e=="about"?modals.open(e):modals.safeWinOpen(app.urls.donate["ko-fi"]),env.scriptManager.supportsTooltips?{title:" "}:void 0))})}},window.updateCheck=()=>c({method:"GET",url:`${app.urls.update.gm}?t=${Date.now()}`,headers:{"Cache-Control":"no-cache"},onload:t=>{if(app.latestVer=/@version +(.*)/.exec(t.responseText)?.[1],app.latestVer)for(let e=0;e<4;e++){const n=parseInt(app.version.split(".")[e],10)||0,a=parseInt(app.latestVer.split(".")[e],10)||0;if(n>a)break;if(a>n)return modals.open("update","available")}modals.open("update","unavailable")}});function g(t){if(!t)return"";const e=t.toLowerCase().split(" ");for(let n=0;n<e.length;n++)e[n]=e[n][0].toUpperCase()+e[n].slice(1);return e.join(" ")}window.notify=function(t,e="",n="",a=""){if(styles.toast.node||styles.update({key:"toast"}),config.notifDisabled&&!new RegExp(`${app.msgs.menuLabel_show} ${app.msgs.menuLabel_notifs}`,"i").test(t))return;const s=toolbarMenu.state.words.find(r=>t.includes(r));s&&(t=t.replace(s,"")),chatgpt.notify(`${app.symbol} ${t}`,e,n,a||env.ui.scheme=="light");const o=document.querySelector(".chatgpt-notif:last-child");if(o.classList.add(app.slug),s){const r={on:{light:"color: #5cef48 ; text-shadow: rgba(255,250,169,0.38) 2px 1px 5px",dark:"color: #5cef48 ; text-shadow: rgb(55,255,0) 3px 0 10px"},off:{light:"color: #ef4848 ; text-shadow: rgba(255,169,225,0.44) 2px 1px 5px",dark:"color: #ef4848 ; text-shadow: rgba(255, 116, 116, 0.87) 3px 0 9px"}},i=dom.create.elem("span");i.style.cssText=r[s==toolbarMenu.state.words[0]?"off":"on"][env.ui.scheme],i.append(s),o.append(i)}},chatgpt.isIdle=function(){return new Promise(t=>{new MutationObserver((e,n)=>{chatgpt.getStopBtn()||(n.disconnect(),t())}).observe(document.body,{childList:!0,subtree:!0})})},toggles.sidebar.update.navicon({preload:!0}),postMessage({action:"getExtensionInfo",source:`${app.slug}.user.js`},location.origin),addEventListener("message",d);function d(t){if(t.origin!=location.origin)return;const e=t.data.source;env.extensionActive=e.includes(app.slug)&&/extension/i.test(e)}if(await new Promise(t=>setTimeout(t,100)),removeEventListener("message",d),toolbarMenu.register(),env.extensionActive)return;await Promise.race([chatgpt.isLoaded(),new Promise(t=>setTimeout(t,5e3))]),"hidden"in document&&(document.onvisibilitychange=()=>{config.infinityMode&&(settings.save("infinityMode",!1),sync.configToUI({updatedKey:"infinityMode"}))}),["rpg","rpw"].forEach(t=>document.head.append(dom.create.style(GM_getResourceText(`${t}CSS`)))),toggles.sidebar.insert(),config.autoStart&&(settings.save("infinityMode",!0),sync.configToUI({updatedKey:"infinityMode"}),notify(`${app.msgs.menuLabel_autoStart}: ${app.msgs.state_on.toUpperCase()}`)),new MutationObserver(()=>{!config.toggleHidden&&document.querySelector(chatgpt.selectors.sidebar)&&!document.querySelector(`.${toggles.sidebar.class}`)&&toggles.sidebar.status!="inserting"&&(toggles.sidebar.status="missing",toggles.sidebar.insert())}).observe(document.body,{attributes:!0,subtree:!0}),new MutationObserver(m).observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>requestAnimationFrame(m));function m(){const t=ui.getScheme();env.ui.scheme!=t&&(env.ui.scheme=t,toggles.sidebar.update.scheme(),modals.stylize())}document.documentElement.hasAttribute("sidebar-click-zoom-observed")||(new MutationObserver(t=>t.forEach(({target:e})=>{e.closest("[class*=sidebar]")&&!e.closest("[class*=sidebar-toggle]")&&e.style.transform!="none"&&(e.style.transform="none")})).observe(document.body,{attributes:!0,subtree:!0,attributeFilter:["style"]}),document.documentElement.setAttribute("sidebar-click-zoom-observed",!0))})();
