// ==UserScript==
// @name         Tiktok Video & Slideshow Downloader 🎬🖼️
// @namespace    https://greasyfork.org/en/scripts/431826
// @version      2.9
// @author       YAD
// @match        *://*.tiktok.com/*
// @grant        GM_xmlhttpRequest
// @grant        GM_download
// @require      https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js
// @icon         https://miro.medium.com/v2/resize:fit:512/1*KX6NTUUHWlCP4sCXz28TBA.png
// @license      MIT
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Tiktok20Video20DownloaderF09F8EAC.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Tiktok20Video20DownloaderF09F8EAC.meta.js
// ==/UserScript==
(function(){"use strict";const m=document.createElement("style");m.innerHTML=`
        [id^="xgwrapper-"] {
            height: 100% !important;
        }
    `,document.head.appendChild(m);const p=e=>`TikTok_Video_${e}.mp4`,f=(e,t,o)=>{const r=document.createElement("div");return Object.assign(r.style,{position:"absolute",right:"15px",top:"27%",transform:"translateY(-50%)",width:"50px",height:"50px",backgroundColor:t,color:"#ffffff",fontSize:"18px",textShadow:"3px 3px 0px #9C1331",textAlign:"center",lineHeight:"50px",borderRadius:"50%",cursor:"pointer",zIndex:"999999"}),r.textContent=e,r.onclick=o,r},h=(e,t,o,r=!1)=>{if(!e){o.textContent="\u2716\uFE0F";return}o.textContent="\u23F3",GM_xmlhttpRequest({method:"GET",url:e,responseType:"blob",onload:({response:s})=>{s?r?t.file("video",s):GM_download({url:URL.createObjectURL(s),name:t,onload:()=>{o.textContent="\u2714\uFE0F",setTimeout(()=>o.remove(),2e3)},onerror:()=>{o.textContent="\u2716\uFE0F",setTimeout(()=>o.remove(),1500)}}):(o.textContent="\u2716\uFE0F",setTimeout(()=>o.remove(),1500))},onerror:()=>{o.textContent="\u2716\uFE0F",setTimeout(()=>o.remove(),1500)},ontimeout:()=>{o.textContent="\u2716\uFE0F",setTimeout(()=>o.remove(),1500)}})},y=e=>{const t=f("\u{1F39E}\uFE0F","#ff3b5c",async o=>{o.stopPropagation(),o.preventDefault(),t.textContent="\u23F3";const r=e.src||e.querySelector("source")?.src,c=e.closest('[id^="xgwrapper-"]')?.id.split("-")[2]||"default";if(r&&r.startsWith("blob:")){t.style.backgroundColor="#ffa700";const i=`https://www.tiktok.com/@YAD/video/${c}`,n=document.createElement("iframe");n.style.position="fixed",n.style.width="80%",n.style.height="80%",n.style.top="10%",n.style.left="10%",n.style.border="2px solid #000",n.style.zIndex="10000",n.style.visibility="hidden",n.src=i,document.body.appendChild(n);const d=()=>{const a=n.contentDocument||n.contentWindow.document,u=a.querySelector("video"),l=a.querySelector("video source");u&&l&&l.src?(h(l.src,p(c),t),n.remove()):setTimeout(d,1e3)};n.onload=()=>{setTimeout(d,8e3)}}else t.style.backgroundColor="#ff3b5c",h(r,p(c),t)});return e.parentNode.style.position="relative",e.parentNode.appendChild(t),t},g=e=>{let t;e.addEventListener("mouseover",()=>{t||(t=y(e))}),e.addEventListener("mouseout",o=>{t&&!e.contains(o.relatedTarget)&&!t.contains(o.relatedTarget)&&t.textContent!=="\u23F3"&&(t.remove(),t=null)})},x=()=>new Promise(e=>{const t=confirm("Do you want to download images as a ZIP file? Cancel will download individually");e(t)}),w=e=>{if(e.querySelector(".image-download-btn"))return;const t=f("\u{1F5BC}\uFE0F","#16b1c6",async()=>{t.textContent="\u231B";const o=e.querySelectorAll("img");if(!o.length){alert("No images found!"),t.textContent="\u2716\uFE0F";return}const r=Array.from(o).map(i=>i.src),s=[...new Set(r)];if(await x()){const i=new JSZip;let n=0;s.forEach((d,a)=>{GM_xmlhttpRequest({method:"GET",url:d,responseType:"blob",onload:u=>{i.file(`image${a+1}.jpeg`,u.response),n++,n===s.length&&i.generateAsync({type:"blob"}).then(l=>{const b=URL.createObjectURL(l);GM_download({url:b,name:"TikTok_Slideshow.zip"}),t.textContent="\u2714\uFE0F"})}})})}else s.forEach((i,n)=>{GM_download({url:i,name:`image${n+1}.jpeg`,onload:()=>{t.textContent="\u2714\uFE0F"}})})});e.style.position="relative",e.appendChild(t)},C=()=>{document.querySelectorAll('div[class*="DivPhotoVideoContainer"]:not(.processed)').forEach(e=>{e.classList.add("processed"),w(e)})};new MutationObserver(C).observe(document.body,{childList:!0,subtree:!0}),new MutationObserver(()=>{document.querySelectorAll("video:not(.processed)").forEach(e=>{e.classList.add("processed"),g(e)})}).observe(document.body,{childList:!0,subtree:!0})})();
