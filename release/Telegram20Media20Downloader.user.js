// ==UserScript==
// @name         Telegram Media Downloader
// @name:en      Telegram Media Downloader
// @version      1.206
// @namespace    https://github.com/Neet-Nestor/Telegram-Media-Downloader
// @author       Nestor Qin
// @license      GNU GPLv3
// @website      https://github.com/Neet-Nestor/Telegram-Media-Downloader
// @match        https://web.telegram.org/*
// @match        https://webk.telegram.org/*
// @match        https://webz.telegram.org/*
// @icon         https://img.icons8.com/color/452/telegram-app--v5.png
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Telegram20Media20Downloader.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Telegram20Media20Downloader.meta.js
// ==/UserScript==
(function(){const d={info:(c,r=null)=>{console.log(`[Tel Download] ${r?`${r}: `:""}${c}`)},error:(c,r=null)=>{console.error(`[Tel Download] ${r?`${r}: `:""}${c}`)}},w="\uE95A",_="\uE976",q=/^bytes (\d+)-(\d+)\/(\d+)$/,v=500,C=c=>{var r=0,t=c.length,u=0;if(t>0)for(;u<t;)r=(r<<5)-r+c.charCodeAt(u++)|0;return r>>>0},A=(c,r)=>{const t=document.querySelector("html").classList.contains("night")||document.querySelector("html").classList.contains("theme-dark"),u=document.getElementById("tel-downloader-progress-bar-container"),l=document.createElement("div");l.id="tel-downloader-progress-"+c,l.style.width="20rem",l.style.marginTop="0.4rem",l.style.padding="0.6rem",l.style.backgroundColor=t?"rgba(0,0,0,0.3)":"rgba(0,0,0,0.6)";const p=document.createElement("div");p.style.display="flex",p.style.justifyContent="space-between";const o=document.createElement("p");o.className="filename",o.style.margin=0,o.style.color="white",o.innerText=r;const m=document.createElement("div");m.style.cursor="pointer",m.style.fontSize="1.2rem",m.style.color=t?"#8a8a8a":"white",m.innerHTML="&times;",m.onclick=function(){u.removeChild(l)};const s=document.createElement("div");s.className="progress",s.style.backgroundColor="#e2e2e2",s.style.position="relative",s.style.width="100%",s.style.height="1.6rem",s.style.borderRadius="2rem",s.style.overflow="hidden";const n=document.createElement("p");n.style.position="absolute",n.style.zIndex=5,n.style.left="50%",n.style.top="50%",n.style.transform="translate(-50%, -50%)",n.style.margin=0,n.style.color="black";const e=document.createElement("div");e.style.position="absolute",e.style.height="100%",e.style.width="0%",e.style.backgroundColor="#6093B5",s.appendChild(n),s.appendChild(e),p.appendChild(o),p.appendChild(m),l.appendChild(p),l.appendChild(s),u.appendChild(l)},E=(c,r,t)=>{const u=document.getElementById("tel-downloader-progress-"+c);u.querySelector("p.filename").innerText=r;const l=u.querySelector("div.progress");l.querySelector("p").innerText=t+"%",l.querySelector("div").style.width=t+"%"},k=c=>{const r=document.getElementById("tel-downloader-progress-"+c).querySelector("div.progress");r.querySelector("p").innerText="Completed",r.querySelector("div").style.backgroundColor="#B6C649",r.querySelector("div").style.width="100%"},D=c=>{const r=document.getElementById("tel-downloader-progress-"+c).querySelector("div.progress");r.querySelector("p").innerText="Aborted",r.querySelector("div").style.backgroundColor="#D16666",r.querySelector("div").style.width="100%"},f=c=>{let r=[],t=0,u=null,l="mp4";const p=(Math.random()+1).toString(36).substring(2,10)+"_"+Date.now().toString();let o=C(c).toString(36)+"."+l;try{const e=JSON.parse(decodeURIComponent(c.split("/")[c.split("/").length-1]));e.fileName&&(o=e.fileName)}catch{}d.info(`URL: ${c}`,o);const m=e=>{fetch(c,{method:"GET",headers:{Range:`bytes=${t}-`},"User-Agent":"User-Agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/117.0"}).then(i=>{if(![200,206].includes(i.status))throw new Error("Non 200/206 response was received: "+i.status);const a=i.headers.get("Content-Type").split(";")[0];if(!a.startsWith("video/"))throw new Error("Get non video response with MIME type "+a);l=a.split("/")[1],o=o.substring(0,o.indexOf(".")+1)+l;const y=i.headers.get("Content-Range").match(q),b=parseInt(y[1]),S=parseInt(y[2]),h=parseInt(y[3]);if(b!==t)throw d.error("Gap detected between responses.",o),d.info("Last offset: "+t,o),d.info("New start offset "+y[1],o),"Gap detected between responses.";if(u&&h!==u)throw d.error("Total size differs",o),"Total size differs";return t=S+1,u=h,d.info(`Get response: ${i.headers.get("Content-Length")} bytes data from ${i.headers.get("Content-Range")}`,o),d.info(`Progress: ${(t*100/u).toFixed(0)}%`,o),E(p,o,(t*100/u).toFixed(0)),i.blob()}).then(i=>{e!==null?e.write(i).then(()=>{}):r.push(i)}).then(()=>{if(!u)throw new Error("_total_size is NULL");t<u?m(e):(e!==null?e.close().then(()=>{d.info("Download finished",o)}):s(),k(p))}).catch(i=>{d.error(i,o),D(p)})},s=()=>{d.info("Finish downloading blobs",o),d.info("Concatenating blobs and downloading...",o);const e=new Blob(r,{type:"video/mp4"}),i=window.URL.createObjectURL(e);d.info("Final blob size: "+e.size+" bytes",o);const a=document.createElement("a");document.body.appendChild(a),a.href=i,a.download=o,a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(i),d.info("Download triggered",o)};"showSaveFilePicker"in unsafeWindow&&(()=>{try{return unsafeWindow.self===unsafeWindow.top}catch{return!1}})()?unsafeWindow.showSaveFilePicker({suggestedName:o}).then(e=>{e.createWritable().then(i=>{m(i),A(p)}).catch(i=>{console.error(i.name,i.message)})}).catch(e=>{e.name!=="AbortError"&&console.error(e.name,e.message)}):(m(null),A(p))},B=c=>{let r=[],t=0,u=null;const l=C(c).toString(36)+".ogg",p=s=>{fetch(c,{method:"GET",headers:{Range:`bytes=${t}-`}}).then(n=>{if(n.status!==206&&n.status!==200){d.error("Non 200/206 response was received: "+n.status,l);return}const e=n.headers.get("Content-Type").split(";")[0];if(!e.startsWith("audio/"))throw d.error("Get non audio response with MIME type "+e,l),"Get non audio response with MIME type "+e;try{const i=n.headers.get("Content-Range").match(q),a=parseInt(i[1]),y=parseInt(i[2]),b=parseInt(i[3]);if(a!==t)throw d.error("Gap detected between responses."),d.info("Last offset: "+t),d.info("New start offset "+i[1]),"Gap detected between responses.";if(u&&b!==u)throw d.error("Total size differs"),"Total size differs";t=y+1,u=b}finally{return d.info(`Get response: ${n.headers.get("Content-Length")} bytes data from ${n.headers.get("Content-Range")}`),n.blob()}}).then(n=>{s!==null?s.write(n).then(()=>{}):r.push(n)}).then(()=>{t<u?p(s):s!==null?s.close().then(()=>{d.info("Download finished",l)}):o()}).catch(n=>{d.error(n,l)})},o=()=>{d.info("Finish downloading blobs. Concatenating blobs and downloading...",l);let s=new Blob(r,{type:"audio/ogg"});const n=window.URL.createObjectURL(s);d.info("Final blob size in bytes: "+s.size,l),s=0;const e=document.createElement("a");document.body.appendChild(e),e.href=n,e.download=l,e.click(),document.body.removeChild(e),window.URL.revokeObjectURL(n),d.info("Download triggered",l)};"showSaveFilePicker"in unsafeWindow&&(()=>{try{return unsafeWindow.self===unsafeWindow.top}catch{return!1}})()?unsafeWindow.showSaveFilePicker({suggestedName:l}).then(s=>{s.createWritable().then(n=>{p(n)}).catch(n=>{console.error(n.name,n.message)})}).catch(s=>{s.name!=="AbortError"&&console.error(s.name,s.message)}):p(null)},g=c=>{const r=(Math.random()+1).toString(36).substring(2,10)+".jpeg",t=document.createElement("a");document.body.appendChild(t),t.href=c,t.download=r,t.click(),document.body.removeChild(t),d.info("Download triggered",r)};d.info("Initialized"),setInterval(()=>{const c=document.getElementById("StoryViewer");if(c){console.log("storiesContainer");const m=()=>{console.log("createDownloadButton");const n=document.createElement("i");n.className="icon icon-download";const e=document.createElement("button");return e.className="Button TkphaPyQ tiny translucent-white round tel-download",e.appendChild(n),e.setAttribute("type","button"),e.setAttribute("title","Download"),e.setAttribute("aria-label","Download"),e.onclick=()=>{const i=c.querySelector("video"),a=i?.src||i?.currentSrc||i?.querySelector("source")?.src;if(a)f(a);else{const y=c.querySelectorAll("img.PVZ8TOWS");if(y.length>0){const b=y[y.length-1]?.src;b&&g(b)}}},e},s=c.querySelector(".GrsJNw3y")||c.querySelector(".DropdownMenu").parentNode;s&&!s.querySelector(".tel-download")&&(console.log("storyHeader"),s.insertBefore(m(),s.querySelector("button")))}const r=document.querySelector("#MediaViewer .MediaViewerSlide--active"),t=document.querySelector("#MediaViewer .MediaViewerActions");if(!r||!t)return;const u=r.querySelector(".MediaViewerContent > .VideoPlayer"),l=r.querySelector(".MediaViewerContent > div > img"),p=document.createElement("i");p.className="icon icon-download";const o=document.createElement("button");if(o.className="Button smaller translucent-white round tel-download",o.setAttribute("type","button"),o.setAttribute("title","Download"),o.setAttribute("aria-label","Download"),u){const m=u.querySelector("video").currentSrc;o.setAttribute("data-tel-download-url",m),o.appendChild(p),o.onclick=()=>{f(u.querySelector("video").currentSrc)};const s=u.querySelector(".VideoPlayerControls");if(s){const n=s.querySelector(".buttons");n.querySelector("button.tel-download")||n.querySelector(".spacer").after(o)}if(t.querySelector("button.tel-download")){const n=t.querySelector("button.tel-download");t.querySelectorAll('button[title="Download"]').length>1?t.querySelector("button.tel-download").remove():n.getAttribute("data-tel-download-url")!==m&&(n.onclick=()=>{f(u.querySelector("video").currentSrc)},n.setAttribute("data-tel-download-url",m))}else t.querySelector('button[title="Download"]')||t.prepend(o)}else if(l&&l.src)if(o.setAttribute("data-tel-download-url",l.src),o.appendChild(p),o.onclick=()=>{g(l.src)},t.querySelector("button.tel-download")){const m=t.querySelector("button.tel-download");t.querySelectorAll('button[title="Download"]').length>1?t.querySelector("button.tel-download").remove():m.getAttribute("data-tel-download-url")!==l.src&&(m.onclick=()=>{g(l.src)},m.setAttribute("data-tel-download-url",l.src))}else t.querySelector('button[title="Download"]')||t.prepend(o)},v),setInterval(()=>{const c=document.body.querySelector(".pinned-audio");let r,t=document.body.querySelector("._tel_download_button_pinned_container")||document.createElement("button");c&&(r=c.getAttribute("data-mid"),t.className="btn-icon tgico-download _tel_download_button_pinned_container",t.innerHTML=`<span class="tgico button-icon">${w}</span>`),document.body.querySelectorAll("audio-element").forEach(e=>{const i=e.closest(".bubble");if(!(!i||i.querySelector("._tel_download_button_pinned_container"))&&r&&t.getAttribute("data-mid")!==r&&e.getAttribute("data-mid")===r){t.onclick=b=>{b.stopPropagation(),y?B(a):f(a)},t.setAttribute("data-mid",r);const a=e.audio&&e.audio.getAttribute("src"),y=e.audio&&e.audio instanceof HTMLAudioElement;a&&c.querySelector(".pinned-container-wrapper-utils").appendChild(t)}});const l=document.getElementById("stories-viewer");if(l){const e=()=>{const y=document.createElement("button");return y.className="btn-icon rp tel-download",y.innerHTML=`<span class="tgico">${w}</span><div class="c-ripple"></div>`,y.setAttribute("type","button"),y.setAttribute("title","Download"),y.setAttribute("aria-label","Download"),y.onclick=()=>{const b=l.querySelector("video.media-video"),S=b?.src||b?.currentSrc||b?.querySelector("source")?.src;if(S)f(S);else{const h=l.querySelector("img.media-photo")?.src;h&&g(h)}},y},i=l.querySelector("[class^='_ViewerStoryHeaderRight']");i&&!i.querySelector(".tel-download")&&i.prepend(e());const a=l.querySelector("[class^='_ViewerStoryFooterRight']");a&&!a.querySelector(".tel-download")&&a.prepend(e())}const p=document.querySelector(".media-viewer-whole");if(!p)return;const o=p.querySelector(".media-viewer-movers .media-viewer-aspecter"),m=p.querySelector(".media-viewer-topbar .media-viewer-buttons");if(!o||!m)return;const s=m.querySelectorAll("button.btn-icon.hide");let n=null;for(const e of s)e.classList.remove("hide"),e.textContent===_&&e.classList.add("tgico-forward"),e.textContent===w&&(e.classList.add("tgico-download"),n=()=>{e.click()},d.info("onDownload",n));if(o.querySelector(".ckin__player")){const e=o.querySelector(".default__controls.ckin__controls");if(e&&!e.querySelector(".tel-download")){const i=e.querySelector(".bottom-controls .right-controls"),a=document.createElement("button");a.className="btn-icon default__button tgico-download tel-download",a.innerHTML=`<span class="tgico">${w}</span>`,a.setAttribute("type","button"),a.setAttribute("title","Download"),a.setAttribute("aria-label","Download"),n?a.onclick=n:a.onclick=()=>{f(o.querySelector("video").src)},i.prepend(a)}}else if(o.querySelector("video")&&o.querySelector("video")&&!m.querySelector("button.btn-icon.tgico-download")){const e=document.createElement("button");e.className="btn-icon tgico-download tel-download",e.innerHTML=`<span class="tgico button-icon">${w}</span>`,e.setAttribute("type","button"),e.setAttribute("title","Download"),e.setAttribute("aria-label","Download"),n?e.onclick=n:e.onclick=()=>{f(o.querySelector("video").src)},m.prepend(e)}else if(!m.querySelector("button.btn-icon.tgico-download")){if(!o.querySelector("img.thumbnail")||!o.querySelector("img.thumbnail").src)return;const e=document.createElement("button");e.className="btn-icon tgico-download tel-download",e.innerHTML=`<span class="tgico button-icon">${w}</span>`,e.setAttribute("type","button"),e.setAttribute("title","Download"),e.setAttribute("aria-label","Download"),n?e.onclick=n:e.onclick=()=>{g(o.querySelector("img.thumbnail").src)},m.prepend(e)}},v),function(){const r=document.querySelector("body"),t=document.createElement("div");t.id="tel-downloader-progress-bar-container",t.style.position="fixed",t.style.bottom=0,t.style.right=0,location.pathname.startsWith("/k/")?t.style.zIndex=4:t.style.zIndex=1600,r.appendChild(t)}(),d.info("Completed script setup.")})();
