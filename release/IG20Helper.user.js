// ==UserScript==
// @name               IG Helper
// @namespace          https://github.snkms.com/
// @version            3.6.1
// @author             SN-Koarashi (5026)
// @match              https://*.instagram.com/*
// @grant              GM_info
// @grant              GM_addStyle
// @grant              GM_setValue
// @grant              GM_getValue
// @grant              GM_xmlhttpRequest
// @grant              GM_registerMenuCommand
// @grant              GM_unregisterMenuCommand
// @grant              GM_getResourceText
// @grant              GM_notification
// @grant              GM_openInTab
// @connect            i.instagram.com
// @connect            raw.githubusercontent.com
// @require            https://code.jquery.com/jquery-3.7.1.min.js#sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=
// @resource           INTERNAL_CSS https://raw.githubusercontent.com/SN-Koarashi/ig-helper/master/style.css
// @resource           LOCALE_MANIFEST https://raw.githubusercontent.com/SN-Koarashi/ig-helper/master/locale/manifest.json
// @supportURL         https://github.com/SN-Koarashi/ig-helper/
// @contributionURL    https://ko-fi.com/snkoarashi
// @icon               https://www.google.com/s2/favicons?domain=www.instagram.com&sz=32
// @compatible         firefox >= 100
// @compatible         chrome >= 100
// @compatible         edge >= 100
// @license            GPL-3.0-only
// @run-at             document-idle
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/IG20Helper.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/IG20Helper.meta.js
// ==/UserScript==
(function(e){"use strict";const _={CHECK_UPDATE:!0,AUTO_RENAME:!0,RENAME_PUBLISH_DATE:!0,DISABLE_VIDEO_LOOPING:!1,HTML5_VIDEO_CONTROL:!1,REDIRECT_CLICK_USER_STORY_PICTURE:!1,FORCE_FETCH_ALL_RESOURCES:!1,DIRECT_DOWNLOAD_VISIBLE_RESOURCE:!1,DIRECT_DOWNLOAD_ALL:!1,DIRECT_DOWNLOAD_STORY:!1,MODIFY_VIDEO_VOLUME:!1,MODIFY_RESOURCE_EXIF:!1,SCROLL_BUTTON:!0,FORCE_RESOURCE_VIA_MEDIA:!1,USE_BLOB_FETCH_WHEN_MEDIA_RATE_LIMIT:!1,NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST:!1,SKIP_VIEW_STORY_CONFIRM:!1},Ae=["RENAME_PUBLISH_DATE","USE_BLOB_FETCH_WHEN_MEDIA_RATE_LIMIT","NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST"],O={DOWNLOAD:'<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><g><rect fill="none" height="24" width="24"/></g><g><path d="M18,15v3H6v-3H4v3c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2v-3H18z M17,11l-1.41-1.41L13,12.17V4h-2v8.17L8.41,9.59L7,11l5,5 L17,11z"/></g></svg>',NEW_TAB:'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>',THUMBNAIL:'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4.86 8.86l-3 3.87L9 13.14 6 17h12l-3.86-5.14z"/></svg>',DOWNLOAD_ALL:'<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><g><rect fill="none" height="24" width="24"/></g><g><g><polygon points="18,6.41 16.59,5 12,9.58 7.41,5 6,6.41 12,12.41"/><polygon points="18,13 16.59,11.59 12,16.17 7.41,11.59 6,13 12,19"/></g></g></svg>',CLOSE:'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>',FULLSCREEN:'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>',TURN_DEG:'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#1f1f1f"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M7.34 6.41L.86 12.9l6.49 6.48 6.49-6.48-6.5-6.49zM3.69 12.9l3.66-3.66L11 12.9l-3.66 3.66-3.65-3.66zm15.67-6.26C17.61 4.88 15.3 4 13 4V.76L8.76 5 13 9.24V6c1.79 0 3.58.68 4.95 2.05 2.73 2.73 2.73 7.17 0 9.9C16.58 19.32 14.79 20 13 20c-.97 0-1.94-.21-2.84-.61l-1.49 1.49C10.02 21.62 11.51 22 13 22c2.3 0 4.61-.88 6.36-2.64 3.52-3.51 3.52-9.21 0-12.72z"/></svg>'},he=250,Re=GM_getResourceText("INTERNAL_CSS"),_e=JSON.parse(GM_getResourceText("LOCALE_MANIFEST"));var d={videoVolume:GM_getValue("G_VIDEO_VOLUME")?GM_getValue("G_VIDEO_VOLUME"):1,tempFetchRateLimit:!1,fileRenameFormat:GM_getValue("G_RENAME_FORMAT")?GM_getValue("G_RENAME_FORMAT"):"%USERNAME%-%SOURCE_TYPE%-%SHORTCODE%-%YEAR%%MONTH%%DAY%_%HOUR%%MINUTE%%SECOND%_%ORIGINAL_NAME_FIRST%",registerMenuIds:[],locale:{},lang:GM_getValue("lang")||navigator.language||navigator.userLanguage,currentURL:location.href,firstStarted:!1,pageLoaded:!1,GL_registerEventList:[],GL_logger:[],GL_referrer:null,GL_postPath:null,GL_username:null,GL_repeat:null,GL_dataCache:{stories:{},highlights:{}},GL_observer:new MutationObserver(function(){ae()})};He(),GM_addStyle(Re),q(),Ge(d.lang).then(n=>{d.locale[d.lang]=n,ce(),q(),le(300)}).catch(n=>{q(),le(300),d.lang.startsWith("en")||console.error("getTranslationText catch error:",n)}),h("Script Loaded",GM_info.script.name,"version:",GM_info.script.version);var ze=setInterval(function(){if(e("div#splash-screen").length>0&&!e("div#splash-screen").is(":hidden")||location.pathname.match(/^\/(explore(\/.*)?|challenge\/?.*|direct\/?.*|qr\/?|accounts\/.*|emails\/.*|language\/?.*?|your_activity\/?.*|settings\/help(\/.*)?$)$/ig)||!location.hostname.startsWith("www.")||(location.pathname.endsWith("/followers/")||location.pathname.endsWith("/following/"))&&e('body > div[class]:not([id^="mount"]) div div[role="dialog"]').length>0){d.pageLoaded=!1;return}if(d.currentURL!=location.href||!d.firstStarted||!d.pageLoaded){if(console.log("Main Timer","trigging"),clearInterval(d.GL_repeat),d.pageLoaded=!1,d.firstStarted=!0,d.currentURL=location.href,d.GL_observer.disconnect(),location.href.startsWith("https://www.instagram.com/p/")||location.pathname.match(/^\/(.*?)\/(p|reel)\//ig)||location.href.startsWith("https://www.instagram.com/reel/")){d.GL_dataCache.stories={},d.GL_dataCache.highlights={},h("isDialog");var n=setInterval(()=>{e(`body > div[class]:not([id^="mount"]) div div[role="dialog"] article,
                                section:visible > main > div > div > div > div > div > hr,
                                body > div[id^="mount"] section nav + div > article,
                                section:visible > main > div > div > article > div > div > div > div > div > header
                            `).length>0&&(clearInterval(n),setTimeout(()=>{ae(!1)},15))},100);d.pageLoaded=!0}if(location.href.startsWith("https://www.instagram.com/reels/")&&(h("isReels"),setTimeout(()=>{Z(!1)},150),d.pageLoaded=!0),location.href.split("?")[0]=="https://www.instagram.com/"){d.GL_dataCache.stories={},d.GL_dataCache.highlights={};let s=d.GL_referrer?.match(/^\/(stories|highlights)\//ig)!=null;h("isHomepage",s),setTimeout(()=>{ae(!1,s);const l=e('div[id^="mount"] > div > div div > section > main div:not([class]):not([style]) > div > article')?.parent()[0];l&&d.GL_observer.observe(l,{childList:!0})},150),d.pageLoaded=!0}e("header > *[class]:first-child img[alt]").length&&location.pathname.match(/^(\/)([0-9A-Za-z\.\-_]+)\/?(tagged|reels|saved)?\/?$/ig)&&!location.pathname.match(/^(\/explore\/?$|\/stories(\/.*)?$|\/p\/)/ig)&&(h("isProfile"),setTimeout(()=>{me(!1)},150),d.pageLoaded=!0),d.pageLoaded||(location.href.match(/^(https:\/\/www\.instagram\.com\/stories\/highlights\/)/ig)?(d.GL_dataCache.highlights={},h("isHighlightsStory"),J(!1),d.GL_repeat=setInterval(()=>{Q(!1)},he),e(".IG_DWHISTORY").length&&setTimeout(()=>{if(_.SKIP_VIEW_STORY_CONFIRM){var s=e('div[id^="mount"] section:last-child > div > div div[role="button"]').filter(function(){return e(this).children().length===0&&this.textContent.trim()!==""});s?.trigger("click")}d.pageLoaded=!0},150)):location.href.match(/^(https:\/\/www\.instagram\.com\/stories\/)/ig)?(h("isStory"),e('div[id^="mount"] section > div > a[href="/"]').length>0&&(e(".IG_DWSTORY").remove(),e(".IG_DWNEWTAB").remove(),e(".IG_DWSTORY_THUMBNAIL").length&&e(".IG_DWSTORY_THUMBNAIL").remove(),k(!1),setTimeout(()=>{k(!1)},150)),e(".IG_DWSTORY").length&&setTimeout(()=>{if(_.SKIP_VIEW_STORY_CONFIRM){var s=e('div[id^="mount"] section:last-child > div > div div[role="button"]').filter(function(){return e(this).children().length===0&&this.textContent.trim()!==""});s?.click()}d.pageLoaded=!0},150)):(d.pageLoaded=!1,e(".IG_DWSTORY").length&&e(".IG_DWSTORY").remove(),e(".IG_DWSTORY_ALL").length&&e(".IG_DWSTORY_ALL").remove(),e(".IG_DWNEWTAB").length&&e(".IG_DWNEWTAB").remove(),e(".IG_DWSTORY_THUMBNAIL").length&&e(".IG_DWSTORY_THUMBNAIL").remove(),e(".IG_DWHISTORY").length&&e(".IG_DWHISTORY").remove(),e(".IG_DWHISTORY_ALL").length&&e(".IG_DWHISTORY_ALL").remove(),e(".IG_DWHINEWTAB").length&&e(".IG_DWHINEWTAB").remove(),e(".IG_DWHISTORY_THUMBNAIL").length&&e(".IG_DWHISTORY_THUMBNAIL").remove())),le(300),d.GL_referrer=new URL(location.href).pathname}},he);async function be(){G(!0);let n=new Date().getTime(),s=Math.floor(n/1e3),l=location.href.replace(/\/$/ig,"").split("/").at(-1),i=await se(l),t=i.data.reels_media[0].owner.username;if(_.DIRECT_DOWNLOAD_STORY){let a=0;F(a,i.data.reels_media[0].items.length),i.data.reels_media[0].items.forEach((o,r)=>{setTimeout(()=>{_.RENAME_PUBLISH_DATE&&(s=o.taken_at_timestamp),o.display_resources.sort(function(c,p){return c.config_width<p.config_width?1:c.config_width>p.config_width?-1:0}),o.is_video?R(o.video_resources[0].src,t,"highlights",s,"mp4",o.id).then(()=>{F(++a,i.data.reels_media[0].items.length)}):R(o.display_resources[0].src,t,"highlights",s,"jpg",o.id).then(()=>{F(++a,i.data.reels_media[0].items.length)})},100*r)})}else C(!1,!0),Ie(i,"highlights")}async function J(n,s){var l=e('body > div section:visible a[href^="/"]').filter(function(){return e(this).attr("href").split("/").filter(i=>i.length>0).length===1}).first().attr("href").split("/").filter(i=>i.length>0).at(0);if(n){let i=new Date().getTime(),t=Math.floor(i/1e3),a=location.href.replace(/\/$/ig,"").split("/").at(-1),o=e("body > div section._ac0a header._ac0k > ._ac3r ._ac3n ._ac3p[style]").length||e("body > div section:visible > div > div:not([class]) > div > div div.x1ned7t2.x78zum5 div.x1caxmr6").length||e("body > div div:not([hidden]) section:visible > div div[style]:not([class]) > div").find("div div.x1ned7t2.x78zum5 div.x1caxmr6").length,r=0;if(G(!0),d.GL_dataCache.highlights[a]){h("Fetch from memory cache:",a);let c=d.GL_dataCache.highlights[a].data.reels_media[0].items.length;l=d.GL_dataCache.highlights[a].data.reels_media[0].owner.username,r=d.GL_dataCache.highlights[a].data.reels_media[0].items[c-o]}else{let c=await se(a),p=c.data.reels_media[0].items.length;l=c.data.reels_media[0].owner.username,r=c.data.reels_media[0].items[p-o],d.GL_dataCache.highlights[a]=c}if(h("onHighlightsStory",a,d.GL_dataCache.highlights[a]),_.RENAME_PUBLISH_DATE&&(t=r.taken_at_timestamp),_.FORCE_RESOURCE_VIA_MEDIA&&!d.tempFetchRateLimit){let c=await j(r.id);c.status==="ok"?c.items[0].video_versions?s?M(c.items[0].video_versions[0].url):R(c.items[0].video_versions[0].url,l,"highlights",t,"mp4",c.items[0].id):s?M(c.items[0].image_versions2.candidates[0].url):R(c.items[0].image_versions2.candidates[0].url,l,"highlights",t,"jpg",c.items[0].id):(_.USE_BLOB_FETCH_WHEN_MEDIA_RATE_LIMIT?(delete d.GL_dataCache.highlights[a],d.tempFetchRateLimit=!0,J(!0,s)):alert("Fetch failed from Media API. API response message: "+c.message),h(c))}else r.is_video?s?M(r.video_resources.at(-1).src,l):R(r.video_resources.at(-1).src,l,"highlights",t,"mp4",r.id):s?M(r.display_resources.at(-1).src,l):R(r.display_resources.at(-1).src,l,"highlights",t,"jpg",r.id),d.tempFetchRateLimit=!1;G(!1)}else if(!e(".IG_DWHISTORY").length){let i=null;if(e("body > div section._ac0a").length>0?i=e("body > div section:visible._ac0a"):(i=e("body > div section:visible > div > div[style]:not([class])"),i.css("position","relative")),i.length===0){let t=e("body > div div:not([hidden]) section:visible > div div[class][style] > div[style]:not([class])"),a=0;t.each(function(){e(this).width()>a&&(a=e(this).width(),i=e(this).children("div").first())})}if(i!=null){i.append(`<div data-ih-locale-title="DW" title="${f("DW")}" class="IG_DWHISTORY">${O.DOWNLOAD}</div>`),i.append(`<div data-ih-locale-title="NEW_TAB" title="${f("NEW_TAB")}" class="IG_DWHINEWTAB">${O.NEW_TAB}</div>`);let t=Y(l);t.length>1&&i.append(`<div data-ih-locale-title="DW_ALL" title="${f("DW_ALL")}" class="IG_DWHISTORY_ALL">${O.DOWNLOAD_ALL}</div>`);let a=t.parents("div[class]").find("time[datetime]")?.attr("title");a!=null&&t.parents("div[class]").find("time[datetime]").text(a),i.find("img[referrerpolicy]").each(function(){e(this).on("load",function(){e(this).data("remove-thumbnail")||(i.find(".IG_DWHISTORY_THUMBNAIL").length===0?(e(this).attr("data-remove-thumbnail",!0),e(".IG_DWHISTORY_THUMBNAIL").remove(),h("(highlight) Manually removing thumbnail button")):(e(this).attr("data-remove-thumbnail",!0),h("(highlight) Thumbnail button is not present for this picture")))})})}}}async function Q(n){if(n){let s=new Date().getTime(),l=Math.floor(s/1e3),i=location.href.replace(/\/$/ig,"").split("/").at(-1),t="",a=e("body > div section._ac0a header._ac0k > ._ac3r ._ac3n ._ac3p[style]").length||e("body > div section:visible > div > div:not([class]) > div > div div.x1ned7t2.x78zum5 div.x1caxmr6").length||e("body > div div:not([hidden]) section:visible > div div[style]:not([class]) > div").find("div div.x1ned7t2.x78zum5 div.x1caxmr6").length,o="";if(G(!0),d.GL_dataCache.highlights[i]){h("Fetch from memory cache:",i);let r=d.GL_dataCache.highlights[i].data.reels_media[0].items.length;t=d.GL_dataCache.highlights[i].data.reels_media[0].owner.username,o=d.GL_dataCache.highlights[i].data.reels_media[0].items[r-a]}else{let r=await se(i),c=r.data.reels_media[0].items.length;t=r.data.reels_media[0].owner.username,o=r.data.reels_media[0].items[c-a],d.GL_dataCache.highlights[i]=r}if(_.RENAME_PUBLISH_DATE&&(l=o.taken_at_timestamp),_.FORCE_RESOURCE_VIA_MEDIA&&!d.tempFetchRateLimit){let r=await j(o.id);r.status==="ok"?R(r.items[0].image_versions2.candidates[0].url,t,"highlights",l,"jpg",i):(_.USE_BLOB_FETCH_WHEN_MEDIA_RATE_LIMIT?(delete d.GL_dataCache.highlights[i],d.tempFetchRateLimit=!0,Q(!0)):alert("Fetch failed from Media API. API response message: "+r.message),h(r))}else R(o.display_resources.at(-1).src,t,"highlights",l,"jpg",i),d.tempFetchRateLimit=!1;G(!1)}else if(e("body > div section video.xh8yej3").length){if(!e(".IG_DWHISTORY_THUMBNAIL").length){let s=null;if(e("body > div section._ac0a").length>0?s=e("body > div section:visible._ac0a"):(s=e("body > div section:visible > div > div[style]:not([class])"),s.css("position","relative")),s.length===0){let l=e("body > div div:not([hidden]) section:visible > div div[class][style] > div[style]:not([class])"),i=0;l.each(function(){e(this).width()>i&&(i=e(this).width(),s=e(this).children("div").first())})}s?.append(`<div data-ih-locale-title="THUMBNAIL_INTRO" title="${f("THUMBNAIL_INTRO")}" class="IG_DWHISTORY_THUMBNAIL">${O.THUMBNAIL}</div>`)}}else e(".IG_DWHISTORY_THUMBNAIL").remove()}function ae(n,s){if(s===!0&&(h("hasReferrer","regenerated"),e('article[data-snig="canDownload"], div[data-snig="canDownload"]').filter(function(){return e(this).find(".IG_DW_MAIN").length===0}).removeAttr("data-snig")),n==!1){let t=0;var l=setInterval(()=>{(t>100||e('article[data-snig="canDownload"], section:visible > main > div > div[data-snig="canDownload"] > div > div > div > hr, div[id^="mount"] > div > div > div.x1n2onr6.x1vjfegm div[data-snig="canDownload"]').length>0)&&(clearInterval(l),t>100&&console.warn("onReadyMyDW() Timer","maximum number of repetitions reached, terminated")),h("onReadyMyDW() Timer","repeating to call detection createDownloadButton()"),ue(),t++},50)}else ue()}function fe(n){_.DISABLE_VIDEO_LOOPING&&n.find("video").each(function(){e(this).on("ended",function(){e(this).data("loop")||(e(this).attr("data-loop",!0),this.pause(),h("(post) Added video event listener #loop"))})}),_.MODIFY_VIDEO_VOLUME&&n.find("video").each(function(){e(this).on("play playing",function(){e(this).data("modify")||(e(this).attr("data-modify",!0),this.volume=d.videoVolume,h("(post) Added video event listener #modify"))})}),_.HTML5_VIDEO_CONTROL&&n.find("video").each(function(){if(!e(this).data("controls")){let i=e(this);h("(post) Added video html5 contorller #modify"),_.MODIFY_VIDEO_VOLUME&&(this.volume=d.videoVolume,e(this).on("loadstart",function(){this.volume=d.videoVolume})),e(this).on("contextmenu",function(t){t.preventDefault(),i.css("z-index","-1"),i.removeAttr("controls")}),e(this).parent().find("video + div > div").first().on("contextmenu",function(t){t.preventDefault(),i.css("z-index","2"),i.attr("controls",!0)}),e(this).on("volumechange",function(){let t=e(this).parent().find("video + div > div").find('button[type="button"], div[role="button"]').filter(function(o){return e(this).width()<=64&&e(this).height()<=64&&e(this).find('svg > path[d^="M16.636 7.028a1.5"], svg > path[d^="M1.5 13.3c-.8"]').length>0});var a=t.find('svg > path[d^="M16.636"]').length===0;this.muted!=a&&(this.volume=d.videoVolume,t?.trigger("click")),e(this).attr("data-completed")&&(d.videoVolume=this.volume,GM_setValue("G_VIDEO_VOLUME",this.volume)),this.volume==d.videoVolume&&e(this).attr("data-completed",!0)}),e(this).css("position","absolute"),e(this).css("z-index","2"),e(this).attr("data-controls",!0),e(this).attr("controls",!0)}});var s=n.find("video"),l=n.find("video + div > div").first();K(s,l,"post","bottom")}function ue(){e("article, section:visible > main > div > div > div > div > div > hr").map(function(n){return e(this).is("section:visible > main > div > div > div > div > div > hr")?e(this).parent().parent().parent().parent()[0]:this}).filter(function(){return e(this).height()>0&&e(this).width()>0}).each(function(n){if(!e(this).attr("data-snig")&&!e(this).hasClass("x1iyjqo2")&&!e(this).children("article")?.hasClass("x1iyjqo2")&&e(this).parents("div#scrollview").length===0){h("Found post container",e(this));const t=e(this),a=this.tagName,o="._acay ._acaz";var s;if(a==="DIV"&&n!=0)return;const r=t.children("div").children("div");if(r.length===0)return;if(h("Found insert point",r),t.find("._acay").length>0){t.find("._acay + .x24i39r").length>0&&t.find("._acay + .x24i39r").css("top","37px");const I=t.find("._acay").first().parent()[0];var l=new MutationObserver(function(){t.find("._acay + .x24i39r").css("top","37px")});l.observe(I,{childList:!0})}r.eq(a==="DIV"?0:r.length-2).append('<div class="button_wrapper">');const c=`<div data-ih-locale-title="DW" title="${f("DW")}" class="IG_DW_MAIN">${O.DOWNLOAD}</div>`,p=`<div data-ih-locale-title="NEW_TAB" title="${f("NEW_TAB")}" class="IG_NEWTAB_MAIN">${O.NEW_TAB}</div>`,m=`<div data-ih-locale-title="THUMBNAIL_INTRO" title="${f("THUMBNAIL_INTRO")}" class="IG_THUMBNAIL_MAIN">${O.THUMBNAIL}</div>`,u=`<div data-ih-locale-title="IMAGE_VIEWER" title="${f("IMAGE_VIEWER")}" class="IG_IMAGE_VIEWER">${O.FULLSCREEN}</div>`;if(r.find(".button_wrapper").append(c),t.find(o).length>1&&_.DIRECT_DOWNLOAD_VISIBLE_RESOURCE&&!_.DIRECT_DOWNLOAD_ALL){const I=`<div data-ih-locale-title="DW_ALL" title="${f("DW_ALL")}" class="IG_DW_ALL_MAIN">${O.DOWNLOAD_ALL}</div>`;r.find(".button_wrapper").append(I)}r.find(".button_wrapper").append(p),setTimeout(()=>{if(r.eq(a==="DIV"?0:r.length-2).find("div > ul li._acaz").length===0)r.find("video").length>0?r.find(".button_wrapper").append(m):(s=t.find("img").filter(function(){return e(this).width()>200&&e(this).height()>200}).attr("src"),r.find(".button_wrapper").append(u));else{const I=(E,T)=>{E.forEach(L=>{if(L.isIntersecting){var D=e(L.target);r.find(".IG_THUMBNAIL_MAIN")?.remove(),r.find(".IG_IMAGE_VIEWER")?.remove(),D.find("video").length>0?(r.find(".IG_THUMBNAIL_MAIN").length===0&&r.find(".button_wrapper").append(m),fe(t)):(s=D.find("img").attr("src"),r.find(".button_wrapper").append(u))}})},v=new IntersectionObserver(I,{root:t.find("div > ul._acay").first().parent().parent().parent()[0],rootMargin:"0px",threshold:.1}),P=new MutationObserver(function(E,T){var L=E.at(0)?.target;e(L).find("li._acaz").each(function(){v.observe(this)})});t.find("div > ul li._acaz").each(function(){v.observe(this)});const w=r.eq(a==="DIV"?0:r.length-2).find("div > ul li._acaz")?.parent()[0],b=r.eq(a==="DIV"?0:r.length-2).find("div > ul li._acaz")?.parent().parent()[0];w&&P.observe(w,{childList:!0}),b&&P.observe(b,{attributes:!0})}},50),r.css("position","relative"),fe(t),d.GL_registerEventList.push({element:this,trigger:[".IG_THUMBNAIL_MAIN",".IG_NEWTAB_MAIN",".IG_DW_ALL_MAIN",".IG_DW_MAIN",".IG_IMAGE_VIEWER"]}),e(this).on("click",".IG_IMAGE_VIEWER",function(){s!=null?ke(s):alert("Cannot find resource url.")}),e(this).on("click",".IG_THUMBNAIL_MAIN",function(){G(!0),d.GL_username=t.attr("data-username"),d.GL_postPath=location.pathname.replace(/\/$/,"").split("/").at(-1)||t.find('a[href^="/p/"]').first().attr("href").split("/").at(2)||e(this).parent().parent().parent().children("div:last-child").children("div").children("div:last-child").find('a[href^="/p/"]').last().attr("href").split("/").at(2);var I=ne(t);C(!0,!1),S(d.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY","").then(()=>{let v=setInterval(()=>{if(e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").length>0){clearInterval(v);var P=e('.IG_POPUP_DIG .IG_POPUP_DIG_BODY a[data-globalindex="'+(I+1)+'"]')?.parent().find(".videoThumbnail")?.first();P!=null&&P.length>0?P.trigger("click"):alert("Can not find thumbnail url."),G(!1),e(".IG_POPUP_DIG").remove()}},250)})}),e(this).on("click",".IG_NEWTAB_MAIN",function(){G(!0),d.GL_username=t.attr("data-username"),d.GL_postPath=location.pathname.replace(/\/$/,"").split("/").at(-1)||t.find('a[href^="/p/"]').first().attr("href").split("/").at(2)||e(this).parent().parent().parent().children("div:last-child").children("div").children("div:last-child").find('a[href^="/p/"]').last().attr("href").split("/").at(2);var I=ne(t);C(!0,!1),S(d.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY","").then(()=>{let v=setInterval(()=>{if(e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").length>0){clearInterval(v);var P=e('.IG_POPUP_DIG .IG_POPUP_DIG_BODY a[data-globalindex="'+(I+1)+'"]');if(_.FORCE_RESOURCE_VIA_MEDIA&&_.NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST)oe(P.first()[0],!0);else{let b=P?.attr("data-href");if(b){var w=new URL(b);w.host="scontent.cdninstagram.com",M(w.href)}else alert("Can not find open tab url.")}G(!1),e(".IG_POPUP_DIG").remove()}},250)})}),e(this).on("click",".IG_DW_ALL_MAIN",async function(){d.GL_username=t.attr("data-username"),d.GL_postPath=location.pathname.replace(/\/$/,"").split("/").at(-1)||t.find('a[href^="/p/"]').first().attr("href").split("/").at(2)||e(this).parent().parent().parent().children("div:last-child").children("div").children("div:last-child").find('a[href^="/p/"]').last().attr("href").split("/").at(2),C(_.DIRECT_DOWNLOAD_ALL,!0),e("#article-id").html(`<a href="https://www.instagram.com/p/${d.GL_postPath}">${d.GL_postPath}</a>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).wrap("<div></div>"),e(this).before('<label class="inner_box_wrapper"><input class="inner_box" type="checkbox"><span></span></label>'),e(this).after(`<div data-ih-locale-title="NEW_TAB" title="${f("NEW_TAB")}" class="newTab">${O.NEW_TAB}</div>`),e(this).attr("data-name")=="video"&&e(this).after(`<div data-ih-locale-title="THUMBNAIL_INTRO" title="${f("THUMBNAIL_INTRO")}" class="videoThumbnail">${O.THUMBNAIL}</div>`)}),S(d.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",f("LOAD_BLOB_MULTIPLE")).then(()=>{let I=setInterval(()=>{e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").length>0&&(clearInterval(I),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).trigger("click")}),e(".IG_POPUP_DIG").remove())},250)})}),e(this).on("click",".IG_DW_MAIN",async function(){if(d.GL_username=t.attr("data-username"),d.GL_postPath=location.pathname.replace(/\/$/,"").split("/").at(-1)||t.find('a[href^="/p/"]').first().attr("href").split("/").at(2)||e(this).parent().parent().parent().children("div:last-child").children("div").children("div:last-child").find('a[href^="/p/"]').last().attr("href").split("/").at(2),C(_.DIRECT_DOWNLOAD_ALL,!0),e("#article-id").html(`<a href="https://www.instagram.com/p/${d.GL_postPath}">${d.GL_postPath}</a>`),_.DIRECT_DOWNLOAD_VISIBLE_RESOURCE){G(!0),Ce(!0);var I=ne(e(this).parent().parent().parent());S(d.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY","").then(()=>{let E=setInterval(()=>{if(e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").length>0){clearInterval(E);var T=e('.IG_POPUP_DIG .IG_POPUP_DIG_BODY a[data-globalindex="'+(I+1)+'"]')?.attr("data-href");T?(G(!1),e('.IG_POPUP_DIG .IG_POPUP_DIG_BODY a[data-globalindex="'+(I+1)+'"]')?.trigger("click")):alert("Can not find download url."),e(".IG_POPUP_DIG").remove()}},250)});return}if(!_.DIRECT_DOWNLOAD_ALL){var v=0,P=e(this).parent().parent().find(o).length,w=_.FORCE_FETCH_ALL_RESOURCES,b=new Date(e(this).parent().parent().parent().find("a[href] time[datetime]").filter(function(){let E=e(this).parents("a[href]").attr("href");return E?.startsWith("/p/")||E?.match(/\/([\w.\-_]+)\/p\//ig)!=null}).first().attr("datetime")).getTime();if(P)e(this).parent().parent().find(o).each(function(){let E=e(this).parent().parent().parent().find("video");E&&E.attr("src")&&(w=!0)}),w||_.FORCE_RESOURCE_VIA_MEDIA?S(d.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",f("LOAD_BLOB_MULTIPLE")):(e(this).parent().parent().find(o).each(function(){v++;let E=e(this).find("video"),T=e(this).find("._aagv img"),L=T.attr("srcset")?T.attr("srcset").split(" ")[0]:T.attr("src");E&&E.attr("src")&&(w=!0),T&&L&&e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY").append(`<a datetime="${b}" data-needed="direct" data-path="${d.GL_postPath}" data-name="photo" data-type="jpg" data-globalIndex="${v}" href="javascript:;" data-href="${L}"><img width="100" src="${L}" /><br/>- <span data-ih-locale="IMG">${f("IMG")}</span> ${v} -</a>`)}),w&&S(d.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",f("LOAD_BLOB_RELOAD")));else if(_.FORCE_RESOURCE_VIA_MEDIA)S(d.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",f("LOAD_BLOB_MULTIPLE"));else{v++;let E=e(this).parent().parent().parent().find("video"),T=e(this).parent().parent().parent().find("._aagv img"),L=T.attr("srcset")?T.attr("srcset").split(" ")[0]:T.attr("src");E&&E.attr("src")&&S(d.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",f("LOAD_BLOB_ONE")),T&&L&&e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY").append(`<a datetime="${b}" data-needed="direct" data-path="${d.GL_postPath}" data-name="photo" data-type="jpg" data-globalIndex="${v}" href="javascript:;" href="" data-href="${L}"><img width="100" src="${L}" /><br/>- <span data-ih-locale="IMG">${f("IMG")}</span> ${v} -</a>`)}}e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).wrap("<div></div>"),e(this).before('<label class="inner_box_wrapper"><input class="inner_box" type="checkbox"><span></span></label>'),e(this).after(`<div data-ih-locale-title="NEW_TAB" title="${f("NEW_TAB")}" class="newTab">${O.NEW_TAB}</div>`),e(this).attr("data-name")=="video"&&e(this).after(`<div data-ih-locale-title="THUMBNAIL_INTRO" title="${f("THUMBNAIL_INTRO")}" class="videoThumbnail">${O.THUMBNAIL}</div>`)}),_.DIRECT_DOWNLOAD_ALL&&S(d.GL_postPath,".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY",f("LOAD_BLOB_MULTIPLE")).then(()=>{let E=setInterval(()=>{e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").length>0&&(clearInterval(E),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).trigger("click")}),e(".IG_POPUP_DIG").remove())},250)})});var i=e(this).find("header > div:last-child > div:first-child span a").first().text()||e(this).find('a[href^="/"]').filter(function(){return e(this)?.text()?.length>0}).first().text();e(this).attr("data-snig","canDownload"),e(this).attr("data-username",i)}})}function pe(n){var s=n.shortcode_media??n;return s.owner==null&&s.user!=null&&(s.owner=s.user),s.owner==null&&(h("carousel_media:","undefined username"),alert("carousel_media: undefined username")),s}async function S(n,s,l){try{e(`${s} a`).remove(),e(s).append('<p id="_SNLOAD">'+l+"</p>");let i=await ge(n),t=pe(i.data);if(i.type==="query_hash"){let a=1;if(t.__typename=="GraphVideo"&&t.video_url&&(e(s).append(`<a media-id="${t.id}" datetime="${t.taken_at_timestamp}" data-blob="true" data-needed="direct" data-path="${t.shortcode}" data-name="video" data-type="mp4" data-username="${t.owner.username}" data-globalIndex="${a}" href="javascript:;" data-href="${t.video_url}"><img width="100" src="${t.display_resources[1].src}" /><br/>- <span data-ih-locale="VID">${f("VID")}</span> ${a} -</a>`),a++),t.__typename=="GraphImage"&&(e(s).append(`<a media-id="${t.id}" datetime="${t.taken_at_timestamp}" data-blob="true" data-needed="direct" data-path="${t.shortcode}" data-name="photo" data-type="jpg" data-username="${t.owner.username}" data-globalIndex="${a}" href="javascript:;" data-href="${t.display_resources[t.display_resources.length-1].src}"><img width="100" src="${t.display_resources[1].src}" /><br/>- <span data-ih-locale="IMG">${f("IMG")}</span> ${a} -</a>`),a++),t.__typename=="GraphSidecar"&&t.edge_sidecar_to_children)for(let o of t.edge_sidecar_to_children.edges)o.node.__typename=="GraphVideo"&&e(s).append(`<a media-id="${o.node.id}" datetime="${t.taken_at_timestamp}" data-blob="true" data-needed="direct" data-path="${t.shortcode}" data-name="video" data-type="mp4" data-username="${t.owner.username}" data-globalIndex="${a}" href="javascript:;" data-href="${o.node.video_url}"><img width="100" src="${o.node.display_resources[1].src}" /><br/>- <span data-ih-locale-title="VID">${f("VID")}</span> ${a} -</a>`),o.node.__typename=="GraphImage"&&e(s).append(`<a media-id="${o.node.id}" datetime="${t.taken_at_timestamp}" data-blob="true" data-needed="direct" data-path="${t.shortcode}" data-name="photo" data-type="jpg" data-username="${t.owner.username}" data-globalIndex="${a}" href="javascript:;" data-href="${o.node.display_resources[o.node.display_resources.length-1].src}"><img width="100" src="${o.node.display_resources[1].src}" /><br/>- <span data-ih-locale="IMG">${f("IMG")}</span> ${a} -</a>`),a++}else if(t.carousel_media)h("carousel_media"),t.carousel_media.forEach((a,o)=>{let r=o+1;a.video_versions==null?(a.image_versions2.candidates.sort(function(c,p){let m=new URL(c.url).searchParams.get("stp"),u=new URL(p.url).searchParams.get("stp");if(m&&u){if(m.length>u.length)return 1;if(m.length<u.length)return-1}else{if(c.width<p.width)return 1;if(c.width>p.width)return-1}return 0}),e(s).append(`<a media-id="${a.pk}" datetime="${a.taken_at}" data-blob="true" data-needed="direct" data-path="${t.code}" data-name="photo" data-type="jpg" data-username="${t.owner.username}" data-globalIndex="${r}" href="javascript:;" data-href="${a.image_versions2.candidates[0].url}"><img width="100" src="${a.image_versions2.candidates[0].url}" /><br/>- <span data-ih-locale="IMG">${f("IMG")}</span> ${r} -</a>`)):e(s).append(`<a media-id="${a.pk}" datetime="${a.taken_at}" data-blob="true" data-needed="direct" data-path="${t.code}" data-name="video" data-type="mp4" data-username="${t.owner.username}" data-globalIndex="${r}" href="javascript:;" data-href="${a.video_versions[0].url}"><img width="100" src="${a.image_versions2.candidates[0].url}" /><br/>- <span data-ih-locale="VID">${f("VID")}</span> ${r} -</a>`)});else{let a=1;t.video_versions==null?(t.image_versions2.candidates.sort(function(o,r){let c=new URL(o.url).searchParams.get("stp"),p=new URL(r.url).searchParams.get("stp");if(c&&p){if(c.length>p.length)return 1;if(c.length<p.length)return-1}else{if(o.width<r.width)return 1;if(o.width>r.width)return-1}return 0}),e(s).append(`<a media-id="${t.pk}" datetime="${t.taken_at}" data-blob="true" data-needed="direct" data-path="${t.code}" data-name="photo" data-type="jpg" data-username="${t.owner.username}" data-globalIndex="${a}" href="javascript:;" data-href="${t.image_versions2.candidates[0].url}"><img width="100" src="${t.image_versions2.candidates[0].url}" /><br/>- <span data-ih-locale="IMG">${f("IMG")}</span> ${a} -</a>`)):e(s).append(`<a media-id="${t.pk}" datetime="${t.taken_at}" data-blob="true" data-needed="direct" data-path="${t.code}" data-name="video" data-type="mp4" data-username="${t.owner.username}" data-globalIndex="${a}" href="javascript:;" data-href="${t.video_versions[0].url}"><img width="100" src="${t.image_versions2.candidates[0].url}" /><br/>- <span data-ih-locale="VID">${f("VID")}</span> ${a} -</a>`)}e("#_SNLOAD").remove(),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).wrap("<div></div>"),e(this).before('<label class="inner_box_wrapper"><input class="inner_box" type="checkbox"><span></span></label>'),e(this).after(`<div data-ih-locale-title="NEW_TAB" title="${f("NEW_TAB")}" class="newTab">${O.NEW_TAB}</div>`),e(this).attr("data-name")=="video"&&e(this).after(`<div data-ih-locale-title="THUMBNAIL_INTRO" title="${f("THUMBNAIL_INTRO")}" class="videoThumbnail">${O.THUMBNAIL}</div>`)})}catch(i){h("createMediaListDOM",i)}}function ne(n){var s=0,l=n.find(".x1iyjqo2 > div > div:last-child > div");return(l==null||!l.hasClass("_acnb"))&&(l=n.find("._aatk > div > div:last-child").eq(0).children("div")),l.filter("._acnb").each(function(i){e(this).hasClass("_acnf")&&(s=i)}),s}async function me(n){if(n){G(!0);let s=new Date().getTime(),l=Math.floor(s/1e3),i=location.pathname.replaceAll(/(reels|tagged)\/$/ig,"").split("/").filter(a=>a.length>0).at(-1),t=await V(i);try{let a=await Me(t.user.pk);R(a,i,"avatar",l,"jpg")}catch{R(t.user.profile_pic_url,i,"avatar",l,"jpg")}G(!1)}else if(!e(".IG_DWPROFILE").length){let s=setInterval(()=>{if(e(".IG_DWPROFILE").length){clearInterval(s);return}e("header > *[class]:first-child img[alt][draggable]").parent().parent().append(`<div data-ih-locale-title="DW" title="${f("DW")}" class="IG_DWPROFILE">${O.DOWNLOAD}</div>`),e("header > *[class]:first-child img[alt][draggable]").parent().parent().css("position","relative"),e("header > *[class]:first-child img[alt]:not([draggable])").parent().parent().parent().append(`<div data-ih-locale-title="DW" title="${f("DW")}" class="IG_DWPROFILE">${O.DOWNLOAD}</div>`),e("header > *[class]:first-child img[alt]:not([draggable])").parent().parent().parent().css("position","relative")},150)}}async function Z(n,s,l){if(n){G(!0);let t=location.href.split("?").at(0).split("instagram.com/reels/").at(-1).replaceAll("/",""),a=await ge(t),o=pe(a.data),r=new Date().getTime();_.RENAME_PUBLISH_DATE&&(a.type==="query_hash"?r=o.shortcode_media.taken_at_timestamp:r=o.taken_at),a.type==="query_hash"?s&&o.shortcode_media.is_video?l?M(o.shortcode_media.video_url):R(o.shortcode_media.video_url,o.shortcode_media.owner.username,"reels",r,"mp4",t):l?M(o.shortcode_media.display_resources.at(-1).src):R(o.shortcode_media.display_resources.at(-1).src,o.shortcode_media.owner.username,"reels",r,"jpg",t):s&&o.video_versions!=null?l?M(o.video_versions[0].url):R(o.video_versions[0].url,o.owner.username,"reels",r,"mp4",t):l?M(o.image_versions2.candidates[0].url):R(o.image_versions2.candidates[0].url,o.owner.username,"reels",r,"jpg",t),G(!1)}else var i=setInterval(()=>{e('section > main[role="main"] > div div.x1qjc9v5 video').length>0&&(clearInterval(i),_.SCROLL_BUTTON&&(e("#scrollWrapper").remove(),e('section > main[role="main"]').append('<section id="scrollWrapper"></section>'),e('section > main[role="main"] > #scrollWrapper').append('<div class="button-up"><div></div></div>'),e('section > main[role="main"] > #scrollWrapper').append('<div class="button-down"><div></div></div>'),e('section > main[role="main"] > #scrollWrapper > .button-up').on("click",function(){e('section > main[role="main"] > div')[0].scrollBy({top:-30,behavior:"smooth"})}),e('section > main[role="main"] > #scrollWrapper > .button-down').on("click",function(){e('section > main[role="main"] > div')[0].scrollBy({top:30,behavior:"smooth"})})),e('section > main[role="main"] > div[tabindex], section > main[role="main"] > div[class]').children("div").each(function(){if(e(this).children().length>0&&!e(this).children().find(".IG_REELS").length){var t=e(this);e(this).children().css("position","relative"),e(this).children().append(`<div data-ih-locale-title="DW" title="${f("DW")}" class="IG_REELS">${O.DOWNLOAD}</div>`),e(this).children().append(`<div data-ih-locale-title="NEW_TAB" title="${f("NEW_TAB")}" class="IG_REELS_NEWTAB">${O.NEW_TAB}</div>`),e(this).children().append(`<div data-ih-locale-title="THUMBNAIL_INTRO" title="${f("THUMBNAIL_INTRO")}" class="IG_REELS_THUMBNAIL">${O.THUMBNAIL}</div>`),_.DISABLE_VIDEO_LOOPING&&e(this).find("video").each(function(){e(this).on("ended",function(){if(!e(this).data("loop")){let r=e(this).next().find('div[role="presentation"] > div svg > path[d^="M5.888"]').parents('button[role="button"], div[role="button"]');r.length>0?(e(this).attr("data-loop",!0),r.trigger("click"),h("Adding video event listener #loop, then paused click()")):(e(this).attr("data-loop",!0),e(this).parent().find(".xpgaw4o").removeAttr("style"),this.pause(),h("Adding video event listener #loop, then paused pause()"))}})}),_.HTML5_VIDEO_CONTROL&&e(this).find("video").each(function(){if(!e(this).data("controls")){let r=e(this);h("(reel) Added video html5 contorller #modify"),_.MODIFY_VIDEO_VOLUME&&(this.volume=d.videoVolume,e(this).on("loadstart",function(){this.volume=d.videoVolume})),e(this).on("contextmenu",function(c){c.preventDefault(),r.css("z-index","-1"),r.removeAttr("controls")}),e(this).parent().find('video + div div[role="button"]').filter(function(){return e(this).parent('div[role="presentation"]').length>0&&e(this).css("cursor")==="pointer"&&e(this).attr("style")!=null}).first().on("contextmenu",function(c){c.preventDefault(),r.css("z-index","2"),r.attr("controls",!0)}),e(this).on("volumechange",function(){let c=e(this).parent().find("video + div > div").find('button[type="button"], div[role="button"]').filter(function(m){return e(this).width()<=64&&e(this).height()<=64&&e(this).find('svg > path[d^="M16.636 7.028a1.5"], svg > path[d^="M1.5 13.3c-.8"]').length>0});var p=c.find('svg > path[d^="M16.636"]').length===0;this.muted!=p&&(this.volume=d.videoVolume,c?.trigger("click")),e(this).attr("data-completed")&&(d.videoVolume=this.volume,GM_setValue("G_VIDEO_VOLUME",this.volume)),this.volume==d.videoVolume&&e(this).attr("data-completed",!0)}),e(this).css("position","absolute"),e(this).css("z-index","2"),e(this).attr("data-controls",!0),e(this).attr("controls",!0)}});var a=t.find("video"),o=e(this).find('div[role="presentation"] > div[role="button"] > div').first();K(a,o,"reel")}}))},250)}async function Ie(n,s){try{e(".IG_POPUP_DIG #post_info").text(`${s} ID: ${n.data.reels_media[0].id}`);const l=".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY";n.data.reels_media[0].items.forEach((i,t)=>{let a=new Date().getTime(),o=Math.floor(a/1e3),r=n.data.reels_media[0]?.user?.username||n.data.reels_media[0]?.owner?.username;_.RENAME_PUBLISH_DATE&&(o=i.taken_at_timestamp),i.display_resources.sort(function(c,p){return c.config_width<p.config_width?1:c.config_width>p.config_width?-1:0}),i.is_video?e(l).append(`<a media-id="${i.id}" datetime="${o}" data-blob="true" data-needed="direct" data-name="${s}" data-type="mp4" data-username="${r}" data-path="${i.id}" data-globalIndex="${t+1}" href="javascript:;" data-href="${i.video_resources[0].src}"><img width="100" src="${i.display_resources[0].src}" /><br/>- <span data-ih-locale-title="VID">${f("VID")}</span> ${t} -</a>`):e(l).append(`<a media-id="${i.id}" datetime="${o}" data-blob="true" data-needed="direct" data-name="${s}" data-type="jpg" data-username="${r}" data-path="${i.id}" data-globalIndex="${t+1}" href="javascript:;" data-href="${i.display_resources[0].src}"><img width="100" src="${i.display_resources[0].src}" /><br/>- <span data-ih-locale-title="IMG">${f("IMG")}</span> ${t} -</a>`)}),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_BODY a").each(function(){e(this).wrap("<div></div>"),e(this).before('<label class="inner_box_wrapper"><input class="inner_box" type="checkbox"><span></span></label>'),e(this).after(`<div data-ih-locale-title="NEW_TAB" title="${f("NEW_TAB")}" class="newTab">${O.NEW_TAB}</div>`),e(this).attr("data-type")=="mp4"&&e(this).after(`<div data-ih-locale-title="THUMBNAIL_INTRO" title="${f("THUMBNAIL_INTRO")}" class="videoThumbnail">${O.THUMBNAIL}</div>`)}),G(!1)}catch(l){console.error("createStoryListDOM()",l)}}async function we(){G(!0);let n=new Date().getTime(),s=Math.floor(n/1e3),l=e("body > div section._ac0a header._ac0k ._ac0l a + div a").first().text()||location.pathname.split("/").filter(o=>o.length>0).at(1),t=(await V(l)).user.pk,a=await z(t);if(_.DIRECT_DOWNLOAD_STORY){let o=0;F(o,a.data.reels_media[0].items.length),a.data.reels_media[0].items.forEach((r,c)=>{setTimeout(()=>{_.RENAME_PUBLISH_DATE&&(s=r.taken_at_timestamp),r.display_resources.sort(function(p,m){return p.config_width<m.config_width?1:p.config_width>m.config_width?-1:0}),r.is_video?R(r.video_resources[0].src,l,"stories",s,"mp4",r.id).then(()=>{F(++o,a.data.reels_media[0].items.length)}):R(r.display_resources[0].src,l,"stories",s,"jpg",r.id).then(()=>{F(++o,a.data.reels_media[0].items.length)})},100*c)})}else C(!1,!0),Ie(a,"stories")}async function k(n,s,l){var i=e("body > div section._ac0a header._ac0k ._ac0l a + div a").first().text()||location.pathname.split("/").filter(t=>t.length>0).at(1);if(n){let t=new Date().getTime(),a=Math.floor(t/1e3);if(G(!0),_.FORCE_RESOURCE_VIA_MEDIA&&!d.tempFetchRateLimit){let o=null,c=(await V(i)).user.pk,p=await z(c),m=location.pathname.split("/").filter(g=>g.length>0&&g.match(/^([0-9]{10,})$/)).at(-1);p.data.reels_media[0].items.forEach(g=>{g.id==m&&(o=g.id)}),o==null&&Y(i).each(function(I){e(this).children().length>0&&(o=p.data.reels_media[0].items[I].id)}),o==null&&(e("body > div section:visible div.x1ned7t2.x78zum5 > div").each(function(g){e(this).hasClass("x1lix1fw")&&e(this).children().length>0&&(o=p.data.reels_media[0].items[g].id)}),e("body > div section:visible ._ac0k > ._ac3r > div").each(function(g){e(this).children().hasClass("_ac3q")&&(o=p.data.reels_media[0].items[g].id)})),o==null&&(o=location.pathname.split("/").filter(g=>g.length>0&&g.match(/^([0-9]{10,})$/)).at(-1));let u=await j(o);_.RENAME_PUBLISH_DATE&&(a=u.items[0].taken_at),u.status==="ok"?u.items[0].video_versions?l?M(u.items[0].video_versions[0].url):R(u.items[0].video_versions[0].url,i,"stories",a,"mp4",o):l?M(u.items[0].image_versions2.candidates[0].url):R(u.items[0].image_versions2.candidates[0].url,i,"stories",a,"jpg",o):(_.USE_BLOB_FETCH_WHEN_MEDIA_RATE_LIMIT?(d.tempFetchRateLimit=!0,k(n,s,l)):alert("Fetch failed from Media API. API response message: "+u.message),h(u)),G(!1);return}if(e("body > div section:visible video[playsinline]").length>0){let o="mp4",r="",c=location.pathname.replace(/\/$/ig,"").split("/").at(-1),p=null;if(d.GL_dataCache.stories[i]&&!s){if(h("Fetch from memory cache:",i),d.GL_dataCache.stories[i].data.reels_media[0].items.forEach(m=>{m.id==c&&(r=m.video_resources[0].src,_.RENAME_PUBLISH_DATE&&(a=m.taken_at_timestamp,p=m.id))}),r.length==0){h("Memory cache not found, try fetch from API:",i),k(!0,!0);return}}else{let u=(await V(i)).user.pk,g=await z(u);g.data.reels_media[0].items.forEach(I=>{I.id==c&&(r=I.video_resources[0].src,_.RENAME_PUBLISH_DATE&&(a=I.taken_at_timestamp,p=I.id))}),r.length==0&&(Y(i).each(function(v){e(this).children().length>0&&(r=g.data.reels_media[0].items[v].video_resources[0].src,_.RENAME_PUBLISH_DATE&&(a=g.data.reels_media[0].items[v].taken_at_timestamp,p=g.data.reels_media[0].items[v].id))}),r.length==0&&(e("body > div section:visible div.x1ned7t2.x78zum5 > div").each(function(v){e(this).hasClass("x1lix1fw")&&e(this).children().length>0&&(r=g.data.reels_media[0].items[v].video_resources[0].src,_.RENAME_PUBLISH_DATE&&(a=g.data.reels_media[0].items[v].taken_at_timestamp,p=g.data.reels_media[0].items[v].id))}),e("body > div section:visible ._ac0k > ._ac3r > div").each(function(v){e(this).children().hasClass("_ac3q")&&(r=g.data.reels_media[0].items[v].video_resources[0].src,_.RENAME_PUBLISH_DATE&&(a=g.data.reels_media[0].items[v].taken_at_timestamp,p=g.data.reels_media[0].items[v].id))}))),d.GL_dataCache.stories[i]=g}r.length==0?alert(f("NO_VID_URL")):l?M(r):R(r,i,"stories",a,o,p)}else{let o=e("body > div section:visible img[referrerpolicy][class], body > div section:visible img[crossorigin][class]:not([alt])").attr("srcset")?.split(",")[0]?.split(" ")[0],r=o||e("body > div section:visible img[referrerpolicy][class], body > div section:visible img[crossorigin][class]:not([alt])").filter(function(){return e(this).parents("a").length===0&&e(this).width()===e(this).parent().width()}).attr("src");if(!r){let m=e("body > div section:visible img._aa63");r=m.attr("srcset")?m.attr("srcset")?.split(",")[0]?.split(" ")[0]:m.attr("src")}_.RENAME_PUBLISH_DATE&&(a=new Date(e("body > div section:visible time[datetime][class]").first().attr("datetime")).getTime());let c=r;l?M(c):R(c,i,"stories",a,"jpg",Se(c)??"")}d.tempFetchRateLimit=!1,G(!1)}else if(!e(".IG_DWSTORY").length){d.GL_dataCache.stories={};let t=null;if(e("body > div section._ac0a").length>0?t=e("body > div section:visible._ac0a"):(t=e("body > div section:visible > div > div[style]:not([class])"),t.css("position","relative")),t.length===0&&(t=e('div[id^="mount"] section > div > a[href="/"]').parent().parent().parent().find("section:visible > div > div[style]:not([class])"),t.css("position","relative")),t.length===0&&(t=e('div[id^="mount"] section > div > a[href="/"]').parent().parent().parent().find('section:visible > div div[style]:not([class]) > div:not([data-visualcompletion="loading-state"])'),t.css("position","relative")),t.length===0){let a=e("body > div div:not([hidden]) section:visible > div div[class][style] > div[style]:not([class])"),o=0;a.each(function(){e(this).width()>o&&(o=e(this).width(),t=e(this).children("div").first())})}t!=null&&(t.first().css("position","relative"),t.first().append(`<div data-ih-locale-title="DW" title="${f("DW")}" class="IG_DWSTORY">${O.DOWNLOAD}</div>`),t.first().append(`<div data-ih-locale-title="NEW_TAB" title="${f("NEW_TAB")}" class="IG_DWNEWTAB">${O.NEW_TAB}</div>`),Y(i).length>1&&t.first().append(`<div data-ih-locale-title="DW_ALL" title="${f("DW_ALL")}" class="IG_DWSTORY_ALL">${O.DOWNLOAD_ALL}</div>`),t.find("img[referrerpolicy]").each(function(){e(this).on("load",function(){e(this).data("remove-thumbnail")||(t.find(".IG_DWSTORY_THUMBNAIL").length===0?(e(this).attr("data-remove-thumbnail",!0),e(".IG_DWSTORY_THUMBNAIL").remove(),h("(story) Manually removing thumbnail button")):(e(this).attr("data-remove-thumbnail",!0),h("(story) Thumbnail button is not present for this picture")))})}))}}async function $(n,s){if(n){let l=new Date().getTime(),i=Math.floor(l/1e3),t="jpg",a=e("body > div section._ac0a header._ac0k ._ac0l a + div a").first().text()||location.pathname.split("/").at(2),o=location.pathname.replace(/\/$/ig,"").split("/").at(-1),r="",c=null;if(G(!0),_.FORCE_RESOURCE_VIA_MEDIA&&!d.tempFetchRateLimit){let m=(await V(a)).user.pk,u=await z(m),g=location.pathname.split("/").filter(v=>v.length>0&&v.match(/^([0-9]{10,})$/)).at(-1);u.data.reels_media[0].items.forEach(v=>{v.id==g&&(c=v.id)}),c==null&&Y(a).each(function(P){e(this).children().length>0&&(c=u.data.reels_media[0].items[P].id)}),c==null&&(e("body > div section:visible div.x1ned7t2.x78zum5 > div").each(function(v){e(this).hasClass("x1lix1fw")&&e(this).children().length>0&&(c=u.data.reels_media[0].items[v].id)}),e("body > div section:visible ._ac0k > ._ac3r > div").each(function(v){e(this).children().hasClass("_ac3q")&&(c=u.data.reels_media[0].items[v].id)})),c==null&&(c=location.pathname.split("/").filter(v=>v.length>0&&v.match(/^([0-9]{10,})$/)).at(-1));let I=await j(c);_.RENAME_PUBLISH_DATE&&(i=I.items[0].taken_at),I.status==="ok"?R(I.items[0].image_versions2.candidates[0].url,a,"stories",i,"jpg",c):(_.USE_BLOB_FETCH_WHEN_MEDIA_RATE_LIMIT?(d.tempFetchRateLimit=!0,$(!0,s)):alert("Fetch failed from Media API. API response message: "+I.message),h(I)),G(!1);return}if(d.GL_dataCache.stories[a]&&!s){if(h("Fetch from memory cache:",a),d.GL_dataCache.stories[a].data.reels_media[0].items.forEach(p=>{p.id==o&&(r=p.display_url,_.RENAME_PUBLISH_DATE&&(i=p.taken_at_timestamp,c=p.id))}),r.length==0){h("Memory cache not found, try fetch from API:",a),$(!0,!0);return}}else{let m=(await V(a)).user.pk,u=await z(m);u.data.reels_media[0].items.forEach(g=>{g.id==o&&(r=g.display_url,_.RENAME_PUBLISH_DATE&&(i=g.taken_at_timestamp,c=g.id))}),r.length==0&&(Y(a).each(function(I){e(this).children().length>0&&(r=u.data.reels_media[0].items[I].display_url,_.RENAME_PUBLISH_DATE&&(i=u.data.reels_media[0].items[I].taken_at_timestamp,c=u.data.reels_media[0].items[I].id))}),r.length==0&&(e("body > div section:visible div.x1ned7t2.x78zum5 > div").each(function(I){e(this).hasClass("x1lix1fw")&&e(this).children().length>0&&(r=u.data.reels_media[0].items[I].display_url,_.RENAME_PUBLISH_DATE&&(i=u.data.reels_media[0].items[I].taken_at_timestamp,c=u.data.reels_media[0].items[I].id))}),e("body > div section:visible ._ac0k > ._ac3r > div").each(function(I){e(this).children().hasClass("_ac3q")&&(r=u.data.reels_media[0].items[I].display_url,_.RENAME_PUBLISH_DATE&&(i=u.data.reels_media[0].items[I].taken_at_timestamp,c=u.data.reels_media[0].items[I].id))})))}R(r,a,"thumbnail",i,t,c),d.tempFetchRateLimit=!1,G(!1)}else if(e("body > div div.IG_DWSTORY").parent().find("video[class]").length){let l=null;if(e("body > div section._ac0a").length>0?l=e("body > div section:visible._ac0a"):(l=e("body > div section:visible > div > div[style]:not([class])"),l.css("position","relative")),l.length===0&&(l=e('div[id^="mount"] section > div > a[href="/"]').parent().parent().parent().find("section:visible > div > div[style]:not([class])"),l.css("position","relative")),l.length===0&&(l=e('div[id^="mount"] section > div > a[href="/"]').parent().parent().parent().find('section:visible > div div[style]:not([class]) > div:not([data-visualcompletion="loading-state"])'),l.css("position","relative")),l.length===0){let i=e("body > div div:not([hidden]) section:visible > div div[class][style] > div[style]:not([class])"),t=0;i.each(function(){e(this).width()>t&&(t=e(this).width(),l=e(this).children("div").first())})}l!=null&&(l.first().css("position","relative"),l.first().append(`<div data-ih-locale-title="THUMBNAIL_INTRO" title="${f("THUMBNAIL_INTRO")}" class="IG_DWSTORY_THUMBNAIL">${O.THUMBNAIL}</div>`))}}function se(n){return new Promise((s,l)=>{let i=`https://www.instagram.com/graphql/query/?query_hash=45246d3fe16ccc6577e0bd297a5db1ab&variables=%7B%22highlight_reel_ids%22:%5B%22${n}%22%5D,%22precomposed_overlay%22:false%7D`;GM_xmlhttpRequest({method:"GET",url:i,onload:function(t){try{let a=JSON.parse(t.response);s(a)}catch(a){h("getHighlightStories()","reject",a.message),l(a)}},onerror:function(t){h("getHighlightStories()","reject",t),l(t)}})})}function z(n){return new Promise((s,l)=>{let i=`https://www.instagram.com/graphql/query/?query_hash=15463e8449a83d3d60b06be7e90627c7&variables=%7B%22reel_ids%22:%5B%22${n}%22%5D,%22precomposed_overlay%22:false%7D`;GM_xmlhttpRequest({method:"GET",url:i,onload:function(t){try{let a=JSON.parse(t.response);h("getStories()",a),s(a)}catch(a){h("getStories()","reject",a.message),l(a)}},onerror:function(t){h("getStories()","reject",t),l(t)}})})}function V(n){return new Promise((s,l)=>{let i=`https://www.instagram.com/web/search/topsearch/?query=${n}`;GM_xmlhttpRequest({method:"GET",url:i,onload:function(t){let a=JSON.parse(t.response),o=null;a.users.forEach(r=>{r.user.username?.toLowerCase()===n?.toLowerCase()&&(o=r)}),o!=null?(h("getUserId()",o),s(o)):Ue(n).then(r=>{s(r)}).catch(r=>{alert("Can not find user info from getUserId()")})},onerror:function(t){h("getUserId()","reject",t),l(t)}})})}function Ue(n){return new Promise((s,l)=>{let i=`https://i.instagram.com/api/v1/users/web_profile_info/?username=${n}`;GM_xmlhttpRequest({method:"GET",url:i,headers:{"X-IG-App-ID":ee()},onload:function(t){try{let a=JSON.parse(t.response);if(a?.data?.user!=null){let r=a?.data;r.user.pk=r.user.id,h("getUserIdWithAgent()",a),s(r)}else h("getUserIdWithAgent()","reject","undefined"),l("undefined")}catch(a){h("getUserIdWithAgent()","reject",a.message),l(a)}},onerror:function(t){h("getUserIdWithAgent()","reject",t),l(t)}})})}function Me(n){return new Promise((s,l)=>{let i=`https://i.instagram.com/api/v1/users/${n}/info/`;GM_xmlhttpRequest({method:"GET",url:i,headers:{"User-Agent":"Mozilla/5.0 (Linux; Android 10; Pixel 7 XL)Build/RP1A.20845.002; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0 Chrome/117.0.5938.60 Mobile Safari/537.36 Instagram 307.0.0.34.111"},onload:function(t){try{let a=JSON.parse(t.response);a.status!=="ok"?(h("getUserHighSizeProfile()","reject",a),l("faild")):(h("getUserHighSizeProfile()",a),s(a.user.hd_profile_pic_url_info?.url))}catch(a){h("getUserHighSizeProfile()","reject",a),l(a)}},onerror:function(t){h("getUserHighSizeProfile()","reject",t),l(t)}})})}function ye(n){return new Promise((s,l)=>{n||l("NOPATH");let t=`https://www.instagram.com/graphql/query/?query_hash=2c4c2e343a8f64c625ba02b2aa12c7f8&variables=%7B%22shortcode%22:%22${n}%22}`;GM_xmlhttpRequest({method:"GET",url:t,onload:function(a){try{let o=JSON.parse(a.response);h("getPostOwner()",o),s(o.data.shortcode_media.owner.username)}catch(o){h("getPostOwner()","reject",o.message),l(o)}},onerror:function(a){h("getPostOwner()","reject",a),l(a)}})})}function ge(n){return new Promise((s,l)=>{n||l("NOPATH");let i=n,t=`https://www.instagram.com/graphql/query/?query_hash=2c4c2e343a8f64c625ba02b2aa12c7f8&variables=%7B%22shortcode%22:%22${i}%22}`;GM_xmlhttpRequest({method:"GET",url:t,headers:{"User-Agent":"Mozilla/5.0 (Linux; Android 10; Pixel 7 XL)Build/RP1A.20845.002; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0 Chrome/117.0.5938.60 Mobile Safari/537.36 Instagram 307.0.0.34.111"},onload:function(a){try{let o=JSON.parse(a.response);h(o),o.status==="fail"?(h("Request with:","getBlobMediaWithQuery()",i),Ne(i).then(r=>{s({type:"query_id",data:r.xdt_api__v1__media__shortcode__web_info.items[0]})}).catch(r=>{l(r)})):s({type:"query_hash",data:o.data})}catch(o){h("getBlobMedia()","reject",o.message),l(o)}},onerror:function(a){h("getBlobMedia()","reject",a),l(a)}})})}function Ne(n){return new Promise((s,l)=>{n||l("NOPATH");let t=`https://www.instagram.com/graphql/query/?query_id=9496392173716084&variables={%22shortcode%22:%22${n}%22,%22__relay_internal__pv__PolarisFeedShareMenurelayprovider%22:true,%22__relay_internal__pv__PolarisIsLoggedInrelayprovider%22:true}`;GM_xmlhttpRequest({method:"GET",url:t,headers:{"User-Agent":"Mozilla/5.0 (Linux; Android 10; Pixel 7 XL)Build/RP1A.20845.002; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0 Chrome/117.0.5938.60 Mobile Safari/537.36 Instagram 307.0.0.34.111","X-IG-App-ID":ee()},onload:function(a){try{let o=JSON.parse(a.response);h(o),o.status==="fail"?(alert(`getBlobMediaWithQueryID(): Request failed with API response:
${o.message}: ${o.feedback_message}`),h(`Request failed with API response ${o.message}: ${o.feedback_message}`),l(a)):(h("getBlobMediaWithQueryID()",o.data),s(o.data))}catch(o){h("getBlobMediaWithQueryID()","reject",o.message),l(o)}},onerror:function(a){h("getBlobMediaWithQueryID()","reject",a),l(a)}})})}function j(n){return new Promise((s,l)=>{let i=`https://i.instagram.com/api/v1/media/${n}/info/`;if(n==null){alert("Can not call Media API because of the media id is invalid."),h("getMediaInfo()","reject","Can not call Media API because of the media id is invalid."),G(!1),l(-1);return}if(ee()==null){alert("Can not call Media API because of the app id is invalid."),h("getMediaInfo()","reject","Can not call Media API because of the app id is invalid."),G(!1),l(-1);return}GM_xmlhttpRequest({method:"GET",url:i,headers:{"User-Agent":window.navigator.userAgent,Accept:"*/*","X-IG-App-ID":ee()},onload:function(t){if(t.finalUrl==i){let a=JSON.parse(t.response);h("getMediaInfo()",a),s(a)}else new URL(t.finalUrl).pathname.startsWith("/accounts/login")?(h("getMediaInfo()","reject","The account must be logged in to access Media API."),alert("The account must be logged in to access Media API.")):(h("getMediaInfo()","reject",'Unable to retrieve content because the API was redirected to "'+t.finalUrl+'"'),alert('Unable to retrieve content because the API was redirected to "'+t.finalUrl+'"')),G(!1),l(-1)},onerror:function(t){h("getMediaInfo()","reject",t),s(t)}})})}function Se(n){let l=new URL(n)?.searchParams?.get("ig_cache_key")?.split(".").at(0);return l?atob(l):null}function ee(){let n=null;return e('script[type="application/json"]').each(function(){const s=/"APP_ID":"([0-9]+)"/ig;e(this).text().match(s)!=null&&n==null&&(n=[...e(this).text().matchAll(s)])}),n?n.at(0).at(-1):null}function G(n){n?(e('div[id^="mount"] > div > div > div:first').removeClass("x1s85apg"),e('div[id^="mount"] > div > div > div:first').css("z-index","20000")):(e('div[id^="mount"] > div > div > div:first').addClass("x1s85apg"),e('div[id^="mount"] > div > div > div:first').css("z-index",""))}function Y(n){let s=e('body > div section:visible a[href^="/'+n+'"] span').filter(function(){return e(this).children().length===0&&e(this).find("svg").length===0&&e(this).text()?.toLowerCase()===n?.toLowerCase()}).parents("div:not([class]):not([style])").filter(function(){return e(this).text()?.toLowerCase()!==n?.toLowerCase()}).filter(function(){return e(this).children().length>1}).first();return s.length===0&&(s=e('body > div section:visible a[href^="/'+n+'"]').filter(function(){return e(this).find("img").length>0}).parents("div:not([class]):not([style])").filter(function(){return e(this).text()?.toLowerCase()!==n?.toLowerCase()}).filter(function(){return e(this).children().length>1}).first()),s.children().filter(function(){return e(this).height()<10}).first().children()}function F(n,s){e(".circle_wrapper").length?(e(".circle_wrapper span").text(`${n}/${s}`),n>=s&&e(".circle_wrapper").fadeOut(250,function(){e(this).remove()})):e("body").append(`<div class="circle_wrapper"><circle></circle><span>${n}/${s}</span></div>`)}function C(n,s){let l=n?"hidden":"";e("body").append('<div class="IG_POPUP_DIG '+l+'"><div class="IG_POPUP_DIG_BG"></div><div class="IG_POPUP_DIG_MAIN"><div class="IG_POPUP_DIG_TITLE"></div><div class="IG_POPUP_DIG_BODY"></div></div></div>'),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_TITLE").append(`<div style="position:relative;min-height:36px;text-align:center;margin-bottom: 7px;"><div style="position:absolute;left:0px;line-height: 18px;"><kbd>Alt</kbd>+<kbd>Q</kbd> [<span data-ih-locale="CLOSE">${f("CLOSE")}</span>]</div><div style="line-height: 18px;">IG Helper v${GM_info.script.version}</div><div id="post_info" style="line-height: 14px;font-size:14px;">Post ID: <span id="article-id"></span></div><div class="IG_POPUP_DIG_BTN">${O.CLOSE}</div></div>`),s&&(e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_TITLE").append('<div style="text-align: center;" id="button_group"></div>'),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_TITLE > div#button_group").append(`<button id="batch_download_selected" data-ih-locale="BATCH_DOWNLOAD_SELECTED">${f("BATCH_DOWNLOAD_SELECTED")}</button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_TITLE > div#button_group").append(`<button id="batch_download_direct" data-ih-locale="BATCH_DOWNLOAD_DIRECT">${f("BATCH_DOWNLOAD_DIRECT")}</button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_MAIN .IG_POPUP_DIG_TITLE").append(`<label class="checkbox"><input value="yes" type="checkbox" /><span data-ih-locale="ALL_CHECK">${f("ALL_CHECK")}</span></label>`))}function Ce(n){e(".IG_POPUP_DIG").length&&(n?e(".IG_POPUP_DIG").addClass("hidden"):e(".IG_POPUP_DIG").removeClass("hidden"))}function R(n,s,l,i,t,a){return new Promise(o=>{setTimeout(()=>{G(!0),fetch(n).then(r=>r.blob().then(c=>{G(!1),Be(n,c,s,l,i,t,a),o(!0)}))},50)})}function re(n,s){const l=document.createElement("a");l.href=URL.createObjectURL(n),l.download=s,l.click(),l.remove()}function Be(n,s,l,i,t,a,o){t=parseInt(t.toString().padEnd(13,"0")),_.RENAME_PUBLISH_DATE&&(t=parseInt(t.toString().padEnd(13,"0")));const r=new Date(t),c=new URL(n).pathname.split("/").at(-1).split(".").slice(0,-1).join("."),p=r.getFullYear().toString(),m=(r.getMonth()+1).toString().padStart(2,"0"),u=r.getDate().toString().padStart(2,"0"),g=r.getHours().toString().padStart(2,"0"),I=r.getMinutes().toString().padStart(2,"0"),v=r.getSeconds().toString().padStart(2,"0");var P=d.fileRenameFormat.toUpperCase(),w=o??"",b={"%USERNAME%":l,"%SOURCE_TYPE%":i,"%SHORTCODE%":w,"%YEAR%":p,"%2-YEAR%":p.substr(-2),"%MONTH%":m,"%DAY%":u,"%HOUR%":g,"%MINUTE%":I,"%SECOND%":v,"%ORIGINAL_NAME%":c,"%ORIGINAL_NAME_FIRST%":c.split("_").at(0)};P=P.replace(/%[\w\-]+%/g,function(L){return b[L]||L});const E=l+"_"+c+"."+a,T=_.AUTO_RENAME?P+"."+a:E;_.MODIFY_RESOURCE_EXIF&&a==="jpg"&&o&&i==="photo"&&(s.type==="image/jpeg"||s.type==="image/webp")?xe(s,o).then(L=>re(L,T)).catch(L=>{console.error("Failed to strip EXIF and/or attach post URL to EXIF.",L),re(s,T)}):re(s,T)}async function xe(n,s){const l=(...A)=>{const U=A.reduce((W,B)=>W+B.length,0),N=new Uint8Array(U);let y=0;for(const W of A)N.set(W,y),y+=W.length;return N},i=A=>{const U=new Uint8Array(4);return new DataView(U.buffer).setUint32(0,A,!0),U},t=A=>new TextEncoder().encode(A),a=(A,U)=>String.fromCharCode(A.getUint8(U),A.getUint8(U+1),A.getUint8(U+2),A.getUint8(U+3)),o=new Uint8Array(await n.slice(0,12).arrayBuffer()),r=o[0]===255&&o[1]===216,c=o.length>=12&&String.fromCharCode(...o.subarray(0,4))==="RIFF"&&String.fromCharCode(...o.subarray(8,12))==="WEBP";if(!r&&!c)throw new Error("Not a JPEG or WEBP");const p=t(`https://www.instagram.com/p/${s}/\0`),m=t("Exif\0\0"),u=Uint8Array.from([73,73,42,0,8,0,0,0]),g=Uint8Array.from([1,0]),I=l(Uint8Array.from([14,1,2,0]),i(p.length),i(26)),v=l(u,g,I,i(0),p);if(r){const A=await n.arrayBuffer(),U=new DataView(A),N=l(m,v),y=new Uint8Array(4);new DataView(y.buffer).setUint16(0,65505),new DataView(y.buffer).setUint16(2,N.length+2);const W=l(y,N),B=[new Uint8Array(A,0,2)];let x=2,Ye=!1;for(;x<U.byteLength;){const H=U.getUint16(x);if((H&65280)!==65280)break;if(H===65498){Ye||B.push(W),B.push(new Uint8Array(A,x));break}const X=U.getUint16(x+2)+2;if(H===65505){x+=X;continue}B.push(new Uint8Array(A,x,X)),x+=X}const Fe=B.reduce((H,X)=>H+X.length,0),Te=new Uint8Array(Fe);let Le=0;return B.forEach(H=>{Te.set(H,Le),Le+=H.length}),new Blob([Te],{type:"image/jpeg"})}const P=await n.arrayBuffer(),w=new DataView(P),b=[];let E=-1,T=12;for(;T<w.byteLength;){const A=a(w,T),U=w.getUint32(T+4,!0),N=U&1,y=8+U+N;A!=="EXIF"&&A!=="XMP "&&(b.push(new Uint8Array(P,T,y)),A==="VP8X"&&(E=b.length-1)),T+=y}let L=l(t("EXIF"),i(m.length+v.length),m,v);if(L.length&1&&(L=l(L,Uint8Array.of(0))),E!==-1){const A=new Uint8Array(b[E]);A[8]|=16,b[E]=A,b.splice(E+1,0,L)}else b.push(L);const D=b.reduce((A,U)=>A+U.length,0),te=l(t("RIFF"),i(D+4),t("WEBP")),ie=l(te,...b);return new Blob([ie],{type:"image/webp"})}async function oe(n,s){let l=new Date().getTime(),i=Math.floor(l/1e3),t=e(n).attr("data-username")?e(n).attr("data-username"):d.GL_username;if(!t&&e(n).attr("data-path")&&(h("catching owner name from shortcode:",e(n).attr("data-href")),t=await ye(e(n).attr("data-path")).catch(o=>{h("get username failed, replace with default string, error message:",o.message)}),t==null&&(t="NONE")),_.RENAME_PUBLISH_DATE&&e(n).attr("datetime")&&(i=parseInt(e(n).attr("datetime"))),_.FORCE_RESOURCE_VIA_MEDIA){G(!0);let o=await j(e(n).attr("media-id"));if(G(!1),o.status==="ok"){var a=null;if(o.items[0].video_versions)a=o.items[0].video_versions[0].url;else{o.items[0].image_versions2.candidates.sort(function(p,m){let u=new URL(p.url).searchParams.get("stp"),g=new URL(m.url).searchParams.get("stp");if(u&&g){if(u.length>g.length)return 1;if(u.length<g.length)return-1}else{if(p.width<m.width)return 1;if(p.width>m.width)return-1}return 0}),a=o.items[0].image_versions2.candidates[0].url;const c=function(p){if(p.width!=null)return p.width;const u=new URL(p.url).searchParams.get("stp");return u!=null?parseInt(u.match(/_p([0-9]+)x([0-9]+)_/i)?.at(1)||-1):0}(o.items[0].image_versions2.candidates[0]);o.items[0].original_width}if(s){let r=new URL(a);r.host="scontent.cdninstagram.com",M(r.href)}else R(a,t,e(n).attr("data-name"),i,e(n).attr("data-type"),e(n).attr("data-path"))}else{if(_.USE_BLOB_FETCH_WHEN_MEDIA_RATE_LIMIT)if(s){let r=new URL(e(n).attr("data-href"));r.host="scontent.cdninstagram.com",M(r.href)}else R(e(n).attr("data-href"),t,e(n).attr("data-name"),i,e(n).attr("data-type"),e(n).attr("data-path"));else alert("Fetch failed from Media API. API response message: "+o.message);h(o)}}else R(e(n).attr("data-href"),t,e(n).attr("data-name"),i,e(n).attr("data-type"),e(n).attr("data-path"))}function q(){for(let n of d.registerMenuIds)h("GM_unregisterMenuCommand",n),GM_unregisterMenuCommand(n);d.registerMenuIds.push(GM_registerMenuCommand(f("SETTING"),()=>{De()},{accessKey:"w"})),d.registerMenuIds.push(GM_registerMenuCommand(f("DONATE"),()=>{GM_openInTab("https://ko-fi.com/snkoarashi",{active:!0})},{accessKey:"d"})),d.registerMenuIds.push(GM_registerMenuCommand(f("DEBUG"),()=>{Oe()},{accessKey:"z"})),d.registerMenuIds.push(GM_registerMenuCommand(f("FEEDBACK"),()=>{We()},{accessKey:"f"})),d.registerMenuIds.push(GM_registerMenuCommand(f("CHECK_UPDATE_MENU"),()=>{ve()},{accessKey:"c"})),d.registerMenuIds.push(GM_registerMenuCommand(f("RELOAD_SCRIPT"),()=>{Pe()},{accessKey:"r"}))}function le(n){if(!_.CHECK_UPDATE)return;const s=GM_getValue("G_CHECK_TIMESTAMP")??new Date().getTime();new Date().getTime()>parseInt(s)+n*1e3&&(GM_setValue("G_CHECK_TIMESTAMP",new Date().getTime()),ve())}function ve(){const n=GM_info.script.version;GM_xmlhttpRequest({method:"GET",url:"https://raw.githubusercontent.com/SN-Koarashi/ig-helper/refs/heads/master/main.js",onload:function(l){const t=l.responseText.match(/\/\/\s+@version\s+([0-9.\-a-zA-Z]+)/i);if(t&&t[1]){const a=t[1];h("Current version: ",n,"|","Remote version: ",a),a!==n?GM_notification({text:f("NOTICE_UPDATE_CONTENT"),title:f("NOTICE_UPDATE_TITLE"),tag:"ig_helper_notice",highlight:!0,timeout:5e3,zombieTimeout:5e3,image:"https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Instagram_icon.png/64px-Instagram_icon.png",onclick:o=>{o?.preventDefault();var r=GM_openInTab(GM_info.script.downloadURL);setTimeout(()=>{r.close()},250)}}):h("there is no new update")}else console.error("Could not find version in the remote script.")}})}function De(){e(".IG_POPUP_DIG").remove(),C(),e(".IG_POPUP_DIG #post_info").text("Preference Settings"),e(".IG_POPUP_DIG .IG_POPUP_DIG_TITLE > div").append('<select id="langSelect"></select><div style="font-size: 12px;">Some texts are machine-translated and may be inaccurate; translation contributions are welcome on GitHub.</div>');for(let n in _e)e(".IG_POPUP_DIG .IG_POPUP_DIG_TITLE > div #langSelect").append(`<option value="${n}" ${d.lang==n?"selected":""}>${_e[n]}</option>`);for(let n in _)e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY").append(`<label class="globalSettings${Ae.includes(n)?" child":""}" title="${f(n+"_INTRO")}" data-ih-locale-title="${n+"_INTRO"}"><span data-ih-locale="${n}">${f(n)}</span> <input id="${n}" value="box" type="checkbox" ${_[n]===!0?"checked":""}><div class="chbtn"><div class="rounds"></div></div></label>`),n==="MODIFY_VIDEO_VOLUME"&&e('.IG_POPUP_DIG .IG_POPUP_DIG_BODY input[id="'+n+'"]').parent("label").on("contextmenu",function(s){s.preventDefault(),e(this).find("#tempWrapper").length===0&&(e(this).append('<div id="tempWrapper"></div>'),e(this).children("#tempWrapper").append('<input value="'+d.videoVolume+'" type="range" min="0" max="1" step="0.05" />'),e(this).children("#tempWrapper").append('<input value="'+d.videoVolume+'" step="0.05" type="number" />'),e(this).children("#tempWrapper").append(`<div class="IG_POPUP_DIG_BTN">${O.CLOSE}</div>`))}),n==="AUTO_RENAME"&&e('.IG_POPUP_DIG .IG_POPUP_DIG_BODY input[id="'+n+'"]').parent("label").on("contextmenu",function(s){s.preventDefault(),e(this).find("#tempWrapper").length===0&&(e(this).append('<div id="tempWrapper"></div>'),e(this).children("#tempWrapper").append('<input id="date_format" value="'+d.fileRenameFormat+'" />'),e(this).children("#tempWrapper").append(`<div class="IG_POPUP_DIG_BTN">${O.CLOSE}</div>`))})}function Oe(){e(".IG_POPUP_DIG").remove(),C(),e(".IG_POPUP_DIG #post_info").text("IG Debug DOM Tree"),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY").append('<textarea style="font-family: monospace;width:100%;box-sizing: border-box;height:300px;background: transparent;" readonly></textarea>'),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY").append('<span style="display:block;text-align:center;">'),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_DISPLAY_DOM_TREE"><a>${f("SHOW_DOM_TREE")}</a></button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_SELECT_DOM_TREE"><a>${f("SELECT_AND_COPY")}</a></button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_DOWNLOAD_DOM_TREE"><a>${f("DOWNLOAD_DOM_TREE")}</a></button><br/>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_REPORT_GITHUB"><a href="https://github.com/SN-Koarashi/ig-helper/issues" target="_blank">${f("REPORT_GITHUB")}</a></button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_REPORT_DISCORD"><a href="https://discord.gg/q3KT4hdq8x" target="_blank">${f("REPORT_DISCORD")}</a></button>`)}function We(){e(".IG_POPUP_DIG").remove(),C(),e(".IG_POPUP_DIG #post_info").text("Feedback Options"),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY").append('<span style="display:block;text-align:center;">'),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_REPORT_FORK"><a href="https://greasyfork.org/en/scripts/404535-ig-helper/feedback" target="_blank">${f("REPORT_FORK")}</a></button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_REPORT_GITHUB"><a href="https://github.com/SN-Koarashi/ig-helper/issues" target="_blank">${f("REPORT_GITHUB")}</a></button>`),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY span").append(`<button style="margin: 3px;" class="IG_REPORT_DISCORD"><a href="https://discord.gg/q3KT4hdq8x" target="_blank">${f("REPORT_DISCORD")}</a></button>`)}function M(n){var s=document.createElement("a");s.href=n,s.target="_blank",document.body.appendChild(s),s.click(),s.remove()}function Pe(){clearInterval(d.GL_repeat),d.GL_registerEventList.forEach(n=>{n.trigger.forEach(s=>{e(n.element).off("click",s)})}),d.GL_registerEventList=[],e(".button_wrapper").remove(),e(".IG_DWPROFILE, .IG_DWPROFILE, .IG_DWSTORY, .IG_DWSTORY_ALL, .IG_DWSTORY_THUMBNAIL, .IG_DWNEWTAB, .IG_DWHISTORY, .IG_DWHISTORY_ALL, .IG_DWHINEWTAB, .IG_DWHISTORY_THUMBNAIL, .IG_REELS, .IG_REELS_NEWTAB, .IG_REELS_THUMBNAIL").remove(),e("[data-snig]").removeAttr("data-snig"),d.pageLoaded=!1,d.firstStarted=!1,d.currentURL=location.href,d.GL_observer.disconnect(),h("main timer re-register completed")}function h(...n){var s=new Date;d.GL_logger.push({time:s.getTime(),content:[...n]}),d.GL_logger.length>1e3&&(d.GL_logger=[{time:s.getTime(),content:["logger sliced"]},...d.GL_logger.slice(-999)]),console.log(`[${s.toISOString()}]`,...n)}function He(){for(let n in _)GM_getValue(n)!=null&&typeof GM_getValue(n)=="boolean"&&(_[n]=GM_getValue(n),n==="MODIFY_VIDEO_VOLUME"&&GM_getValue(n)!==!0&&(d.videoVolume=1))}function K(n,s,l,i=""){s.find("div.volume_slider").length===0?(s.append(`<div class="volume_slider ${i}" />`),s.find("div.volume_slider").append(`<div><input type="range" max="1" min="0" step="0.05" value="${d.videoVolume}" /></div>`),s.find("div.volume_slider input").attr("style",`--ig-track-progress: ${d.videoVolume*100+"%"}`),s.find("div.volume_slider input").on("input",function(){var t=e(this).val()*100+"%";d.videoVolume=e(this).val(),GM_setValue("G_VIDEO_VOLUME",e(this).val()),e(this).attr("style",`--ig-track-progress: ${t}`),n.each(function(){h(`(${l})`,"video volume changed #slider"),this.volume=d.videoVolume})}),s.find("div.volume_slider input").on("mouseenter",function(){var t=d.videoVolume*100+"%";e(this).attr("style",`--ig-track-progress: ${t}`),e(this).val(d.videoVolume),n.each(function(){h(`(${l})`,"video volume changed #slider"),this.volume=d.videoVolume})}),s.find("div.volume_slider").on("click",function(t){t.stopPropagation(),t.preventDefault()})):s.find("div.volume_slider").remove()}var Ee=null;function ke(n){de(),e("body").append(`<div id="imageViewer">
    	<div id="iv_header">
    		<div style="flex:1;">Image Viewer</div>
    		<div style="display: flex;filter: invert(1);gap: 8px;margin-right: 8px;">
                <div id="rotate_left" style="cursor: pointer;">${O.TURN_DEG}</div>
                <div id="rotate_right" style="transform: scaleX(-1);cursor: pointer;">${O.TURN_DEG}</div>
            </div>
    		<div id="iv_close">${O.CLOSE}</div>
    	</div>
        <section>
            <div id="iv_transform">
                <div id="iv_rotate">
                    <img id="iv_image" src="" />
                </div>
            </div>
        </section>
    </div>`);const s=e("#imageViewer"),l=e("#imageViewer > section"),i=e("#iv_transform"),t=e("#iv_rotate"),a=e("#iv_header"),o=e("#iv_close"),r=e("#iv_image"),c=e("#rotate_left"),p=e("#rotate_right");r.attr("src",n),s.css("display","flex"),i.css("transform-origin","0 0"),i.css("transition","transform 0.15s ease"),t.css("transform-origin","center"),t.css("transition","transform 0.15s ease"),i.css("will-change","transform"),t.css("will-change","transform");let m=0,u=1,g=0,I=0,v=!1,P=!1,w,b;var E={x:0,y:0};Ee=setInterval(()=>{const D={x:g,y:I};D.x!==E.x||D.y!==E.y?P=!0:P=!1,E=D},100),r.on("load",()=>{g=0,I=0,T()}),r.on("dragstart drop",D=>{D.preventDefault()}),r.on("click",D=>{D.preventDefault(),D.stopPropagation(),P||(u<=1?L(D,Math.min(Math.max(1,u+1.25),5)):(u=1,g=0,I=0),T())}),l.on("wheel",D=>{D.preventDefault(),L(D)}),s.on("wheel",D=>{D.preventDefault()}),r.on("mousedown",D=>{u!=1&&(v=!0,w=D.pageX-g,b=D.pageY-I,r.css("cursor","grabbing"))}),r.on("mouseup",()=>{u!=1&&(v=!1,r.css("cursor","grab"))}),c.on("click",function(){m-=90,T()}),p.on("click",function(){m+=90,T()}),e(document).on("mousemove.igHelper",D=>{v&&(D.preventDefault(),g=D.pageX-w,I=D.pageY-b,T())}),s.on("click",()=>{de()}),o.on("click",()=>{de()}),a.on("click",D=>{D.preventDefault(),D.stopPropagation()});function T(){i.css("transition",P?"none":"transform 0.15s ease"),i.css("transform",`translate(${g}px, ${I}px) scale(${u})`),t.css("transform",`rotate(${m}deg)`),u==1?r.css("cursor","zoom-in"):r.css("cursor","grabbing")}function L(D,te){D.preventDefault();let ie=u;if(te==null){let B=.1,x=D.originalEvent.deltaY<0?1:-1;u=Math.min(5,Math.max(1,u+x*B*u))}else u=te;let A=l[0].getBoundingClientRect(),U=D.clientX-A.left,N=D.clientY-A.top,y=(U-g)/ie,W=(N-I)/ie;g=-y*u+U,I=-W*u+N,T()}}function de(){clearInterval(Ee),e("#imageViewer").remove(),e(document).off("mousemove.igHelper")}function Ve(){var n={"en-US":{NOTICE_UPDATE_TITLE:"Wololo! New version released.",NOTICE_UPDATE_CONTENT:"IG-Helper has released a new version, click here to update.",CHECK_UPDATE:"Checking for Script Updates",CHECK_UPDATE_MENU:"Checking for Updates",CHECK_UPDATE_INTRO:`Check for updates when the script is triggered (check every 300 seconds).
Update notifications will be sent as desktop notifications through the browser.`,RELOAD_SCRIPT:"Reload Script",DONATE:"Donate",FEEDBACK:"Feedback",IMAGE_VIEWER:"Open Image In Viewer",NEW_TAB:"Open in New Tab",SHOW_DOM_TREE:"Show DOM Tree",SELECT_AND_COPY:"Select All and Copy from the Input Box",DOWNLOAD_DOM_TREE:"Download DOM Tree as a Text File",REPORT_GITHUB:"Report an Issue on GitHub",REPORT_DISCORD:"Report an Issue on Discord Support Server",REPORT_FORK:"Report an Issue on Greasy Fork",DEBUG:"Debug Window",CLOSE:"Close",ALL_CHECK:"Select All",BATCH_DOWNLOAD_SELECTED:"Download Selected Resources",BATCH_DOWNLOAD_DIRECT:"Download All Resources",IMG:"Image",VID:"Video",DW:"Download",DW_ALL:"Download All Resources",THUMBNAIL_INTRO:"Download Video Thumbnail",LOAD_BLOB_ONE:"Loading Blob Media...",LOAD_BLOB_MULTIPLE:"Loading Blob Media and Others...",LOAD_BLOB_RELOAD:"Detecting Blob Media, reloading...",NO_CHECK_RESOURCE:"You need to select a resource to download.",NO_VID_URL:"Cannot find video URL.",SETTING:"Settings",AUTO_RENAME:"Automatically Rename Files (Right-Click to Set)",RENAME_SHORTCODE:"Rename the File and Include Shortcode",RENAME_PUBLISH_DATE:"Set Renamed File Timestamp to Resource Publish Date",RENAME_LOCATE_DATE:"Modify Renamed File Timestamp Date Format (Right-Click to Set)",DISABLE_VIDEO_LOOPING:"Disable Video Auto-looping",HTML5_VIDEO_CONTROL:"Display HTML5 Video Controller",REDIRECT_CLICK_USER_STORY_PICTURE:"Redirect When Clicking on User's Story Picture",FORCE_FETCH_ALL_RESOURCES:"Force Fetch All Resources in the Post",DIRECT_DOWNLOAD_VISIBLE_RESOURCE:"Directly Download the Visible Resources in the Post",DIRECT_DOWNLOAD_ALL:"Directly Download All Resources in the Post",MODIFY_VIDEO_VOLUME:"Modify Video Volume (Right-Click to Set)",MODIFY_RESOURCE_EXIF:"Modify Resource EXIF \u200B\u200BProperties",SCROLL_BUTTON:"Enable Scroll Buttons for Reels Page",FORCE_RESOURCE_VIA_MEDIA:"Force Fetch Resource via Media API",USE_BLOB_FETCH_WHEN_MEDIA_RATE_LIMIT:"Use Alternative Methods to Download When the Media API is Not Accessible",NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST:"Always Use Media API for 'Open in New Tab' in Posts",AUTO_RENAME_INTRO:`Auto rename file to custom format:
Custom Format List: 
%USERNAME% - Username
%SOURCE_TYPE% - Download Source
%SHORTCODE% - Post Shortcode
%YEAR% - Year when downloaded/published
%2-YEAR% - Year (last two digits) when downloaded/published
%MONTH% - Month when downloaded/published
%DAY% - Day when downloaded/published
%HOUR% - Hour when downloaded/published
%MINUTE% - Minute when downloaded/published
%SECOND% - Second when downloaded/published
%ORIGINAL_NAME% - Original name of downloaded file
%ORIGINAL_NAME_FIRST% - Original name of downloaded file (first part of name)

If set to false, the file name will remain unchanged.
Example: instagram_321565527_679025940443063_4318007696887450953_n.jpg`,RENAME_SHORTCODE_INTRO:`Auto rename file to the following format:
USERNAME-TYPE-SHORTCODE-TIMESTAMP.FILETYPE
Example: instagram-photo-CwkxyiVynpW-1670350000.jpg

This will ONLY work if [Automatically Rename Files] is set to TRUE.`,RENAME_PUBLISH_DATE_INTRO:`Sets the timestamp in the file rename format to the resource publish date (browser time zone).

This feature only works when [Automatically Rename Files] is set to TRUE.`,RENAME_LOCATE_DATE_INTRO:`Modify the renamed file timestamp date format to the browser's local time, and format it to your preferred regional date format.

This feature only works when [Automatically Rename Files] is set to TRUE.`,DISABLE_VIDEO_LOOPING_INTRO:"Disable video auto-looping in Reels and posts.",HTML5_VIDEO_CONTROL_INTRO:`Display the HTML5 video controller in video resource.

This will hide the custom video volume slider and replace it with the HTML5 controller. The HTML5 controller can be hidden by right-clicking on the video to reveal the original details.`,REDIRECT_CLICK_USER_STORY_PICTURE_INTRO:`Redirect to a user's profile page when right-clicking on their avatar in the story area on the homepage.
If you use the middle mouse button to click, it will open in a new tab.`,FORCE_FETCH_ALL_RESOURCES_INTRO:"Force fetching of all resources (photos and videos) in a post via the Instagram API to remove the limit of three resources per post.",DIRECT_DOWNLOAD_VISIBLE_RESOURCE_INTRO:"Directly download the current resources available in the post.",DIRECT_DOWNLOAD_ALL_INTRO:"When you click the download button, all resources in the post will be forcibly fetched and downloaded.",MODIFY_VIDEO_VOLUME_INTRO:"Modify the video playback volume in Reels and posts (right-click to open the volume setting slider).",SCROLL_BUTTON_INTRO:"Enable scroll buttons for the lower right corner of the Reels page.",FORCE_RESOURCE_VIA_MEDIA_INTRO:"The Media API will try to get the highest quality photo or video possible, but it may take longer to load.",USE_BLOB_FETCH_WHEN_MEDIA_RATE_LIMIT_INTRO:"When the Media API reaches its rate limit or cannot be used for other reasons, the Forced Fetch API will be used to download resources (the resource quality may be slightly lower).",NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST_INTRO:"The [Open in New Tab] button in posts will always use the Media API to obtain high-resolution resources.",SKIP_VIEW_STORY_CONFIRM:"Skip the Confirmation Page for Viewing a Story/Highlight",SKIP_VIEW_STORY_CONFIRM_INTRO:"Automatically skip when confirmation page is shown in story or highlight.",MODIFY_RESOURCE_EXIF_INTRO:"Modify the EXIF \u200B\u200Bproperties of the image resource to place the post link in it.",DIRECT_DOWNLOAD_STORY:"Directly Download All Resources in the Story/Highlight",DIRECT_DOWNLOAD_STORY_INTRO:"When you click Download All Resources, whether you want to download all stories/highlights resources directly."}},s=Object.assign({},n,d.locale),l=Object.keys(s).sort().reduce((i,t)=>(i[t]=s[t],i),{});return l}async function Ge(n){return new Promise((s,l)=>{GM_xmlhttpRequest({method:"GET",url:`https://raw.githubusercontent.com/SN-Koarashi/ig-helper/master/locale/translations/${n}.json`,onload:function(i){try{let t=JSON.parse(i.response);s(t)}catch(t){l(t)}},onerror:function(i){h("getTranslationText()","reject",i),l(i)}})})}function f(n){const s=Ve();return s[d.lang]!=null&&s[d.lang][n]!=null?s[d.lang][n]:s["en-US"][n]}function ce(){e("[data-ih-locale]").each(function(){e(this).text(f(e(this).attr("data-ih-locale")))}),e("[data-ih-locale-title]").each(function(){e(this).attr("title",f(e(this).attr("data-ih-locale-title")))})}e(function(){function n(i){var t=[];for(var a of i)t.push({tagName:a.tagName,id:a.id,className:a.className});return t}function s(){let i=e('div[id^="mount"]')[0];var t="";d.GL_logger.forEach(a=>{var o=JSON.stringify(a.content,function(r,c){return Array.isArray(this)&&typeof c=="object"&&c instanceof jQuery?n(c):c},"	");t+=`${new Date(a.time).toISOString()}: ${o}
`}),e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY textarea").text(`Logger:
`+t+`
-----

Location: `+location.pathname+`
DOM Tree with div#mount:
`+i.innerHTML)}e("body").on("click",".IG_POPUP_DIG .IG_POPUP_DIG_BODY .IG_DISPLAY_DOM_TREE",function(){s()}),e("body").on("click",".IG_POPUP_DIG .IG_POPUP_DIG_BODY .IG_SELECT_DOM_TREE",function(){e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY textarea").select(),document.execCommand("copy")}),e("body").on("click",".IG_POPUP_DIG .IG_POPUP_DIG_BODY .IG_DOWNLOAD_DOM_TREE",function(){e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY textarea").text().length===0&&s();var i=e(".IG_POPUP_DIG .IG_POPUP_DIG_BODY textarea").text(),t=document.createElement("a"),a=new Blob([i],{type:"text/plain"});t.href=URL.createObjectURL(a),t.download="DOMTree-"+new Date().getTime()+".txt",document.body.appendChild(t),t.click(),t.remove()}),e("body").on("click",".IG_POPUP_DIG_BTN, .IG_POPUP_DIG_BG",function(){e(this).parent("#tempWrapper").length>0?e(this).parent("#tempWrapper").fadeOut(250,function(){e(this).remove()}):e(".IG_POPUP_DIG").remove()}),e(window).on("keydown",function(i){i.which=="81"&&i.altKey&&(e(".IG_POPUP_DIG").remove(),i.preventDefault()),i.which=="87"&&i.altKey&&(De(),i.preventDefault()),i.which=="90"&&i.altKey&&(Oe(),i.preventDefault()),i.which=="82"&&i.altKey&&(Pe(),i.preventDefault()),i.which=="83"&&i.altKey&&(location.href.match(/^(https:\/\/www\.instagram\.com\/stories\/)/ig)&&e(".IG_DWSTORY").length>0&&e(".IG_DWSTORY")?.trigger("click"),location.href.match(/^(https:\/\/www\.instagram\.com\/stories\/highlights\/)/ig)&&e(".IG_DWHISTORY").length>0&&e(".IG_DWHISTORY")?.trigger("click"),i.preventDefault())}),e("body").on("change",".IG_POPUP_DIG input",function(){var i=e(this).attr("id");if(i&&_[i]!==void 0){let t=e(this).prop("checked");GM_setValue(i,t),_[i]=t,console.log("user settings",i,t)}}),e("body").on("click",".IG_POPUP_DIG .globalSettings",function(i){e(this).find("#tempWrapper").length>0&&i.preventDefault()}),e("body").on("change",".IG_POPUP_DIG #tempWrapper input:not(#date_format)",function(){let i=e(this).val();e(this).attr("type")=="range"?e(this).next().val(i):e(this).prev().val(i),i>=0&&i<=1&&(d.videoVolume=i,GM_setValue("G_VIDEO_VOLUME",i))}),e("body").on("input",".IG_POPUP_DIG #tempWrapper input:not(#date_format)",function(){if(e(this).attr("type")=="range"){let i=e(this).val();e(this).next().val(i)}else{let i=e(this).val();i>=0&&i<=1?e(this).prev().val(i):i<0?e(this).val(0):e(this).val(1)}}),e("body").on("input",".IG_POPUP_DIG #tempWrapper input#date_format",function(){GM_setValue("G_RENAME_FORMAT",e(this).val()),d.fileRenameFormat=e(this).val()}),e("body").on("click",'a[data-needed="direct"]',function(i){i.preventDefault(),oe(this)}),e("body").on("click",".IG_POPUP_DIG_BODY .newTab",function(){if(_.FORCE_RESOURCE_VIA_MEDIA&&_.NEW_TAB_ALWAYS_FORCE_MEDIA_IN_POST)oe(e(this).parent().children("a").first()[0],!0);else{var i=new URL(e(this).parent().children("a").attr("data-href"));i.host="scontent.cdninstagram.com",M(i.href)}}),e("body").on("click",".IG_POPUP_DIG_BODY .videoThumbnail",function(){let i=new Date().getTime();_.RENAME_PUBLISH_DATE&&e(this).parent().children("a").attr("datetime")&&(i=e(this).parent().children("a").attr("datetime"));let t=e(this).parent().children("a").attr("data-path")??e("#article-id").text();R(e(this).parent().children("a").find("img").first().attr("src"),e(this).parent().children("a").attr("data-username"),"thumbnail",i,"jpg",t)}),e("body").on("click",".IG_DWSTORY",function(){k(!0)}),e("body").on("click",".IG_DWSTORY_ALL",function(){we()}),e("body").on("click",".IG_DWNEWTAB",function(i){i.preventDefault(),k(!0,!0,!0)}),e("body").on("click",".IG_DWSTORY_THUMBNAIL",function(){$(!0)}),e("body").on("click",".IG_DWPROFILE",function(i){i.stopPropagation(),me(!0)}),e("body").on("click",".IG_DWHISTORY",function(){J(!0)}),e("body").on("click",".IG_DWHISTORY_ALL",function(){be()}),e("body").on("click",".IG_DWHINEWTAB",function(i){i.preventDefault(),J(!0,!0)}),e("body").on("click",".IG_DWHISTORY_THUMBNAIL",function(){Q(!0)}),e("body").on("click",".IG_REELS",function(){Z(!0,!0)}),e("body").on("click",".IG_REELS_NEWTAB",function(){Z(!0,!0,!0)}),e("body").on("click",".IG_REELS_THUMBNAIL",function(){Z(!0,!1)}),e("body").on("mousedown",'button[role="menuitem"], div[role="menuitem"], ul > li[tabindex="-1"] > div[role="button"]',function(i){if((i.which===3||i.which===2)&&location.href==="https://www.instagram.com/"&&_.REDIRECT_CLICK_USER_STORY_PICTURE&&(i.preventDefault(),e(this).find("canvas._aarh, canvas + span > img").length>0)){const t="https://www.instagram.com/"+e(this).children("div").last().text();i.which===2?GM_openInTab(t):location.href=t}}),e("body").on("change",".IG_POPUP_DIG_TITLE .checkbox",function(){var i=e(this).find("input").prop("checked");e(".IG_POPUP_DIG_BODY .inner_box").each(function(){e(this).prop("checked",i)})}),e("body").on("change",".IG_POPUP_DIG_BODY .inner_box",function(){var i=e(".IG_POPUP_DIG_BODY .inner_box:checked").length,t=e(".IG_POPUP_DIG_BODY .inner_box").length;e(".IG_POPUP_DIG_TITLE .checkbox").find("input").prop("checked",i==t)}),e("body").on("click",".IG_POPUP_DIG_TITLE #batch_download_selected",function(){let i=0;e('.IG_POPUP_DIG_BODY a[data-needed="direct"]').each(function(){e(this).prev().children("input").prop("checked")&&(e(this).trigger("click"),i++)}),i==0&&alert(f("NO_CHECK_RESOURCE"))}),e("body").on("change",".IG_POPUP_DIG_TITLE #langSelect",function(){GM_setValue("lang",e(this).val()),d.lang=e(this).val(),d.lang?.startsWith("en")||d.locale[d.lang]!=null?(ce(),q()):Ge(d.lang).then(i=>{d.locale[d.lang]=i,ce(),q()}).catch(i=>{console.error("getTranslationText catch error:",i)})}),e("body").on("click",".IG_POPUP_DIG_TITLE #batch_download_direct",function(){e('.IG_POPUP_DIG_BODY a[data-needed="direct"]').each(function(){e(this).trigger("click")})}),new MutationObserver(i=>{for(const t of i)t.type==="childList"&&t.addedNodes.forEach(a=>{const o=e(a).find("video");if(location.pathname.startsWith("/stories/highlights/")&&e(a).attr("data-ih-locale-title")==null&&e(a).attr("data-visualcompletion")==null&&a.tagName==="DIV"){var r=e(a).find("time[datetime]");let c=r?.attr("title");c!=null&&r.text(c)}if(o.length>0&&(_.MODIFY_VIDEO_VOLUME&&o.each(function(){e(this).on("play playing",function(){e(this).data("modify")||(e(this).attr("data-modify",!0),this.volume=d.videoVolume,h("(audio_observer) Added video event listener #modify"))})}),location.pathname.match(/^(\/stories\/)/ig))){const c=location.pathname.match(/^(\/stories\/highlights\/)/ig)!=null,p=c?"highlight":"story";o.each(function(){e(this).on("timeupdate",function(){if(!e(this).data("modify-thumbnail")){let u=e(this);u.parents("div[style][class]").filter(function(){return e(this).width()==u.width()}).find(".IG_DWSTORY_THUMBNAIL, .IG_DWHISTORY_THUMBNAIL").length===0?(e(this).attr("data-modify-thumbnail",!0),c?Q(!1):$(!1),h(`(${p})`,"Manually inserting thumbnail button")):(e(this).attr("data-modify-thumbnail",!0),h(`(${p})`,"Thumbnail button already inserted"))}});var m=e(this);if(_.HTML5_VIDEO_CONTROL){if(!m.data("controls")){h(`(${p})`,"Added video html5 contorller #modify"),_.MODIFY_VIDEO_VOLUME&&(this.volume=d.videoVolume,m.on("loadstart",function(){this.volume=d.videoVolume}));let u=m.parents("div").filter(function(){return e(this).attr("class")==null&&e(this).attr("style")==null}).first(),g=u.next();g.hide();let I=u.find('div[class][role="button"]');I.hide();const v=function(P){P.preventDefault(),m.css("z-index","2"),m.attr("controls",!0),I.hide(),g.hide(),K(m,m.parents("div[style][class]").filter(function(){return e(this).width()==m.width()}).first(),p,"vertical")};m.parent().find("video + div").on("contextmenu",v),I.on("contextmenu",v),g.on("contextmenu",v),m.on("contextmenu",function(P){P.preventDefault(),m.css("z-index","-1"),m.removeAttr("controls"),g.show(),I.show(),K(m,m.parents("div[style][class]").filter(function(){return e(this).width()==m.width()}).first(),p,"vertical")}),m.on("volumechange",function(){let P=u.parent().find('svg > path[d^="M1.5 13.3c-.8 0-1.5.7-1.5 1.5v18.4c0"], svg > path[d^="M16.636 7.028a1.5 1.5"]').parents('[role="button"]').first();var w=P.find('svg > path[d^="M16.636"]').length===0;this.muted!=w&&(this.volume=d.videoVolume,P?.trigger("click")),e(this).attr("data-completed")&&(d.videoVolume=this.volume,GM_setValue("G_VIDEO_VOLUME",this.volume)),this.volume==d.videoVolume&&e(this).attr("data-completed",!0)}),m.css("position","absolute"),m.css("z-index","2"),m.attr("data-controls",!0),m.attr("controls",!0)}}else K(m,m.parents("div[style][class]").filter(function(){return e(this).width()==m.width()}).first(),p,"vertical")})}})}).observe(e('div[id^="mount"]')[0],{childList:!0,subtree:!0})})})(jQuery);
