// ==UserScript==
// @name         TwitchAdSolutions (video-swap-new)
// @namespace    https://github.com/pixeltris/TwitchAdSolutions
// @version      1.35
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/videoswapnew.meta.js
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/videoswapnew.user.js
// @author       pixeltris
// @match        *://*.twitch.tv/*
// @run-at       document-start
// @inject-into  page
// @grant        none
// ==/UserScript==
(function(){"use strict";var I=2;if(window.twitchAdSolutionsVersion&&window.twitchAdSolutionsVersion>=I){console.log("skipping video-swap-new as there's another script active. ourVersion:"+I+" activeVersion:"+window.twitchAdSolutionsVersion),window.twitchAdSolutionsVersion=I;return}window.twitchAdSolutionsVersion=I;function C(r){r.OPT_MODE_STRIP_AD_SEGMENTS=!0,r.OPT_MODE_NOTIFY_ADS_WATCHED=!0,r.OPT_MODE_NOTIFY_ADS_WATCHED_MIN_REQUESTS=!1,r.OPT_BACKUP_PLAYER_TYPE="autoplay",r.OPT_BACKUP_PLATFORM="ios",r.OPT_REGULAR_PLAYER_TYPE="site",r.OPT_ACCESS_TOKEN_PLAYER_TYPE=null,r.OPT_SHOW_AD_BANNER=!0,r.AD_SIGNIFIER="stitched-ad",r.LIVE_SIGNIFIER=",live",r.CLIENT_ID="kimne78kx3ncx6brgo4mv6wki5h1ko",r.StreamInfos=[],r.StreamInfosByUrl=[],r.CurrentChannelNameFromM3U8=null,r.gql_device_id=null,r.ClientIntegrityHeader=null,r.AuthorizationHeader=null}var D=[],N=["twitch","isVariantA"],R=[],U=["isVariantA","besuper/","${patch_url}"];function M(r){for(var t=null,e=null,a=r;a;){var o=a.toString();N.some(n=>o.includes(n))&&!R.some(n=>o.includes(n))?e!==null&&Object.setPrototypeOf(e,Object.getPrototypeOf(a)):(t===null&&(t=a),e=a),a=Object.getPrototypeOf(a)}return t}function B(r){for(var t=[],e=r;e;){var a=e.toString();U.some(o=>a.includes(o))&&t.push(e),e=Object.getPrototypeOf(e)}return t}function V(r,t){for(var e=r,a=0;a<t.length;a++)Object.setPrototypeOf(t[a],e),e=t[a];return e}function F(r){var t=r.toString();return!N.some(e=>t.includes(e))||R.some(e=>t.includes(e))||U.some(e=>t.includes(e))}function q(){var r=B(window.Worker),t=class extends M(window.Worker){constructor(o,n){var i=!1;try{i=new URL(o).origin.endsWith(".twitch.tv")}catch{}if(!i){super(o,n);return}var u=`
                    ${W.toString()}
                    ${X.toString()}
                    ${C.toString()}
                    ${H.toString()}
                    ${T.toString()}
                    ${_.toString()}
                    ${Y.toString()}
                    ${E.toString()}
                    ${P.toString()}
                    ${$.toString()}
                    var workerString = getWasmWorkerJs('${o.replaceAll("'","%27")}');
                    declareOptions(self);
                    self.addEventListener('message', function(e) {
                        if (e.data.key == 'UboUpdateDeviceId') {
                            gql_device_id = e.data.value;
                        } else if (e.data.key == 'UpdateClientIntegrityHeader') {
                            ClientIntegrityHeader = e.data.value;
                        } else if (e.data.key == 'UpdateAuthorizationHeader') {
                            AuthorizationHeader = e.data.value;
                        }
                    });
                    hookWorkerFetch();
                    eval(workerString);
                `;super(URL.createObjectURL(new Blob([u])),n),D.push(this),this.addEventListener("message",s=>{if(s.data.key=="UboShowAdBanner"){var l=d();l!=null&&(l.P.textContent="Blocking"+(s.data.isMidroll?" midroll":"")+" ads",OPT_SHOW_AD_BANNER&&(l.style.display="block"))}else if(s.data.key=="UboHideAdBanner"){var l=d();l!=null&&(l.style.display="none")}else s.data.key=="UboChannelNameM3U8Changed"||(s.data.key=="UboReloadPlayer"?A():s.data.key=="UboPauseResumePlayer"?A(!1,!0):s.data.key=="UboSeekPlayer"&&A(!0))});function d(){var s=document.querySelector(".video-player"),l=null;return s!=null&&(l=s.querySelector(".ubo-overlay"),l==null&&(l=document.createElement("div"),l.className="ubo-overlay",l.innerHTML='<div class="player-ad-notice" style="color: white; background-color: rgba(0, 0, 0, 0.8); position: absolute; top: 0px; left: 0px; padding: 5px;"><p></p></div>',l.style.display="none",l.P=l.querySelector("p"),s.appendChild(l))),l}}},e=V(t,r);Object.defineProperty(window,"Worker",{get:function(){return e},set:function(a){F(a)?e=a:console.log("Attempt to set twitch worker denied")}})}function $(r){var t=new XMLHttpRequest;return t.open("GET",r,!1),t.overrideMimeType("text/javascript"),t.send(),t.responseText}function P(r,t,e){console.log("Found ads, switch to backup"),r.UseBackupStream=!0,r.IsMidroll=t.includes('"MIDROLL"')||t.includes('"midroll"'),e&&postMessage({key:"UboReloadPlayer"}),postMessage({key:"UboShowAdBanner",isMidroll:r.IsMidroll})}async function W(r,t,e){var a=StreamInfosByUrl[r];if(a==null)return console.log("Unknown stream url "+r),t;if(!OPT_MODE_STRIP_AD_SEGMENTS)return t;var o=t.includes(AD_SIGNIFIER);if(a.UseBackupStream){if(a.Encodings==null)return console.log("Found backup stream but not main stream?"),a.UseBackupStream=!1,postMessage({key:"UboReloadPlayer"}),"";var n=a.Encodings.match(/^https:.*\.m3u8$/m)[0],i=await e(n);if(i.status==200){var u=await i.text();if(u!=null){if(!u.includes(AD_SIGNIFIER))console.log("No more ads on main stream. Triggering player reload to go back to main stream..."),a.UseBackupStream=!1,postMessage({key:"UboHideAdBanner"}),postMessage({key:"UboReloadPlayer"});else if(!u.includes('"MIDROLL"')&&!u.includes('"midroll"'))for(var d=u.replace("\r","").split(`
`),s=0;s<d.length;s++){var l=d[s];if(l.startsWith("#EXTINF")&&d.length>s+1&&!l.includes(LIVE_SIGNIFIER)&&!a.RequestedAds.has(d[s+1])){a.RequestedAds.add(d[s+1]),fetch(d[s+1]).then(f=>{f.blob()});break}}}}}else o?P(a,t,!0):postMessage({key:"UboHideAdBanner"});if(o&&a.BackupEncodings!=null){var n=a.BackupEncodings.match(/^https:.*\.m3u8.*$/m)[0],i=await e(n);i.status==200&&(t=await i.text())}return t}function X(){console.log("hookWorkerFetch (video-swap-new)");var r=fetch;fetch=async function(t,e){if(typeof t=="string"){if(t=t.trimEnd(),t.endsWith("m3u8"))return new Promise(function(o,n){var i=async function(d){var s=await W(t,await d.text(),r);o(new Response(s,{status:d.status,statusText:d.statusText,headers:d.headers}))},u=function(){return r(t,e).then(function(d){i(d)}).catch(function(d){console.log("fetch hook err "+d),n(d)})};u()});if(t.includes("/api/channel/hls/")&&!t.includes("picture-by-picture")){var a=new URL(t).pathname.match(/([^\/]+)(?=\.\w+$)/)[0];if(CurrentChannelNameFromM3U8!=a&&postMessage({key:"UboChannelNameM3U8Changed",value:a}),CurrentChannelNameFromM3U8=a,OPT_MODE_STRIP_AD_SEGMENTS)return new Promise(async function(o,n){var i=StreamInfos[a];if(i!=null&&i.Encodings!=null&&(await r(i.Encodings.match(/^https:.*\.m3u8$/m)[0])).status!==200&&(i=null),i==null||i.Encodings==null||i.BackupEncodings==null){StreamInfos[a]=i={RequestedAds:new Set,Encodings:null,BackupEncodings:null,IsMidroll:!1,UseBackupStream:!1,ChannelName:a};for(var u=0;u<2;u++){var d=t;if(u==1){var s=await H(a,OPT_BACKUP_PLAYER_TYPE,OPT_BACKUP_PLATFORM,r);if(s!=null&&s.status===200){var l=await s.json(),f=new URL("https://usher.ttvnw.net/api/channel/hls/"+a+".m3u8"+new URL(t).search);f.searchParams.set("sig",l.data.streamPlaybackAccessToken.signature),f.searchParams.set("token",l.data.streamPlaybackAccessToken.value),d=f.href}else{o(s);return}}var v=await r(d,e);if(v!=null&&v.status===200){var p=await v.text();if(u==0){i.Encodings=p;var c=p.match(/^https:.*\.m3u8$/m)[0],y=await r(c);if(y.status==200){var h=await y.text();h.includes(AD_SIGNIFIER)&&P(i,h,!1)}else{o(y);return}}else{for(var m=p.replace("\r","").split(`
`),k=null,g=0;g<m.length;g++)if(m[g].startsWith("#EXT-X-STREAM-INF")){var O=E(m[g]).RESOLUTION;if(O&&m[g+1].endsWith(".m3u8")){k=m[g+1];break}}if(k!=null&&i.Encodings!=null){for(var j=i.Encodings,S=j.replace("\r","").split(`
`),g=0;g<S.length-1;g++)if(S[g].startsWith("#EXT-X-STREAM-INF")){var O=E(S[g]).RESOLUTION;O&&(k+=" ",S[g+1]=k)}p=S.join(`\r
`)}i.BackupEncodings=p}for(var w=p.replace("\r","").split(`
`),g=0;g<w.length;g++)!w[g].startsWith("#")&&w[g].includes(".m3u8")&&(StreamInfosByUrl[w[g].trimEnd()]=i)}else{o(v);return}}}i.UseBackupStream?o(new Response(i.BackupEncodings)):o(new Response(i.Encodings))})}}return r.apply(this,arguments)}}function _(r,t,e){return[{operationName:"ClientSideAdEventHandling_RecordAdEvent",variables:{input:{eventName:r,eventPayload:JSON.stringify(e),radToken:t}},extensions:{persistedQuery:{version:1,sha256Hash:"7e6c69e6eb59f8ccb97ab73686f3d8b7d85a72a0298745ccd8bfc68e4054ca5b"}}}]}function H(r,t,e,a){e||(e="web");var o=null,n='query PlaybackAccessToken_Template($login: String!, $isLive: Boolean!, $vodID: ID!, $isVod: Boolean!, $playerType: String!) {  streamPlaybackAccessToken(channelName: $login, params: {platform: "'+e+'", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isLive) {    value    signature    __typename  }  videoPlaybackAccessToken(id: $vodID, params: {platform: "'+e+'", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isVod) {    value    signature    __typename  }}';return o={operationName:"PlaybackAccessToken_Template",query:n,variables:{isLive:!0,login:r,isVod:!1,vodID:"",playerType:t}},T(o,a)}function T(r,t){ClientIntegrityHeader==null;var e=t||fetch;return e("https://gql.twitch.tv/gql",{method:"POST",body:JSON.stringify(r),headers:{"Client-Id":CLIENT_ID,"Client-Integrity":ClientIntegrityHeader,"X-Device-Id":gql_device_id,Authorization:AuthorizationHeader}})}function E(r){return Object.fromEntries(r.split(/(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))/).filter(Boolean).map(t=>{const e=t.indexOf("="),a=t.substring(0,e),o=t.substring(e+1),n=Number(o);return[a,Number.isNaN(n)?o.startsWith('"')?JSON.parse(o):o:n]}))}async function Y(r){try{if(!r||!r.includes(AD_SIGNIFIER))return 1;var t=r.match(/#EXT-X-DATERANGE:(ID="stitched-ad-[^\n]+)\n/);if(t.length>1){const l=t[1],f=E(l);var e=parseInt(f["X-TV-TWITCH-AD-POD-LENGTH"]?f["X-TV-TWITCH-AD-POD-LENGTH"]:"1"),a=parseInt(f["X-TV-TWITCH-AD-POD-POSITION"]?f["X-TV-TWITCH-AD-POD-POSITION"]:"0"),o=f["X-TV-TWITCH-AD-RADS-TOKEN"],n=f["X-TV-TWITCH-AD-LINE-ITEM-ID"],i=f["X-TV-TWITCH-AD-ORDER-ID"],u=f["X-TV-TWITCH-AD-CREATIVE-ID"],d=f["X-TV-TWITCH-AD-ADVERTISER-ID"],s=f["X-TV-TWITCH-AD-ROLL-TYPE"].toLowerCase();const v={stitched:!0,roll_type:s,player_mute:!1,player_volume:.5,visible:!0};for(let p=0;p<e;p++)if(OPT_MODE_NOTIFY_ADS_WATCHED_MIN_REQUESTS)await T(_("video_ad_pod_complete",o,v));else{const c={...v,ad_id:d,ad_position:p,duration:30,creative_id:u,total_ads:e,order_id:i,line_item_id:n};await T(_("video_ad_impression",o,c));for(let y=0;y<4;y++)await T(_("video_ad_quartile_complete",o,{...c,quartile:y+1}));await T(_("video_ad_pod_complete",o,v))}}return 0}catch(l){return console.log(l),0}}function b(r,t){D.forEach(e=>{e.postMessage({key:r,value:t})})}function G(){var r=window.fetch;window.fetch=function(t,e,...a){if(typeof t=="string"&&t.includes("gql")){var o=e.headers["X-Device-Id"];if(typeof o!="string"&&(o=e.headers["Device-ID"]),typeof o=="string"&&(gql_device_id=o),gql_device_id&&b("UboUpdateDeviceId",gql_device_id),typeof e.body=="string"&&e.body.includes("PlaybackAccessToken")){if(OPT_ACCESS_TOKEN_PLAYER_TYPE){const n=JSON.parse(e.body);if(Array.isArray(n))for(let i=0;i<n.length;i++)n[i].variables.playerType=OPT_ACCESS_TOKEN_PLAYER_TYPE;else n.variables.playerType=OPT_ACCESS_TOKEN_PLAYER_TYPE;e.body=JSON.stringify(n)}typeof e.headers["Client-Integrity"]=="string"&&(ClientIntegrityHeader=e.headers["Client-Integrity"],ClientIntegrityHeader&&b("UpdateClientIntegrityHeader",e.headers["Client-Integrity"])),typeof e.headers.Authorization=="string"&&(AuthorizationHeader=e.headers.Authorization,AuthorizationHeader&&b("UpdateAuthorizationHeader",e.headers.Authorization))}}return r.apply(this,arguments)}}function A(r,t){function e(c,y){if(c.stateNode&&y(c.stateNode))return c.stateNode;let h=c.child;for(;h;){const m=e(h,y);if(m)return m;h=h.sibling}return null}function a(){var c=null,y=document.querySelector("#root");if(y&&y._reactRootContainer&&y._reactRootContainer._internalRoot&&y._reactRootContainer._internalRoot.current&&(c=y._reactRootContainer._internalRoot.current),c==null){var h=Object.keys(y).find(m=>m.startsWith("__reactContainer"));h!=null&&(c=y[h])}return c}var o=a();if(!o){console.log("Could not find react root");return}var n=e(o,c=>c.setPlayerActive&&c.props&&c.props.mediaPlayerInstance);n=n&&n.props&&n.props.mediaPlayerInstance?n.props.mediaPlayerInstance:null;var i=e(o,c=>c.setSrc&&c.setInitialPlaybackSettings);if(!n){console.log("Could not find player");return}if(!i){console.log("Could not find player state");return}if(n.paused||n.core?.paused)return;if(r){console.log("Force seek to reset player (hopefully fixing any audio desync) pos:"+n.getPosition()+" range:"+JSON.stringify(n.getBuffered()));var u=n.getPosition();n.seekTo(0),n.seekTo(u);return}if(t){n.pause(),n.play();return}const d="video-quality",s="video-muted",l="volume";var f=localStorage.getItem(d),v=localStorage.getItem(s),p=localStorage.getItem(l);n?.core?.state&&(localStorage.setItem(s,JSON.stringify({default:n.core.state.muted})),localStorage.setItem(l,n.core.state.volume)),n?.core?.state?.quality?.group&&localStorage.setItem(d,JSON.stringify({default:n.core.state.quality.group})),i.setSrc({isNewMediaPlayerInstance:!0,refreshAccessToken:!0}),setTimeout(()=>{localStorage.setItem(d,f),localStorage.setItem(s,v),localStorage.setItem(l,p)},3e3)}function L(){try{Object.defineProperty(document,"visibilityState",{get(){return"visible"}})}catch{}try{Object.defineProperty(document,"hidden",{get(){return!1}})}catch{}var r=i=>{i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation()};document.addEventListener("visibilitychange",r,!0),document.addEventListener("webkitvisibilitychange",r,!0),document.addEventListener("mozvisibilitychange",r,!0),document.addEventListener("hasFocus",r,!0);try{/Firefox/.test(navigator.userAgent)?Object.defineProperty(document,"mozHidden",{get(){return!1}}):Object.defineProperty(document,"webkitHidden",{get(){return!1}})}catch{}for(var t=["video-quality","video-muted","volume","lowLatencyModeEnabled","persistenceEnabled"],e=new Map,a=0;a<t.length;a++)e.set(t[a],localStorage.getItem(t[a]));var o=localStorage.setItem;localStorage.setItem=function(i,u){e.has(i)&&e.set(i,u),o.apply(this,arguments)};var n=localStorage.getItem;localStorage.getItem=function(i){return e.has(i)?e.get(i):n.apply(this,arguments)}}window.reloadTwitchPlayer=A,C(window),q(),G(),document.readyState==="complete"||document.readyState==="loaded"||document.readyState==="interactive"?L():window.addEventListener("DOMContentLoaded",function(){L()})})();
