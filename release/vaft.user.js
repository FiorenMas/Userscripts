// ==UserScript==
// @name         TwitchAdSolutions (vaft)
// @namespace    https://github.com/pixeltris/TwitchAdSolutions
// @version      17.0.0
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/vaft.meta.js
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/vaft.user.js
// @author       https://github.com/cleanlock/VideoAdBlockForTwitch#credits
// @match        *://*.twitch.tv/*
// @run-at       document-start
// @inject-into  page
// @grant        none
// ==/UserScript==
(function(){"use strict";var b=2;if(window.twitchAdSolutionsVersion&&window.twitchAdSolutionsVersion>=b){console.log("skipping vaft as there's another script active. ourVersion:"+b+" activeVersion:"+window.twitchAdSolutionsVersion),window.twitchAdSolutionsVersion=b;return}window.twitchAdSolutionsVersion=b;function E(a){a.AdSignifier="stitched",a.ClientID="kimne78kx3ncx6brgo4mv6wki5h1ko",a.ClientVersion="null",a.ClientSession="null",a.PlayerType2="embed",a.PlayerType3="site",a.PlayerType4="autoplay",a.CurrentChannelName=null,a.UsherParams=null,a.WasShowingAd=!1,a.GQLDeviceID=null,a.IsSquadStream=!1,a.StreamInfos=[],a.StreamInfosByUrl=[],a.MainUrlByUrl=[],a.EncodingCacheTimeout=6e4,a.ClientIntegrityHeader=null,a.AuthorizationHeader=null}var L=[],w=null,k=null,D=null,O=["twitch","isVariantA"],W=[],V=["isVariantA","besuper/","${patch_url}"];function N(a){for(var e=null,t=null,r=a;r;){var i=r.toString();O.some(u=>i.includes(u))&&!W.some(u=>i.includes(u))?t!==null&&Object.setPrototypeOf(t,Object.getPrototypeOf(r)):(e===null&&(e=r),t=r),r=Object.getPrototypeOf(r)}return e}function $(a){for(var e=[],t=a;t;){var r=t.toString();V.some(i=>r.includes(i))&&e.push(t),t=Object.getPrototypeOf(t)}return e}function q(a,e){for(var t=a,r=0;r<e.length;r++)Object.setPrototypeOf(e[r],t),t=e[r];return t}function F(a){var e=a.toString();return!O.some(t=>e.includes(t))||W.some(t=>e.includes(t))||V.some(t=>e.includes(t))}function B(){var a=$(window.Worker),e=class extends N(window.Worker){constructor(i,u){var o=!1;try{o=new URL(i).origin.endsWith(".twitch.tv")}catch{}if(!o){super(i,u);return}var d=`
                    ${P.toString()}
                    ${T.toString()}
                    ${G.toString()}
                    ${I.toString()}
                    ${X.toString()}
                    ${E.toString()}
                    ${_.toString()}
                    ${C.toString()}
                    ${R.toString()}
                    ${j.toString()}
                    ${S.toString()}
                    ${Q.toString()}
                    var workerString = getWasmWorkerJs('${i.replaceAll("'","%27")}');
                    declareOptions(self);
                    self.addEventListener('message', function(e) {
                        if (e.data.key == 'UpdateIsSquadStream') {
                            IsSquadStream = e.data.value;
                        } else if (e.data.key == 'UpdateClientVersion') {
                            ClientVersion = e.data.value;
                        } else if (e.data.key == 'UpdateClientSession') {
                            ClientSession = e.data.value;
                        } else if (e.data.key == 'UpdateClientId') {
                            ClientID = e.data.value;
                        } else if (e.data.key == 'UpdateDeviceId') {
                            GQLDeviceID = e.data.value;
                        } else if (e.data.key == 'UpdateClientIntegrityHeader') {
                            ClientIntegrityHeader = e.data.value;
                        } else if (e.data.key == 'UpdateAuthorizationHeader') {
                            AuthorizationHeader = e.data.value;
                        }
                    });
                    hookWorkerFetch();
                    eval(workerString);
                `;super(URL.createObjectURL(new Blob([d])),u),L.push(this),this.addEventListener("message",n=>{if(n.data.key=="ShowAdBlockBanner")w==null&&(w=v()),w.P.textContent="Blocking ads",w.style.display="block";else if(n.data.key=="HideAdBlockBanner")w==null&&(w=v()),w.style.display="none";else if(n.data.key=="PauseResumePlayer")A(!0,!1,!1,!1,!1);else if(n.data.key=="ForceChangeQuality")try{return;var l,s;if((!s.includes("360")||n.data.value!=null)&&!k.includes("360")){var g;if(g==null){var p=document.querySelector('button[data-a-target="player-settings-button"]');if(p){p.click();var c=document.querySelector('button[data-a-target="player-settings-menu-item-quality"]');c&&c.click();var f=document.querySelectorAll('input[data-a-target="tw-radio"');if(f){var h=f.length-2;n.data.value!=null&&(n.data.value.includes("original")&&(n.data.value=k,D&&(n.data.value="auto")),n.data.value.includes("160p")&&(h=5),n.data.value.includes("360p")&&(h=4),n.data.value.includes("480p")&&(h=3),n.data.value.includes("720p")&&(h=2),n.data.value.includes("822p")&&(h=2),n.data.value.includes("864p")&&(h=2),n.data.value.includes("900p")&&(h=2),n.data.value.includes("936p")&&(h=2),n.data.value.includes("960p")&&(h=2),n.data.value.includes("1080p")&&(h=2),n.data.value.includes("source")&&(h=1),n.data.value.includes("auto")&&(h=0));var y=window.localStorage.getItem("video-quality");f[h].click(),p.click(),window.localStorage.setItem("video-quality",y),n.data.value!=null&&(k=null,D=null,A(!1,!1,!1,!0,!0))}}}}}catch{k=null,D=null}});function v(){var n=document.querySelector(".video-player"),l=null;return n!=null&&(l=n.querySelector(".adblock-overlay"),l==null&&(l=document.createElement("div"),l.className="adblock-overlay",l.innerHTML='<div class="player-adblock-notice" style="color: white; background-color: rgba(0, 0, 0, 0.8); position: absolute; top: 0px; left: 0px; padding: 5px;"><p></p></div>',l.style.display="none",l.P=l.querySelector("p"),n.appendChild(l))),l}}},t=q(e,a);Object.defineProperty(window,"Worker",{get:function(){return t},set:function(r){F(r)?t=r:console.log("Attempt to set twitch worker denied")}})}function Q(a){var e=new XMLHttpRequest;return e.open("GET",a,!1),e.overrideMimeType("text/javascript"),e.send(),e.responseText}function X(){console.log("hookWorkerFetch (vaft)");var a=fetch;fetch=async function(e,t){if(typeof e=="string"){if(e.endsWith("m3u8"))return new Promise(function(u,o){var d=async function(n){if(n.status===200){var l=await n.text(),s=null;s=await I(e,l,a,PlayerType2),s.includes(AdSignifier)&&(s=await I(e,l,a,PlayerType3)),s.includes(AdSignifier)&&(s=await I(e,l,a,PlayerType4)),u(new Response(s))}else u(n)},v=function(){return a(e,t).then(function(n){d(n)}).catch(function(n){o(n)})};v()});if(e.includes("/api/channel/hls/")){var r=new URL(e).pathname.match(/([^\/]+)(?=\.\w+$)/)[0];UsherParams=new URL(e).search,CurrentChannelName=r;var i=e.includes("picture-by-picture");return i&&(e=""),new Promise(function(u,o){var d=async function(n){if(n.status==200){encodingsM3u8=await n.text();var l=StreamInfos[r];l==null&&(StreamInfos[r]=l={}),l.ChannelName=r,l.RequestedAds=new Set,l.Urls=[],l.EncodingsM3U8Cache=[],l.EncodingsM3U8=encodingsM3u8;for(var s=encodingsM3u8.replace("\r","").split(`
`),g=0;g<s.length;g++)if(!s[g].startsWith("#")&&s[g].includes(".m3u8")){if(l.Urls[s[g]]=-1,g>0&&s[g-1].startsWith("#EXT-X-STREAM-INF")){var p=S(s[g-1]),c=p.RESOLUTION,f=p["FRAME-RATE"];c&&(l.Urls[s[g]]={Resolution:c,FrameRate:f})}StreamInfosByUrl[s[g]]=l,MainUrlByUrl[s[g]]=e}u(new Response(encodingsM3u8))}else u(n)},v=function(){return a(e,t).then(function(n){d(n)}).catch(function(n){o(n)})};v()})}}return a.apply(this,arguments)}}function P(a,e,t){var r=0;t&&t.endsWith("p")&&(r=t.substr(0,t.length-1)|0);for(var i=0,u=0,o=a.replace("\r","").split(`
`),d=null,v=null,n=null,l=!1,s=0;s<o.length;s++)if(!o[s].startsWith("#")&&o[s].includes(".m3u8")&&s>0&&o[s-1].startsWith("#EXT-X-STREAM-INF")){var g=S(o[s-1]),p=g.RESOLUTION,c=g["FRAME-RATE"];if(p){if(r){var f=p.toLowerCase().split("x")[1];if(f==r){if(i=f,u=c,n=o[s],c<40)return n}else if(f<r)return n||o[s]}else if((!e||p==e.Resolution)&&(!n||!l&&c==e.FrameRate)&&(n=o[s],l=c==e.FrameRate,l))return n}d==null&&(d=o[s]),v=o[s]}return r?v:n||d}async function T(a,e,t,r,i,u){var o=null;(a.EncodingsM3U8Cache[i].Resolution!=e.Resolution||a.EncodingsM3U8Cache[i].RequestTime<Date.now()-EncodingCacheTimeout)&&console.log(`Blocking ads (type:${i}, resolution:${e.Resolution}, frameRate:${e.FrameRate}, qualityOverride:${o})`),a.EncodingsM3U8Cache[i].RequestTime=Date.now(),a.EncodingsM3U8Cache[i].Value=t,a.EncodingsM3U8Cache[i].Resolution=e.Resolution;var d=P(t,e,o),v=await u(d);if(v.status==200){var n=await v.text();return WasShowingAd=!0,postMessage({key:"ShowAdBlockBanner"}),postMessage({key:"ForceChangeQuality"}),(!n||n.includes(AdSignifier))&&(a.EncodingsM3U8Cache[i].Value=null),n}else return a.EncodingsM3U8Cache[i].Value=null,r}function G(a,e){e||(e=["token","sig"]);for(var t=new URL("https://localhost/"+a),r=0;r<e.length;r++)t.searchParams.delete(e[r]);return t.pathname.substring(1)+t.search}async function I(a,e,t,r){var i=StreamInfosByUrl[a];if(IsSquadStream==!0||!e||!e.includes(".ts")&&!e.includes(".mp4"))return e;var u=e.includes(AdSignifier);if(u){var o=e.includes('"MIDROLL"')||e.includes('"midroll"');if(!o&&r===PlayerType2)for(var d=e.replace("\r","").split(`
`),v=0;v<d.length;v++){var n=d[v];if(n.startsWith("#EXTINF")&&d.length>v+1&&!n.includes(",live")&&!i.RequestedAds.has(d[v+1])){i.RequestedAds.add(d[v+1]),fetch(d[v+1]).then(y=>{y.blob()});break}}var l=null;if(i&&i.Urls){for(const[y,M]of Object.entries(i.Urls))if(y==a){l=M;break}}var s=i.EncodingsM3U8Cache[r];if(s){if(s.Value&&s.RequestTime>=Date.now()-EncodingCacheTimeout)try{var g=T(i,l,s.Value,null,r,t);if(g)return g}catch{s.Value=null}}else i.EncodingsM3U8Cache[r]={RequestTime:Date.now(),Value:null,Resolution:null};var p=await _(CurrentChannelName,r);if(p.status===200){var c=await p.json();try{var f=new URL("https://usher.ttvnw.net/api/channel/hls/"+CurrentChannelName+".m3u8"+UsherParams);f.searchParams.set("sig",c.data.streamPlaybackAccessToken.signature),f.searchParams.set("token",c.data.streamPlaybackAccessToken.value);var h=await t(f.href);return h.status===200?T(i,l,await h.text(),e,r,t):e}catch{}return e}else return e}else return WasShowingAd&&(console.log("Finished blocking ads"),WasShowingAd=!1,postMessage({key:"ForceChangeQuality",value:"original"}),postMessage({key:"PauseResumePlayer"}),postMessage({key:"HideAdBlockBanner"})),e;return e}function S(a){return Object.fromEntries(a.split(/(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))/).filter(Boolean).map(e=>{const t=e.indexOf("="),r=e.substring(0,t),i=e.substring(t+1),u=Number(i);return[r,Number.isNaN(u)?i.startsWith('"')?JSON.parse(i):i:u]}))}async function j(a){var e=a.match(/#EXT-X-DATERANGE:(ID="stitched-ad-[^\n]+)\n/);if(e.length>1){const l=e[1],s=S(l);var t=parseInt(s["X-TV-TWITCH-AD-POD-LENGTH"]?s["X-TV-TWITCH-AD-POD-LENGTH"]:"1"),r=parseInt(s["X-TV-TWITCH-AD-POD-POSITION"]?s["X-TV-TWITCH-AD-POD-POSITION"]:"0"),i=s["X-TV-TWITCH-AD-RADS-TOKEN"],u=s["X-TV-TWITCH-AD-LINE-ITEM-ID"],o=s["X-TV-TWITCH-AD-ORDER-ID"],d=s["X-TV-TWITCH-AD-CREATIVE-ID"],v=s["X-TV-TWITCH-AD-ADVERTISER-ID"],n=s["X-TV-TWITCH-AD-ROLL-TYPE"].toLowerCase();const g={stitched:!0,roll_type:n,player_mute:!0,player_volume:0,visible:!1};for(let p=0;p<t;p++){const c={...g,ad_id:v,ad_position:p,duration:0,creative_id:d,total_ads:t,order_id:o,line_item_id:u};await C(R("video_ad_impression",i,c));for(let f=0;f<4;f++)await C(R("video_ad_quartile_complete",i,{...c,quartile:f+1}));await C(R("video_ad_pod_complete",i,g))}}}function R(a,e,t){return[{operationName:"ClientSideAdEventHandling_RecordAdEvent",variables:{input:{eventName:a,eventPayload:JSON.stringify(t),radToken:e}},extensions:{persistedQuery:{version:1,sha256Hash:"7e6c69e6eb59f8ccb97ab73686f3d8b7d85a72a0298745ccd8bfc68e4054ca5b"}}}]}function _(a,e,t){var r=null,i='query PlaybackAccessToken_Template($login: String!, $isLive: Boolean!, $vodID: ID!, $isVod: Boolean!, $playerType: String!) {  streamPlaybackAccessToken(channelName: $login, params: {platform: "ios", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isLive) {    value    signature    __typename  }  videoPlaybackAccessToken(id: $vodID, params: {platform: "ios", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isVod) {    value    signature    __typename  }}';return r={operationName:"PlaybackAccessToken_Template",query:i,variables:{isLive:!0,login:a,isVod:!1,vodID:"",playerType:e}},C(r,t)}function C(a,e){ClientIntegrityHeader==null;var t=e||fetch;if(!GQLDeviceID)for(var r="abcdefghijklmnopqrstuvwxyz0123456789",i=r.length,u=0;u<32;u++)GQLDeviceID+=r.charAt(Math.floor(Math.random()*i));return t("https://gql.twitch.tv/gql",{method:"POST",body:JSON.stringify(a),headers:{"Client-ID":ClientID,"Client-Integrity":ClientIntegrityHeader,"Device-ID":GQLDeviceID,"X-Device-Id":GQLDeviceID,"Client-Version":ClientVersion,"Client-Session-Id":ClientSession,Authorization:AuthorizationHeader}})}function A(a,e,t,r,i){try{let g=function(c,f){if(c.stateNode&&f(c.stateNode))return c.stateNode;let h=c.child;for(;h;){const y=g(h,f);if(y)return y;h=h.sibling}return null},p=function(){var c=null,f=document.querySelector("#root");if(f&&f._reactRootContainer&&f._reactRootContainer._internalRoot&&f._reactRootContainer._internalRoot.current&&(c=f._reactRootContainer._internalRoot.current),c==null){var h=Object.keys(f).find(y=>y.startsWith("__reactContainer"));h!=null&&(c=f[h])}return c};var u=null,o=null,d=p();if(!d){console.log("Could not find react root");return}if(o=g(d,c=>c.setPlayerActive&&c.props&&c.props.mediaPlayerInstance),o=o&&o.props&&o.props.mediaPlayerInstance?o.props.mediaPlayerInstance:null,a){o.pause(),o.play();return}if(e){if(typeof o.getQuality()>"u")return;var v=JSON.stringify(o.getQuality());return v||void 0}if(r){if(typeof o.isAutoQualityMode()>"u")return!1;var n=o.isAutoQualityMode();return n?(o.setAutoQualityMode(!1),n):!1}if(i){o.setAutoQualityMode(!0);return}try{var l=document.URL,s=!0;(l.includes("videos/")||l.includes("clip/"))&&(s=!1),t&&s&&setTimeout(function(){(o.isLiveLowLatency()&&o.getLiveLatency()>5||o.getLiveLatency()>15)&&(o.pause(),o.play())},3e3)}catch{}}catch{}}window.reloadTwitchPlayer=A;var U=null;U=window.localStorage.getItem("local_copy_unique_id");function m(a,e){L.forEach(t=>{t.postMessage({key:a,value:e})})}function z(){var a=window.fetch;window.fetch=function(e,t,...r){if(typeof e=="string"&&(window.location.pathname.includes("/squad")?m("UpdateIsSquadStream",!0):m("UpdateIsSquadStream",!1),e.includes("/access_token")||e.includes("gql"))){var i=t.headers["X-Device-Id"];typeof i!="string"&&(i=t.headers["Device-ID"]),typeof i=="string"&&!i.includes("twitch-web-wall-mason")?GQLDeviceID=i:U&&(GQLDeviceID=U.replace('"',""),GQLDeviceID=GQLDeviceID.replace('"',"")),GQLDeviceID&&(typeof t.headers["X-Device-Id"]=="string"&&(t.headers["X-Device-Id"]=GQLDeviceID),typeof t.headers["Device-ID"]=="string"&&(t.headers["Device-ID"]=GQLDeviceID),m("UpdateDeviceId",GQLDeviceID));var u=t.headers["Client-Version"];u&&typeof u=="string"&&(ClientVersion=u),ClientVersion&&m("UpdateClientVersion",ClientVersion);var o=t.headers["Client-Session-Id"];if(o&&typeof o=="string"&&(ClientSession=o),ClientSession&&m("UpdateClientSession",ClientSession),e.includes("gql")&&t&&typeof t.body=="string"&&t.body.includes("PlaybackAccessToken")){var d=t.headers["Client-ID"];d&&typeof d=="string"?ClientID=d:(d=t.headers["Client-Id"],d&&typeof d=="string"&&(ClientID=d)),ClientID&&m("UpdateClientId",ClientID),ClientIntegrityHeader=t.headers["Client-Integrity"],ClientIntegrityHeader&&m("UpdateClientIntegrityHeader",ClientIntegrityHeader),AuthorizationHeader=t.headers.Authorization,AuthorizationHeader&&m("UpdateAuthorizationHeader",AuthorizationHeader)}e.includes("gql")&&t&&typeof t.body=="string"&&t.body.includes("PlaybackAccessToken")&&t.body.includes("picture-by-picture")&&(t.body="");var v=e.includes("picture-by-picture");v&&(e="")}return a.apply(this,arguments)}}function H(){try{Object.defineProperty(document,"visibilityState",{get(){return"visible"}})}catch{}try{Object.defineProperty(document,"hidden",{get(){return!1}})}catch{}var a=e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()};document.addEventListener("visibilitychange",a,!0),document.addEventListener("webkitvisibilitychange",a,!0),document.addEventListener("mozvisibilitychange",a,!0),document.addEventListener("hasFocus",a,!0);try{/Firefox/.test(navigator.userAgent)?Object.defineProperty(document,"mozHidden",{get(){return!1}}):Object.defineProperty(document,"webkitHidden",{get(){return!1}})}catch{}}E(window),B(),z(),document.readyState==="complete"||document.readyState==="loaded"||document.readyState==="interactive"?H():window.addEventListener("DOMContentLoaded",function(){H()})})();
