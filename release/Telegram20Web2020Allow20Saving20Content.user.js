// ==UserScript==
// @name         Telegram Web - Allow Saving Content
// @namespace    c0d3r
// @license      MIT
// @version      0.5
// @author       c0d3r
// @match        https://web.telegram.org/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=telegram.org
// @grant        unsafeWindow
// @grant        GM_addStyle
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Telegram20Web2020Allow20Saving20Content.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Telegram20Web2020Allow20Saving20Content.meta.js
// ==/UserScript==
function downloadMediaFromMessage(e){var t;e.media&&(t=e.media.document||e.media.photo),t&&unsafeWindow.appDownloadManager.downloadToDisc({media:t})}function slowDown(e,t,n,r,o){setTimeout(function(){n.disabled=!0,n.style.opacity=.6,r.textContent=".."+(e+1)+"..",o.textContent="\u{1F554}",downloadMediaFromMessage(t)},e*1e3)}async function downloadSingleMedia(e,t){var n=await unsafeWindow.mtprotoMessagePort.getMessageByPeer(e,t);downloadMediaFromMessage(n)}async function downloadSelectedMedia(){var e=await unsafeWindow.appImManager.chat.selection.getSelectedMessages(),t=0,n=document.querySelector("#batch-btn"),r=n.querySelector(".i18n"),o=n.querySelector(".mytgico");e.forEach(function(i,d){i.media&&(i.media.document||i.media.photo)&&(slowDown(t,i,n,r,o),t++),d===e.length-1&&setTimeout(function(){n.disabled=!1,n.style.opacity=1,r.textContent="D/L",o.textContent="\u{1F4E5}"},t*1e3)})}(function(){"use strict";if(window.location.pathname.startsWith("/a/"))window.location.replace(window.location.href.replace(".org/a/",".org/k/"));else{var e=document.querySelector("#column-center"),t=["photo","audio","video","voice-message","media-round","grouped-item","document-container","sticker"],n='<div class="btn-menu-item rp-overflow" id="down-btn"><span class="mytgico btn-menu-item-icon" style="font-size: 16px;">\u{1F4E5}</span><span class="i18n btn-menu-item-text">Download</span></div>',r='&nbsp;&nbsp;<button class="btn-primary btn-transparent text-bold" id="batch-btn" title="Download Media"><span class="mytgico" style="padding-bottom: 2px;">\u{1F4E5}</span>&nbsp;<span class="i18n">D/L</span></button>',o=!1,i,d,u;GM_addStyle(".no-forwards .bubbles, .bubble, .bubble-content { -webkit-user-select: text!important; -moz-user-select: text!important; user-select: text!important; }");var l=EventTarget.prototype.addEventListener;EventTarget.prototype.addEventListener=function(s){s!=="copy"&&l.apply(this,arguments)},e.addEventListener("mouseup",function(s){if(s.button===2&&(o=!1,document.querySelector(".no-forwards"))){var c=s.target.closest("[data-mid]");c&&t.some(function(a){return c.classList.contains(a)})&&(i=c.dataset.mid,d=c.dataset.peerId,o=!0)}}),u=new MutationObserver(function(s){s.forEach(function(c){c.addedNodes.forEach(function(a){a.id==="bubble-contextmenu"&&o&&(a.querySelector(".btn-menu-item").insertAdjacentHTML("beforebegin",n),a.querySelector("#down-btn").addEventListener("click",function(){downloadSingleMedia(d,i)})),a.classList&&a.classList.contains("selection-wrapper")&&(a.querySelector(".selection-container-left").insertAdjacentHTML("beforeend",r),a.querySelector("#batch-btn").addEventListener("click",function(){downloadSelectedMedia()}))})})}),u.observe(e,{subtree:!0,childList:!0})}})();
