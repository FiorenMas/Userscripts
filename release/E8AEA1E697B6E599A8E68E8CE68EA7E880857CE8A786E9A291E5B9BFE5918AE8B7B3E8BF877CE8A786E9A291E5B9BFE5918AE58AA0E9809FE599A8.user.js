// ==UserScript==
// @name            计时器掌控者|视频广告跳过|视频广告加速器
// @name:en         TimerHooker
// @namespace       https://gitee.com/HGJing/everthing-hook/
// @version         1.0.62
// @include         *
// @require         https://greasyfork.org/scripts/372672-everything-hook/code/Everything-Hook.js?version=881251
// @author          Cangshi
// @match           http://*/*
// @run-at          document-start
// @grant           none
// @license         GPL-3.0-or-later
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/E8AEA1E697B6E599A8E68E8CE68EA7E880857CE8A786E9A291E5B9BFE5918AE8B7B3E8BF877CE8A786E9A291E5B9BFE5918AE58AA0E9809FE599A8.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/E8AEA1E697B6E599A8E68E8CE68EA7E880857CE8A786E9A291E5B9BFE5918AE8B7B3E8BF877CE8A786E9A291E5B9BFE5918AE58AA0E9809FE599A8.meta.js
// ==/UserScript==
window.isDOMLoaded=!1,window.isDOMRendered=!1,document.addEventListener("readystatechange",function(){(document.readyState==="interactive"||document.readyState==="complete")&&(window.isDOMLoaded=!0)}),~function(h){var w=[],g=[],p={},m=function(r,n,l){return{applyUI:function(){var e="._th-container ._th-item{margin-bottom:3px;position:relative;width:0;height:0;cursor:pointer;opacity:.3;background-color:aquamarine;border-radius:100%;text-align:center;line-height:30px;-webkit-transition:all .35s;-o-transition:all .35s;transition:all .35s;right:30px}._th-container ._th-item,._th-container ._th-click-hover,._th_cover-all-show-times ._th_times{-webkit-box-shadow:-3px 4px 12px -5px black;box-shadow:-3px 4px 12px -5px black}._th-container:hover ._th-item._item-x2{margin-left:18px;width:40px;height:40px;line-height:40px}._th-container:hover ._th-item._item-x-2{margin-left:17px;width:38px;height:38px;line-height:38px}._th-container:hover ._th-item._item-xx2{width:36px;height:36px;margin-left:16px;line-height:36px}._th-container:hover ._th-item._item-xx-2{width:32px;height:32px;line-height:32px;margin-left:14px}._th-container:hover ._th-item._item-reset{width:30px;line-height:30px;height:30px;margin-left:10px}._th-click-hover{position:relative;-webkit-transition:all .5s;-o-transition:all .5s;transition:all .5s;height:45px;width:45px;cursor:pointer;opacity:.3;border-radius:100%;background-color:aquamarine;text-align:center;line-height:45px;right:0}._th-container:hover{left:-5px}._th-container{font-size:12px;-webkit-transition:all .5s;-o-transition:all .5s;transition:all .5s;left:-35px;top:20%;position:fixed;-webkit-box-sizing:border-box;box-sizing:border-box;z-index:100000;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}._th-container ._th-item:hover{opacity:.8;background-color:#5fb492;color:aliceblue}._th-container ._th-item:active{opacity:.9;background-color:#1b3a26;color:aliceblue}._th-container:hover ._th-click-hover{opacity:.8}._th-container:hover ._th-item{opacity:.6;right:0}._th-container ._th-click-hover:hover{opacity:.8;background-color:#5fb492;color:aliceblue}._th_cover-all-show-times{position:fixed;top:0;right:0;width:100%;height:100%;z-index:99999;opacity:1;font-weight:900;font-size:30px;color:#4f4f4f;background-color:rgba(0,0,0,0.1)}._th_cover-all-show-times._th_hidden{z-index:-99999;opacity:0;-webkit-transition:1s all;-o-transition:1s all;transition:1s all}._th_cover-all-show-times ._th_times{width:300px;height:300px;border-radius:50%;background-color:rgba(127,255,212,0.51);text-align:center;line-height:300px;position:absolute;top:50%;right:50%;margin-top:-150px;margin-right:-150px}",t=(1/n._percentage).toFixed(2),a=`<div class="_th-container">
    <div class="_th-click-hover _item-input">
        x`+t+`
    </div>
    <div class="_th-item _item-x2">&gt;</div>
    <div class="_th-item _item-x-2">&lt;</div>
    <div class="_th-item _item-xx2">&gt;&gt;</div>
    <div class="_th-item _item-xx-2">&lt;&lt;</div>
    <div class="_th-item _item-reset">O</div>
</div>
<div class="_th_cover-all-show-times _th_hidden">
    <div class="_th_times">x`+t+`</div>
</div>`,i=document.createElement("style");if(i.setAttribute("type","text/css"),i.styleSheet)i.styleSheet.cssText=e;else{var o=document.createTextNode(e);i.appendChild(o)}var s=document.createElement("div");s.innerHTML=a;var c={"_item-input":function(){changeTime()},"_item-x2":function(){changeTime(2,0,!0)},"_item-x-2":function(){changeTime(-2,0,!0)},"_item-xx2":function(){changeTime(0,2)},"_item-xx-2":function(){changeTime(0,-2)},"_item-reset":function(){changeTime(0,0,!1,!0)}};Object.keys(c).forEach(function(d){var f=c[d],v=s.getElementsByClassName(d)[0];v&&(v.onclick=f)}),h.isDOMLoaded?(document.head.appendChild(i),document.body.appendChild(s),h.isDOMRendered=!0,console.log("Time Hooker Works!")):document.addEventListener("readystatechange",function(){(document.readyState==="interactive"||document.readyState==="complete")&&!h.isDOMRendered&&(document.head.appendChild(i),document.body.appendChild(s),h.isDOMRendered=!0,console.log("Time Hooker Works!"))})},applyGlobalAction:function(e){e.changeTime=function(t,a,i,o){if(o){h.timer.change(1);return}if(h.timer){var s;if(!t&&!a){var c=prompt("\u8F93\u5165\u6B32\u6539\u53D8\u8BA1\u65F6\u5668\u53D8\u5316\u500D\u7387\uFF08\u5F53\u524D\uFF1A"+1/n._percentage+"\uFF09");if(c==null)return;if(isNaN(parseFloat(c))){alert("\u8BF7\u8F93\u5165\u6B63\u786E\u7684\u6570\u5B57"),e.changeTime();return}if(parseFloat(c)<=0){alert("\u500D\u7387\u4E0D\u80FD\u5C0F\u4E8E\u7B49\u4E8E0"),e.changeTime();return}s=1/parseFloat(c)}else if(i&&t){if(1/n._percentage<=1&&t<0)return;s=1/(1/n._percentage+t)}else a<=0&&(a=1/-a),s=1/(1/n._percentage*a);e.change(s)}},h.changeTime=e.changeTime},applyHooking:function(){var e=this;r.hookReplace(window,"setInterval",function(i){return e.getHookedTimerFunction("interval",i)}),r.hookReplace(window,"setTimeout",function(i){return e.getHookedTimerFunction("timeout",i)}),r.hookBefore(window,"clearInterval",function(i,o){e.redirectNewestId(o)}),r.hookBefore(window,"clearTimeout",function(i,o){e.redirectNewestId(o)});var t=this.getHookedDateConstructor();r.hookClass(window,"Date",t,"_innerDate",["now"]),Date.now=function(){return new Date().getTime()},r.hookedToString(n._Date.now,Date.now);var a=Object.prototype.toString;Object.prototype.toString=function(){"use strict";return this instanceof n._mDate?"[object Date]":a.call(this)},r.hookedToString(a,Object.prototype.toString),r.hookedToString(n._setInterval,setInterval),r.hookedToString(n._setTimeout,setTimeout),r.hookedToString(n._clearInterval,clearInterval),n._mDate=window.Date,this.hookShadowRoot()},getHookedDateConstructor:function(){return function(){if(arguments.length===1){Object.defineProperty(this,"_innerDate",{configurable:!1,enumerable:!1,value:new n._Date(arguments[0]),writable:!1});return}else if(arguments.length>1){var e;switch(arguments.length){case 2:e=new n._Date(arguments[0],arguments[1]);break;case 3:e=new n._Date(arguments[0],arguments[1],arguments[2]);break;case 4:e=new n._Date(arguments[0],arguments[1],arguments[2],arguments[3]);break;case 5:e=new n._Date(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4]);break;case 6:e=new n._Date(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5]);break;default:case 7:e=new n._Date(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6]);break}Object.defineProperty(this,"_innerDate",{configurable:!1,enumerable:!1,value:e,writable:!1});return}var t=n._Date.now(),a=t-n.__lastDatetime,i=a*(1/n._percentage);Object.defineProperty(this,"_innerDate",{configurable:!1,enumerable:!1,value:new n._Date(n.__lastMDatetime+i),writable:!1})}},getHookedTimerFunction:function(e,t){var a="_"+e+"Ids";return function(){var i=n.genUniqueId(),o=arguments[0];typeof o=="string"&&(o+=";timer.notifyExec("+i+")",arguments[0]=o),typeof o=="function"&&(arguments[0]=function(){var d=o.apply(this,arguments);return n.notifyExec(i),d});var s=arguments[1];arguments[1]*=n._percentage;var c=t.apply(window,arguments);return n[a][c]={args:arguments,originMS:s,originId:c,nowId:c,uniqueId:i,oldPercentage:n._percentage,exceptNextFireTime:n._Date.now()+s},c}},redirectNewestId:function(e){var t=e[0];n._intervalIds[t]&&(e[0]=n._intervalIds[t].nowId,delete n._intervalIds[t]),n._timeoutIds[t]&&(e[0]=n._timeoutIds[t].nowId,delete n._timeoutIds[t])},registerShortcutKeys:function(e){addEventListener("keydown",function(t){switch(t.keyCode){case 57:(t.ctrlKey||t.altKey)&&e.changeTime();break;case 190:case 187:{t.ctrlKey?e.changeTime(2,0,!0):t.altKey&&e.changeTime(0,2);break}case 188:case 189:{t.ctrlKey?e.changeTime(-2,0,!0):t.altKey&&e.changeTime(0,-2);break}case 48:{(t.ctrlKey||t.altKey)&&e.changeTime(0,0,!1,!0);break}default:}})},percentageChangeHandler:function(e){l.ergodicObject(n,n._intervalIds,function(t,a){t.args[1]=Math.floor((t.originMS||1)*e),this._clearInterval.call(window,t.nowId),t.nowId=this._setInterval.apply(window,t.args)}),l.ergodicObject(n,n._timeoutIds,function(t,a){var i=this._Date.now(),o=t.exceptNextFireTime,s=t.oldPercentage,c=o-i;c<0&&(c=0);var d=Math.floor(e/s*c);t.args[1]=d,t.exceptNextFireTime=i+d,t.oldPercentage=e,this._clearTimeout.call(window,t.nowId),t.nowId=this._setTimeout.apply(window,t.args)})},hookShadowRoot:function(){var e=Element.prototype.attachShadow;r.hookAfter(Element.prototype,"attachShadow",function(t,a,i){return g.push(i),i},!1),r.hookedToString(e,Element.prototype.attachShadow)},hookDefine:function(){const e=this;r.hookBefore(Object,"defineProperty",function(t,a){var i=a[2],o=a[0],s=a[1],c=e.hookDefineDetails(o,s,i);c.forEach((d,f)=>{a[f]=d})}),r.hookBefore(Object,"defineProperties",function(t,a){var i=a[1],o=a[0];o&&o instanceof Element&&Object.keys(i).forEach(s=>{var c=i[s],d=e.hookDefineDetails(o,s,c);a[0]=d[0],delete i[s],i[d[1]]=d[2]})})},hookDefineDetails:function(e,t,a){return a&&e&&e instanceof Element&&typeof t=="string"&&t.indexOf("on")>=0&&(a.configurable=!0),e instanceof HTMLVideoElement&&t==="playbackRate"&&(a.configurable=!0,console.warn("[Timer Hook]","\u5DF2\u963B\u6B62\u9ED8\u8BA4\u64CD\u4F5C\u89C6\u9891\u500D\u7387"),t="playbackRate_hooked"),[e,t,a]},suppressEvent:function(e,t){e&&(delete e["on"+t],delete e["on"+t],delete e["on"+t],e["on"+t]=void 0),p[t]||(r.hookBefore(EventTarget.prototype,"addEventListener",function(a,i){var o=i[0];t===o&&(console.warn(t,"event suppressed."),i[0]+="suppressed")},!1),p[t]=!0)},changePlaybackRate:function(e,t){delete e.playbackRate,delete e.playbackRate,delete e.playbackRate,e.playbackRate=t,t!==1&&n.defineProperty.call(Object,e,"playbackRate",{configurable:!0,get:function(){return 1},set:function(){}})}}},u={isInIframe:function(){let r=h.parent!==h;try{r=r&&h.parent.document.body.tagName!=="FRAMESET"}catch{}return r},listenParentEvent:function(r){h.addEventListener("message",function(n){var l=n.data,e=l.type||"";e==="changePercentage"&&r(l.percentage||0)})},sentChangesToIframe:function(r){var n=document.querySelectorAll("iframe")||[],l=document.querySelectorAll("frame");if(n.length)for(var e=0;e<n.length;e++)n[e].contentWindow.postMessage({type:"changePercentage",percentage:r},"*");if(l.length)for(var t=0;t<l.length;t++)l[t].contentWindow.postMessage({type:"changePercentage",percentage:r},"*")}},_=function(r,n,l){var e=r.querySelectorAll(n);return e=Array.prototype.slice.call(e||[]),l&&g.forEach(function(t){e=e.concat(_(t,n,!1))}),e},y=function(){return function(r){w.forEach(function(e){r.urlMatching(location.href,"http.*://.*"+e+".*")&&(window.Worker=void 0,console.log("Worker disabled"))});var n=this,l={_intervalIds:{},_timeoutIds:{},_auoUniqueId:1,__percentage:1,_setInterval:window.setInterval,_clearInterval:window.clearInterval,_clearTimeout:window.clearTimeout,_setTimeout:window.setTimeout,_Date:window.Date,__lastDatetime:new Date().getTime(),__lastMDatetime:new Date().getTime(),videoSpeedInterval:1e3,defineProperty:Object.defineProperty,defineProperties:Object.defineProperties,genUniqueId:function(){return this._auoUniqueId++},notifyExec:function(e){var t=this;if(e){var a=Object.values(this._timeoutIds).filter(function(i){return i.uniqueId===e});a.forEach(function(i){t._clearTimeout.call(window,i.nowId),delete t._timeoutIds[i.originId]})}},init:function(){var e=this,t=m(n,e,r);t.hookDefine(),t.applyHooking(),Object.defineProperty(e,"_percentage",{get:function(){return e.__percentage},set:function(a){return a===e.__percentage||(t.percentageChangeHandler(a),e.__percentage=a),a}}),u.isInIframe()?(console.log("[TimeHooker]","loading inner window..."),u.listenParentEvent(function(a){console.log("[TimeHooker]","Inner Changed",a),this.change(a)}.bind(this))):(console.log("[TimeHooker]","loading outer window..."),t.applyUI(),t.applyGlobalAction(e),t.registerShortcutKeys(e))},change:function(e){this.__lastMDatetime=this._mDate.now(),this.__lastDatetime=this._Date.now(),this._percentage=e;var t=document.getElementsByClassName("_th-click-hover"),a=document.getElementsByClassName("_th_times"),i=(1/this._percentage).toFixed(2);(t[0]||{}).innerHTML="x"+i,(a[0]||{}).innerHTML="x"+i;var o=document.getElementsByClassName("_th_cover-all-show-times")[0]||{};o.className="_th_cover-all-show-times",this._setTimeout.bind(window)(function(){o.className="_th_cover-all-show-times _th_hidden"},100),this.changeVideoSpeed(),u.sentChangesToIframe(e)},changeVideoSpeed:function(){var e=this,t=m(n,e,r),a=1/this._percentage;a>16&&(a=16),a<.065&&(a=.065);var i=_(document,"video",!0)||[];if(i.length)for(var o=0;o<i.length;o++)t.changePlaybackRate(i[o],a)}};return l.init(),l}};h.eHook&&h.eHook.plugins({name:"timer",mount:y()})}(window);
