// ==UserScript==
// @name        Lazyloadfier Userscript
// @namespace   Lazyloadfier Userscript - Violentmonkey Scripts
// @match       *://*/*
// @grant       none
// @version     1.0
// @run-at      document-start
// @author      -
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Lazyloadfier20Userscript.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Lazyloadfier20Userscript.meta.js
// ==/UserScript==
const SRC_ATTRIBUTE_NAME="src",SRCSET_ATTRIBUTE_NAME="srcset",POSTER_ATTRIBUTE_NAME="poster",LOADING_ATTRIBUTE_NAME="loading",LAZY_LOADING_ATTRIBUTE_VALUE="lazy",IMG_TAG_NAME="IMG",VIDEO_TAG_NAME="VIDEO",AUDIO_TAG_NAME="AUDIO",SOURCE_TAG_NAME="SOURCE",IFRAME_TAG_NAME="IFRAME",FRAME_TAG_NAME="FRAME",EMBED_TAG_NAME="EMBED",TAG_NAMES_WITH_SRC_ATTRIBUTE=new Set([IMG_TAG_NAME,VIDEO_TAG_NAME,AUDIO_TAG_NAME,SOURCE_TAG_NAME,IFRAME_TAG_NAME,FRAME_TAG_NAME,EMBED_TAG_NAME]),TAG_NAMES_WITH_SRCSET_ATTRIBUTE=new Set([IMG_TAG_NAME,SOURCE_TAG_NAME]),TAG_NAMES_WITH_POSTER_ATTRIBUTE=new Set([VIDEO_TAG_NAME]),OBSERVED_TAGS_SELECTOR=Array.from(TAG_NAMES_WITH_SRC_ATTRIBUTE).join(","),UNSENT_READY_STATE=0,DOM_CONTENT_LOADED_EVENT="DOMContentLoaded",EMPTY_DEFAULT_DATA_URI="data:,",EMPTY_IMAGE_DATA_URI="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==",EMPTY_TEXT_DATA_URI="data:text/plain,",EMPTY_DATA_URI=new Map([[VIDEO_TAG_NAME,EMPTY_DEFAULT_DATA_URI],[AUDIO_TAG_NAME,EMPTY_DEFAULT_DATA_URI],[SOURCE_TAG_NAME,EMPTY_IMAGE_DATA_URI],[IMG_TAG_NAME,EMPTY_IMAGE_DATA_URI],[IFRAME_TAG_NAME,EMPTY_TEXT_DATA_URI],[FRAME_TAG_NAME,EMPTY_TEXT_DATA_URI],[EMBED_TAG_NAME,EMPTY_TEXT_DATA_URI]]),MUTATION_OBSERVER_OPTIONS={childList:!0,subtree:!0},MINIMUM_INTERSECTION_RATIO=0,MUTATION_OBSERVER_TIMEOUT=2500;observeDocumentMutations();function observeDocumentMutations(){const t={},e=new MutationObserver(A=>mutationObserverCallback(A,n));e.observe(document,MUTATION_OBSERVER_OPTIONS),addEventListener(DOM_CONTENT_LOADED_EVENT,n);function n(){deferDisconnectObserver(e,t)}}function deferDisconnectObserver(t,e){e.id&&clearTimeout(e.id),e.id=setTimeout(()=>t.disconnect(),MUTATION_OBSERVER_TIMEOUT)}function mutationObserverCallback(t,e){const n=getObservedNodes(t);n.length&&(n.forEach(observeNodeIntersection),e(n))}function getObservedNodes(t){const e=[];return t.forEach(n=>{const A=new Set(n.addedNodes);A.forEach(s=>{s.querySelectorAll&&s.querySelectorAll(OBSERVED_TAGS_SELECTOR).forEach(c=>A.add(c))}),e.splice(0,0,...Array.from(A).filter(matchObservedNode))}),e}function matchObservedNode(t){return TAG_NAMES_WITH_SRC_ATTRIBUTE.has(t.tagName)&&nodeIsHidden(t)&&t[LOADING_ATTRIBUTE_NAME]!=LAZY_LOADING_ATTRIBUTE_VALUE}function nodeIsHidden(t){const e=t.getBoundingClientRect();return e.bottom<0||e.top>innerHeight||e.left<0||e.right>innerWidth}function observeNodeIntersection(t){const e=resetSource(t,SRC_ATTRIBUTE_NAME),n=resetSource(t,SRCSET_ATTRIBUTE_NAME),A=resetSource(t,POSTER_ATTRIBUTE_NAME);new IntersectionObserver((c,o)=>intersectionObserverCallback(c,t,o,{src:e,srcset:n,poster:A})).observe(t.tagName==SOURCE_TAG_NAME?t.parentElement:t)}function intersectionObserverCallback(t,e,n,A){const s=t[0];s&&s.intersectionRatio>MINIMUM_INTERSECTION_RATIO&&(replaceSource(e,A),n.disconnect())}function replaceSource(t,e){setSource(t,SRC_ATTRIBUTE_NAME,e.src),TAG_NAMES_WITH_SRCSET_ATTRIBUTE.has(t.tagName)&&setSource(t,SRCSET_ATTRIBUTE_NAME,e.srcset),TAG_NAMES_WITH_POSTER_ATTRIBUTE.has(t.tagName)&&setSource(t,POSTER_ATTRIBUTE_NAME,e.poster)}function resetSource(t,e){const n=t[e];if(n)return t[e]=EMPTY_DATA_URI.get(t.tagName),n}function setSource(t,e,n){t[e]==EMPTY_DATA_URI.get(t.tagName)&&(n?t[e]=n:(t.removeAttribute(e),t.readyState===UNSENT_READY_STATE&&t.load()))}
