// ==UserScript==
// @name        Pixiv Plus
// @namespace   https://github.com/Ahaochan/Tampermonkey
// @version     0.9.2
// @icon        https://www.pixiv.net/favicon.ico
// @author      Ahaochan
// @include     http*://www.pixiv.net*
// @match       http://www.pixiv.net/
// @connect     i.pximg.net
// @connect     i-f.pximg.net
// @connect     i-cf.pximg.net
// @license     GPL-3.0
// @supportURL  https://github.com/Ahaochan/Tampermonkey
// @grant       unsafeWindow
// @grant       GM.xmlHttpRequest
// @grant       GM.setClipboard
// @grant       GM.setValue
// @grant       GM.getValue
// @grant       GM_addStyle
// @grant       GM_xmlhttpRequest
// @grant       GM_registerMenuCommand
// @grant       GM_unregisterMenuCommand
// @grant       GM_setClipboard
// @grant       GM_setValue
// @grant       GM_getValue
// @require     https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/2.2.4/jquery.min.js
// @require     https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/jszip/3.1.4/jszip.min.js
// @require     https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/FileSaver.js/1.3.2/FileSaver.min.js
// @require     https://greasyfork.org/scripts/2963-gif-js/code/gifjs.js?version=8596
// @require     https://greasyfork.org/scripts/375359-gm4-polyfill-1-0-1/code/gm4-polyfill-101.js?version=652238
// @run-at      document-end
// @noframes
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Pixiv20Plus.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Pixiv20Plus.meta.js
// ==/UserScript==
jQuery(i=>{"use strict";i.fn.extend({fitWindow(){this.css("width","auto").css("height","auto").css("max-width","").css("max-height",i(window).height())},replaceTagName(e){const n=[];let r=this.length;for(;r--;){const a=document.createElement(e),t=this[r],o=t.attributes;for(let s=o.length-1;s>=0;s--){const c=o[s];a.setAttribute(c.name,c.value)}a.innerHTML=t.innerHTML,i(t).after(a).remove(),n[r]=a}return i(n)},getBackgroundUrl(){const e=[];return this.each(function(n,{style:r}){let a=i(this).css("background-image")||r.backgroundImage||'url("")';const t=a.match(/url\((['"])(.*?)\1\)/);a=t&&t.length>=2?t[2]:"",e.push(a)}),e.length===1?e[0]:e}});const N={ja:{author:"\u4F5C\u8005",background:"\u80CC\u666F\u753B\u50CF",background_not_found:"\u80CC\u666F\u753B\u50CF\u306A\u3057",copy_to_clipboard:"\u30AF\u30EA\u30C3\u30D7\u30DC\u30FC\u30C9\u306B\u30B3\u30D4\u30FC\u3057\u307E\u3057\u305F",download:"\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9",download_wait:"\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u5B8C\u4E86\u3092\u304A\u5F85\u3061\u304F\u3060\u3055\u3044",illegal:"\u9055\u6CD5",illust_type_single:"[\u5358\u679A]",illust_type_multiple:"[\u8907\u6570\u679A]",illust_type_gif:"[GIF\u753B\u50CF]",loginWarning:"Pixiv\u62E1\u5F35\u30B9\u30AF\u30EA\u30D7\u30C8\u8B66\u544A\uFF01\u3088\u308A\u826F\u3044\u4F53\u9A13\u306E\u305F\u3081\u306BPixiv\u306B\u30ED\u30B0\u30A4\u30F3\u3057\u3066\u304F\u3060\u3055\u3044\uFF01\u672A\u30ED\u30B0\u30A4\u30F3\u306E\u5834\u5408\u3001\u4E88\u671F\u3057\u306A\u3044\u30D0\u30B0\u304C\u767A\u751F\u3059\u308B\u53EF\u80FD\u6027\u304C\u3042\u308A\u307E\u3059\uFF01",switch_antiAd:"\u5E83\u544A\u7121\u52B9\u5316",switch_antiRedirect:"\u30EA\u30C0\u30A4\u30EC\u30AF\u30C8\u89E3\u9664",switch_commentLoad:"\u30B3\u30E1\u30F3\u30C8\u8AAD\u307F\u8FBC\u307F",switch_imageSize:"\u753B\u50CF\u30B5\u30A4\u30BA\u8868\u793A",switch_preDownload:"\u753B\u50CF\u3092\u4E8B\u524D\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9",switch_searchUid:"UID\u691C\u7D22",switch_searchPid:"PID\u691C\u7D22",switch_searchAuthor:"\u4F5C\u8005\u691C\u7D22",switch_searchFavourite:"users\u5165\u308A\u691C\u7D22"},en:{author:"Author",background:"Background Image",background_not_found:"No Background Image",copy_to_clipboard:"Copied to clipboard",download:"Download",download_wait:"Please wait for download to complete",illegal:"Illegal",illust_type_single:"[Single Image]",illust_type_multiple:"[Multiple Images]",illust_type_gif:"[GIF Image]",loginWarning:"Pixiv Plus Script Warning! Please login to Pixiv for a better experience! Failure to login may result in unpredictable bugs!",switch_antiAd:"Disable Ads",switch_antiRedirect:"Cancel Redirection",switch_commentLoad:"Load Comments",switch_imageSize:"Show Image Size",switch_preDownload:"Pre-download Images",switch_searchUid:"Search UID",switch_searchPid:"Search PID",switch_searchAuthor:"Search Author",switch_searchFavourite:"Search users\u5165\u308A (user bookmarks)"},zh:{author:"\u4F5C\u8005",background:"\u80CC\u666F\u56FE",background_not_found:"\u65E0\u80CC\u666F\u56FE",copy_to_clipboard:"\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F",download:"\u4E0B\u8F7D",download_wait:"\u8BF7\u7B49\u5F85\u4E0B\u8F7D\u5B8C\u6210",illegal:"\u4E0D\u5408\u6CD5",illust_type_single:"[\u5355\u56FE]",illust_type_multiple:"[\u591A\u56FE]",illust_type_gif:"[gif\u56FE]",loginWarning:"Pixiv\u589E\u5F3A \u811A\u672C\u8B66\u544A! \u8BF7\u767B\u5F55Pixiv\u83B7\u5F97\u66F4\u597D\u7684\u4F53\u9A8C! \u672A\u767B\u5F55\u53EF\u80FD\u4EA7\u751F\u4E0D\u53EF\u9884\u6599\u7684bug!",switch_antiAd:"\u7981\u7528\u5E7F\u544A",switch_antiRedirect:"\u53D6\u6D88\u91CD\u5B9A\u5411",switch_commentLoad:"\u52A0\u8F7D\u8BC4\u8BBA",switch_imageSize:"\u663E\u793A\u56FE\u7247\u5C3A\u5BF8",switch_preDownload:"\u9884\u4E0B\u8F7D\u56FE\u7247",switch_searchUid:"\u641C\u7D22uid",switch_searchPid:"\u641C\u7D22pid",switch_searchAuthor:"\u641C\u7D22\u4F5C\u8005",switch_searchFavourite:"\u641C\u7D22users\u5165\u308A"},"zh-cn":{},"zh-tw":{author:"\u4F5C\u8005",background:"\u80CC\u666F\u5716",background_not_found:"\u7121\u80CC\u666F\u5716",copy_to_clipboard:"\u5DF2\u8907\u88FD\u5230\u526A\u8CBC\u7C3F",download:"\u4E0B\u8F09",download_wait:"\u8ACB\u7B49\u5F85\u4E0B\u8F09\u5B8C\u6210",illegal:"\u4E0D\u5408\u6CD5",illust_type_single:"[\u55AE\u5716]",illust_type_multiple:"[\u591A\u5716]",illust_type_gif:"[gif\u5716]",loginWarning:"Pixiv\u589E\u5F37 \u8173\u672C\u8B66\u544A! \u8ACB\u767B\u5165Pixiv\u7372\u5F97\u66F4\u597D\u7684\u9AD4\u9A57! \u672A\u767B\u5165\u53EF\u80FD\u7522\u751F\u4E0D\u53EF\u9810\u6599\u7684bug!",switch_antiAd:"\u7981\u7528\u5EE3\u544A",switch_antiRedirect:"\u53D6\u6D88\u91CD\u5B9A\u5411",switch_commentLoad:"\u8F09\u5165\u8A55\u8AD6",switch_imageSize:"\u986F\u793A\u5716\u7247\u5C3A\u5BF8",switch_preDownload:"\u9810\u4E0B\u8F09\u5716\u7247",switch_searchUid:"\u641C\u5C0Buid",switch_searchPid:"\u641C\u5C0Bpid",switch_searchAuthor:"\u641C\u5C0B\u4F5C\u8005",switch_searchFavourite:"\u641C\u5C0Busers\u5165\u308A"}};N["zh-cn"]=Object.assign({},N.zh);const B=(document.documentElement.getAttribute("lang")||"en").toLowerCase(),u=e=>N[B][e]||`i18n[${B}][${e}] not found`,F=!0,[C,R]=[F?console.log:()=>{},console.error],p={antiAd:{type:"checkbox"},antiRedirect:{type:"checkbox"},commentLoad:{type:"checkbox"},imageSize:{type:"checkbox"},preDownload:{type:"checkbox"},searchUid:{type:"checkbox"},searchPid:{type:"checkbox"},searchAuthor:{type:"checkbox"},searchFavourite:{type:"checkbox"}};let M={};const D=e=>((!M||String(M.userId)!==String(e))&&i.ajax({url:`/ajax/user/${e}`,dataType:"json",async:!1,success:({body:n})=>{M=n}}),M);let P={};const f=()=>{const e=location.href.match(/artworks\/(\d*)(#\d*)?$/)?.[1]||"";return(!P||String(P?.illustId)!==String(e))&&i.ajax({url:`/ajax/illust/${e}`,dataType:"json",async:!1,success:({body:n})=>{P=n}}),P},g=function(e){const n={callback:()=>{},node:document.body,option:{childList:!0,subtree:!0}};let r;typeof e=="function"?r={...n,callback:e}:(r=Object.assign({},n,e),r.node=r.node||document.body);const a=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,t=new a((o,s)=>{r.callback.call(this,o,s)});try{t.observe(r.node,r.option)}catch(o){throw console.error("MutationObserver \u521D\u59CB\u5316\u5931\u8D25:",o),new Error("MutationObserver \u521D\u59CB\u5316\u5931\u8D25")}return t},U={downloadName:"download-name"},O=()=>/.+artworks\/\d+.*/.test(location.href),S=()=>/.+\/users\/\d+.*/.test(location.href),W=()=>/.+\/member_illust\.php\?id=\d+/.test(location.href),V=()=>/.+\/bookmark\.php\?id=\d+/.test(location.href),q=()=>/.+\/mypixiv_all\.php\?id=\d+/.test(location.href),H=()=>/.+\/stacc.+/.test(location.href),ct=()=>S()||W()||V()||q(),lt=()=>/.+\/search\.php.*/.test(location.href)||/.+\/tags\/.*\/artworks.*/.test(location.href),Q=()=>f().pageCount>1,J=()=>f().illustType===2,dt=()=>(f().illustType===0||f().illustType===1)&&f().pageCount===1;(()=>{let e=0;return i.ajax({url:"https://www.pixiv.net/setting_user.php",async:!1}).done((n,r,a)=>e=a.status),e===200})()||alert(u("loginWarning"));const K=()=>{i(".ad").remove(),i("._premium-lead-tag-search-bar").hide(),i(".popular-introduction-overlay").hide(),i(".ad-footer").remove();const e=["iframe","._premium-lead-promotion-banner",'a[href="/premium/lead/lp/?g=anchor&i=popular_works_list&p=popular&page=visitor"]','a[href="/premium/lead/lp/?g=anchor&i=work_detail_remove_ads"]'];return g((n,r)=>{for(const a of n)for(const t of a.addedNodes)if(t.nodeType===Node.ELEMENT_NODE)for(const o of e)i(t).find(o).hide()})},Z=()=>{C("\u641C\u7D22\u589E\u5F3A \u521D\u59CB\u5316");let e=i("form:not([action]) > div.charcoal-text-field-root").parent("form");e.length||(e=i('#js-mount-point-header form:not([action]), #root div[style="position: static; z-index: auto;"] form:not([action])')),e.find("div.charcoal-text-field-root").length>0?e.parent().parent().css({"grid-template-columns":"1fr minmax(0px, 319px) minmax(0px, 319px) minmax(0px, 438px) minmax(0px, 438px) minmax(0px, 219px) 2fr",gap:"10px"}):e.parent().parent().css("grid-template-columns","1fr minmax(0px, 219px) minmax(0px, 219px) minmax(0px, 538px) minmax(0px, 538px) minmax(0px, 219px) 2fr");const r=a=>{const t=Object.assign({$form:null,field:"\u641C\u7D22\u5B57\u6BB5",placeholder:"\u8BF7\u8F93\u5165",template:"***",validNumber:!1},a);t.$form||R(`\u641C\u7D22\u7EC4\u4EF6[${t.field}]\u521D\u59CB\u5316\u5931\u8D25, form\u5143\u7D20\u83B7\u53D6\u5931\u8D25`);const o=t.$form.parent().clone(),s=o.find("form");s.children("div").eq(1).remove(),s.attr("class",`ahao-search-${t.field}`),t.$form.parent().before(o);const c=s.find('input[type="text"]:first');c.attr("placeholder",t.placeholder),c.attr("value",""),c.val(""),s.submit(l=>{l.preventDefault();const d=encodeURIComponent(c.val());if(t.validNumber&&!/^[0-9]+$/.test(d)){const w=t.placeholder+u("illegal");alert(w);return}const m=t.template.replaceAll("***",d);window.open(m),c.val("")})};if(p.searchUid.isEnable()&&r({$form:e,field:"UID",placeholder:"UID",template:"https://www.pixiv.net/users/***",validNumber:!0}),p.searchPid.isEnable()&&r({$form:e,field:"PID",placeholder:"PID",template:"https://www.pixiv.net/artworks/***",validNumber:!0}),p.searchAuthor.isEnable()&&r({$form:e,field:u("author"),placeholder:u("author"),template:"https://www.pixiv.net/search_user.php?nick=***&s_mode=s_usr",validNumber:!1}),p.searchFavourite.isEnable()){const a=e.find('input[type="text"]:first'),t=i(`
                    <select id="select-ahao-favorites">
                        <option value=""></option>
                        <option value="50000users\u5165\u308A">50000users\u5165\u308A</option>
                        <option value="30000users\u5165\u308A">30000users\u5165\u308A</option>
                        <option value="20000users\u5165\u308A">20000users\u5165\u308A</option>
                        <option value="10000users\u5165\u308A">10000users\u5165\u308A</option>
                        <option value="5000users\u5165\u308A" > 5000users\u5165\u308A</option>
                        <option value="1000users\u5165\u308A" > 1000users\u5165\u308A</option>
                        <option value="500users\u5165\u308A"  >  500users\u5165\u308A</option>
                        <option value="300users\u5165\u308A"  >  300users\u5165\u308A</option>
                        <option value="100users\u5165\u308A"  >  100users\u5165\u308A</option>
                        <option value="50users\u5165\u308A"   >   50users\u5165\u308A</option>
                    </select>`);t.on("change",()=>{a.val()&&e.submit()}),e.parent().after(t),e.submit(o=>{o.preventDefault(),t.val()&&(a.val((c,l)=>l.split(" ").filter(d=>!!d&&!/users入り$/.test(d)).join(" ")),a.val((c,l)=>`${l} ${t.val()}`));const s=encodeURIComponent(a.val());s&&(/\/tags\/(.*?)\/artworks/.test(location.href)?location.href=location.href.replace(/\/tags\/(.*?)\/artworks/g,`/tags/${s}/artworks`):location.href=`https://www.pixiv.net/tags/${s}/artworks?s_mode=s_tag`)})}},E=e=>{if(!p.imageSize.isEnable())return;const n=Object.assign({$:void 0,position:"relative"},e),r=n.$,a=n.position;let t=r.next("span");t.length<=0&&(t=i(`<span class="ahao-img-size" style="position: ${a}; right: 0; top: 28px;
                    color: #ffffff; font-size: x-large; font-weight: bold; -webkit-text-stroke: 1.0px #000000;"></span>`),r.before(t));const o=r.prop("tagName").toLowerCase();if(o==="img"){const s=new Image;s.src=r.attr("src"),s.onload=function(){t.text(`${this.width}x${this.height}`)}}else if(o==="canvas"){const s=r.attr("width")||r.css("width").replace("px","")||r.css("max-width").replace("px","")||0,c=r.attr("height")||r.css("height").replace("px","")||r.css("max-height").replace("px","")||0;t.text(`${s}x${c}`)}else t.text(`${o}\u6682\u4E0D\u652F\u6301\u83B7\u53D6\u56FE\u7247\u5927\u5C0F`)},T=e=>{const n=Object.assign({$shareButtonContainer:void 0,id:"",text:"",clickFun:()=>{}},e),r=n.$shareButtonContainer.clone();return r.addClass("ahao-download-btn").attr("id",n.id).removeClass(n.$shareButtonContainer.attr("class")).css("margin-right","10px").css("position","relative").css("border","1px solid").css("padding","1px 10px").append(`<p style="display: inline">${n.text}</p>`),r.find("button").css("transform","rotate(180deg)").on("click",n.clickFun),n.$shareButtonContainer.after(r),r},L=e=>{const n=f();return e=e.replace("{pid}",n.illustId),e=e.replace("{uid}",n.userId),e=e.replace("{pname}",n.illustTitle),e=e.replace("{uname}",n.userName),e},X=()=>{g({callback(n,r){for(const a of n)for(const t of a.addedNodes){let o=i(t).filter('img[src^="https://i.pximg.net/img-master"]');o.length===0&&(o=i(t).find('img[src^="https://i.pximg.net/img-master"]')),o.attr("ahao-done",!0),o.each(function(){const s=i(this),c=s.parent("a").attr("href"),l=o.parent("a").attr("class")==="gtm-expand-full-size-illust";(c?.endsWith("jpg")||c?.endsWith("png"))&&(s.attr("src",c).css("filter","none"),s.fitWindow(),E({$:s,position:l?"relative":"absolute"}))})}},option:{attributes:!0,childList:!0,subtree:!0,attributeFilter:["src","href"]}})},Y=()=>{g({callback:(n,r)=>{for(const a of n)for(const t of a.addedNodes){const o=i(t).find('div:has(> button[class^="style_transparentButton"]):eq(1)');if(o.length<=0)continue;const s=new JSZip;let c=0;const l=f(),d=l.pageCount,m=l.urls.original,w=Array(parseInt(d)).fill().map((h,b)=>m.replace(/_p\d\./,`_p${b}.`)),x=T({$shareButtonContainer:o,id:"ahao-download-zip",text:`${u("download")}`,clickFun(){if(i(this).attr("start")!=="true"){i(this).attr("start",!0),i.each(w,(h,b)=>{GM.xmlHttpRequest({method:"GET",url:b,headers:{referer:"https://www.pixiv.net/"},overrideMimeType:"text/plain; charset=x-user-defined",onload({responseText:v}){const $=v,I=new Uint8Array($.length);let _=0;for(;_<$.length;)I[_]=$.charCodeAt(_),_++;const k=b.split(".").splice(-1),A={png:"image/png",jpg:"image/jpeg",gif:"image/gif"}[k],y=new Blob([I],{type:A});GM.getValue(U.downloadName,"{pid}").then(z=>{s.file(`${L(z)}_${h}.${k}`,y,{binary:!0})}),c++,x.find("p").html(`${u("download")}${c}/${d}`)}})});return}if(c<d){alert(u("download_wait"));return}GM.getValue(U.downloadName,"{pid}").then(h=>{s.generateAsync({type:"blob",base64:!0}).then(b=>saveAs(b,L(h)))})}});p.preDownload.isEnable()&&x.find("button").click()}},option:{attributes:!0,childList:!0,subtree:!0,attributeFilter:["src","href"]}})},tt=()=>{g({callback:(n,r)=>{for(const a of n)for(const t of a.addedNodes){const o=i(t).find("canvas");o.length>0&&E({$:o});const s=i(t).find('div:has(> button[class^="style_transparentButton"]):eq(1)');if(s.length<=0)continue;const c=T({$shareButtonContainer:s,id:"ahao-download-zip",text:"zip"}),l=T({$shareButtonContainer:s,id:"ahao-download-gif",text:"gif",clickFun(){i.ajax({url:`/ajax/illust/${f().illustId}/ugoira_meta`,dataType:"json",success:({body:d})=>{let m;const w=[],x=new GIF({workers:1,quality:10,workerScript:GIF_worker_URL});for(let h=0,b=d.frames,v=b.length;h<v;h++){const $=b[h],I=f().urls.original.replace("ugoira0.",`ugoira${h}.`);GM.xmlHttpRequest({method:"GET",url:I,headers:{referer:"https://www.pixiv.net/"},overrideMimeType:"text/plain; charset=x-user-defined",onload({responseText:_}){const k=_,A=new Uint8Array(k.length);let y=0;for(;y<k.length;)A[y]=k.charCodeAt(y),y++;const z=I.split(".").splice(-1),rt={png:"image/png",jpg:"image/jpeg",gif:"image/gif"}[z],at=new Blob([A],{type:rt}),j=document.createElement("img");j.src=URL.createObjectURL(at),j.width=f().width,j.height=f().height,j.onload=()=>{w[h]={frame:j,option:{delay:$.delay}},Object.keys(w).length>=v&&(i.each(w,(ft,G)=>x.addFrame(G.frame,G.option)),x.render())}}})}x.on("progress",h=>{l.find("p").text(`gif ${parseInt(h*100)}%`)}),x.on("finished",h=>{m=URL.createObjectURL(h),GM.getValue(U.downloadName,"{pid}").then(b=>{const v=i(`<a href="${m}" download="${L(b)}"></a>`);l.find("button").wrap(v)})}),l.find("button").off("click").on("click",()=>{if(!m){alert("Gif\u672A\u52A0\u8F7D\u5B8C\u6BD5, \u8BF7\u7A0D\u7B49\u7247\u523B!");return}})}})}});i.ajax({url:`/ajax/illust/${f().illustId}/ugoira_meta`,dataType:"json",success:({body:d})=>{GM.getValue(U.downloadName,"{pid}").then(m=>{const w=i(`<a href="${d.originalSrc}" download="${L(m)}"></a>`);c.find("button").wrap(w)})}}),p.preDownload.isEnable()&&l.find("button").click()}},option:{attributes:!0,childList:!0,subtree:!0,attributeFilter:["src","href"]}})};O()&&(X(),Q()&&Y(),J()&&tt());const et=()=>{g({callback:(n,r)=>{for(const a of n){const t=location.href.match(/\/users\/(\d+)/)?.[1],o=i(a.target).find(`div:has(> a[href$="/users/${t}/following"])`);if(o.length<=0||o.attr("ahao-done"))continue;o.attr("ahao-done",!0);const s=o.clone();s.children("a").remove();const c=D(t)?.background?.url||"";c&&c!=="none"?s.append(`<img src="${c}" width="30px"><a target="_blank" href="${c}" style="font-size: 20px;font-weight: 700;color: #333;margin-right: 8px;line-height: 1">${u("background")}</a>`):s.append(`<span>${u("background_not_found")}</span>`),o.parent().append(s);const l=o.clone();l.children("a").remove(),l.append(i(`<div style="font-size: 20px;font-weight: 700;color: #333;margin-right: 8px;line-height: 1">UID:${t}</div>`).on("click",function(){const d=i(this);d.html(`<span>UID${u("copy_to_clipboard")}</span>`),GM.setClipboard(t),setTimeout(()=>{d.html(`<span>UID${t}</span>`)},2e3)})),o.parent().append(l)}},option:{childList:!0,subtree:!0}})};S()&&et();const ot=()=>{g({callback:(n,r)=>{for(const a of n){const t=i(a.target).filter("aside").find("section:first h2");if(t.length<=0||t.attr("ahao-done"))continue;t.attr("ahao-done",!0);const o=t.find("[data-gtm-value]:first").data("gtm-value"),s=D(o)?.background?.url||"",c=t.clone();c.children("a").remove(),c.children("div").children("div").remove(),c.prepend(`<img src="${s}" width="10%"/>`),c.find("div a").attr("href",s||"javascript:void(0)").attr("target","_blank").text(u(s?"background":"background_not_found")),t.after(c);const l=t.clone();l.children("a").remove(),l.children("div").children("div").remove(),l.find("a").attr("href","javascript:void(0)").attr("id","ahao-uid").text(`UID: ${o}`),l.on("click",function(){const d=i(this);d.find("a").text(`UID${u("copy_to_clipboard")}`),GM.setClipboard(o),setTimeout(()=>{d.find("a").text(`UID: ${o}`)},2e3)}),c.after(l)}},option:{childList:!0,subtree:!0}})};O()&&ot(),void 0;const it=()=>{if(!O())return;g({callback:(n,r)=>{for(const a of n)for(const t of a.addedNodes)i(t).filter('[class^="CommentList_buttonArea"]').find("div[role='button']").click(),i(a.target).filter('[class^="CommentList_buttonArea"]').find("div[role='button']").click(),i(a.target).find("._28zR1MQ").click()},option:{childList:!0,subtree:!0},node:document.querySelector("main")[0]})},nt=()=>H()?(C("\u6807\u8BB0\u4F5C\u54C1 \u521D\u59CB\u5316"),g({callback:(n,r)=>{for(const a of n)i(a.target).find(".stacc_ref_illust_title").each(function(){const o=i(this).find("a");if(o.attr("ahao-illust-id"))return;const s=new URL(`${location.origin}/${o.attr("href")}`).searchParams.get("illust_id");o.attr("ahao-illust-id",s),i.ajax({url:`/ajax/illust/${s}`,dataType:"json",success:({body:c})=>{const l=parseInt(c.illustType),d=parseInt(c.pageCount)>1;switch(l){case 0:case 1:o.after(`<p>${u(d?"illust_type_multiple":"illust_type_single")}</p>`);break;case 2:o.after(`<p>${u("illust_type_gif")}</p>`);break}}})})},option:{childList:!0},node:document.getElementById("stacc_timeline")})):void 0,st=()=>{g({callback:(n,r)=>{for(const a of n)for(const t of a.addedNodes)i(t).find('a[href*="jump.php"]').each(function(c,l){const d=i(this),m=d.attr("href").match(/jump\.php\?(url=)?(.*)$/)[2];d.attr("href",decodeURIComponent(m))})}},{childList:!0,subtree:!0})};({init(){this.checkUrlAndToggleElement(),this.setupObserver()},checkUrlAndToggleElement(){const e=["/artworks","novel/show.php","bookmark_new_illust","/users","/tag","/discovery","/dashboard","/manage","/settings"],n=i(".group\\/logo .flex.gap-8.items-center .ml-8.size-\\[50px\\]"),r=e.some(a=>location.href.includes(a));n.toggle(!r)},setupObserver(){g({callback:()=>this.checkUrlAndToggleElement(),node:document.body,option:{childList:!0,subtree:!0}})}}).init();for(const e in p){const n=p[e];n.type==="checkbox"&&(n.isEnable=()=>GM_getValue(e,!0))}GM_registerMenuCommand("\u63A7\u5236\u9762\u677F",()=>{const n=i('<div id="myControlPanel" style="position: fixed; top: 20px; left: 20px; background-color: #fff; border: 1px solid #ddd; padding: 15px; z-index: 1000; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1); border-radius: 5px; font-family: sans-serif; display: flex; flex-direction: column; gap: 10px;"></div>');i("body").append(n);for(const t in p)if(p[t].type==="checkbox"){const s=GM_getValue(t,!0),c=i('<div style="display: flex; align-items: center; gap: 10px;"></div>'),l=i('<label style="color: #333;"></label>').text(u(`switch_${t}`)),d=i('<input type="checkbox">').prop("checked",s);d.on("change",function(){GM_setValue(t,i(this).prop("checked"))}),c.append(d,l),n.append(c)}const r=i('<button style="padding: 8px 15px; border: none; border-radius: 3px; cursor: pointer; font-size: 1rem; background-color: #007bff; color: white; transition: background-color 0.3s ease; margin-top: 10px;">\u91CD\u7F6E\u9ED8\u8BA4\u503C</button>'),a=i('<button style="padding: 8px 15px; border: none; border-radius: 3px; cursor: pointer; font-size: 1rem; background-color: #6c757d; color: white; transition: background-color 0.3s ease;">\u5173\u95ED</button>');n.append(r,a),r.on("click",function(){for(const t in p){const o=p[t];o.type==="checkbox"?GM_setValue(t,o.default||!0):GM_setValue(t,o.default)}alert("\u6240\u6709\u914D\u7F6E\u5DF2\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u503C\u3002"),window.location.reload()}),a.on("click",function(){n.remove(),window.location.reload()})}),p.antiAd.isEnable()&&K(),setTimeout(()=>Z(),1e3),p.commentLoad.isEnable()&&it(),p.antiRedirect.isEnable()&&st(),nt()});
