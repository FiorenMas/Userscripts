// ==UserScript==
// @name              InstantPage Super Lite
// @namespace         Need4Speed
// @version           1.4.6
// @author            -
// @match             *://*/*
// @noframes
// @run-at            document-idle
// @grant             none
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/InstantPage20Super20Lite.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/InstantPage20Super20Lite.meta.js
// ==/UserScript==
var EXCLUDE=new RegExp(/login|logout|register|signin|signup|signout|pay|create|edit|download|del|reset|submit|doubleclick|googleads|exit|unread/);let t,e,n,o,i,a=null,s=65,c=new Set;const r=1111;function d(g){o=performance.now();const v=g.target.closest("a");m(v)&&p(v.href,"high")}function u(g){if(performance.now()-o<r||!("closest"in g.target))return;const v=g.target.closest("a");m(v)&&(v.addEventListener("mouseout",f,{passive:!0}),i=setTimeout(()=>{p(v.href,"high"),i=void 0},s))}function l(g){const v=g.target.closest("a");m(v)&&p(v.href,"high")}function f(g){g.relatedTarget&&g.target.closest("a")==g.relatedTarget.closest("a")||i&&(clearTimeout(i),i=void 0)}function h(g){if(performance.now()-o<r)return;const v=g.target.closest("a");if(g.which>1||g.metaKey||g.ctrlKey||!v)return;v.addEventListener("click",function(E){E.detail!=1337&&E.preventDefault()},{capture:!0,passive:!1,once:!0});const w=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1,detail:1337});v.dispatchEvent(w)}function m(g){if(!g.href.match(EXCLUDE)&&g&&g.href&&(!n||"instant"in g.dataset)){if(g.origin!=location.origin&&(!(e||"instant"in g.dataset)||!a))return;if(["http:","https:"].includes(g.protocol)&&(g.protocol!="http:"||location.protocol!="https:")&&(t||!g.search||"instant"in g.dataset)&&!(g.hash&&g.pathname+g.search==location.pathname+location.search||"noInstant"in g.dataset))return!0}}function p(g,v="auto"){if(c.has(g))return;const w=document.createElement("link");w.rel="prefetch",w.href=g,w.fetchPriority=v,w.as="document",document.head.appendChild(w),c.add(g)}(function(){if(!document.createElement("link").relList.supports("prefetch"))return;const g="instantVaryAccept"in document.body.dataset||"Shopify"in window,v=navigator.userAgent.indexOf("Chrome/");if(v>-1&&(a=parseInt(navigator.userAgent.substring(v+7))),g&&a&&a<110)return;const w="instantMousedownShortcut"in document.body.dataset;t="instantAllowQueryString"in document.body.dataset,e="instantAllowExternalLinks"in document.body.dataset,n="instantWhitelist"in document.body.dataset;const E={capture:!0,passive:!0};let k=!1,A=!1,I=!1;if("instantIntensity"in document.body.dataset){const y=document.body.dataset.instantIntensity;if(y.startsWith("mousedown"))k=!0,y=="mousedown-only"&&(A=!0);else if(y.startsWith("viewport")){const b=navigator.connection&&navigator.connection.saveData,L=navigator.connection&&navigator.connection.effectiveType&&navigator.connection.effectiveType.includes("2g");b||L||(y=="viewport"?document.documentElement.clientWidth*document.documentElement.clientHeight<45e4&&(I=!0):y=="viewport-all"&&(I=!0))}else{const b=parseInt(y);isNaN(b)||(s=b)}}if(A||document.addEventListener("touchstart",d,E),k?w||document.addEventListener("mousedown",l,E):document.addEventListener("mouseover",u,E),w&&document.addEventListener("mousedown",h,E),I){let y=window.requestIdleCallback;y||(y=b=>{b()}),y(function(){const b=new IntersectionObserver(L=>{L.forEach(T=>{if(T.isIntersecting){const C=T.target;b.unobserve(C),p(C.href)}})});document.querySelectorAll("a").forEach(L=>{m(L)&&b.observe(L)})},{timeout:1500})}})();
