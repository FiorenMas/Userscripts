// ==UserScript==
// @name     Microsoft Store Direct Download
// @namespace    StephenP
// @version  2.0.4
// @author       StephenP
// @grant    GM.xmlHttpRequest
// @connect	 rg-adguard.net
// @match    https://apps.microsoft.com/*
// @match    https://apps.microsoft.com/*
// @contributionURL https://buymeacoffee.com/stephenp_greasyfork
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Microsoft20Store20Direct20Download.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Microsoft20Store20Direct20Download.meta.js
// ==/UserScript==
var dlBtn;(function(){setInterval(checkReload,1e3)})();function checkReload(){let o=querySelectorAllShadows(".buy-box-container");o.length>0&&querySelectorAllShadows("#dlBtn").length==0&&(dlBtn=document.createElement("DIV"),dlBtn.id="dlBtn",dlBtn.setAttribute("aria-label","Download from AdGuard Store"),dlBtn.style.background="#00a686",dlBtn.style.font="initial",dlBtn.style.textAlign="center",dlBtn.style.borderRadius="var(--sl-input-border-radius-large)",dlBtn.style.marginTop="0.5em",dlBtn.innerText="",dlBtn.appendChild(document.createElement("P")),dlBtn.firstChild.innerText="\u25BC",dlBtn.addEventListener("click",function(){openLink(document.location.href,"url")}),o[0].appendChild(dlBtn))}function openLink(o,n){try{dlBtn.firstChild.innerText="...";var i="type="+n+"&url="+o+"&ring=RP&lang=it-IT";GM.xmlHttpRequest({method:"POST",url:"https://store.rg-adguard.net/api/GetFiles",data:i,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(t){dlBtn.firstChild.innerText="\u25BC";try{var r=querySelectorAllShadows("#linkTable");r[0].parentNode.removeChild(r[0]);var l=querySelectorAllShadows("#messageFromServer");l[0].parentNode.removeChild(l[0])}catch(d){console.log(d)}try{output(t,n)}catch(d){if(console.log(d),n==="ProductId")output(d,n);else{let a=querySelectorAllShadows("[product-id]")[0].getAttribute("product-id");openLink(a,"ProductId")}}}})}catch(t){if(console.log(t),n==="ProductId")output(t,n);else{let r=querySelectorAllShadows("[product-id]")[0].getAttribute("product-id");openLink(r,"ProductId")}}}function output(o,n){var i=document.createElement("div");i.innerHTML=o.responseText;var t=i.getElementsByTagName("TABLE")[0],r=i.getElementsByTagName("P")[0];if(r.id="messageFromServer",r.style.fontWeight="bold",t!==void 0){if(!document.getElementById("realign")){let e=document.createElement("STYLE");e.id="realign",e.innerText="div.details.two-column{display: initial}}",document.getElementsByTagName("HEAD")[0].appendChild(e)}t.id="linkTable";const l=t.getElementsByTagName("TBODY")[0].getElementsByTagName("TR");for(let e of l)e.firstChild.firstChild&&e.firstChild.firstChild.innerHTML.match(/\.appx$|\.appxbundle$|\.msix$|\.msixbundle$|\.exe$/)&&(e.style.fontWeight="bold");let d=document.createElement("STYLE");d.innerHTML="td:last-child{word-break: break-all}";let a=querySelectorAllShadows("sl-card");if(a.length>0){const e=a[0].parentNode;e.insertBefore(t,e.querySelector("sl-card")),e.insertBefore(d,e.querySelector("sl-card")),t.style.marginTop="2em",r.style.color="green",e.insertBefore(r,e.querySelector("sl-card"))}}else if(t===void 0&&n==="url"){let l=querySelectorAllShadows("[product-id]")[0].getAttribute("product-id");openLink(l,"ProductId")}else r.style.color="red",dlBtn.parentNode.parentNode.parentNode.appendChild(r)}function querySelectorAllShadows(o,n=document.body){const t=Array.from(n.querySelectorAll("*")).map(l=>l.shadowRoot).filter(Boolean).map(l=>querySelectorAllShadows(o,l));return Array.from(n.querySelectorAll(o)).concat(t).flat()}
