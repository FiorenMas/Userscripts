// ==UserScript==
// @name                Instagram Download Button
// @namespace           https://github.com/y252328/Instagram_Download_Button
// @version             1.17.18
// @compatible          chrome
// @author              ZhiYu
// @match               https://www.instagram.com/*
// @icon                https://www.google.com/s2/favicons?sz=64&domain=instagram.com
// @grant               none
// @license             MIT
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Instagram20Download20Button.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Instagram20Download20Button.meta.js
// ==/UserScript==
(function(){"use strict";const U="%id%-%datetime%-%medianame%",$=U,J="%y%%m%%d%_%H%%M%%S%",K=/^\/p\/([^/]+)\//,G=/instagram\.com\/p\/[\w-]+\//;var V=`<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" height="24" width="24"
     viewBox="0 0 477.867 477.867" style="fill:%color;" xml:space="preserve">
    <g>
        <path d="M443.733,307.2c-9.426,0-17.067,7.641-17.067,17.067v102.4c0,9.426-7.641,17.067-17.067,17.067H68.267
            c-9.426,0-17.067-7.641-17.067-17.067v-102.4c0-9.426-7.641-17.067-17.067-17.067s-17.067,7.641-17.067,17.067v102.4
            c0,28.277,22.923,51.2,51.2,51.2H409.6c28.277,0,51.2-22.923,51.2-51.2v-102.4C460.8,314.841,453.159,307.2,443.733,307.2z"/>
    </g>
    <g>
        <path d="M335.947,295.134c-6.614-6.387-17.099-6.387-23.712,0L256,351.334V17.067C256,7.641,248.359,0,238.933,0
            s-17.067,7.641-17.067,17.067v334.268l-56.201-56.201c-6.78-6.548-17.584-6.36-24.132,0.419c-6.388,6.614-6.388,17.099,0,23.713
            l85.333,85.333c6.657,6.673,17.463,6.687,24.136,0.031c0.01-0.01,0.02-0.02,0.031-0.031l85.333-85.333
            C342.915,312.486,342.727,301.682,335.947,295.134z"/>
    </g>
</svg>`,j=`<svg id="Capa_1" style="fill:%color;" viewBox="0 0 482.239 482.239" xmlns="http://www.w3.org/2000/svg" height="24" width="24">
    <path d="m465.016 0h-344.456c-9.52 0-17.223 7.703-17.223 17.223v86.114h-86.114c-9.52 0-17.223 7.703-17.223 17.223v344.456c0 9.52 7.703 17.223 17.223 17.223h344.456c9.52 0 17.223-7.703 17.223-17.223v-86.114h86.114c9.52 0 17.223-7.703 17.223-17.223v-344.456c0-9.52-7.703-17.223-17.223-17.223zm-120.56 447.793h-310.01v-310.01h310.011v310.01zm103.337-103.337h-68.891v-223.896c0-9.52-7.703-17.223-17.223-17.223h-223.896v-68.891h310.011v310.01z"/>
</svg>`,L="";document.addEventListener("keydown",W);function W(t){if(window.location.href==="https://www.instagram.com/")return;const e={stopPropagation:function(){},preventDefault:function(){}};if(t.altKey&&(t.code==="KeyK"||t.key=="k")){let n=document.getElementsByClassName("download-btn");if(n.length>0){let r={...e};r.currentTarget=n[n.length-1],q(r),k(r)}}if(t.altKey&&(t.code==="KeyI"||t.key=="i")){let n=document.getElementsByClassName("newtab-btn");if(n.length>0){let r={...e};r.currentTarget=n[n.length-1],q(r),k(r)}}if(t.altKey&&(t.code==="KeyL"||t.key=="l")){let n=document.getElementsByClassName("_9zm2");n.length>0&&n[0].click()}if(t.altKey&&(t.code==="KeyJ"||t.key=="j")){let n=document.getElementsByClassName("_9zm0");n.length>0&&n[0].click()}}function X(){return!!window.location.href.match(G)}function v(t,e,n){let r=t.querySelectorAll(e);for(let o=0;o<r.length;++o){let i=r[o];if(i.querySelector(n))return i}return null}var he=setInterval(function(){const t=window.location.href,e='article *:not(li)>*>*>*>div:not([class])>div[role="button"]:not([style]):not([tabindex="-1"])',n='section > *:not(main) header div>svg:not([aria-label=""])',r="header section svg circle",o='path[d="M5.888 22.5a3.46 3.46 0 0 1-1.721-.46l-.003-.002a3.451 3.451 0 0 1-1.72-2.982V4.943a3.445 3.445 0 0 1 5.163-2.987l12.226 7.059a3.444 3.444 0 0 1-.001 5.967l-12.22 7.056a3.462 3.462 0 0 1-1.724.462Z"]',i='path[d="M15 1c-3.3 0-6 1.3-6 3v40c0 1.7 2.7 3 6 3s6-1.3 6-3V4c0-1.7-2.7-3-6-3zm18 0c-3.3 0-6 1.3-6 3v40c0 1.7 2.7 3 6 3s6-1.3 6-3V4c0-1.7-2.7-3-6-3z"]';let l=getComputedStyle(document.body).backgroundColor.match(/[.?\d]+/g),s=l[0]*.299+l[1]*.587+l[2]*.114<=150?"white":"black";if(L!==t)for(;document.getElementsByClassName("custom-btn").length!==0;)document.getElementsByClassName("custom-btn")[0].remove();let p=document.querySelectorAll("article");for(let a=0;a<p.length;a++){let u=Array.from(p[a].querySelectorAll(e)).pop();u&&p[a].getElementsByClassName("custom-btn").length===0&&A(u,s,Z)}if(X()){let a=v(document,'div[role="button"] > div[role="button"]:not([style])','polygon[points="20 21 12 13.44 4 21 4 3 20 3 20 21"]')||v(document,'div[role="button"] > div[role="button"]:not([style])','path[d="M20 22a.999.999 0 0 1-.687-.273L12 14.815l-7.313 6.912A1 1 0 0 1 3 21V3a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1Z"]');document.getElementsByClassName("custom-btn").length===0&&a.parentNode.querySelector("svg")&&A(a.parentNode.querySelector("svg"),s,Y)}if(document.getElementsByClassName("custom-btn").length===0&&!t.includes("stor")&&document.querySelector(r)&&A(document.querySelector(r),s,Q),document.getElementsByClassName("custom-btn").length===0){let a=v(document,"svg",o)||v(document,"svg",i);if(a){let u=a.parentNode;A(u,"white",ee)}}L=t},500);function Z(t,e){t.append(e)}function Y(t,e){t.parentNode.parentNode.append(e)}function Q(t,e){t.parentNode.parentNode.parentNode.appendChild(e,t.parentNode.parentNode)}function ee(t,e){t.parentNode.parentNode.parentNode.append(e)}function A(t,e,n){let r=B(j,e,"newtab-btn","16px");n(t,r);let o=B(V,e,"download-btn","14px");n(t,o)}function B(t,e,n,r){let o=document.createElement("a");return o.innerHTML=t.replace("%color",e),o.setAttribute("class","custom-btn "+n),o.setAttribute("target","_blank"),o.setAttribute("style","cursor: pointer;margin-left: "+r+";margin-top: 8px;z-index: 999;"),o.onclick=k,o.onmouseenter=q,n.includes("newtab")?o.setAttribute("title","Open in new tab"):o.setAttribute("title","Download"),o}function k(t){let e=t.currentTarget;t.stopPropagation(),t.preventDefault(),window.location.pathname.includes("stories")?ce(e):document.querySelector("header")&&document.querySelector("header").contains(e)?ne(e):oe(e)}function q(t){let e=t.currentTarget;window.location.pathname.includes("stories")?ae(e):document.querySelector("header")&&document.querySelector("header").contains(e)?te(e):re(e)}function te(t){let e=T(t);t.setAttribute("href",e)}function ne(t){let e=T(t);if(e.length>0)if(t.getAttribute("class").includes("download-btn")){const n=document.querySelector("header h2").textContent;E(e,n)}else C(e)}function T(t){return document.querySelector("header img").getAttribute("src")}async function re(t){let e=P(t),{url:n}=await D(t,e);t.setAttribute("href",n)}async function oe(t){try{let e=P(t),{url:n,mediaIndex:r}=await D(t,e);if(n.length>0)if(t.getAttribute("class").includes("download-btn")){let o=n.split("?")[0].split("\\").pop().split("/").pop();o=o.substring(0,o.lastIndexOf("."));let i=new Date(e.querySelector("time").getAttribute("datetime")),l=e.querySelector("header a")||ie(e);l=l.getAttribute("href").replace(/\//g,"");let s=F(e),p=R(U,l,i,o,s,r);E(n,p)}else C(n)}catch(e){return console.log(`Uncatched in postOnClicked(): ${e}
${e.stack}`),null}}function P(t){let e=t;for(;e&&e.tagName!=="ARTICLE"&&e.tagName!=="MAIN";)e=e.parentNode;return e}async function D(t,e){let n=e.querySelectorAll("li[style][class]"),r=null,o=0;if(n.length===0){if(r=await x(e),r===null){let i=e.querySelector("video");i?(r=i.getAttribute("src"),i.hasAttribute("videoURL")?r=i.getAttribute("videoURL"):(r===null||r.includes("blob"))&&(r=await _(e,i))):e.querySelector("article  div[role] div > img")?r=e.querySelector("article  div[role] div > img").getAttribute("src"):console.log("Err: not find media at handle post single")}}else{const i=location.pathname.startsWith("/p/");if(o=[...[...e.querySelectorAll("div._acnb")]].reduce((s,p,a)=>p.classList.length===2?a:s,null),o===null)throw"Cannot find the media index";if(r=await x(e,o),r===null){const s=[...e.querySelectorAll(`:scope > div > div:nth-child(${i?1:2}) > div > div:nth-child(1) ul li[style*="translateX"]`)],p=Math.max(...s.map(c=>c.clientWidth)),u=s.reduce((c,d)=>{const f=Math.round(Number(d.style.transform.match(/-?(\d+)/)[1])/p);return{...c,[f]:d}},{})[o];if(u.querySelector("video")){let c=u.querySelector("video");r=c.getAttribute("src"),c.hasAttribute("videoURL")?r=c.getAttribute("videoURL"):(r===null||r.includes("blob"))&&(r=await _(e,c))}else u.querySelector("img")&&(r=u.querySelector("img").getAttribute("src"))}}return{url:r,mediaIndex:o}}function le(){let t=document.querySelector('div[style^="transform"]').parentElement,n=t.parentElement.children;return Array.from(n).indexOf(t)}let I={},N={};async function x(t,e=0){try{let o=function(){let c=document.querySelectorAll("body > script");for(let d=0;d<c.length;++d){let f=c[d].text.match(n);if(f)return f[1]}return console.log("Cannot find app id"),null},l=function(c){return"video_versions"in c?c.video_versions[0].url:c.image_versions2.candidates[0].url};const n=/"X-IG-App-ID":"([\d]+)"/,r=/instagram:\/\/media\?id=(\d+)|["' ]media_id["' ]:["' ](\d+)["' ]/;async function i(){function c(){let m=window.location.href,h=m.match(/www.instagram.com\/stories\/[^\/]+\/(\d+)/);if(!m.includes("highlights")&&h)return h[1]}async function d(){let m=await F(t);if(!m)return null;if(!(m in N)){let h=`https://www.instagram.com/p/${m}/`,w=await(await fetch(h)).text(),g=w?w.match(r):[],b=null;for(let S=0;S<g.length;++S)g[S]&&(b=g[S]);if(!b)return null;N[m]=b}return N[m]}function f(){let m=document.querySelectorAll('script[type="application/json"]');for(let h=0;h<m.length;h++){let M=m[h].text.match(/"pk":"(\d+)","id":"[\d_]+"/);if(M){if(!window.location.href.includes("highlights"))return M[1];let w=Array.from(m[h].text.matchAll(/"pk":"(\d+)","id":"[\d_]+"/g),b=>b[1]);const g=le();if(w.length>g)return w[g]}}}return c()||await d()||f()}let s=o();if(!s)return null;let p={method:"GET",headers:{Accept:"*/*","X-IG-App-ID":s},credentials:"include",mode:"cors"},a=await i();if(!a)return console.log("Cannot find media id"),null;if(!(a in I)){let c="https://i.instagram.com/api/v1/media/"+a+"/info/",d=await fetch(c,p);if(d.status!==200)return console.log(`Fetch info API failed with status code: ${d.status}`),null;let f=await d.json();I[a]=f}let u=I[a];return"carousel_media"in u.items[0]?l(u.items[0].carousel_media[e]):l(u.items[0])}catch(n){return console.log(`Uncatched in getUrlFromInfoApi(): ${n}
${n.stack}`),null}}function ie(t){let e=t.querySelector('article section + * a[href^="/"][href$="/"]');if(e)return e;let n=t.querySelector("canvas ~ * img");if(n){n=n.getAttribute("alt");let r=t.querySelectorAll("a");for(let o=0;o<r.length;o++){const i=r[o].getAttribute("href").replace(/\//g,"");if(n.includes(i))return r[o]}}else return document.querySelector("h2[dir]").innerText}function F(t){let e=t.querySelectorAll("a");for(let n=0;n<e.length;++n){let r=e[n].getAttribute("href");if(r){let o=r.match(K);if(o)return o[1]}}return null}async function _(t,e){let n=e.getAttribute("poster"),r=t.querySelectorAll("time"),o=r[r.length-1].parentNode.parentNode.href;const i=/\/([^\/?]*)\?/;let s=n.match(i)[1],a=await(await fetch(o)).text();const u=new RegExp(`${s}.*?video_versions.*?url":("[^"]*")`,"s");let c=a.match(u),d=JSON.parse(c[1]);return d=d.replace(/^(?:https?:\/\/)?(?:[^@\/\n]+@)?(?:www\.)?([^:\/?\n]+)/g,"https://scontent.cdninstagram.com"),e.setAttribute("videoURL",d),d}async function ae(t){let e=H(t),n=await O(t,e);t.setAttribute("href",n)}async function ce(t){let e=H(t),n=await O(t,e);const r=/\/stories\/(.*)\/.*\//;if(t.getAttribute("class").includes("download-btn")){let o=n.split("?")[0].split("\\").pop().split("/").pop();o=o.substring(0,o.lastIndexOf("."));let i=new Date(e.querySelector("time").getAttribute("datetime")),l="unkown";const s=e.querySelector("header a");if(s&&(l=s.getAttribute("href").replace(/\//g,"")),l==="unkown"){const a=window.location.pathname.match(r);a&&(l=a[1])}let p=R($,l,i,o);E(n,p)}else C(n)}function H(t){let e=t;for(;e&&e.tagName!=="SECTION";)e=e.parentNode;return e}async function O(t,e){let n=null;if(n=await x(t),!n)if(e.querySelector("video > source"))n=e.querySelector("video > source").getAttribute("src");else if(e.querySelector('img[decoding="sync"]')){if(n=e.querySelector('img[decoding="sync"]').srcset.split(/ \d+w/g)[0].trim(),n.length>0)return n;n=e.querySelector('img[decoding="sync"]').getAttribute("src")}else e.querySelector("video")&&(n=e.querySelector("video").getAttribute("src"));return n}function R(t,e,n,r,o=+new Date,i="0"){let l=t;return l=l.replace(/%id%/g,e),l=l.replace(/%datetime%/g,se(J,n)),l=l.replace(/%medianame%/g,r),l=l.replace(/%postId%/g,o),l=l.replace(/%mediaIndex%/g,i),l}function se(t,e){let n=t;return n=n.replace(/%y%/g,e.getFullYear()),n=n.replace(/%m%/g,y((e.getMonth()+1).toString())),n=n.replace(/%d%/g,y(e.getDate().toString())),n=n.replace(/%H%/g,y(e.getHours().toString())),n=n.replace(/%M%/g,y(e.getMinutes().toString())),n=n.replace(/%S%/g,y(e.getSeconds().toString())),n}function y(t){return t.length===1?"0"+t:t}function C(t){var e=document.createElement("a");e.href=t,e.setAttribute("target","_blank"),document.body.appendChild(e),e.click(),e.remove()}function z(t,e,n){var r=document.createElement("a");r.download=e+"."+n,r.href=t,document.body.appendChild(r),r.click(),r.remove()}function E(t,e){if(t.startsWith("blob:")){z(t,e,"mp4");return}console.log(`Dowloading ${t}`),e||(e=t.split("\\").pop().split("/").pop()),fetch(t,{headers:new Headers({"User-Agent":window.navigator.userAgent,Origin:location.origin}),mode:"cors"}).then(n=>n.blob()).then(n=>{const r=n.type.split("/").pop();let o=window.URL.createObjectURL(n);z(o,e,r)}).catch(n=>console.error(n))}})();
