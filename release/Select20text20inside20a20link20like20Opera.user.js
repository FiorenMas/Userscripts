// ==UserScript==
// @name Select text inside a link like Opera
// @version 6.0.0
// @homepageURL https://github.com/eight04/select-text-inside-a-link-like-opera#readme
// @supportURL https://github.com/eight04/select-text-inside-a-link-like-opera/issues
// @license MIT
// @author eight <eight04@gmail.com> (http://eight04.blogspot.tw)
// @namespace eight04.blogspot.com
// @include *
// @grant GM_addStyle
// @run-at document-start
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Select20text20inside20a20link20like20Opera.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Select20text20inside20a20link20like20Opera.meta.js
// ==/UserScript==
const tracker=createMovementTracker(),selection=window.getSelection();let state="WAITING",preState,mousemoves=0,linkTarget;const initPos=[0,0];let selectType;const EVENTS={mousedown:t=>{if(state==="WAITING"){if(t.altKey||t.button||/img/i.test(t.target.nodeName))return;const e=findLinkTarget(t.target);if(!e||!e.href||(selectType=t.ctrlKey?"add":t.shiftKey?"extend":"new",initPos[0]=t.pageX,initPos[1]=t.pageY,selectType==="new"&&!selection.isCollapsed&&inSelect(getInitPos(),selection)))return;mousemoves=0,state="STARTING",linkTarget=e,linkTarget.classList.add("select-text-inside-a-link")}},mousemove:t=>{if(state==="STARTING"&&(mousemoves++,mousemoves>=3&&startSelecting(t)),state==="STARTED"){const e=caretPositionFromPoint(t.pageX-window.scrollX,t.pageY-window.scrollY);selection.extend(e.offsetNode,e.offset)}},mouseup:()=>{state!=="WAITING"&&(preState=state,state="ENDING",setTimeout(startWaiting))},click:t=>{state==="ENDING"&&(preState==="STARTED"&&findLinkTarget(t.target)===linkTarget&&(t.preventDefault(),t.stopImmediatePropagation()),startWaiting())},dragstart:t=>{if(state==="STARTED"){t.preventDefault();return}state==="STARTING"&&startSelecting(t)}};for(const t in EVENTS)document.addEventListener(t,EVENTS[t],!0);(!document.contentType||!document.contentType.endsWith("/xml"))&&document.addEventListener("DOMContentLoaded",function(){GM_addStyle(".select-text-inside-a-link{ -moz-user-select: text!important; }")});function startSelecting(t){if(!shouldStart(t)){startWaiting();return}if(t.type==="dragstart"&&t.preventDefault(),selectType==="new"){const e=getInitPos();selection.collapse(e.offsetNode,e.offset)}else if(selectType==="add"){const e=new Range,n=getInitPos();e.setStart(n.offsetNode,n.offset),selection.addRange(e)}state="STARTED"}function getInitPos(){return caretPositionFromPoint(initPos[0]-window.scrollX,initPos[1]-window.scrollY)}function shouldStart(t){const e=tracker?tracker():[Math.abs(t.pageX-initPos[0]),Math.abs(t.pageY-initPos[1])];return e[0]>=e[1]}function startWaiting(){linkTarget&&linkTarget.classList.remove("select-text-inside-a-link"),state="WAITING",linkTarget=null}function createMovementTracker(){const t=[[0,0],[0,0],[0,0]];let e=0;return document.addEventListener("mousemove",n=>{t[e][0]=n.pageX,t[e][1]=n.pageY,e=(e+1)%3}),()=>{const n=[];for(let o=0;o<2;o++)n.push(Math.abs(t[e][o]-t[(e+1)%3][o])+Math.abs(t[(e+1)%3][o]-t[(e+2)%3][o]));return n}}function caretPositionFromPoint(t,e){if(document.caretPositionFromPoint)return document.caretPositionFromPoint(t,e);var n=document.caretRangeFromPoint(t,e);return{offsetNode:n.startContainer,offset:n.startOffset}}function inSelect(t,e){var n,o=e.rangeCount,i;for(n=0;n<o;n++)if(i=e.getRangeAt(n),i.isPointInRange(t.offsetNode,t.offset))return!0;return!1}function findLinkTarget(t){for(;t&&t.nodeName!=="A"&&t.nodeName!=="a";)t=t.parentNode;return t}
