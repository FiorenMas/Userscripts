// ==UserScript==
// @name                 Netflix Plus
// @namespace            http://tampermonkey.net/
// @version              3.7
// @author               TGSAN
// @match                https://www.netflix.com/*
// @icon                 https://www.google.com/s2/favicons?sz=64&domain=netflix.com
// @run-at               document-start
// @sandbox              raw
// @grant                unsafeWindow
// @grant                GM_setValue
// @grant                GM_getValue
// @grant                GM_registerMenuCommand
// @grant                GM_unregisterMenuCommand
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Netflix20Plus.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Netflix20Plus.meta.js
// ==/UserScript==
(async()=>{"use strict";let t=self.window;self.unsafeWindow?(console.log("[Netflix Plus] use unsafeWindow mode"),t=self.unsafeWindow):console.log("[Netflix Plus] use window mode (your userscript extensions not support unsafeWindow)");{const e=document.createElement("meta");e.httpEquiv="Cache-Control",e.content="no-cache",t.document.head.appendChild(e)}{const e=document.createElement("meta");e.httpEquiv="Pragma",e.content="no-cache",t.document.head.appendChild(e)}{const e=document.createElement("meta");e.httpEquiv="Expires",e.content="-1",t.document.head.appendChild(e)}function b(){let e=document.createElement("div");return e.style.position="fixed",e.style.top="20px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.padding="10px 20px",e.style.backgroundColor="rgba(250, 250, 250, 1.0)",e.style.color="rgba(32, 32, 32, 1.0)",e.style.fontSize="12px",e.style.textAlign="center",e.style.fontWeight="600",e.style.zIndex="9999",e.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.25)",e.style.borderRadius="30px",e.style.opacity="0.0",e.style.transition="opacity 0.5s",document.body.appendChild(e),e}function x(e,n=1500){let a=b();a.innerText=e,setTimeout(function(){a.style.opacity="1.0",setTimeout(function(){a.style.opacity="0.0",setTimeout(function(){document.body.removeChild(a)},500)},n)},1)}let r,d=!0;t.Function.prototype.callNetflixPlusOriginal=t.Function.prototype.call,t.Function.prototype.call=function(...e){if(d){let n=this.toString();if(n.length>1e6&&n.indexOf("h264mpl")>-1&&n.indexOf("videoElementNetflixPlus")<0){console.log("PlayerCore found len: "+n.length),h();return}}return this.callNetflixPlusOriginal(...e)},t.netflix!==void 0&&t.netflix.player!==void 0&&(x(`Netflix Plus is executing too late and is being forced to run, which may cause issues.

Refresh the page while holding down the "Shift" key to resolve the issue.`,1e4),console.warn("The user script is executing too late and is being forced to run, which may cause issues."),h());function h(){const e=()=>{try{t.netflix.reactContext.models.playerModel.data.config.core.initParams.browserInfo.os.name=="linux"&&(t.netflix.reactContext.models.playerModel.data.config.core.initParams.browserInfo.os={name:"windows",version:"10.0"}),t.netflix.reactContext.models.playerModel.data.config.core.initParams.browserInfo.hardware!="computer"&&(t.netflix.reactContext.models.playerModel.data.config.core.initParams.browserInfo.hardware="computer")}catch{setTimeout(e,0)}};if(e(),d=!1,r==null){for(let a of t.document.getElementsByTagName("script"))if(a.src&&a.src.indexOf("cadmium-playercore")>-1){r=a;break}}let n=document.createElement("script");n.src="https://www.cloudmoe.com/static/userscript/netflix-plus/cadmium-playercore.js",n.async=r.async,n.id=r.id,r.replaceWith(n)}t._videoElementNetflixPlus,Object.defineProperty(t,"videoElementNetflixPlus",{get:function(){return t._videoElementNetflixPlus},set:function(e){let n=t._videoElementNetflixPlus;t._videoElementNetflixPlus=e,e.addEventListener("playing",function(){if(n===e||!t.globalOptions.setMaxBitrateOld)return;let a=function(s){return document.evaluate(s,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue},l=function(){t.dispatchEvent(new KeyboardEvent("keydown",{keyCode:83,ctrlKey:!0,altKey:!0,shiftKey:!0})),t.dispatchEvent(new KeyboardEvent("keydown",{keyCode:66,ctrlKey:!0,altKey:!0,shiftKey:!0}));const s=a("//div[text()='Video Bitrate / VMAF']"),u=a("//div[text()='Audio Bitrate']"),i=a("//button[text()='Override']");s&&u&&i?([s,u].forEach(function(N){let g=N.parentElement;g.querySelectorAll("select").forEach(function(C){C.removeAttribute("disabled")});let c=g.querySelectorAll("select > option");for(var p=0;p<c.length-1;p++)c[p].removeAttribute("selected");c[c.length-1].setAttribute("selected","selected")}),setTimeout(function(){i.click()},100),n=e):setTimeout(l,100)};l()})}}),t.modifyFilterNetflixPlus=function(e,n,a){let l=a==="playready"?30:0;return t.globalOptions.useprk&&(e.push("h264mpl30-dash-playready-prk-qc"),e.push("h264mpl31-dash-playready-prk-qc"),e.push("h264mpl40-dash-playready-prk-qc")),l==30?(t.globalOptions.useddplus&&(e.push("ddplus-2.0-dash"),e.push("ddplus-5.1-dash"),e.push("ddplus-5.1hq-dash"),e.push("ddplus-atmos-dash")),t.globalOptions.usehevc&&(e=e.filter(s=>{if(!new RegExp(/main10-L5/g).test(JSON.stringify(s)))return s})),t.globalOptions.usef12k&&(e=e.filter(s=>{if(!new RegExp(/hevc-main10-L.*-dash-cenc-prk-do/g).test(JSON.stringify(s)))return s})),t.globalOptions.usef4k&&(e.push("hevc-main10-L30-dash-cenc"),e.push("hevc-main10-L31-dash-cenc"),e.push("hevc-main10-L40-dash-cenc"),e.push("hevc-main10-L41-dash-cenc"))):(t.globalOptions.useFHD&&(e.push("playready-h264mpl40-dash"),e.push("playready-h264hpl40-dash"),e.push("vp9-profile0-L40-dash-cenc"),e.push("av1-main-L50-dash-cbcs-prk"),e.push("av1-main-L51-dash-cbcs-prk"),e.push("av1-hdr10plus-main-L40-dash-cbcs-prk"),e.push("av1-hdr10plus-main-L41-dash-cbcs-prk"),e.push("av1-hdr10plus-main-L50-dash-cbcs-prk"),e.push("av1-hdr10plus-main-L51-dash-cbcs-prk")),t.globalOptions.useHA&&e.push("heaac-5.1-dash"),t.globalOptions.usedef||(t.globalOptions.useav1&&(e.push("av1-main-L20-dash-cbcs-prk"),e.push("av1-main-L21-dash-cbcs-prk"),e=e.filter(s=>{if(!new RegExp(/h264/g).test(JSON.stringify(s)))return s}),e=e.filter(s=>{if(!new RegExp(/vp9-profile/g).test(JSON.stringify(s)))return s})),t.globalOptions.usevp9&&(e.push("vp9-profile0-L21-dash-cenc"),e=e.filter(s=>{if(!new RegExp(/h264/g).test(JSON.stringify(s)))return s}),e=e.filter(s=>{if(!new RegExp(/av1-main/g).test(JSON.stringify(s)))return s})),t.globalOptions.useAVCH&&(e=e.filter(s=>{if(!new RegExp(/vp9-profile/g).test(JSON.stringify(s)))return s}),e=e.filter(s=>{if(!new RegExp(/av1-main/g).test(JSON.stringify(s)))return s})),t.globalOptions.useAVC&&(e=e.filter(s=>{if(!new RegExp(/vp9-profile/g).test(JSON.stringify(s)))return s}),e=e.filter(s=>{if(!new RegExp(/h264hp/g).test(JSON.stringify(s)))return s}),e=e.filter(s=>{if(!new RegExp(/av1-main/g).test(JSON.stringify(s)))return s})))),t.globalOptions.useallSub&&(n.showAllSubDubTracks=1),t.globalOptions.closeimsc&&(e=e.filter(s=>{if(!new RegExp(/imsc1.1/g).test(JSON.stringify(s)))return s})),[e,n,a]};const v=t.fetch;t.fetch=(...e)=>{let n="",a=!1;switch(typeof e[0]){case"object":n=e[0].url,a=!0;break;case"string":n=e[0];break;default:break}if(n.indexOf("//web.prod.cloud.netflix.com/graphql")>-1&&typeof e[1]=="object"){let l=e[1];if(typeof l.body=="string"&&l.body.startsWith("{")&&l.body.endsWith("}")){let s=JSON.parse(l.body);if(typeof s.operationName=="string"&&t.globalOptions.disableHouseholdCheck&&s.operationName.startsWith("CLCSInterstitial"))return console.debug("Mocked: "+s.operationName),new Promise(u=>{let i={data:{}};i.data["body.operationName"]=null,u(new Response(JSON.stringify(i)))});l.body=JSON.stringify(s)}e[1]=l}return v(...e)};const w=class{constructor(e,n){this.script=e,this.target=n,this._cancel=!1,this._replace=null,this._stop=!1}preventDefault(){this._cancel=!0}stopPropagation(){this._stop=!0}replacePayload(e){this._replace=e}};let o=[];t.addBeforeScriptExecuteListener=e=>{if(typeof e!="function")throw new Error("Event handler must be a function.");o.push(e)},t.removeBeforeScriptExecuteListener=e=>{let n=o.length;for(;n--;)o[n]===e&&o.splice(n,1)};const E=(e,n)=>{if(e.tagName!=="SCRIPT")return;const a=new w(e,n);if(typeof t.onbeforescriptexecute=="function")try{t.onbeforescriptexecute(a)}catch(l){console.error(l)}for(const l of o){if(a._stop)break;try{l(a)}catch(s){console.error(s)}}a._cancel?(e.textContent="",e.remove()):typeof a._replace=="string"&&(e.textContent=a._replace)};new MutationObserver(e=>{for(const n of e)for(const a of n.addedNodes)E(a,n.target)}).observe(document,{childList:!0,subtree:!0});const O=[["onlyMaxBitrate","Only use best bitrate available"],["useallSub","Show all audio-tracks and subs"],["closeimsc","Use SUP subtitle replace IMSC subtitle"],["useDDPandHA","Enable Dolby and HE-AAC 5.1 Audio"],["alwaysUseHDR","Always use HDR or Dolby Vision when available"],["useFHD","Focus 1080P"],["disableHouseholdCheck","Disable checks for Netflix Household"]];let f=[];t.globalOptions={disableHouseholdCheck:!0,useDDPandHA:!0,useXHA:!1,alwaysUseHDR:!1,onlyMaxBitrate:!0,get onlyVideoMaxBitrate(){return t.globalOptions.onlyMaxBitrate},get onlyAudioMaxBitrate(){return t.globalOptions.onlyMaxBitrate},setMaxBitrateOld:!1,useallSub:!0,get useddplus(){return t.globalOptions.useDDPandHA},useAVC:!1,usedef:!1,get useHA(){return t.globalOptions.useDDPandHA},useAVCH:!0,usevp9:!1,useav1:!1,useprk:!0,usehevc:!1,usef4k:!0,usef12k:!1,closeimsc:!0},t.globalOptions.useFHD=!await S(),t.onbeforescriptexecute=function(e){let n=document.getElementsByTagName("script");if(n.length!==0)for(let a=0;n.length>a;a++){let l=n[a];if(l.src.includes("cadmium-playercore")){r=l,console.warn("parsing playercore dom"),t.onbeforescriptexecute=null;break}}};async function S(){let e=!1;t.MSMediaKeys&&(e=!0),t.WebKitMediaKeys&&(e=!0);let n=[{videoCapabilities:[{contentType:"video/mp4;codecs=avc1.42E01E",robustness:"HW_SECURE_ALL"}]}];try{await navigator.requestMediaKeySystemAccess("com.widevine.alpha.experiment",n),e=!0}catch{}return console.log("Supported advanced DRM: "+e),e}async function y(e){let n=await GM_getValue("NETFLIX_PLUS_"+e);return typeof n=="boolean"?n:t.globalOptions[e]}async function k(e,n){let a=await y(n);return t.globalOptions[n]=a,await GM_registerMenuCommand((await y(n)?"\u2705":"\u{1F532}")+" "+e,async function(){await GM_setValue("NETFLIX_PLUS_"+n,!a),t.globalOptions[n]=!a,m()})}async function m(){for(let e of f)await GM_unregisterMenuCommand(e);f=[];for(let e of O)f.push(await k(e[1],e[0]))}m()})();
