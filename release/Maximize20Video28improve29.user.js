// ==UserScript==
// @name                Maximize Video(improve)
// @namespace           https://github.com/ryomahan
// @author              冻猫, ryomahan
// @include             *
// @exclude             *www.w3school.com.cn*
// @version             12.5
// @run-at              document-end
// @license             MIT
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Maximize20Video28improve29.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Maximize20Video28improve29.meta.js
// ==/UserScript==
(()=>{const e={isFull:!1,isIframe:!1,autoCheckCount:0},p={"www.acfun.cn":[".player-container .player"],"www.bilibili.com":["#bilibiliPlayer"],"www.douyu.com":["#js-player-video-case"],"www.huya.com":["#videoContainer"],"www.twitch.tv":[".player"],"www.youtube.com":["#ytd-player"],"www.miguvideo.com":["#mod-player"],"www.yy.com":["#player"],"*weibo.com":['[aria-label="Video Player"]',".html5-video-live .html5-video"],"v.huya.com":["#video_embed_flash>div"]},h=[".dplayer",".video-js",".jwplayer","[data-player]"];window.top!==window.self&&(e.isIframe=!0),navigator.language.toLocaleLowerCase()=="zh-cn"?e.btnText={max:"\u7F51\u9875\u5168\u5C4F",pip:"\u753B\u4E2D\u753B",tip:"Iframe\u5185\u89C6\u9891\uFF0C\u8BF7\u7528\u9F20\u6807\u70B9\u51FB\u89C6\u9891\u540E\u91CD\u8BD5"}:e.btnText={max:"Maximize",pip:"PicInPic",tip:"Iframe video. Please click on the video and try again"};const n={print(t){const o=new Date,i=o.getFullYear(),a=(o.getMonth()+1<10?"0":"")+(o.getMonth()+1),r=(o.getDate()<10?"0":"")+o.getDate(),c=(o.getHours()<10?"0":"")+o.getHours(),m=(o.getMinutes()<10?"0":"")+o.getMinutes(),y=(o.getSeconds()<10?"0":"")+o.getSeconds(),f="["+i+"-"+a+"-"+r+" "+c+":"+m+":"+y+"]";console.log(f+"[Maximize Video] > "+t)},getRect(t){const o=t.getBoundingClientRect(),i=n.getScroll();return{pageX:o.left+i.left,pageY:o.top+i.top,screenX:o.left,screenY:o.top}},isHalfFullClient(t){const o=n.getClient(),i=n.getRect(t);return Math.abs(o.width-t.offsetWidth)<21&&i.screenX<20||Math.abs(o.height-t.offsetHeight)<21&&i.screenY<10?Math.abs(t.offsetWidth/2+i.screenX-o.width/2)<21&&Math.abs(t.offsetHeight/2+i.screenY-o.height/2)<21:!1},isAllFullClient(t){const o=n.getClient(),i=n.getRect(t);return Math.abs(o.width-t.offsetWidth)<21&&i.screenX<20&&Math.abs(o.height-t.offsetHeight)<21&&i.screenY<10},getScroll(){return{left:document.documentElement.scrollLeft||document.body.scrollLeft,top:document.documentElement.scrollTop||document.body.scrollTop}},getClient(){return{width:document.compatMode=="CSS1Compat"?document.documentElement.clientWidth:document.body.clientWidth,height:document.compatMode=="CSS1Compat"?document.documentElement.clientHeight:document.body.clientHeight}},addStyle(t){const o=document.createElement("style");o.type="text/css";const i=document.createTextNode(t);return o.appendChild(i),document.head.appendChild(o),o},matchRule(t,o){return new RegExp("^"+o.split("*").join(".*")+"$").test(t)},createButton(t){const o=document.createElement("tbdiv");return o.id=t,o.onclick=()=>{s.playerControl()},document.body.appendChild(o),o},async addTip(t){if(!document.getElementById("catTip")){const o=document.createElement("tbdiv");o.id="catTip",o.innerHTML=t,o.style.cssText='transition: all 0.8s ease-out;background: none repeat scroll 0 0 #27a9d8;color: #FFFFFF;font: 1.1em "\u5FAE\u8F6F\u96C5\u9ED1";margin-left: -250px;overflow: hidden;padding: 10px;position: fixed;text-align: center;bottom: 100px;z-index: 300;',document.body.appendChild(o),o.style.right=-o.offsetWidth-5+"px",await new Promise(i=>{o.style.display="block",setTimeout(()=>{o.style.right="25px",i("OK")},300)}),await new Promise(i=>{setTimeout(()=>{o.style.right=-o.offsetWidth-5+"px",i("OK")},3500)}),await new Promise(i=>{setTimeout(()=>{document.body.removeChild(o),i("OK")},1e3)})}}},d={init(){if(document.getElementById("playerControlBtn")||u(),e.isIframe&&n.isHalfFullClient(e.player)){window.parent.postMessage("iframeVideo","*");return}this.show()},show(){e.player.removeEventListener("mouseleave",l.leavePlayer,!1),e.player.addEventListener("mouseleave",l.leavePlayer,!1),e.isFull||(document.removeEventListener("scroll",l.scrollFix,!1),document.addEventListener("scroll",l.scrollFix,!1)),e.controlBtn.style.display="block",e.controlBtn.style.visibility="visible",document.pictureInPictureEnabled&&e.player.nodeName!="OBJECT"&&e.player.nodeName!="EMBED"&&(e.picinpicBtn.style.display="block",e.picinpicBtn.style.visibility="visible"),this.locate()},locate(){let t;const o=!!(window.trustedTypes&&window.trustedTypes.createPolicy);o&&(t=window.trustedTypes.createPolicy("myEscapePolicy",{createHTML:(a,r)=>a}));const i=n.getRect(e.player);e.controlBtn.style.opacity="0.5",e.controlBtn.innerHTML=o?t.createHTML(e.btnText.max):e.btnText.max,e.controlBtn.style.top=i.screenY-20+"px",e.controlBtn.style.left=i.screenX-64+e.player.offsetWidth+"px",e.picinpicBtn.style.opacity="0.5",e.picinpicBtn.innerHTML=o?t.createHTML(e.btnText.pip):e.btnText.pip,e.picinpicBtn.style.top=e.controlBtn.style.top,e.picinpicBtn.style.left=i.screenX-64+e.player.offsetWidth-54+"px"}},l={getPlayer(t){if(e.isFull)return;e.mouseoverEl=t.target;const o=document.location.hostname;let i=[];for(let a in p)if(n.matchRule(o,a)){for(let r of p[a])if(document.querySelectorAll(r).length>0)for(let c of document.querySelectorAll(r))i.push(c);break}if(i.length==0){for(let a of h)if(document.querySelectorAll(a).length>0)for(let r of document.querySelectorAll(a))i.push(r)}if(i.length==0&&t.target.nodeName!="VIDEO"&&document.querySelectorAll("video").length>0){const a=document.querySelectorAll("video");for(let r of a){const c=r.getBoundingClientRect();if(t.clientX>=c.x-2&&t.clientX<=c.x+c.width+2&&t.clientY>=c.y-2&&t.clientY<=c.y+c.height+2&&r.offsetWidth>399&&r.offsetHeight>220){i=[],i[0]=l.autoCheck(r),e.autoCheckCount=1;break}}}if(i.length>0){const a=t.path||t.composedPath();for(let r of i)if(a.indexOf(r)>-1){e.player=r,d.init();return}}switch(t.target.nodeName){case"VIDEO":case"OBJECT":case"EMBED":t.target.offsetWidth>399&&t.target.offsetHeight>220&&(e.player=t.target,d.init());break;default:l.leavePlayer()}},autoCheck(t){let o,i=t;for(e.playerChilds=[],e.playerChilds.push(t);(i=i.parentNode)&&(Math.abs(t.offsetWidth-i.offsetWidth)<15&&Math.abs(t.offsetHeight-i.offsetHeight)<15);)o=i,e.playerChilds.push(i);return o},leavePlayer(){e.controlBtn.style.visibility=="visible"&&(e.controlBtn.style.opacity="",e.controlBtn.style.visibility="",e.picinpicBtn.style.opacity="",e.picinpicBtn.style.visibility="",e.player.removeEventListener("mouseleave",l.leavePlayer,!1),document.removeEventListener("scroll",l.scrollFix,!1))},scrollFix(t){clearTimeout(e.scrollFixTimer),e.scrollFixTimer=setTimeout(()=>{d.locate()},20)},hotKey(t){t.keyCode==27&&s.playerControl(),t.keyCode==113&&l.pictureInPicture()},async receiveMessage(t){switch(t.data){case"iframePicInPic":n.print("messege:iframePicInPic"),document.pictureInPictureElement?await document.exitPictureInPicture():await document.querySelector("video").requestPictureInPicture().catch(o=>{n.addTip(e.btnText.tip)});break;case"iframeVideo":n.print("messege:iframeVideo"),e.isFull||(e.player=e.mouseoverEl,d.init());break;case"parentFull":n.print("messege:parentFull"),e.player=e.mouseoverEl,e.isIframe&&window.parent.postMessage("parentFull","*"),s.checkParent(),s.fullWin(),getComputedStyle(e.player).left!="0px"&&n.addStyle("#htmlToothbrush #bodyToothbrush .playerToothbrush {left:0px !important;width:100vw !important;}"),e.isFull=!0;break;case"parentSmall":n.print("messege:parentSmall"),e.isIframe&&window.parent.postMessage("parentSmall","*"),s.smallWin();break;case"innerFull":n.print("messege:innerFull"),e.player.nodeName=="IFRAME"&&e.player.contentWindow.postMessage("innerFull","*"),s.checkParent(),s.fullWin();break;case"innerSmall":n.print("messege:innerSmall"),e.player.nodeName=="IFRAME"&&e.player.contentWindow.postMessage("innerSmall","*"),s.smallWin();break}},pictureInPicture(){document.pictureInPictureElement?document.exitPictureInPicture():e.player?e.player.nodeName=="IFRAME"?e.player.contentWindow.postMessage("iframePicInPic","*"):e.player.parentNode.querySelector("video").requestPictureInPicture():document.querySelector("video").requestPictureInPicture()}},s={playerControl(){if(e.player)if(this.checkParent(),e.isFull)e.isIframe&&window.parent.postMessage("parentSmall","*"),e.player.nodeName=="IFRAME"&&e.player.contentWindow.postMessage("innerSmall","*"),this.smallWin();else if(e.isIframe&&window.parent.postMessage("parentFull","*"),e.player.nodeName=="IFRAME"&&e.player.contentWindow.postMessage("innerFull","*"),this.fullWin(),e.autoCheckCount>0&&!n.isHalfFullClient(e.playerChilds[0])){if(e.autoCheckCount>10){for(let o of e.playerChilds)o.classList.add("videoToothbrush");return}const t=l.autoCheck(e.playerChilds[0]);e.autoCheckCount++,s.playerControl(),e.player=t,s.playerControl()}else e.autoCheckCount=0},checkParent(){if(e.isFull)return;e.playerParents=[];let t=e.player;for(;(t=t.parentNode)&&t.nodeName!="BODY";)t.getAttribute&&e.playerParents.push(t)},fullWin(){if(!e.isFull){document.removeEventListener("mouseover",l.getPlayer,!1),e.backHtmlId=document.body.parentNode.id,e.backBodyId=document.body.id,e.leftBtn.style.display="block",e.rightBtn.style.display="block",e.picinpicBtn.style.display="",e.controlBtn.style.display="",this.addClass();const t=document.location.hostname;t.includes("www.youtube.com")&&!document.querySelector("#player-theater-container #movie_player")&&document.querySelector(".html5-video-container").clientWidth-document.querySelector(".ytp-chrome-bottom").clientWidth>24&&(document.querySelector("#movie_player .ytp-size-button").click(),e.ytbStageChange=!0),t.includes("bilibili")&&(document.querySelector(".right-container").style.display="none",document.querySelector("#biliMainHeader").style.display="none")}e.isFull=!0},addClass(){document.body.parentNode.id="htmlToothbrush",document.body.id="bodyToothbrush";for(let t of e.playerParents)t.classList.add("parentToothbrush"),getComputedStyle(t).position=="fixed"&&t.classList.add("absoluteToothbrush");e.player.classList.add("playerToothbrush"),e.player.nodeName=="VIDEO"&&(e.backControls=e.player.controls,e.player.controls=!0),window.dispatchEvent(new Event("resize"))},smallWin(){document.body.parentNode.id=e.backHtmlId,document.body.id=e.backBodyId;for(let o of e.playerParents)o.classList.remove("parentToothbrush"),o.classList.remove("absoluteToothbrush");e.player.classList.remove("playerToothbrush"),document.location.hostname=="www.youtube.com"&&e.ytbStageChange&&document.querySelector("#player-theater-container #movie_player")&&(document.querySelector("#movie_player .ytp-size-button").click(),e.ytbStageChange=!1),e.player.nodeName=="VIDEO"&&(e.player.controls=e.backControls),e.leftBtn.style.display="",e.rightBtn.style.display="",e.controlBtn.style.display="",document.addEventListener("mouseover",l.getPlayer,!1),window.dispatchEvent(new Event("resize")),document.location.hostname.includes("bilibili")&&(document.querySelector(".right-container").style.removeProperty("display"),document.querySelector("#biliMainHeader").style.removeProperty("display")),e.isFull=!1}},u=()=>{e.picinpicBtn=document.createElement("tbdiv"),e.picinpicBtn.id="picinpicBtn",e.picinpicBtn.onclick=()=>{l.pictureInPicture()},document.body.appendChild(e.picinpicBtn),e.controlBtn=n.createButton("playerControlBtn"),e.leftBtn=n.createButton("leftFullStackButton"),e.rightBtn=n.createButton("rightFullStackButton"),getComputedStyle(e.controlBtn).position!="fixed"&&n.addStyle(["#htmlToothbrush #bodyToothbrush .parentToothbrush .bilibili-player-video {margin:0 !important;}","#htmlToothbrush, #bodyToothbrush {overflow:hidden !important;zoom:100% !important;}","#htmlToothbrush #bodyToothbrush .parentToothbrush {overflow:visible !important;z-index:auto !important;transform:none !important;-webkit-transform-style:flat !important;transition:none !important;contain:none !important;}","#htmlToothbrush #bodyToothbrush .absoluteToothbrush {position:absolute !important;}","#htmlToothbrush #bodyToothbrush .playerToothbrush {position:fixed !important;top:0px !important;left:0px !important;width:100vw !important;height:100vh !important;max-width:none !important;max-height:none !important;min-width:0 !important;min-height:0 !important;margin:0 !important;padding:0 !important;z-index:2147483646 !important;border:none !important;background-color:#000 !important;transform:none !important;}","#htmlToothbrush #bodyToothbrush .parentToothbrush video {object-fit:contain !important;}","#htmlToothbrush #bodyToothbrush .parentToothbrush .videoToothbrush {width:100vw !important;height:100vh !important;}",'#playerControlBtn {text-shadow: none;visibility:hidden;opacity:0;display:none;transition: all 0.5s ease;cursor: pointer;font: 12px "\u5FAE\u8F6F\u96C5\u9ED1";margin:0;width:64px;height:20px;line-height:20px;border:none;text-align: center;position: fixed;z-index:2147483647;background-color: #27A9D8;color: #FFF;} #playerControlBtn:hover {visibility:visible;opacity:1;background-color:#2774D8;}','#picinpicBtn {text-shadow: none;visibility:hidden;opacity:0;display:none;transition: all 0.5s ease;cursor: pointer;font: 12px "\u5FAE\u8F6F\u96C5\u9ED1";margin:0;width:53px;height:20px;line-height:20px;border:none;text-align: center;position: fixed;z-index:2147483647;background-color: #27A9D8;color: #FFF;} #picinpicBtn:hover {visibility:visible;opacity:1;background-color:#2774D8;}',"#leftFullStackButton{display:none;position:fixed;width:1px;height:100vh;top:0;left:0;z-index:2147483647;background:#000;}","#rightFullStackButton{display:none;position:fixed;width:1px;height:100vh;top:0;right:0;z-index:2147483647;background:#000;}"].join(`
`)),document.addEventListener("mouseover",l.getPlayer,!1),document.addEventListener("keydown",l.hotKey,!1),window.addEventListener("message",l.receiveMessage,!1),n.print("Ready")};u()})();
