// ==UserScript==
// @name        ðŸ† [#1 Chess Assistant] A.C.A.S (Advanced Chess Assistance System)
// @name:en     ðŸ† [#1 Chess Assistant] A.C.A.S (Advanced Chess Assistance System)
// @homepageURL https://psyyke.github.io/A.C.A.S
// @supportURL  https://github.com/Psyyke/A.C.A.S/tree/main#why-doesnt-it-work
// @match       https://psyyke.github.io/A.C.A.S/*
// @match       http://localhost/*
// @match       https://www.chess.com/*
// @match       https://lichess.org/*
// @match       https://playstrategy.org/*
// @match       https://www.pychess.org/*
// @match       https://chess.org/*
// @match       https://papergames.io/*
// @match       https://vole.wtf/kilobytes-gambit/
// @match       https://chess.coolmathgames.com/*
// @match       https://www.coolmathgames.com/0-chess/*
// @match       https://immortal.game/*
// @match       https://chessarena.com/*
// @match       http://chess.net/*
// @match       https://chess.net/*
// @match       https://www.freechess.club/*
// @match       https://*.chessclub.com/*
// @match       https://gameknot.com/*
// @match       https://chesstempo.com/*
// @match       https://www.redhotpawn.com/*
// @match       https://www.chessanytime.com/*
// @match       https://www.simplechess.com/*
// @match       https://chessworld.net/*
// @match       https://app.edchess.io/*
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_deleteValue
// @grant       GM_listValues
// @grant       GM_openInTab
// @grant       GM.getValue
// @grant       GM.setValue
// @grant       GM.deleteValue
// @grant       GM.listValues
// @grant       GM.openInTab
// @grant       GM_registerMenuCommand
// @grant       GM_setClipboard
// @grant       GM_notification
// @grant       unsafeWindow
// @run-at      document-start
// @require     https://update.greasyfork.org/scripts/534637/LegacyGMjs.js?acasv=2
// @require     https://update.greasyfork.org/scripts/470418/CommLinkjs.js?acasv=2
// @require     https://update.greasyfork.org/scripts/470417/UniversalBoardDrawerjs.js?acasv=1
// @icon        https://raw.githubusercontent.com/Psyyke/A.C.A.S/main/assets/images/grey-logo.png
// @version     2.3.1
// @namespace   HKR
// @author      HKR
// @license     GPL-3.0
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/F09F8F86205B120Chess20Cheat5D20ACAS2028Advanced20Chess20Assistance20System29.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/F09F8F86205B120Chess20Cheat5D20ACAS2028Advanced20Chess20Assistance20System29.meta.js
// ==/UserScript==
(async()=>{await LOAD_LEGACY_GM_SUPPORT();const F={hosts:{prod:"psyyke.github.io",dev:"localhost"},path:"/A.C.A.S/"},G="currentBackendURL",Re=typeof GM_getValue=="function"?GM_getValue(G):await GM.getValue(G),Oe=Object.values(F.hosts).some(e=>Re?.includes(e));function I(e){const t=window.location.protocol+"//",o=F.hosts;return t+(e||o?.prod||o?.path)+F.path}function qe(e){const o=Object.values(F.hosts).find(s=>s===window?.location?.host),n=window?.location?.pathname?.includes(F.path),r=typeof o=="string"&&n;return r&&!e&&GM_setValue(G,I(o)),r}const M=!1,Fe=!1,N=window.location.hostname.replace("www.",""),je="https://greasyfork.org/en/scripts/459137";function Ve(e){return!e.startsWith("http://")&&!e.startsWith("https://")?"http://"+e:e}function ae(e){if(Fe)return I(F.hosts?.dev);const t=GM_getValue(G);return e||!t?I():Ve(t)}Oe||GM_setValue(G,ae(!0));function he(e){return{set:(t,o)=>GM_setValue(_[e](t),{value:o,date:Date.now()}),get:t=>{const o=GM_getValue(_[e](t));return o?.date&&(o.date=Date.now(),GM_setValue(_[e](t),o)),o?.value}}}const ce="-temp-value-",_={AcasConfig:"AcasConfig",playerColor:e=>"playerColor"+ce+e,turn:e=>"turn"+ce+e,fen:e=>"fen"+ce+e},R={playerColor:he("playerColor"),fen:he("fen")};function Te(){const e={USERSCRIPT_getValue:(o,n)=>{const[r]=o,s=GM_getValue(r);window.postMessage({messageId:n,value:s},"*")},USERSCRIPT_setValue:(o,n)=>{const[r,s]=o;GM_setValue(r,s),window.postMessage({messageId:n,value:!0},"*")},USERSCRIPT_deleteValue:(o,n)=>{const[r]=o;GM_deleteValue(r),window.postMessage({messageId:n,value:!0},"*")},USERSCRIPT_listValues:(o,n)=>{const r=GM_listValues();window.postMessage({messageId:n,value:r},"*")},USERSCRIPT_getInfo:(o,n)=>{const r=typeof GM_info<"u"?JSON.parse(JSON.stringify(GM_info)):{};window.postMessage({messageId:n,value:r},"*")},USERSCRIPT_instanceVars:(o,n)=>{const[r,s,i]=o;if(!R.hasOwnProperty(s)){window.postMessage({messageId:n,value:!1},"*");return}const a=i!==void 0?R[s].set(r,i):R[s].get(r);window.postMessage({messageId:n,value:a},"*")}};window.addEventListener("message",o=>{const n=e[o.data?.type];n&&n(o.data.args,o.data.messageId)});const t=document.createElement("script");t.innerHTML="window.isUserscriptActive = true;",document.head.appendChild(t)}function Be(){typeof unsafeWindow=="object"&&(unsafeWindow.USERSCRIPT={getValue:e=>GM_getValue(e),setValue:(e,t)=>GM_setValue(e,t),deleteValue:e=>GM_deleteValue(e),listValues:e=>GM_listValues(e),instanceVars:R,getInfo:()=>GM_info},unsafeWindow.isUserscriptActive=!0)}if(qe()){typeof unsafeWindow=="object"?Be():Te();return}function fe(){return("10000000-10004000-8000"+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}const C=fe(),Ue=[I(F?.hosts?.prod),I(F?.hosts?.dev),"https://www.chess.com/play","https://lichess.org/","https://chess.org/","https://papergames.io/en/chess","https://playstrategy.org/","https://www.pychess.org/","https://www.coolmathgames.com/0-chess","https://chess.net/"],g={engineElo:"engineElo",moveSuggestionAmount:"moveSuggestionAmount",arrowOpacity:"arrowOpacity",displayMovesOnExternalSite:"displayMovesOnExternalSite",showMoveGhost:"showMoveGhost",showOpponentMoveGuess:"showOpponentMoveGuess",showOpponentMoveGuessConstantly:"showOpponentMoveGuessConstantly",onlyShowTopMoves:"onlyShowTopMoves",maxMovetime:"maxMovetime",chessVariant:"chessVariant",chessEngine:"chessEngine",lc0Weight:"lc0Weight",engineNodes:"engineNodes",chessFont:"chessFont",useChess960:"useChess960",onlyCalculateOwnTurn:"onlyCalculateOwnTurn",ttsVoiceEnabled:"ttsVoiceEnabled",ttsVoiceName:"ttsVoiceName",ttsVoiceSpeed:"ttsVoiceSpeed",chessEngineProfile:"chessEngineProfile",primaryArrowColorHex:"primaryArrowColorHex",secondaryArrowColorHex:"secondaryArrowColorHex",opponentArrowColorHex:"opponentArrowColorHex",reverseSide:"reverseSide",autoMove:"autoMove",autoMoveLegit:"autoMoveLegit",autoMoveRandom:"autoMoveRandom",autoMoveAfterUser:"autoMoveAfterUser",legitModeType:"legitModeType",moveDisplayDelay:"moveDisplayDelay",renderOnExternalSite:"renderOnExternalSite",feedbackOnExternalSite:"feedbackOnExternalSite"},le={};Object.values(g).forEach(e=>{le[e]={get:t=>et(e,C,t),set:null}});let w=null,E=null,Y=null,H=[],ge=[],be=[],A=null,L=null,ue=null,$=null,Ge=null,ye=null,K=!1,we=0,Ee=0,x=!1,J=[];const ve={},b={pawn:"p",knight:"n",bishop:"b",rook:"r",queen:"q",king:"k"};function de(e,t,o){const n=["stroke: rgb(0 0 0 / 50%);","stroke-width: 2px;","stroke-linejoin: round;"];switch(e){case"best":return[`fill: ${t||"limegreen"};`,`opacity: ${o||.9};`,...n].join(`
`);case"secondary":return[...n,`fill: ${t||"dodgerblue"};`,`opacity: ${o||.7};`].join(`
`);case"opponent":return[...n,`fill: ${t||"crimson"};`,`opacity: ${o||.3};`].join(`
`)}}const h=new CommLinkHandler(`frontend_${C}`,{singlePacketResponseWaitTime:1500,maxSendAttempts:3,statusCheckInterval:1,silentMode:!0});h.commands.createInstance=async()=>await h.send("mum","createInstance",{domain:N,instanceID:C,chessVariant:it(),playerColor:P()}),h.registerSendCommand("ping",{commlinkID:"mum",data:"ping"}),h.registerSendCommand("pingInstance",{data:"ping"}),h.registerSendCommand("log"),h.registerSendCommand("updateBoardOrientation"),h.registerSendCommand("updateBoardFen"),h.registerSendCommand("calculateBestMoves"),h.registerListener(`backend_${C}`,e=>{try{switch(e.command){case"ping":return`pong (took ${Date.now()-e.date}ms)`;case"getFen":return oe();case"removeSiteMoveMarkings":return B.removeMarkings(),!0;case"markMoveToSite":B.markMoves(e.data);const t=e.data?.[0]?.profile,o=S(g.autoMove,t),n=S(g.autoMoveAfterUser,t);if(o&&(!n||K)){const r=J.filter(c=>c.move.active);for(const c of r)c.move.stop();const s=S(g.autoMoveLegit,t),a=S(g.autoMoveRandom,t)?e.data[Math.floor(Math.random()*Math.random()*e.data.length)]?.player:e.data[0]?.player;Ze(t,a,s)}return K=!0,!0;case"renderMetricsToSite":return _e(e.data),!0;case"feedbackToSite":return $e(e.data),!0}}catch{return null}});function Ie(){ge.forEach(e=>{e&&e?.remove()})}function _e(e){Ie();function t(n){const r=n?.data;if(!r)return;const s=r?.shapeType,i=r?.shapeSquare,a=r?.shapeConfig;if(s&&i&&a){const c=w.createShape(s,i,a);ge.push(c)}}function o(n){return e.filter(r=>r?.data?.shapeType===n)||[]}o("text").forEach(t),o("rectangle").forEach(t)}function He(){be.forEach(e=>{e&&e?.remove()})}function $e(e){He();function t(o){const n=o?.data;if(!n)return;const r=n?.shapeType,s=n?.shapeSquare,i=n?.shapeConfig;if(r&&s&&i){const a=w.createShape(r,s,i);be.push(a)}}e.forEach(t)}const B={markMoves:e=>{const n=e.length;e.forEach((r,s)=>{const i=r.profile;s===0&&B.removeMarkings(i);const[a,c]=r.player,[l,u]=r.opponent,d=l&&u,m=s+1,y=S(g.showOpponentMoveGuess,i),q=S(g.showOpponentMoveGuessConstantly,i),p=S(g.arrowOpacity,i)/100,k=S(g.primaryArrowColorHex,i),gt=S(g.secondaryArrowColorHex,i),bt=S(g.opponentArrowColorHex,i);let X=null,j=null,Ne=de("best",k,p),ne=30,re=80,se=60,ie=30;if(s!==0){Ne=de("secondary",gt,p);const V=n===2?.75:1-(1-.5)*((m-1)/(n-1));ne=ne*V,re=re*V,se=se*V,ie=ie}if(X=w.createShape("arrow",[a,c],{style:Ne,lineWidth:ne,arrowheadWidth:re,arrowheadHeight:se,startOffset:ie}),d&&y)if(j=w.createShape("arrow",[l,u],{style:de("opponent",bt,p),lineWidth:ne,arrowheadWidth:re,arrowheadHeight:se,startOffset:ie}),q)j.style.display="block";else{const V=w.addSquareListener(a,yt=>{switch(j||V.remove(),yt){case"enter":j.style.display="inherit";break;case"leave":j.style.display="none";break}})}if(s===0&&X){const V=X.parentElement;V.appendChild(X),j&&V.appendChild(j)}H.push({...r,playerArrowElem:X,oppArrowElem:j,profile:i})})},removeMarkings:e=>{let t=H;e?(t=t.filter(o=>o.profile===e),H=H.filter(o=>o.profile!==e)):H=[],t.forEach(o=>{o.oppArrowElem?.remove(),o.playerArrowElem?.remove()})},setBoardOrientation:e=>{w&&(M&&console.warn("setBoardOrientation",e),w.setOrientation(e))},setBoardDimensions:e=>{w&&(M&&console.warn("setBoardDimensions",e),w.setBoardDimensions(e))}};function Z(e,t){typeof GM_notification=="function"?GM_notification({title:e,text:t}):alert(`[${e}]

`+t)}function Ce(e,t){return[...e].filter(o=>{const n=getComputedStyle(o),r=o.getBoundingClientRect(),s=n.visibility==="hidden"||n.display==="none"||n.opacity==="0"||r.width==0||r.height==0;return t?s:!s})}function U(e){const t=e.getBoundingClientRect();if(t.width!==0&&t.height!==0)return{width:t.width,height:t.height};const o=window.getComputedStyle(e),n=parseFloat(o.width),r=parseFloat(o.height);return{width:n,height:r}}function We(e){const t=window.getComputedStyle(e),o=new DOMMatrix(t.transform),n=o.e,r=o.f;return[n,r]}function ee(e,t){const o=t?.onlyFlipX,n=t?.onlyFlipY;ue=U(E);const[r,s]=D();A=s,L=r;const i=P();let[a,c]=We(e),u=ue.width/A;const d=Math.round(a/u),m=Math.round(c/u);if(n||i==="w"){const y=L-m-1;return[d,y]}else return[A-d-1,m]}function wt(e){if(!A||!L){const[i,a]=D();A=a,L=i}const t=P(),o=parseFloat(e.style.left?.replace("%","")),n=parseFloat(e.style.bottom?.replace("%","")),r=Math.max(Math.round(o/(100/A)),0),s=Math.max(Math.round(n/(100/L)),0);if(t==="w")return[r,s];{const i=A-(r+1),a=L-(s+1);return[i,a]}}function me(e){const t=U(e);$=t;const o=parseFloat(e.style.left?.replace("px","")),n=parseFloat(e.style.top?.replace("px","")),r=Math.max(Math.round(o/t.width),0),s=Math.max(Math.round(n/t.width),0);if(P()==="w"){const a=L-(s+1);return[r,a]}else return[A-(r+1),s]}function Qe(){let e=[];document.querySelectorAll("*[data-color]").forEach(t=>{const o=Number(t?.dataset?.color);e?.includes(o)||e.push(o)}),e?.length>1&&(e=e.sort((t,o)=>t-o),Y={[e[0]]:"w",[e[1]]:"b"})}function Me(){const e=U(E);ue=e;const t=e?.width,o=e.height,n=Q();if(n){const r=U(n);$=U(n);const s=r?.width,i=r?.height,a=Math.floor(t/s),c=Math.floor(o/i),l=0<a&&a<=69,u=0<c&&c<=69;if(l&&u)return[a,c]}}function v(e){const t=e.charCodeAt(0)-97;let o=null;return e.slice(1)===":"?o=9:o=Number(e.slice(1))-1,[t,o]}function ze(e){const[t,o]=D(),n=v(e);let r,s;return s=o-(n[1]+1),r=n[0],[r,s]}function Xe(e){const[t,o]=D(),n=v(e),r=z();let s,i;return r==="w"?(s=n[0],i=o-(n[1]+1)):(s=t-(n[0]+1),i=n[1]),[s,i]}function Ye(e){const[t,o]=D(),n=z(),[r,s]=e,i=String.fromCharCode(97+r);let a;return a=t-s,`${i}${a}`}function Ke(e){const[t,o]=e,n=T(t);if(typeof n!="string"||n.toLowerCase()!=="p")return!1;const r=parseInt(o[1],10);return n==="P"&&r===(L??8)||n==="p"&&r===1}function Se(e){const t=E.getBoundingClientRect(),o=Q(),n=U(o),r=n?.width,s=n?.height;$=n;const[i,a]=D();return e.map(l=>{const[u,d]=Xe(l),m=t.x+u*r+r/2,y=t.y+d*s+s/2;return[m,y]})}function ke(e,t){const o=z();let[n,r]=ze(e);const s=t[r][n];if(s===1)return null;const i=s===s.toUpperCase(),a=(l,u,d,m)=>Math.abs(l-d)+Math.abs(u-m);let c=[];for(let l=0;l<t.length;l++)for(let u=0;u<t[l].length;u++){const d=t[l][u];if(d===1||i&&d===d.toLowerCase()||!i&&d===d.toUpperCase())continue;const m=a(r,n,l,u);m<6&&c.push({distance:m,coord:[u,l],piece:d})}if(c.length>0){const l=Math.floor(Math.random()*c.length),u=c[l];return Se([Ye(u.coord)])[0]}return null}function Ae(){return Q(!0)?.length??0}class Je{constructor(t,o,n,r){if(this.id=fe(),J.push({id:this.id,move:this}),this.profile=t,this.fenMoveArr=o,this.isLegit=n,this.active=!0,this.isPromotingPawn=!1,this.onFinished=function(...s){J.filter(i=>i.id!==this.id),this.active=!1,r(...s)},this.moveDomCoords=Se(o),this.isPromotion=Ke(o),this.isLegit){const s=S(g.legitModeType,this.profile)??"casual",i=[{minPieces:30,maxPieces:1/0},{minPieces:23,maxPieces:29},{minPieces:16,maxPieces:22},{minPieces:10,maxPieces:15},{minPieces:6,maxPieces:9},{minPieces:3,maxPieces:5},{minPieces:1,maxPieces:2}],a={beginner:[[2e3,4e3],[3e3,15e3],[5e3,25e3],[4e3,3e4],[3e3,15e3],[2e3,1e4],[1e3,4e3]],casual:[[900,3e3],[1e3,15e3],[3e3,2e4],[2e3,13e3],[1500,1e4],[1e3,9e3],[500,3e3]],intermediate:[[750,2e3],[1e3,1e4],[2e3,15e3],[1500,12e3],[1e3,8e3],[750,7e3],[500,2e3]],advanced:[[500,1500],[1e3,8e3],[750,8e3],[750,12e3],[750,5e3],[750,3e3],[500,1200]],master:[[333,999],[400,2e3],[400,3e3],[400,2500],[400,2e3],[400,1500],[333,750]],professional:[[333,666],[333,666],[333,1e3],[333,1500],[333,1e3],[333,666],[333,666]],god:[[50,333],[50,233],[50,300],[50,250],[50,200],[50,150],[50,100]]};this.timeRanges=i.map((m,y)=>({...m,timeRange:a[s][y]})),this.shouldHesitate=this.isLegit&&Math.random()<.15,this.shouldHesitateTwice=this.isLegit&&Math.random()<.25,this.hesitationTypeOne=this.isLegit&&Math.random()<.35;const c=this.calculateMoveTime(Ae()),l=Date.now()-we,u=Math.max(c-l,500),d=this.generateDelaysForDesiredTime(u);for(const m of Object.keys(d))this[m]=d[m]}this.start()}generateDelaysForDesiredTime(t){const o=this.getRandomIntegerBetween(1e3,1111);if(t>6e3){const n=[{move:.4,to:.2,hesitation:.15,hesitationResolve:.15,secondHesitationResolve:.15},{move:.1,to:.3,hesitation:.25,hesitationResolve:.15,secondHesitationResolve:.2},{move:.2,to:.25,hesitation:.2,hesitationResolve:.2,secondHesitationResolve:.15}],r=n[Math.floor(Math.random()*n.length)];return{promotionDelay:o,moveDelay:t*r.move,toSquareSelectDelay:t*r.to,hesitationDelay:t*r.hesitation,hesitationResolveDelay:t*r.hesitationResolve,secondHesitationResolveDelay:t*r.secondHesitationResolve}}if(t>3e3){const n=[{move:.3,to:.2,hesitation:.25,hesitationResolve:.25},{move:.1,to:.3,hesitation:.45,hesitationResolve:.15},{move:.2,to:.25,hesitation:.2,hesitationResolve:.35}],r=n[Math.floor(Math.random()*n.length)];return{promotionDelay:o,moveDelay:t*r.move,toSquareSelectDelay:t*r.to,hesitationDelay:t*r.hesitation,hesitationResolveDelay:t*r.hesitationResolve,secondHesitationResolveDelay:-1}}else{const n=[{move:.9,to:.1},{move:.45,to:.55},{move:.6,to:.4},{move:.4,to:.6},{move:.1,to:.9}],r=n[Math.floor(Math.random()*n.length)];return{promotionDelay:o,moveDelay:t*r.move,toSquareSelectDelay:t*r.to,hesitationDelay:-1,hesitationResolveDelay:-1,secondHesitationResolveDelay:-1}}}calculateMoveTime(t){for(let o of this.timeRanges)if(t>=o.minPieces&&t<=o.maxPieces)return this.getRandomIntegerBetween(o.timeRange[0],o.timeRange[1]);return 500}getRandomIntegerBetween(t,o){return Math.floor(Math.random()*(o-t+1))+t}getRandomIntegerNearAverage(t,o){const n=(t+o)/2,r=(o-t)/2;let s=Math.floor(n+(Math.random()-.5)*r*1.5);return Math.max(t,Math.min(o,s))}delay(t){return this.active?new Promise(o=>setTimeout(o,t)):!0}async triggerPieceClick(t){if(!!!J.find(p=>p.move===this))return;let n,r;if(t instanceof Element){const p=t.getBoundingClientRect();n=p.left+p.width/2,r=p.top+p.height/2}else if(typeof t=="object")n=t[0],r=t[1];else return;const s=Math.random()<.85?4:Math.random()<.15?3:2,i=Math.random()<.65?3:Math.random()<.35?2:4,a=($?.width-4)/s,c=($?.height-4)/i,l=(Math.random()-.5)*2*a,u=(Math.pow(Math.random(),.5)-.5)*2*c,d=n+l,m=r+u,y={bubbles:!0,cancelable:!0,clientX:d,clientY:m},q=t instanceof Element?t:document.elementFromPoint(n,r);if(q)switch(N){case"chess.com":q.dispatchEvent(new PointerEvent("pointerdown",y)),this.isLegit&&await this.delay(this.getRandomIntegerNearAverage(35,125)),q.dispatchEvent(new PointerEvent("pointerup",y));break;case"lichess.org":q.dispatchEvent(new MouseEvent("mousedown",y)),this.isLegit&&await this.delay(this.getRandomIntegerNearAverage(35,125)),q.dispatchEvent(new MouseEvent("mouseup",y));break;case"chessarena.com":q.dispatchEvent(new MouseEvent("mousedown",y)),this.isLegit&&await this.delay(this.getRandomIntegerNearAverage(35,125)),q.dispatchEvent(new MouseEvent("mouseup",y));break}if(M){const p=document.createElement("div");p.style.position="absolute",p.style.width="7px",p.style.height="7px",p.style.borderRadius="50%",p.style.backgroundColor="lime",p.style.left=`${d-2.5}px`,p.style.top=`${m-2.5}px`;const k=document.createElement("div");k.style.position="absolute",k.style.width=`${Math.round(a*2)}px`,k.style.height=`${Math.round(c*2)}px`,k.style.border="2px dashed green",k.style.backgroundColor="rgba(0, 0, 0, 0.3)",k.style.left=`${n-a}px`,k.style.top=`${r-c}px`,document.body.appendChild(k),document.body.appendChild(p),setTimeout(()=>{p.remove(),k.remove()},1e3)}}click(t){this.active&&this.triggerPieceClick(t)}async hesitate(){const t=ke(this.fenMoveArr[0],te());if(t&&(this.hesitationTypeOne&&(this.click(this.moveDomCoords[0]),await this.delay(this.hesitationDelay)),this.click(t),await this.delay(this.hesitationResolveDelay),this.shouldHesitateTwice&&this.secondHesitationResolveDelay!==-1)){const o=ke(this.fenMoveArr[0],te());this.click(o),await this.delay(this.secondHesitationResolveDelay)}this.finishMove(this.toSquareSelectDelay,this.promotionDelay)}async finishMove(t,o){this.click(this.moveDomCoords[0]),await this.delay(t),this.click(this.moveDomCoords[1]),this.isPromotion&&(this.isPromotingPawn=!0,await this.delay(o),this.click(this.moveDomCoords[1]),this.isPromotingPawn=!1),this.onFinished(!0)}async playLegit(){await this.delay(this.moveDelay),this.shouldHesitate&&this.hesitationDelay!==-1?this.hesitate():this.finishMove(this.toSquareSelectDelay,this.promotionDelay)}async start(){this.isLegit?this.playLegit():this.finishMove(5,1111)}async stop(){this.isPromotingPawn&&this.click(this.moveDomCoords[1]),this.onFinished(!1)}}async function Ze(e,t,o){const n=new Je(e,t,o,r=>{M&&console.warn("Move",t,n.id,"finished","for profile:",e)})}function et(e,t,o){typeof o=="object"&&(o=o.name);const n=GM_getValue(_.AcasConfig),r=n?.instance?.[t]?.[e],s=n?.global?.[e];if(r!==void 0)return r;if(s!==void 0)return s;if(o){const i=n?.global?.profiles?.[o]?.[e],a=n?.instance?.[t]?.profiles?.[o]?.[e];if(a!==void 0)return a;if(i!==void 0)return i}return null}function tt(){const e=GM_getValue(_.AcasConfig),t=e?.global?.profiles,o=e?.instance?.[C]?.profiles;if(t){const n=Object.keys(t);for(profileName of n){const r=t[profileName][g.displayMovesOnExternalSite],s=t[profileName][g.renderOnExternalSite],i=t[profileName][g.feedbackOnExternalSite];if(r||s||i)return!0}}if(o){const n=Object.keys(o);for(profileName of n){const r=o[profileName][g.displayMovesOnExternalSite],s=t[profileName][g.renderOnExternalSite],i=t[profileName][g.feedbackOnExternalSite];if(r||s||i)return!0}}return!1}function S(e,t){return le[e]?.get(t)}function Et(e,t){return le[e]?.set(t)}function ot(e){return e.replace(/1+/g,t=>t.length)}function P(){return R.playerColor.get(C)}function nt(e){return e==e.toUpperCase()?"w":"b"}function vt(e){return nt(e)=="w"?"b":"w"}function rt(e){if(!e||e.length!==2)return null;const t=e[0].toLowerCase(),o=e[1];return t==="w"?o.toUpperCase():t==="b"?o.toLowerCase():null}function st(e,[t,o],n){const r=e.getContext("2d"),s=t*e.width,i=o*e.height,c=r.getImageData(s,i,1,1).data,l=(c[0]+c[1]+c[2])/3;if(n){const u=document.createElement("canvas");u.width=e.width,u.height=e.height;const d=u.getContext("2d");d.drawImage(e,0,0),d.fillStyle="red",d.beginPath(),d.arc(s,i,1,0,Math.PI*2),d.fill();const m=u.toDataURL();console.log(e,c,m)}return l<128?"b":"w"}function Le(e,[t,o],n){t=Math.min(Math.max(t,0),100),o=Math.min(Math.max(o,0),100);const r=e.getContext("2d"),s=t*e.width,i=o*e.height,c=r.getImageData(s,i,1,1).data;if(n){const l=document.createElement("canvas");l.width=e.width,l.height=e.height;const u=l.getContext("2d");u.drawImage(e,0,0),u.fillStyle="red",u.beginPath(),u.arc(s,i,1,0,Math.PI*2),u.fill();const d=l.toDataURL();console.log(e,c,d)}return c[3]!==0}function O(e,t){let n={pathname:window.location.pathname};t&&typeof t=="object"&&(n={...n,...t});const r=ve[N]?.[e];return typeof r!="function"?null:r(n)}function f(e,t){ve[e]=t}function W(){return O("boardElem")||null}function Q(e){const t=W(),o=e?r=>[...t?.querySelectorAll(r)]:t?.querySelector?.bind(t);return typeof o!="function"?null:O("pieceElem",{boardQuerySelector:o,getAll:e})||null}function Ct(e){return O("squareElems",{element:e})||null}function it(){return O("chessVariant")||null}function z(){return O("boardOrientation")||null}function at(e){return O("pieceElemFen",{pieceElem:e})||null}function ct(e){return O("pieceElemCoords",{pieceElem:e})||null}function D(){const e=O("boardDimensions");return e?(A=e[0],L=e[1],e):(A=8,L=8,[8,8])}function lt(e){return O("isMutationNewMove",{mutationArr:e})||!1}function te(){const[e,t]=D(),o=Array.from({length:t},()=>Array(e).fill(1)),n=Q(!0);return(Array.isArray(n)||n instanceof NodeList)&&n.forEach(s=>{const i=at(s),a=ct(s);try{const[c,l]=a;o[t-(l+1)][c]=i}catch(c){M&&console.error(c)}}),Ge=o,o}function T(e){const[t,o]=D(),n=v(e);return te()?.[o-(n[1]+1)]?.[n[0]]}function ut(){let e="";const t=T("e1"),o=T("h1"),n=T("a1");t=="K"&&o=="R"&&(e+="K"),t=="K"&&n=="R"&&(e+="Q");const r=T("e8"),s=T("h8"),i=T("a8");return r=="k"&&s=="r"&&(e+="k"),r=="k"&&i=="r"&&(e+="q"),e||"-"}function dt(){const e=te();return ot(e.map(t=>t.join("")).join("/"))}function oe(e){const t=dt();return M&&console.warn("basicFen",t),e?t:`${t} ${P()} ${ut()} - 0 1`}function xe(){Y=null}function Mt(e){const t=e.split("/"),o=[];for(let n of t){const r=[];for(let s of n)isNaN(s)?r.push(s):r.push(...Array(parseInt(s)).fill(""));o.push(r)}return o}function pe(e,t){const o=oe(),n=R.fen.get(C);if(o!==n||t){M&&console.warn("NEW MOVE DETECTED!");const s=Ae();Math.abs(s-Ee)>7&&(K=!1),xe(),B.setBoardDimensions(D());const a=P();Pe();const c=P(),l=c!=a;l&&(h.commands.log(`Player color (e.g. board orientation) changed from ${a} to ${c}!`),xe(),K=!1,h.commands.log(`Turn updated to ${c}!`)),B.removeMarkings(),h.commands.updateBoardFen(o),we=Date.now(),Ee=s,l&&h.commands.calculateBestMoves(o)}}function mt(){new MutationObserver(t=>{if(M&&console.log(t),lt(t)){M&&console.warn("Mutation is a new move:",t);try{N==="chess.org"||N==="chessarena.com"?setTimeout(()=>pe(t),250):pe(t)}catch(o){M&&console.error("Error while running onNewMove:",o)}}}).observe(E,{childList:!0,subtree:!0,attributes:!0})}async function Pe(){const e=z(),t=ye!==e,o=w&&w?.orientation!==e;(t||o)&&(ye=e,R.playerColor.set(C,e),B.setBoardOrientation(e),await h.commands.updateBoardOrientation(e))}f("chess.com",{boardElem:e=>e.pathname?.includes("/variants")?document.querySelector(".TheBoard-layers"):document.querySelector("#board-layout-chessboard > .board"),pieceElem:e=>{const t=e.pathname,o=e.getAll;if(t?.includes("/variants")){const n=Ce(document.querySelectorAll(".TheBoard-layers *[data-piece]")).filter(r=>r?.dataset?.piece?.toLowerCase()!=="x");return o?n:n[0]}return e.boardQuerySelector(".piece")},squareElems:e=>{const t=e.pathname,o=e.element;if(t?.includes("/variants"))return[...o.querySelectorAll(".square")]},chessVariant:e=>{const t=e.pathname;if(t?.includes("/variants")){const o=t.match(/variants\/([^\/]*)/)?.[1].replaceAll("-chess","").replaceAll("-","");return{"doubles-bughouse":"bughouse","paradigm-chess30":"paradigm"}[o]||o}},boardOrientation:e=>{if(e.pathname?.includes("/variants")){const n=document.querySelector(".playerbox-bottom [data-player]")?.dataset?.player;return n?n==="0"?"w":"b":"w"}return W()?.classList.contains("flipped")?"b":"w"},pieceElemFen:e=>{const t=e.pathname,o=e.pieceElem;let n=null,r=null;if(t?.includes("/variants")){Y||Qe();const s=o?.dataset?.piece;n=Y?.[o?.dataset?.color],r=o?.dataset?.piece,r?.length>1&&(r=r[0])}else[n,r]=[...o.classList].find(i=>i.match(/^(b|w)[prnbqk]{1}$/)).split("");return n=="w"?r.toUpperCase():r.toLowerCase()},pieceElemCoords:e=>{const t=e.pathname,o=e.pieceElem;return t?.includes("/variants")?ee(o):o.classList.toString()?.match(/square-(\d)(\d)/)?.slice(1)?.map(n=>Number(n)-1)},boardDimensions:e=>{if(e.pathname?.includes("/variants")){const o=document.querySelector(".TheBoard-squares");let n=0,r=0;return[...o.childNodes].forEach((s,i)=>{const a=Ce([...s.childNodes]);a?.length>0&&(n=n+1,a.length>r&&(r=a.length))}),[n,r]}else return[8,8]},isMutationNewMove:e=>{const t=e.pathname,o=e.mutationArr;if(t?.includes("/variants"))return!!o.find(a=>a.type==="childList");if(o.length==1)return!1;const n=!!o.find(a=>a?.target?.classList?.contains("hover-square")),r=!!o.find(a=>a?.target?.classList?.contains("highlight")),s=!!o.find(a=>a?.target?.classList?.contains("element-pool")),i=!!o.filter(a=>a?.target?.classList?.contains("highlight")).map(a=>a?.target?.style?.["background-color"]).find(a=>a==="rgb(244, 42, 50)");return(o.length>=4&&!n||o.length>=7||r||s)&&!i}}),f("lichess.org",{boardElem:e=>document.querySelector("cg-board"),pieceElem:e=>e.boardQuerySelector("piece:not(.ghost)"),chessVariant:e=>{const t=document.querySelector(".variant-link");if(t){let o=t?.innerText?.toLowerCase()?.replaceAll(" ","-");return{correspondence:"chess",koth:"kingofthehill","three-check":"3check"}[o]||o}},boardOrientation:e=>document.querySelector("coords.files")?.classList?.contains("black")?"b":"w",pieceElemFen:e=>{const t=e.pieceElem,o=t?.classList?.contains("white")?"w":"b",n=[...t?.classList].find(r=>Object.keys(b).includes(r));if(o&&n){const r=b[n];return o=="w"?r.toUpperCase():r.toLowerCase()}},pieceElemCoords:e=>{const o=e.pieceElem?.cgKey;if(o)return v(o)},boardDimensions:e=>[8,8],isMutationNewMove:e=>{const t=e.mutationArr;return t.length>=4||t.find(o=>o.type==="childList")?!0:!!t.find(o=>o?.target?.classList?.contains("last-move"))}}),f("playstrategy.org",{boardElem:e=>document.querySelector("cg-board"),pieceElem:e=>e.boardQuerySelector('piece[class*="-piece"]:not(.ghost)'),chessVariant:e=>{const t=document.querySelector(".variant-link");if(t){let o=t?.innerText?.toLowerCase()?.replaceAll(" ","-");return{correspondence:"chess",koth:"kingofthehill","three-check":"3check","five-check":"5check","no-castling":"nocastle"}[o]||o}},boardOrientation:e=>document.querySelector(".cg-wrap").classList?.contains("orientation-p1")?"w":"b",pieceElemFen:e=>{const t=e.pieceElem,o=P(),n=t?.classList?.contains("ally")?o:o=="w"?"b":"w";let r=null;if([...t?.classList].forEach(s=>{if(s?.includes("-piece")){const i=s?.split("-piece")?.[0];i&&i?.length===1&&(r=i)}}),n&&r)return n=="w"?r.toUpperCase():r.toLowerCase()},pieceElemCoords:e=>{const o=e.pieceElem?.cgKey;if(o)return v(o)},boardDimensions:e=>Me(),isMutationNewMove:e=>{const t=e.mutationArr;return t.length>=4||t.find(o=>o.type==="childList")?!0:!!t.find(o=>o?.target?.classList?.contains("last-move"))}}),f("pychess.org",{boardElem:e=>document.querySelector("cg-board"),pieceElem:e=>e.boardQuerySelector('piece[class*="-piece"]:not(.ghost)'),chessVariant:e=>{const t=document.querySelector("#main-wrap .tc .user-link");if(t){let o=t?.innerText?.toLowerCase()?.replaceAll(" ","")?.replaceAll("-","");return{correspondence:"chess",koth:"kingofthehill",nocastling:"nocastle","gorogoro+":"gorogoro",oukchaktrang:"cambodian"}[o]||o}},boardOrientation:e=>document.querySelector(".cg-wrap").classList?.contains("orientation-black")?"b":"w",pieceElemFen:e=>{const t=e.pieceElem,o=P(),n=t?.classList?.contains("ally")?o:o=="w"?"b":"w";let r=null;if([...t?.classList].forEach(s=>{if(s?.includes("-piece")){const i=s?.split("-piece")?.[0];i&&i?.length===1&&(r=i)}}),n&&r)return n=="w"?r.toUpperCase():r.toLowerCase()},pieceElemCoords:e=>{const o=e.pieceElem?.cgKey;if(o)return v(o)},boardDimensions:e=>Me(),isMutationNewMove:e=>{const t=e.mutationArr;return t.length>=4||t.find(o=>o.type==="childList")?!0:!!t.find(o=>o?.target?.classList?.contains("last-move"))}}),f("chess.org",{boardElem:e=>document.querySelector(".cg-board"),pieceElem:e=>e.boardQuerySelector("piece:not(.ghost)"),chessVariant:e=>"chess",boardOrientation:e=>document.querySelector("coords.files")?.classList?.contains("black")?"b":"w",pieceElemFen:e=>{const t=e.pieceElem,o=t?.classList?.contains("white")?"w":"b",n=[...t?.classList].find(r=>Object.keys(b).includes(r));if(o&&n){const r=b[n];return o=="w"?r.toUpperCase():r.toLowerCase()}},pieceElemCoords:e=>{const t=e.pieceElem;return ee(t)},boardDimensions:e=>[8,8],isMutationNewMove:e=>{const t=e.mutationArr;return x?!1:t.length>=4||t.find(o=>o.type==="childList")?!0:!!t.find(o=>o?.target?.classList?.contains("last-move"))}}),f("chess.coolmathgames.com",{boardElem:e=>document.querySelector("cg-board"),pieceElem:e=>e.boardQuerySelector("piece:not(.ghost)"),chessVariant:e=>"chess",boardOrientation:e=>{const t=W();return document.querySelector(".ranks.black")?"b":"w"},pieceElemFen:e=>{const t=e.pieceElem,o=t?.classList?.contains("white")?"w":"b",n=[...t?.classList].find(r=>Object.keys(b).includes(r));if(o&&n){const r=b[n];return o=="w"?r.toUpperCase():r.toLowerCase()}},pieceElemCoords:e=>{const o=e.pieceElem?.cgKey;if(o)return v(o)},boardDimensions:e=>[8,8],isMutationNewMove:e=>{const t=e.mutationArr;return x?!1:t.length>=4||t.find(o=>o.type==="childList")?!0:!!t.find(o=>o?.target?.classList?.contains("last-move"))}}),f("papergames.io",{boardElem:e=>document.querySelector(".cm-chessboard"),pieceElem:e=>e.boardQuerySelector("*[data-piece][data-square]"),chessVariant:e=>"chess",boardOrientation:e=>{const t=W();if(t)return[...t.querySelector(".coordinates").childNodes][0].textContent=="h"?"b":"w"},pieceElemFen:e=>{const t=e.pieceElem;return rt(t?.dataset?.piece)},pieceElemCoords:e=>{const o=e.pieceElem?.dataset?.square;if(o)return v(o)},boardDimensions:e=>[8,8],isMutationNewMove:e=>e.mutationArr.length>=12}),f("vole.wtf",{boardElem:e=>document.querySelector("#board"),pieceElem:e=>e.boardQuerySelector('*[data-t][data-l][data-p]:not([data-p="0"]'),chessVariant:e=>"chess",boardOrientation:e=>"w",pieceElemFen:e=>{const t=e.pieceElem,o=Number(t?.dataset?.p),n="pknbrq";return o>8?n[o-9].toUpperCase():n[o-1]},pieceElemCoords:e=>{const t=e.pieceElem;return[Number(t?.dataset?.l),7-Number(t?.dataset?.t)]},boardDimensions:e=>[8,8],isMutationNewMove:e=>e.mutationArr.length>=12}),f("immortal.game",{boardElem:e=>document.querySelector("div.pawn.relative, div.knight.relative, div.bishop.relative, div.rook.relative, div.queen.relative, div.king.relative")?.parentElement?.parentElement,pieceElem:e=>e.boardQuerySelector("div.pawn.relative, div.knight.relative, div.bishop.relative, div.rook.relative, div.queen.relative, div.king.relative"),chessVariant:e=>"chess",boardOrientation:e=>{const t=[...document.querySelectorAll("svg text[x]")].find(n=>n?.textContent=="a");return(Number(t?.getAttribute("x"))||10)<15?"w":"b"},pieceElemFen:e=>{const t=e.pieceElem,o=t?.classList?.contains("white")?"w":"b",n=[...t?.classList].find(r=>Object.keys(b).includes(r));if(o&&n){const r=b[n];return o==="w"?r.toUpperCase():r.toLowerCase()}},pieceElemCoords:e=>{const t=e.pieceElem;return ee(t?.parentElement)},boardDimensions:e=>[8,8],isMutationNewMove:e=>{const t=e.mutationArr;return x?!1:t.length>=5}}),f("chessarena.com",{boardElem:e=>document.querySelector('*[data-component="GameLayoutBoard"] cg-board'),pieceElem:e=>e.boardQuerySelector('cg-piece:not(*[style*="visibility: hidden;"])'),chessVariant:e=>"chess",boardOrientation:e=>document.querySelector("cg-titles")?.classList?.contains("rotated")?"b":"w",pieceElemFen:e=>{const t=e.pieceElem,o=t?.className?.[0],n=t?.className?.[1];if(o&&n){const r=n;return o==="w"?r.toUpperCase():r.toLowerCase()}},pieceElemCoords:e=>{const t=e.pieceElem;return ee(t,{onlyFlipY:!0})},boardDimensions:e=>[8,8],isMutationNewMove:e=>{const t=e.mutationArr;return x?!1:!!t.find(o=>o?.attributeName==="style")}}),f("chess.net",{boardElem:e=>document.querySelector("cg-board"),pieceElem:e=>e.boardQuerySelector("piece:not(.ghost)"),chessVariant:e=>{const t=document.querySelector(".variant-link");if(t){let o=t?.innerText?.toLowerCase()?.replaceAll(" ","-");return{correspondence:"chess",koth:"kingofthehill","three-check":"3check"}[o]||o}},boardOrientation:e=>document.querySelector("coords.files")?.classList?.contains("black")?"b":"w",pieceElemFen:e=>{const t=e.pieceElem,o=t?.classList?.contains("white")?"w":"b",n=[...t?.classList].find(r=>Object.keys(b).includes(r));if(o&&n){const r=b[n];return o=="w"?r.toUpperCase():r.toLowerCase()}},pieceElemCoords:e=>{const o=e.pieceElem?.cgKey;if(o)return v(o)},boardDimensions:e=>[8,8],isMutationNewMove:e=>{const t=e.mutationArr;return t.length>=4||t.find(o=>o.type==="childList")?!0:!!t.find(o=>o?.target?.classList?.contains("last-move"))}}),f("freechess.club",{boardElem:e=>document.querySelector("cg-board"),pieceElem:e=>e.boardQuerySelector("piece:not(.ghost)"),chessVariant:e=>"chess",boardOrientation:e=>document.querySelector("coords.files")?.classList?.contains("black")?"b":"w",pieceElemFen:e=>{const t=e.pieceElem,o=t?.classList?.contains("white")?"w":"b",n=[...t?.classList].find(r=>Object.keys(b).includes(r));if(o&&n){const r=b[n];return o=="w"?r.toUpperCase():r.toLowerCase()}},pieceElemCoords:e=>{const o=e.pieceElem?.cgKey;if(o)return v(o)},boardDimensions:e=>[8,8],isMutationNewMove:e=>{const t=e.mutationArr;return t.length>=4||t.find(o=>o.type==="childList")?!0:!!t.find(o=>o?.target?.classList?.contains("last-move"))}}),f("play.chessclub.com",{boardElem:e=>document.querySelector("cg-board"),pieceElem:e=>e.boardQuerySelector("piece:not(.ghost)"),chessVariant:e=>"chess",boardOrientation:e=>document.querySelector("coords.files")?.classList?.contains("black")?"b":"w",pieceElemFen:e=>{const t=e.pieceElem,o=t?.classList?.contains("white")?"w":"b",n=[...t?.classList].find(r=>Object.keys(b).includes(r));if(o&&n){const r=b[n];return o=="w"?r.toUpperCase():r.toLowerCase()}},pieceElemCoords:e=>{const o=e.pieceElem?.cgKey;if(o)return v(o)},boardDimensions:e=>[8,8],isMutationNewMove:e=>{const t=e.mutationArr;return t.length>=4||t.find(o=>o.type==="childList")?!0:!!t.find(o=>o?.target?.classList?.contains("last-move"))}}),f("gameknot.com",{boardElem:e=>document.querySelector("#chess-board-acboard"),pieceElem:e=>e.boardQuerySelector('*[class*="chess-board-piece"] > img[src*="chess56."][style*="visible"]'),chessVariant:e=>"chess",boardOrientation:e=>document.querySelector("#chess-board-my-side-color .player_white")?"w":"b",pieceElemFen:e=>{const t=e.pieceElem,o=Number(t.style.left.replace("px","")),n=Number(t.style.top.replace("px","")),r=o>=0?"w":"b",s="kqrnbp"[n*-1/60];return r==="w"?s.toUpperCase():s.toLowerCase()},pieceElemCoords:e=>{const t=e.pieceElem;return me(t.parentElement)},boardDimensions:e=>[8,8],isMutationNewMove:e=>{const t=e.mutationArr;return t.find(o=>o.type==="childList")?!0:!!t.find(o=>o?.target?.classList?.contains("last-move"))}}),f("chesstempo.com",{boardElem:e=>document.querySelector(".ct-board-squares"),pieceElem:e=>e.boardQuerySelector('*[class*="ct-pieceClass"][class*="ct-piece-"]'),chessVariant:e=>"chess",boardOrientation:e=>document.querySelector(".ct-coord-column").innerText==="a"?"w":"b",pieceElemFen:e=>{const n=[...e.pieceElem.classList].find(a=>a?.includes("ct-piece-"))?.split("ct-piece-")?.pop(),r=n.startsWith("white")?"w":"b",s=n.substring(5),i=b[s];return r==="w"?i.toUpperCase():i.toLowerCase()},pieceElemCoords:e=>{const t=e.pieceElem;return[t?.ct?.piece?.piece?.column,t?.ct?.piece?.piece?.row]},boardDimensions:e=>[8,8],isMutationNewMove:e=>e.mutationArr.length>=4}),f("redhotpawn.com",{boardElem:e=>document.querySelector("#board-0_1"),pieceElem:e=>e.boardQuerySelector('li.piece[id*="-pc-"]'),chessVariant:e=>"chess",boardOrientation:e=>Number([...document.querySelectorAll(".boardCoordinate")].find(o=>o?.innerText==="a")?.style?.left?.replace("px",""))<200?"w":"b",pieceElemFen:e=>(e.pieceElem?.id?.match(/-pc-(.*?)-/)||[])[1],pieceElemCoords:e=>{const t=e.pieceElem;return me(t)},boardDimensions:e=>[8,8],isMutationNewMove:e=>{const t=e.mutationArr;return x?!1:t.length>=4}}),f("simplechess.com",{boardElem:e=>document.querySelector("#chessboard"),pieceElem:e=>{const t=e.getAll,o=[...document.querySelectorAll("canvas.canvas_piece")].filter(n=>Le(n,[.5,.5]));return t?o:o[0]},chessVariant:e=>"chess",boardOrientation:e=>document.querySelector("#chessboard_coordy0")?.innerText==="8"?"w":"b",pieceElemFen:e=>{const t=e.pieceElem,o=[{name:"k",coords:[52/60,26/60]},{name:"q",coords:[8/60,16/60]},{name:"n",coords:[51/60,42/60]},{name:"b",coords:[9/60,50/60]},{name:"r",coords:[45/60,15/60]},{name:"p",coords:[.5,.5]}],n={k:[42/60,27/60],q:[30/60,50/60],n:[38/60,41/60],b:[30/60,20/60]};let r=null;for(e of o)if(Le(t,e.coords)){r=e.name;break}if(r){const s=n[r]||[.5,.5];return st(t,s)==="w"?r.toUpperCase():r.toLowerCase()}},pieceElemCoords:e=>{const t=e.pieceElem;return me(t)},boardDimensions:e=>[8,8],isMutationNewMove:e=>{const t=e.mutationArr;return x?!1:t.length>=7}}),f("chessworld.net",{boardElem:e=>document.querySelector("#ChessWorldChessBoard"),pieceElem:e=>e.boardQuerySelector('img[src*="merida"'),chessVariant:e=>"chess",boardOrientation:e=>document.querySelector('div[style*="boardb.jpg"]')?"w":"b",pieceElemFen:e=>{const t=e.pieceElem,[o,n]=t?.src?.split("/")?.pop()?.replace(".png","")?.split("_"),r=o==="white"?"w":"b",s=b[n];return r==="w"?s.toUpperCase():s.toLowerCase()},pieceElemCoords:e=>{const t=e.pieceElem;return v(t?.id)},boardDimensions:e=>[8,8],isMutationNewMove:e=>e.mutationArr.length>=2}),f("app.edchess.io",{boardElem:e=>document.querySelector('*[data-boardid="chessboard"]'),pieceElem:e=>e.boardQuerySelector("*[data-piece]"),chessVariant:e=>"chess",boardOrientation:e=>document.querySelector("*[data-square]")?.dataset?.square=="h1"?"b":"w",pieceElemFen:e=>{const t=e.pieceElem,[o,n]=t?.dataset?.piece?.split("");return o==="w"?n.toUpperCase():n.toLowerCase()},pieceElemCoords:e=>{const t=e.pieceElem;return v(t?.parentElement?.parentElement?.dataset?.square)},boardDimensions:e=>[8,8],isMutationNewMove:e=>e.mutationArr.length>=2});async function pt(){return!!await h.commands.ping()}async function De(){await h.commands.createInstance(C);const e=window.location.pathname,t=N==="chess.com"&&e?.includes("/variants"),o=N==="app.edchess.io",n=z();R.playerColor.set(C,n),R.fen.set(C,oe()),tt()&&(w=new UniversalBoardDrawer(E,{window,boardDimensions:D(),playerColor:P(),zIndex:N==="chessarena.com"?9999:500,prepend:!0,debugMode:M,adjustSizeByDimensions:!!t,adjustSizeConfig:{noLeftAdjustment:!0},ignoreBodyRectLeft:o})),await Pe(),mt(),h.setIntervalAsync(async()=>{await h.commands.createInstance(C)},1e3)}function ht(){let e=0;const t=h.setIntervalAsync(async()=>{await pt()?(De(),t.stop()):e<1&&(e++,GM_openInTab(ae(),!0))},1e3)}function ft(){const e=W(),t=Q(),o=e&&t,n=N==="chess.com"&&e?.className.includes("webgl-2d"),r=E!=e;(o||n)&&r&&(E=e,E.addEventListener("mousedown",()=>{x=!0}),E.addEventListener("mouseup",()=>{x=!1}),E.addEventListener("touchstart",()=>{x=!0}),E.addEventListener("touchend",()=>{x=!1}),Ue.includes(window.location.href)||ht())}typeof GM_registerMenuCommand=="function"&&(GM_registerMenuCommand("[u] Open GreasyFork Page",e=>{GM_openInTab(je,!0)},"u"),GM_registerMenuCommand("[o] Open GUI Manually",e=>{GM_openInTab(ae(),!0)},"o"),GM_registerMenuCommand("[s] Start Manually",e=>{E?De():Z("Failed to start manually","No chessboard element found!")},"s"),GM_registerMenuCommand("[g] Get Moves Manually",e=>{E?pe(null,!0):Z("Failed to get moves","No chessboard element found!")},"g"),GM_registerMenuCommand("[r] Render BoardDrawer Manually",e=>{typeof w?.updateDimensions=="function"?w.updateDimensions():Z("Failed to render BoardDrawer","BoardDrawer not initialized or something else went wrong!")},"r"),typeof GM_setClipboard=="function"&&GM_registerMenuCommand("[c] Copy FEN to Clipboard",e=>{E?GM_setClipboard(oe()):Z("Failed to get FEN","No chessboard element found!")},"c")),setInterval(ft,1e3)})();
