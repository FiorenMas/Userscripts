// ==UserScript==
// @name         4chan Image Resizer
// @namespace    https://greasyfork.org/en/users/393416
// @version      2.5
// @author       greenronia
// @match        *://boards.4chan.org/*
// @match        *://boards.4channel.org/*
// @require      https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.0/spark-md5.js
// @require      https://unpkg.com/@daiyam/cropperjs@1.5.9-d2/dist/@daiyam/cropper.js
// @resource     cropper_css https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.9/cropper.css
// @grant        GM_getResourceText
// @grant        GM_addStyle
// @icon         https://i.imgur.com/hQp5BTf.png
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/4chan20Image20Resizer.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/4chan20Image20Resizer.meta.js
// ==/UserScript==
var DEBUG=!1;const version="2.5";DEBUG&&console.log("[ImageResizer] Initialized");var cssTxt=GM_getResourceText("cropper_css");GM_addStyle(cssTxt);var style=document.createElement("style");style.innerHTML=`.centerImg { margin: 0; position: absolute; top: 50%; left: 50%; -ms-transform: translate(-50%, -50%); transform: translate(-50%, -50%); max-width: 100%; max-height: 100vh; height: auto; cursor: pointer; }
.settingsOverlay { background: rgba(0,0,0,0.8); display: none; height: 100%; left: 0; position: fixed; top: 0; width: 100%; z-index: 777; } 
#pvOverlay { background: rgba(0,0,0,0.9); height: 100%; left: 0; position: fixed; top: 0; width: 100%; z-index: 777; text-align: center;} 
#pvHeader { position: fixed; height: 35px; width: 100%; opacity: 0; -webkit-transition: opacity 0.5s ease-in-out;}
#pvHeader:hover { opacity: 0.8; -webkit-transition: none; }
.pvOpct { opacity: 0.7 !important; } 
#imgResizeMenu { margin: 10% auto auto auto; width: 100%; width: 620px; padding: 2em; overflow: hidden; z-index: 8;}
#imgResizeMenu h3 { text-align: center; }
#imgResizeMenu a { cursor: pointer; }
#imgResizeMenu label { text-decoration-line: underline; }
#heplDiv summary { cursor: pointer; }
.settingsOverlay input[type=number], #manInput input[type=number] { -moz-appearance: textfield; text-align: right; }
.resizer-settings { padding-bottom: 10px }
#errMsg { color: red; text-align: center; }
#ruleTable { border-collapse: collapse; }
#ruleTable td, th { padding: 8px; text-align: left; border-bottom: 1pt solid; }
#QCTable { border-collapse: collapse; }
#QCTable td, th { padding: 8px; text-align: center; border-bottom: 1pt solid; }
#QCTable p { margin: auto; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
#inputContainer { text-align: center; padding-top: 1em; }
#inputContainer button { margin-top: 20px; }
.menuBtns { margin-left: 1em; }
#sideMenu { position: absolute; display: none; padding: 5px 0px 5px 0px; width: 105px; margin-left: -110px; margin-top: -2px;}
#manInput { position: absolute; padding: 10px 0px 10px 0px; width: 170px; margin-left: -175px; margin-top: -2px; text-align: center;}
.sideMenuElement { background: inherit; display: block; cursor: pointer; padding: 2px 10px 2px 10px; text-align: left;}
.downscale-menu-off { display: none; }
.downscale-menu-on { display: block !important; }`;var styleRef=document.querySelector("script");styleRef.parentNode.insertBefore(style,styleRef),getSettings(),getPresets(),getQCList(),function(){if(version.localeCompare(getSettings().version,void 0,{numeric:!0,sensitivity:"base"})>=1){var e=getSettings();e.version=version,e.convertOutput="image/png",localStorage.setItem("downscale-settings",JSON.stringify(e));var t="4chan Image Resizer updated to version "+version,c={type:"info",content:t,lifetime:10},r=new CustomEvent("CreateNotification",{bubbles:!0,detail:c});document.dispatchEvent(r)}}();function getSettings(){if(JSON.parse(localStorage.getItem("downscale-settings")))var e=JSON.parse(localStorage.getItem("downscale-settings"));else e={enabled:!0,notify:!0,convert:!0,convertOutput:"image/png",jpegQuality:.92,shortcut:!0,cropOutput:"image/png",version:"2.4"},localStorage.setItem("downscale-settings",JSON.stringify(e));return e}function getPresets(){if(JSON.parse(localStorage.getItem("downscale-presets")))var e=JSON.parse(localStorage.getItem("downscale-presets"));else e=[];return e}function getQCList(){if(JSON.parse(localStorage.getItem("downscale-qclist")))var e=JSON.parse(localStorage.getItem("downscale-qclist"));else e=[];return e}document.addEventListener("QRDialogCreation",function(e){var t=document.getElementById("imgResize"),c=document.getElementById("sideMenuArrow");c||appendSideMenu(),t||appendCheckBox(),document.getElementById("imgResize").addEventListener("click",checkState),checkState(1),DEBUG&&console.log("[QRFile] Listening..."),document.addEventListener("QRFile",function(f){DEBUG&&console.log("[QRFile] File served: "+f.detail),removeRemOption();const g=f.detail,y=new FileReader;if(g.type=="image/jpeg"||g.type=="image/png"||g.type=="image/webp"){let U=function(n,i){DEBUG&&console.log("[quickConverter] Checking for a matching MD5: "+i);for(var a=b.length,v=!1,o=0;o<a;o++){var d=b[o].split(":").pop();if(d==i){DEBUG&&console.log("[quickConverter] Match found."),v=!0,Q(n.width,n.height,n);break}}DEBUG&&(v||console.log("[quickConverter] No match found."))},Y=function(n){for(var i=0,a=[],v=N.length,o=0;o<v;o++){if(a[o]=N[o].split(":"),DEBUG&&console.log("Looking for matching presets..."),a[o][0]!=0){switch(parseInt(a[o][0])){case 1:a[o][0]="image/png";break;case 2:a[o][0]="image/jpeg"}if(a[o][0]!=g.type)continue}if(a[o][1]==n.width&&a[o][2]==n.height){var d=parseInt(a[o][3]),m=parseInt(a[o][4]);i++,DEBUG&&console.log("Preset '"+o+"' matched: "+a[o]);break}}if(i==0||i>1){DEBUG&&console.log("Image didn't match any presets.");return}else{Q(d,m,n);return}},W=function(n){if(g.type=="image/webp"){var i=n.width,a=n.height;DEBUG&&console.log("[WebPConverter] Converting WebP to: "+getSettings().convertOutput),Q(i,a,n,void 0,!0)}else{DEBUG&&console.log("[WebPConverter] Image format isn't WebP.");return}},Q=function(n,i,a,v,o){DEBUG&&!v&&console.log("<FILTER END>"),removePreviewOption();var d=document.createElement("canvas"),m=a.width,u=a.height;m>u?m>n&&(u*=n/m,m=n):u>i&&(m*=i/u,u=i),d.width=m,d.height=u;var S=d.getContext("2d");S.drawImage(a,0,0,m,u);var E;v?E=d.toDataURL("image/jpeg",92):o&&getSettings().convertOutput=="image/png"?E=d.toDataURL("image/png"):E=d.toDataURL("image/jpeg",parseFloat(getSettings().jpegQuality));var k=dataURItoBlob(E);l.disconnect(),DEBUG&&console.log("[classObserver] Stopping..."),J(k,a,m,u,v);var w=new Image;w.src=E,j(w),R(E,k.size,m,u,g.name,k.type)},J=function(n,i,a,v,o){var d=constructFilename(n.type,g.name),m={file:n,name:d},u=new CustomEvent("QRSetFile",{bubbles:!0,detail:m});document.dispatchEvent(u),o&&X(i,g,o,n.size),DEBUG&&console.log("[QRSetFile] File Sent"),DEBUG&&console.log("OUTPUT Dimesnions: "+Math.round(a)+"x"+Math.round(v)),DEBUG&&console.log("OUTPUT Filesize: "+formatBytes(n.size)),DEBUG&&console.log("OUTPUT Format: "+n.type),DEBUG&&n.type=="image/jpeg"&&console.log("JPEG Quality: "+getSettings().jpegQuality);var S="Original size: ("+formatBytes(g.size)+", "+i.width+"x"+i.height+`) 
 New size: (`+formatBytes(n.size)+", "+Math.round(a)+"x"+Math.round(v)+")";if(getSettings().notify){var E={type:"info",content:S,lifetime:5},k=new CustomEvent("CreateNotification",{bubbles:!0,detail:E});document.dispatchEvent(k)}removeQCOption(),removeCropOption(),removeManual(),l.observe(s,p),L=!0,DEBUG&&console.log(`<FINISH>
[classObserver] Restarting...`)},le=function(n,i,a){var v=document.createElement("div");v.id="qcDiv";var o=document.createElement("a");o.id="quickConvert",o.classList.add("sideMenuElement"),o.classList.add("entry"),o.innerHTML="Quick Convert",o.title="Convert image to JPEG format",o.onmouseover=function(){this.classList.toggle("focused")},o.onmouseout=function(){this.classList.toggle("focused")},o.addEventListener("click",function(){DEBUG&&console.log("[quickConverter] Manually calling Resizer..."),Q(n.width,n.height,n,a)});var d=document.getElementById("sideMenu");d.appendChild(v),v.appendChild(o)},Z=function(n,i){var a=document.createElement("div");a.id="manDiv";var v=document.createElement("a");v.id="manualResize",v.classList.add("sideMenuElement"),v.classList.add("entry"),v.innerHTML="Manual Resize",v.title="Manually resize image",v.onmouseover=function(){this.classList.toggle("focused")},v.onmouseout=function(){this.classList.toggle("focused")},v.addEventListener("click",function(){DEBUG&&console.log("[ManualResizer] Opened."),D(n,i)});var o=document.getElementById("sideMenu");o.appendChild(a),a.appendChild(v)},D=function(n,i){var a=document.createElement("div");a.id="manInput",a.classList.add("dialog");var v=document.getElementById("qr");v.insertAdjacentElement("afterbegin",a),a.innerHTML='<input type="number" id="resWidth" title="Output Width" size="3" min="0" onfocus="this.select();"></input> x <input type="number" id="resHeight" title="Output Height" size="3" min="0" onfocus="this.select();"></input> <select id="resFormat" name="resFormat" title="Output Format" style="color: #000"><option id="opt1" value="image/png">PNG</option><option id="opt2" value="image/jpeg">JPEG</option></select><div id="testContainer" style="padding-top: 10px"><button id="resTest">Test</button><span id="resFS" title="Original size: '+formatBytes(i.size)+'" style="padding-left: 10px">'+formatBytes(i.size)+'</span></div><hr id="rm-hr";><a id="resSet" style="cursor: pointer">Set File</a>',document.getElementById("rm-hr").style.borderColor=getHRColor();var o=document.getElementById("resWidth"),d=document.getElementById("resHeight"),m=document.getElementById("resFS"),u=document.getElementById("resFormat"),S=document.getElementById("resTest"),E=document.getElementById("resSet");o.value=n.width,o.max=n.width,o.placeholder=n.width,d.value=n.height,d.max=n.height,d.placeholder=n.height,u.value=i.type,i.size>4194304&&(m.style.color="red"),o.onkeypress=function(){return isNumber(event)},d.onkeypress=function(){return isNumber(event)},o.oninput=function(){calcResAspect("width",n.width,n.height,o.value),I=null},d.oninput=function(){calcResAspect("height",n.width,n.height,d.value),I=null},u.oninput=function(){I=null},S.onclick=function(){(o.value>n.width||d.value>n.height)&&(o.value=n.width,d.value=n.height),K(o.value,d.value,u.value,n,m)},E.onclick=function(){o.value>n.width||d.value>n.height?alert("No upscaling. Do it yourself."):I?(DEBUG&&console.log("[ManualResizer] testBlob found."),l.disconnect(),DEBUG&&console.log("[classObserver] Stopping..."),removePreviewOption(),R(T,I.size,o.value,d.value,i.name,I.type),J(I,n,o.value,d.value)):(DEBUG&&console.log("[ManualResizer] testBlob is null, calling fileSizeTester..."),K(o.value,d.value,u.value,n,m),l.disconnect(),DEBUG&&console.log("[classObserver] Stopping..."),removePreviewOption(),R(T,I.size,o.value,d.value,i.name,I.type),J(I,n,o.value,d.value))},window.addEventListener("click",function k(w){var ee=document.getElementById("manInput");!w.target.matches("#manInput")&&!w.target.matches("#resWidth")&&!w.target.matches("#resHeight")&&!w.target.matches("#resFormat")&&!w.target.matches("#opt1")&&!w.target.matches("#opt2")&&!w.target.matches("#resTest")&&!w.target.matches("#resFS")&&!w.target.matches("#testContainer")&&!w.target.matches("#manualResize")&&(ee.remove(),DEBUG&&console.log("[ManualResizer] Closed."),window.removeEventListener("click",k))})},K=function(n,i,a,v,o){DEBUG&&console.log("[fileSizeTester] Starting...");var d=document.createElement("canvas"),m=v.width,u=v.height;m>u?m>n&&(u*=n/m,m=n):u>i&&(m*=i/u,u=i),d.width=m,d.height=u;var S=d.getContext("2d");S.drawImage(v,0,0,m,u);var E;a=="image/png"?E=d.toDataURL("image/png"):E=d.toDataURL("image/jpeg",parseFloat(getSettings().jpegQuality));var k=dataURItoBlob(E);o.innerHTML=formatBytes(k.size),k.size>4194304?(DEBUG&&console.log("[fileSizeTester] File size is over the limit: "+formatBytes(k.size)),o.style.color="red"):(DEBUG&&console.log("[fileSizeTester] File size OK: "+formatBytes(k.size)),o.style.color="inherit"),I=k,T=E,DEBUG&&console.log("[fileSizeTester] Done.")},j=function(n){var i=document.createElement("div");i.id="cropDiv";var a=document.createElement("a");a.id="crop",a.classList.add("sideMenuElement"),a.classList.add("entry"),a.innerHTML="Crop Image",a.onmouseover=function(){this.classList.toggle("focused")},a.onmouseout=function(){this.classList.toggle("focused")},a.addEventListener("click",function(){DEBUG&&console.log("[cropper] Starting..."),z(n)});var v=document.getElementById("sideMenu");v.appendChild(i),i.appendChild(a)},z=function(n){var i=document.createElement("div");i.id="pvOverlay";var a=document.createElement("div");a.id="pvHeader",a.className="dialog",a.classList.add("pvOpct");var v=document.createElement("a");v.id="setCrop",v.style.cursor="pointer",v.innerHTML="Set Image";var o=document.createElement("a");o.id="undoCrop",o.style.cursor="pointer",o.innerHTML="Undo";var d=document.createElement("a");d.id="closeCrop",d.className="close fa fa-times",d.style="float: right; cursor: pointer; margin-right: 20px; margin-top: 7px; transform: scale(1.5);",d.title="Close";var m=document.createElement("img");m.id="cropImg",m.classList.add("centerImg"),m.src=n.src,m.title=`LMB: Set
MMB: Close
RMB: Undo
Shift+RMB: Context Menu`,m.oncontextmenu=function(){return!1},document.body.appendChild(i),i.appendChild(m);let u;const S=document.getElementById("cropImg");S.addEventListener("ready",function(){i.clientWidth>n.width&&i.clientHeight>n.height&&(u.zoomTo(1),DEBUG&&console.log("[cropper] Scaling image to 100%"));var E=!1;document.body.onkeydown=function(k){var w=k||window.event;if(!(w.target!==this||!u)&&!E){let x=function(){l.disconnect(),E=!0,DEBUG&&console.log("[classObserver] Stopping..."),i.remove(),removePreviewOption(),R(V,A.size,m.width,m.height,g.name,A.type),J(A,n,m.width,m.height)},M=function(B){if(typeof B=="object")switch(B.button){case 0:x();break;case 1:u.destroy(),i.remove(),E=!0;break;case 2:B.shiftKey||(i.remove(),z(n));break}};var H=x,O=M;switch(w.keyCode){case 46:case 27:w.preventDefault(),u.destroy(),i.remove(),E=!0;break;case 8:w.preventDefault(),document.getElementById("undoCrop")?(document.getElementById("undoCrop").click(),E=!0):u.clear();break;case 32:case 13:if(w.preventDefault(),document.getElementById("setCrop"))document.getElementById("setCrop").click(),E=!0;else{var ee=u.getCroppedCanvas({imageSmoothingEnabled:!1,imageSmoothingQuality:"high"});DEBUG&&console.log("[cropper] Output format: "+getSettings().cropOutput);var V=ee.toDataURL(getSettings().cropOutput,parseFloat(getSettings().jpegQuality)),A=dataURItoBlob(V),h=u.getData(!0);u.destroy(),m.src=V,m.addEventListener("mouseup",M),i.appendChild(a),a.appendChild(d),a.innerHTML+="Cropped Image ("+formatBytes(A.size)+", "+h.width+"x"+h.height+")<br>",a.appendChild(v),a.innerHTML+=" | ",a.appendChild(o),setTimeout(function(){a.classList.toggle("pvOpct")},2e3),document.getElementById("closeCrop").onclick=function(){u.destroy(),i.remove(),E=!0},document.getElementById("setCrop").onclick=function(){x()},document.getElementById("undoCrop").onclick=function(){i.remove(),z(n)}}break}}}}),u=new DaiyamCropper(S,{aspectRatio:NaN,background:!1,guides:!1,viewMode:1,autoCrop:!1,scalable:!1})},X=function(n,i,a,v){var o=document.createElement("div");o.id="remDiv";var d=document.createElement("a");d.id="rememberMD5",d.classList.add("sideMenuElement"),d.classList.add("entry"),d.innerHTML="Remember",d.style.fontWeight="bold",d.title="Always convert this image.",d.onmouseover=function(){this.classList.toggle("focused")},d.onmouseout=function(){this.classList.toggle("focused")},d.onclick=function(){saveImgMD5(n,i,a,v)};var m=document.getElementById("sideMenu");m.appendChild(o),o.appendChild(d)},R=function(n,i,a,v,o,d){var m=document.getElementById("previewImg");if(m)m.onclick=function(){showImage(n,i,a,v,o,d)};else{var u=document.createElement("a");u.id="previewImg",u.classList.add("sideMenuElement"),u.classList.add("entry"),u.innerHTML="Preview Image",u.onmouseover=function(){this.classList.toggle("focused")},u.onmouseout=function(){this.classList.toggle("focused")},u.onclick=function(){showImage(n,i,a,v,o,d)};var S=document.getElementById("sideMenu");S.appendChild(u)}};var P=U,de=Y,te=W,q=Q,ne=J,ie=le,oe=Z,ae=D,re=K,_=j,$=z,se=X,ce=R;DEBUG&&console.log("Acceptable File type: "+g.type);var C=document.getElementById("sm-hr");C||appendHR();var L=!1,N=getPresets(),b=getQCList();y.onload=function(n){var i=new Image;i.src=y.result,i.onload=function(){var a=SparkMD5.hash(i.src);DEBUG&&console.log("<FILTER START>"),DEBUG&&(getSettings().convert?console.log("[WebPConverter] Enabled"):console.log("[WebPConverter] Disabled")),DEBUG&&console.log("INPUT Dimensions: "+i.width+"x"+i.height),DEBUG&&console.log("INPUT File size: "+formatBytes(g.size)),getQCList().length>0&&U(i,a),N.length>0&&!L&&Y(i),getSettings().convert&&!L&&W(i),L||(removeQCOption(),removeManual(),removeCropOption(),le(i,g,a),Z(i,g),j(i),removePreviewOption(),R(i.src,g.size,i.width,i.height,g.name,g.type))}};var I=null,T=null;y.readAsDataURL(g)}else removeHR(),removeCropOption(),removeQCOption(),removePreviewOption(),removeManual(),DEBUG&&console.log("[Error] Invalid FileType: "+g.type)},!1);function r(f,g){if(document.getElementById("file-n-submit").classList.contains("has-file")===!0&&checkState(2)===!0)DEBUG&&console.log(`<START>
[classObserver] File detected.`),DEBUG&&console.log("[QRGetFile] Requesting file..."),document.dispatchEvent(new CustomEvent("QRGetFile"));else if(checkState(2)===!1){DEBUG&&console.log("[classObserver] ImageResizer is disabled");return}else removeHR(),removeCropOption(),removeQCOption(),removeRemOption(),removePreviewOption(),removeManual(),DEBUG&&console.log("[classObserver] No file")}const s=document.getElementById("file-n-submit");var p={attributes:!0},l=new MutationObserver(r);DEBUG&&console.log("[classObserver] Starting..."),l.observe(s,p)},!1);function appendCheckBox(){var e=document.createElement("a"),t=document.createElement("label"),c=document.createElement("input");c.type="checkbox",c.id="imgResize",t.id="imgResizeLabel",c.title="Enable Image Resizer",c.style="margin-left: 0",e.classList.add("sideMenuElement"),e.classList.add("entry"),t.classList.add("sideMenuElement"),t.classList.add("entry");var r=document.getElementById("sideMenu");r.appendChild(t),t.appendChild(c),t.title="Enable Image Resizer",t.innerHTML+=" Enabled",e.title="Image Resizer Settings",e.innerHTML="Settings",r.appendChild(e),t.onmouseover=function(){this.classList.toggle("focused")},t.onmouseout=function(){this.classList.toggle("focused")},e.onmouseover=function(){this.classList.toggle("focused")},e.onmouseout=function(){this.classList.toggle("focused")},e.onclick=function(){document.getElementById("imgResizeOverlay").style.display="block"},document.getElementById("imgResize").checked=getSettings().enabled}function checkState(e){var t=document.getElementById("imgResize").checked;return t===!0?(e!=2&&DEBUG&&console.log("[ImageResizer] Enabled"),!0):(e!=2&&DEBUG&&console.log("[ImageResizer] Disabled"),removeHR(),removeCropOption(),removeQCOption(),removeRemOption(),removePreviewOption(),removeManual(),!1)}function clearErr(){document.getElementById("errMsg").innerHTML=""}function basicCheck(e,t){var c=parseInt(document.getElementById("inWidth").value),r=parseInt(document.getElementById("inHeight").value),s=parseInt(document.getElementById("outWidth").value),p=parseInt(document.getElementById("outHeight").value),l=parseInt(document.getElementById("imgType").value);if(s<=0||p<=0){document.getElementById("errMsg").innerHTML="Invalid output dimensions";return}else if(c<s||r<p){document.getElementById("errMsg").innerHTML="Cannot upscale images";return}else finalCheck(e,l,c,r,s,p,t)}function finalCheck(e,t,c,r,s,p,l){var f=document.getElementById("imgType"),g=f.options[f.selectedIndex].text,y=t+":"+c+":"+r+":"+s+":"+p,C=getPresets();if(C.length>0){for(var L=[],N=C.length,b=0;b<N;b++)if(!(e&&b===l)){if(L[b]=C[b].split(":"),y==C[b]){document.getElementById("errMsg").innerHTML="Exact preset already exists";return}else if(c==L[b][1]&&r==L[b][2]&&(t==L[b][0]||L[b][0]==0)){document.getElementById("errMsg").innerHTML="Preset with the same input dimensions for "+g+" format already exists";return}}}clearErr(),e?C[l]=y:C.push(y),localStorage.setItem("downscale-presets",JSON.stringify(C)),document.getElementById("ruleTable").tBodies.item(0).innerHTML="",printList(),document.getElementById("ruleInput").remove(),document.getElementById("addRule").style.display="inline"}function aspectCheckH(){var e=document.getElementById("inWidth").value,t=document.getElementById("inHeight").value,c=document.getElementById("outWidth").value,r=document.getElementById("outHeight").value;r>0&&(parseInt(t)>=parseInt(r)?(calcAspect("width",e,t,r),clearErr()):document.getElementById("errMsg").innerHTML="Cannot upscale images")}function aspectCheckW(){var e=document.getElementById("inWidth").value,t=document.getElementById("inHeight").value,c=document.getElementById("outWidth").value,r=document.getElementById("outHeight").value;c>0&&(parseInt(e)>=parseInt(c)?(calcAspect("height",e,t,c),clearErr()):document.getElementById("errMsg").innerHTML="Cannot upscale images")}function calcAspect(e,t,c,r){if(e=="width"){var s=r/c*t;document.getElementById("outWidth").value=Math.round(s)}if(e=="height"){var p=r/t*c;document.getElementById("outHeight").value=Math.round(p)}}function calcResAspect(e,t,c,r){if(e=="width"){var s=c/t*r;document.getElementById("resHeight").value=Math.round(s)}if(e=="height"){var p=t/c*r;document.getElementById("resWidth").value=Math.round(p)}}function printList(){var e=getPresets(),t=document.getElementById("imgResizeList"),c=document.getElementById("ruleTable");if(e.length>0){var r=[],s=e.length;for(let l=0;l<s;l++){switch(r[l]=e[l].split(":"),parseInt(r[l][0])){case 0:r[l][0]="PNG/JPEG";break;case 1:r[l][0]="PNG";break;case 2:r[l][0]="JPEG"}let f=document.createElement("a"),g=document.createElement("a");f.innerHTML="delete",g.innerHTML="edit",f.onclick=function(){document.getElementById("inputContainer")&&(document.getElementById("inputContainer").innerHTML=""),e.splice(f.parentElement.parentElement.sectionRowIndex,1),localStorage.setItem("downscale-presets",JSON.stringify(e)),c.tBodies.item(0).innerHTML="",printList(),clearErr(),document.getElementById("addRule").style.display="inline"},g.onclick=function(){inputUI(!0,r[l],l),clearErr()};var p=c.tBodies.item(0).insertRow(-1);p.insertCell(0).innerHTML=r[l][0],p.insertCell(1).innerHTML="[ "+r[l][1]+" x "+r[l][2]+" ]",p.insertCell(2).innerHTML="&#8594;",p.insertCell(3).innerHTML="[ "+r[l][3]+" x "+r[l][4]+" ]",p.insertCell(4).appendChild(g),p.insertCell(5).appendChild(f)}}}function inputUI(e,t,c){document.getElementById("inputContainer")&&(document.getElementById("inputContainer").innerHTML=""),document.getElementById("addRule").style.display="none";var r=document.getElementById("inputContainer"),s=document.createElement("div"),p=document.createElement("button");p.innerHTML="Cancel",p.style.margin="auto 0 0 10px";var l=document.createElement("button");l.innerHTML="Save",s.id="ruleInput",s.innerHTML='<select id="imgType" name="imgType" title="Input Format"><option value="0">PNG/JPEG</option><option value="1">PNG</option><option value="2">JPEG</option></select>&ensp;<input type="number" id="inWidth" title="Input Width" size="3" min="0" value="0" onfocus="this.select();"></input> x <input type="number" id="inHeight" title="Input Height" size="3" min="0" value="0" onfocus="this.select();"></input> &ensp; &#8594; &ensp; <input type="number" id="outWidth" title="Output Width" size="3" min="0" value="0" onfocus="this.select();"></input> x <input type="number" id="outHeight" title="Output Height" size="3" min="0" value="0" onfocus="this.select();"></input><br>',r.appendChild(s);var f=document.getElementById("inWidth"),g=document.getElementById("inHeight"),y=document.getElementById("outWidth"),C=document.getElementById("outHeight");if(e){switch(t[0]){case"PNG/JPEG":document.getElementById("imgType").selectedIndex=0;break;case"PNG":document.getElementById("imgType").selectedIndex=1;break;case"JPEG":document.getElementById("imgType").selectedIndex=2}f.value=t[1],g.value=t[2],y.value=t[3],C.value=t[4]}y.addEventListener("input",aspectCheckW),C.addEventListener("input",aspectCheckH),f.onkeypress=function(){return C.value=0,y.value=0,isNumber(event)},g.onkeypress=function(){return C.value=0,y.value=0,isNumber(event)},y.onkeypress=function(){return isNumber(event)},C.onkeypress=function(){return isNumber(event)},s.appendChild(l),s.appendChild(p),p.onclick=function(){document.getElementById(s.id).remove(),document.getElementById("addRule").style.display="inline",clearErr()},l.onclick=function(){e?basicCheck(!0,c):basicCheck(!1)}}function printQCList(){var e=getQCList(),t=document.getElementById("QCList"),c=document.getElementById("QCTable"),r=e.length;if(r>0){var s=[];for(let l=0;l<r;l++){s[l]=e[l].split(":");let f=document.createElement("a");f.innerHTML="delete",f.onclick=function(){e.splice(f.parentElement.parentElement.sectionRowIndex,1),localStorage.setItem("downscale-qclist",JSON.stringify(e)),c.tBodies.item(0).innerHTML="",printQCList()};var p=c.tBodies.item(0).insertRow(-1);p.insertCell(0).innerHTML=s[l][0],p.insertCell(1).innerHTML="[ "+s[l][1]+" x "+s[l][2]+" ]",p.insertCell(2).innerHTML=s[l][3],p.insertCell(3).innerHTML="&#8594;",p.insertCell(4).innerHTML=s[l][4],p.insertCell(5).innerHTML='<p title = "'+s[l][5]+'">'+s[l][5]+"</p>",p.insertCell(6).appendChild(f)}}}function appendSettings(){var e=document.createElement("span"),t=document.createElement("a");t.id="imgResizeSettings",t.className+="fa fa-cog",t.style="cursor: pointer;",t.title="Image Resizer Settings";var c=document.getElementById("shortcut-settings");c.insertBefore(e,parent.nextSibling),e.appendChild(t);var r=document.createElement("div");r.id="imgResizeOverlay",r.classList.add("settingsOverlay"),document.body.appendChild(r);var s=document.createElement("div");s.id="imgResizeMenu",s.classList.add("dialog"),r.appendChild(s);var p=document.createElement("a");p.className+="close fa fa-times",p.style="float: right;",p.title="Close",s.insertAdjacentElement("afterbegin",p);var l=document.createElement("a");l.innerHTML+="Settings",l.classList.add("menuBtns"),l.style="font-weight: bold;",l.onclick=function(){b.className="downscale-menu-on",I.className="downscale-menu-off",T.className="downscale-menu-off",P.className="downscale-menu-off",l.style="font-weight: bold;",f.style="",g.style="",y.style=""},s.appendChild(l);var f=document.createElement("a");f.innerHTML+="Presets",f.classList.add("menuBtns"),f.onclick=function(){b.className="downscale-menu-off",I.className="downscale-menu-on",T.className="downscale-menu-off",P.className="downscale-menu-off",l.style="",f.style="font-weight: bold;",g.style="",y.style=""},s.appendChild(f);var g=document.createElement("a");g.innerHTML+="Quick Convert",g.classList.add("menuBtns"),g.onclick=function(){b.className="downscale-menu-off",I.className="downscale-menu-off",T.className="downscale-menu-on",P.className="downscale-menu-off",l.style="",f.style="",g.style="font-weight: bold;",y.style=""},s.appendChild(g);var y=document.createElement("a");y.innerHTML+="About",y.classList.add("menuBtns"),y.onclick=function(){b.className="downscale-menu-off",I.className="downscale-menu-off",T.className="downscale-menu-off",P.className="downscale-menu-on",l.style="",f.style="",g.style="",y.style="font-weight: bold;"},s.appendChild(y);var C=document.createElement("hr");C.style.borderColor=getHRColor(),s.appendChild(C);var L=document.createElement("div");L.id="imgResizeContent",s.appendChild(L),L.innerHTML="";var N=document.createElement("p");N.id="errMsg";var b=document.createElement("div");b.id="settingsDiv",b.classList.add("downscale-menu-on"),L.appendChild(b);var I=document.createElement("div");I.id="presetsDiv",I.classList.add("downscale-menu-off"),I.style.textAlign="center",L.appendChild(I);var T=document.createElement("div");T.id="QCListDiv",T.classList.add("downscale-menu-off"),L.appendChild(T);var P=document.createElement("div");P.id="heplDiv",P.classList.add("downscale-menu-off"),L.appendChild(P);var de=document.createElement("h3");de.innerHTML="Image Resizer Settings",b.appendChild(de);var te=document.createElement("div");te.classList.add("resizer-settings"),te.innerHTML='<input type="checkbox" id="enableSet" title="" size="1"></input><label for="enableSet">Enable Resizer</label>:&ensp;Enable 4chan Image Resizer by default.',b.appendChild(te);var q=document.getElementById("enableSet");q.checked=getSettings().enabled,q.oninput=function(){q.checked||(removeCropOption(),removeQCOption(),removeRemOption(),removePreviewOption());var h=getSettings();h.enabled=q.checked,document.getElementById("imgResize").checked=q.checked,localStorage.setItem("downscale-settings",JSON.stringify(h))};var ne=document.createElement("div");ne.classList.add("resizer-settings"),ne.innerHTML='<input type="checkbox" id="shortcutSet" title="" size="1"></input><label for="shortcutSet">Enable Shortcut</label>:&ensp;Enable "Quick Convert" shortcut. <kbd>Ctrl</kbd> + <kbd>Q</kbd> by default.',b.appendChild(ne);var ie=document.getElementById("shortcutSet");ie.checked=getSettings().shortcut,ie.oninput=function(){var h=getSettings();h.shortcut=ie.checked,localStorage.setItem("downscale-settings",JSON.stringify(h))};var oe=document.createElement("div");oe.classList.add("resizer-settings"),oe.innerHTML='<input type="checkbox" id="displaySet" title="" size="1"></input><label for="displaySet">Display Notifications</label>:&ensp;Display a notification when an image is downscaled.',b.appendChild(oe);var ae=document.getElementById("displaySet");ae.checked=getSettings().notify,ae.oninput=function(){var h=getSettings();h.notify=ae.checked,localStorage.setItem("downscale-settings",JSON.stringify(h))};var re=document.createElement("div");re.classList.add("resizer-settings"),re.innerHTML='<input type="checkbox" id="convertSet" title="" size="1"></input><label for="convertSet">Convert WebP to </label><select id="convertOut" name="cropOut"><option value="image/png">PNG</option><option value="image/jpeg">JPEG</option></select>:&ensp;Automatically convert WebP images to selected format.',b.appendChild(re);var _=document.getElementById("convertSet");_.checked=getSettings().convert;var $=document.getElementById("convertOut");$.value=getSettings().convertOutput,_.oninput=function(){var h=getSettings();h.convert=_.checked,h.convertOutput=$.value,localStorage.setItem("downscale-settings",JSON.stringify(h))},$.oninput=function(){var h=getSettings();h.convert=_.checked,h.convertOutput=$.value,localStorage.setItem("downscale-settings",JSON.stringify(h))};var se=document.createElement("div");se.classList.add("resizer-settings"),se.innerHTML='<input type="text" id="imgQuality" title="JPEG Quality" size="2"></input><label for="imgQuality">JPEG Quality</label>:&ensp;A number between 1 and 100 indicating the output image quality.',b.appendChild(se);var ce=document.getElementById("imgQuality");ce.value=getSettings().jpegQuality*100,ce.oninput=function(){var h=document.getElementById("imgQuality"),H=new RegExp(/^$|^[1-9][0-9]?$|^100$/);if(H.test(h.value)&&h.value!=""){h.setCustomValidity("");var O=getSettings();O.jpegQuality=h.value/100,localStorage.setItem("downscale-settings",JSON.stringify(O))}else h.value==""?(h.setCustomValidity(`Input a number between 1 and 100.
Current set value: `+getSettings().jpegQuality*100),h.reportValidity()):(h.setCustomValidity(`Input a number between 1 and 100.
Current set value: `+getSettings().jpegQuality*100),h.reportValidity(),h.value=getSettings().jpegQuality*100)};var U=document.createElement("div");U.classList.add("resizer-settings"),U.innerHTML='<select id="cropOut" name="cropOut"><option value="image/png">PNG</option><option value="image/jpeg">JPEG</option></select>&ensp;<label for="cropOut">Crop Output</label>:&ensp;Set the desired output format for cropped images.',b.appendChild(U);var Y=document.getElementById("cropOut");Y.value=getSettings().cropOutput,Y.oninput=function(){var h=getSettings();h.cropOutput=Y.value,localStorage.setItem("downscale-settings",JSON.stringify(h))};var W=document.createElement("div");W.style.overflowY="auto",W.style.maxHeight="220px";var Q=document.createElement("table"),J=document.createElement("thead"),le=document.createElement("tbody"),Z=document.createElement("h3");Z.innerHTML="Presets",I.appendChild(Z),Q.appendChild(J),Q.appendChild(le),Q.id="ruleTable";var D=J.insertRow(0);D.insertCell(0).outerHTML="<th>Format</th>",D.insertCell(1).outerHTML="<th>Input</th>",D.insertCell(2).outerHTML="<th></th>",D.insertCell(3).outerHTML="<th>Output</th>",D.insertCell(4).outerHTML="<th></th>",D.insertCell(5).outerHTML="<th></th>",I.appendChild(W),W.appendChild(Q);var K=document.createElement("div");K.id="inputContainer",I.appendChild(K);var j=document.createElement("button");j.id="addRule",j.innerHTML="New Preset",printList(),I.appendChild(j),I.appendChild(N),t.onclick=function(){r.style.display="block"},p.onclick=function(){r.style.display="none"},window.addEventListener("click",function(h){h.target==r&&(r.style.display="none")}),j.onclick=function(){inputUI(!1)};var z=document.createElement("div");z.style="float: left;";var X=document.createElement("span");X.innerHTML=" | ";var R=document.createElement("a"),n=document.createElement("a");R.innerHTML="Import",n.innerHTML="Export",R.classList.add("menuBtns"),z.innerHTML+='<input id="importPresetsFile-input" type="file" accept=".json" style="display: none;" />',R.onclick=function(){document.getElementById("importPresetsFile-input").click()},n.onclick=function(){downloadObjectAsJson(getPresets(),"4chan Image Resizer v"+version+" Presets List - "+Date.now())},z.appendChild(R),z.appendChild(X),z.appendChild(n),I.appendChild(z),document.getElementById("importPresetsFile-input").addEventListener("change",function(){var h=new FileReader;h.onload=function(){var H=getPresets(),O=0,x=0,M=JSON.parse(h.result);if(Array.isArray(M)){for(let F=0;F<M.length;F++){var B=M[F].split(":");if(B.length!=5){DEBUG&&console.log("[Error] Imported array does not match the required length (5)"),DEBUG&&console.log(B),alert(`Error: Array length mismatch.
This file is either outdated or invalid.`);return}else{for(let G=0;G<H.length;G++){var ue=B[0]+":"+B[1]+":"+B[2]+":"+B[3]+":"+B[4];if(ue==H[G]){x++;break}}x==0?H.push(M[F]):(O+=x,x=0)}}localStorage.setItem("downscale-presets",JSON.stringify(H)),document.getElementById("ruleTable").tBodies.item(0).innerHTML="",printList();var me=M.length-O;alert("Succesfully imported "+M.length+` entries.
Duplicate entries skipped: `+O+`
New entries added: `+me)}else alert("Error: Invalid data type."),DEBUG&&console.log("[Error] Imported data object is not an array.")},h.readAsText(this.files[0])});var i=document.createElement("div");i.style.overflowY="auto",i.style.maxHeight="220px";var a=document.createElement("table"),v=document.createElement("thead"),o=document.createElement("tbody"),d=document.createElement("h3");d.innerHTML="Quick Convert List",T.appendChild(d),T.innerHTML+="<p style='text-align: center;'>Images on this list will be automatically converted to JPEG with a quality setting of 92.</p>",a.appendChild(v),a.appendChild(o),a.id="QCTable";var m=v.insertRow(0);m.insertCell(0).outerHTML="<th>Format</th>",m.insertCell(1).outerHTML="<th>Dimensions</th>",m.insertCell(2).outerHTML="<th>Original Size</th>",m.insertCell(3).outerHTML="<th></th>",m.insertCell(4).outerHTML="<th>New Size</th>",m.insertCell(5).outerHTML="<th>Filename</th>",m.insertCell(6).outerHTML="<th></th>",T.appendChild(i),i.appendChild(a);var u=document.createElement("div");u.style="padding-top: 1em;";var S=document.createElement("span");S.innerHTML=" | ";var E=document.createElement("a"),k=document.createElement("a");E.innerHTML="Import",k.innerHTML="Export",E.classList.add("menuBtns"),u.innerHTML+='<input id="importQCLFile-input" type="file" accept=".json" style="display: none;" />',E.onclick=function(){document.getElementById("importQCLFile-input").click()},k.onclick=function(){downloadObjectAsJson(getQCList(),"4chan Image Resizer v"+version+" Quick Convert List - "+Date.now())},u.appendChild(E),u.appendChild(S),u.appendChild(k),T.appendChild(u),document.getElementById("importQCLFile-input").addEventListener("change",function(){var h=new FileReader;h.onload=function(){var H=getQCList(),O=0,x=0,M=JSON.parse(h.result);if(Array.isArray(M)){for(let F=0;F<M.length;F++){var B=M[F].split(":");if(B.length!=7||B[6].length!=32){DEBUG&&console.log("[Error] Imported array does not match the required length (7) or contains an invalid MD5 hash."),DEBUG&&console.log(B),alert(`Error: Array length mismatch.
This file is either outdated or invalid.`);return}else{for(let G=0;G<H.length;G++){var ue=H[G].split(":");if(B[6]==ue[6]){x++;break}}x==0?H.push(M[F]):(O+=x,x=0)}}localStorage.setItem("downscale-qclist",JSON.stringify(H)),document.getElementById("QCTable").tBodies.item(0).innerHTML="",printQCList();var me=M.length-O;alert("Succesfully imported "+M.length+` entries.
Duplicate entries skipped: `+O+`
New entries added: `+me)}else alert("Error: Invalid data type."),DEBUG&&console.log("[Error] Imported data object is not an array.")},h.readAsText(this.files[0])});var w=document.createElement("a"),ee=[];w.innerHTML="Delete All",w.style="float: right; margin-right: 1em;",w.onclick=function(){confirm(`WARNING!
Are you sure you want to DELETE ALL entries from the "Quick Convert List"?`)&&(localStorage.setItem("downscale-qclist",JSON.stringify(ee)),document.getElementById("QCTable").tBodies.item(0).innerHTML="")},u.appendChild(w),printQCList();var V=document.createElement("h3");V.innerHTML="About",P.appendChild(V);var A=document.createElement("div");A.innerHTML='<strong>4chan Image Resizer</strong> automatically downscales images based on custom presets. Originally developed to downscale anime/vidya screenshots "on the fly". Now with image cropping and WebP conversion!<br><br><details><summary><strong>Presets</strong></summary><br>To automate image resizing, you have to create a preset by choosing an input image format and entering input and output dimensions (pixels). Then just add an image to a quick reply form. If it meets any of the created input requirements, the image will be automatically downscaled to your specified dimensions as a <strong>JPEG</strong>. <br><br><strong>Note</strong> that output dimensions are constrained by input dimensions <strong>aspect ratio</strong>. <br><strong>Also note</strong> that <strong>setting JPEG output quality to 100 will</strong> result in filesizes larger than that of the original image, without any noticable quality changes.</details><br><details><summary><strong>Quick Convert</strong></summary><br>Allows you to quickly convert images (PNG/JPEG/WebP) to JPEG fromat.<br>This is very useful when an image exceeds 4chan image size limit of <strong>4 MB</strong>.<br><br>It works well on super high resolution images (+3000px), sometimes drastically cutting the filesize without any noticeble quality loss. However, <strong>it is not recommended to use it on grayscale PNG images</strong>, i.e. manga pages, because most of the time <strong>it will result in larger than original filesizes</strong>.<br>Once you are satisfied with the <strong>"Quick Convert"</strong> results, you can click <strong>"Remember"</strong> on the side menu to add the image MD5 hash to the <strong>"Quick Convert List"</strong>, which then will always automatically convert the image for you in the future.<br><br>You can also use the default <kbd>Ctrl</kbd> + <kbd>Q</kbd> keyboard shortcut to perform <strong>"Quick Convert"</strong> faster. Press again to <strong>"Remember"</strong> the image.</details><br><details><summary><strong>Import/Export</strong></summary><br>Allows you to seperatly backup both, "Presets" and "Quick Convert" lists as .json files.<br><strong>Import</strong> works by merging list entries instead of overwriting them, <span style="text-decoration-line: line-through;">so you can export/import items between domains without any worry.</span></details><br><details><summary><strong>Image Cropping</strong></summary><br>A basic image cropping tool that uses <a href="https://github.com/daiyam/cropperjs/tree/daiyam" target="_blank">Daiyam/Cropper.js</a> library. You can change cropped image output format in the settings tab.<br><strong>PNG</strong> is lossless and preserves transperancy, but results in larger filesizes.<br><strong>JPEG</strong> is lossy, but results in smaller filesizes (the <strong>"JPEG Quality"</strong> setting also applies here).</details><br><details><summary><strong>Cropper Controls</strong></summary><br>While cropping:<ul><li>Double click <kbd>LMB</kbd> - switch between cropping and zooming.</li><li>Hold <kbd>Shift</kbd> while cropping - draw a fixed rectangle.</li><li><kbd>MWheel</kbd> - zoom in/out.</li><li><kbd>Backspace</kbd> - clear selection.</li><li><kbd>Enter</kbd> - confirm selection.</li><li><kbd>Esc</kbd> or <kbd>Delete</kbd> - close cropper.</li></ul>After selection:<br><ul><li><kbd>Enter</kbd> or <kbd>LMB</kbd> - set image to QR form.</li><li><kbd>Backspace</kbd> or <kbd>RMB</kbd> - undo selection.</li><li><kbd>MMB</kbd> - close cropper.</li><li><kbd>Shift</kbd> + <kbd>RMB</kbd> - open context menu.</li></ul></details><br><details><summary><strong>Custom Shortcuts</strong></summary><br>I am way too lazy to implement custom keybind functionality and the UI for it. But if you really want to change the default keybinds, you will have to edit the code directly.<br><br>To do that, you first have to open the code in your script manager (Tampermonkey, Violentmonkey, etc.).<br>If you want to change "<strong>Quick Convert</strong>" shortcut, hit Ctrl+F and search for "<strong>Quick Convert KEYBINDS</strong>".<br>If you want to change "<strong>Image Cropper</strong>" shortcuts, hit Ctrl+F and search for "<strong>Cropper KEYBINDS</strong>".<br>All you have to do now is change the <strong>keyCode</strong> values to the ones that represent your desired keys. You can easily find equivalent keyCode values for each keyboard key by <a href="https://www.google.com/search?q=keyCode+values" target="_blank">googling</a> them.</details><br><span style="font-weight:bold; color: red;">NEW</span><ul><li>Replaced the useless auto PNG conversion with auto WebP conversion.</li><li>Image  preview header now displays the correct file type after conversion.</li><li>Some minor UI adjustments.</li><br><br><div style="float: right;" >[ <a href="https://greasyfork.org/en/scripts/391758-4chan-image-resizer" target="_blank">version '+version+"</a> ]</div>",P.appendChild(A)}function appendSideMenu(){var e=document.createElement("a");e.id="sideMenuArrow",e.title="Side Menu",e.style.cursor="pointer",e.innerHTML="&#9664;";var t=document.getElementById("autohide");t.parentNode.insertAdjacentElement("beforebegin",e),e.onclick=function(){c.classList.toggle("downscale-menu-on")};var c=document.createElement("div");c.id="sideMenu",c.classList.add("dialog");var r=document.getElementById("qr");r.insertAdjacentElement("afterbegin",c),window.addEventListener("click",function(s){var p=document.getElementById("sideMenu");!s.target.matches("#sideMenuArrow")&&!s.target.matches("#sideMenu")&&!s.target.matches("#imgResize")&&!s.target.matches("#quickConvert")&&!s.target.matches("#imgResizeLabel")&&p.classList.contains("downscale-menu-on")&&p.classList.remove("downscale-menu-on")})}appendSettings();function saveImgMD5(e,t,c,r){removeRemOption();var s=getQCList(),p=t.type.split("/").pop().toUpperCase(),l=t.name.split(".").slice(0,-1).join(".");l=l.replace(/:/g,"_");var f=formatBytes(t.size),g=formatBytes(r),y=p+":"+e.width+":"+e.height+":"+f+":"+g+":"+l+":"+c;s.push(y),localStorage.setItem("downscale-qclist",JSON.stringify(s));var C=t.name+`
Added to the "Quick Convert List"`,L={type:"info",content:C,lifetime:5},N=new CustomEvent("CreateNotification",{bubbles:!0,detail:L});document.dispatchEvent(N),document.getElementById("QCTable").tBodies.item(0).innerHTML="",printQCList()}function removeQCOption(){var e=document.getElementById("qcDiv");e&&e.remove()}function removeRemOption(){var e=document.getElementById("remDiv");e&&e.remove()}function removeCropOption(){var e=document.getElementById("cropDiv");e&&e.remove()}function removePreviewOption(){var e=document.getElementById("previewImg");e&&e.remove()}function removeHR(){var e=document.getElementById("sm-hr");e&&e.remove()}function removeManual(){var e=document.getElementById("manDiv");e&&e.remove()}function getHRColor(){var e=document.getElementById("imgResizeMenu");return window.getComputedStyle(e,null).getPropertyValue("border-bottom-color")}function appendHR(){var e=document.createElement("hr");e.id="sm-hr",e.style.borderColor=getHRColor(),document.getElementById("sideMenu").appendChild(e)}function showImage(e,t,c,r,s,p){var l=constructFilename(p,s),f=document.createElement("div");f.id="pvOverlay";var g=document.createElement("div");g.id="pvHeader",g.className="dialog",g.classList.add("pvOpct"),g.innerHTML=l+"<br>("+formatBytes(t)+", "+Math.round(c)+"x"+Math.round(r)+")";var y=document.createElement("a");y.className="close fa fa-times",y.style="float: right; cursor: pointer; margin-right: 20px; margin-top: -9px; transform: scale(1.5);",y.title="Close",y.onclick=function(){f.remove()};var C=document.createElement("img");C.id="pvImg",C.classList.add("centerImg"),C.title="Click to close",C.src=e,C.onclick=function(){f.remove()},document.body.appendChild(f),f.appendChild(C),f.appendChild(g),g.appendChild(y),setTimeout(function(){g.classList.toggle("pvOpct")},2e3)}function dataURItoBlob(e){var t;e.split(",")[0].indexOf("base64")>=0?t=atob(e.split(",")[1]):t=unescape(e.split(",")[1]);for(var c=e.split(",")[0].split(":")[1].split(";")[0],r=new Uint8Array(t.length),s=0;s<t.length;s++)r[s]=t.charCodeAt(s);return new Blob([r],{type:c})}function downloadObjectAsJson(e,t){var c="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),r=document.createElement("a");r.setAttribute("href",c),r.setAttribute("download",t+".json"),document.body.appendChild(r),r.click(),r.remove()}var scListenerExists=!1;getSettings().shortcut&&!scListenerExists&&(document.addEventListener("keyup",qCShortcut),scListenerExists=!0);function qCShortcut(e){var t=document.getElementById("quickConvert"),c=document.getElementById("rememberMD5");getSettings().shortcut&&(e.ctrlKey&&e.keyCode==81&&t?t.click():e.ctrlKey&&e.keyCode==81&&c&&c.click())}function constructFilename(e,t){var c=e.split("/").pop(),r=t.split(".").slice(0,-1).join(".").concat("."+c);return r}function isNumber(e){var t=(e=e||window.event).which?e.which:e.keyCode;return!(t>31&&(t<48||t>57))}function formatBytes(e,t){if(e==0)return"0 Bytes";var c=1024,r=t||2,s=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],p=Math.floor(Math.log(e)/Math.log(c));return parseFloat((e/Math.pow(c,p)).toFixed(r))+" "+s[p]}
