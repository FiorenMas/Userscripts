// ==UserScript==
// @name         Direct download from Google Play
// @namespace    StephenP
// @version      3.6.1
// @author       StephenP
// @icon      data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAM1BMVEV2ZXLgIkzxMUf6OkN9f5v7ZTAOpP8OxP4myPsU1LkU1P4k4oAr3vwk7H1U41v+ziz92jIMI6b6AAAAAXRSTlMAQObYZgAAAKtJREFUOMul0ssSgyAMQNGAtCgv/f+vLcVCSCLiTLPL3MPAAoAn4/0EbP6eWDsRaxEx3gG7xe+MAIo4ABPhiIjXoBeCOCEiB0IkDphI+3EwQETaM+iIYyL3AhpxVKT3OSgCEeaFACgowiyLBE241WgE7ZEBhdFaVwA9CNi1vgQB+wCE1kcg1A4DQO6n5uxKleMgO/x6nrKKDrXX/eINpstV9D+G9SLIruCP+QAbnhEp2bGFogAAAABJRU5ErkJggg==
// @match        https://play.google.com/*
// @match        http://play.google.com/*
// @match        http://apkfind.com/store/captcha?app=*
// @grant        GM.xmlHttpRequest
// @grant        GM.getValue
// @grant        GM.setValue
// @require      https://greasemonkey.github.io/gm4-polyfill/gm4-polyfill.js
// @connect      self
// @connect      apkpure.com
// @connect      apkfind.com
// @connect      apk-cloud.com
// @connect      winudf.com
// @connect      apkcombo.com
// @connect      down-apk.com
// @connect      play.googleapis.com
// @connect      gvt1.com
// @connect      apkpremier.com
// @connect      web-api.aptoide.com
// @connect      apk.support
// @contributionURL https://buymeacoffee.com/stephenp_greasyfork
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Direct20download20from20Google20Play.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Direct20download20from20Google20Play.meta.js
// ==/UserScript==
var ui,wlButton,pageURL,title,appCwiz,done=[0],useGS;(async function(){useGS=await GM.getValue("useGS",!1),starter()})();function starter(){if(document.location.href.includes("apkfind")===!0)setInterval(unredirect,100);else try{var e=window.location.href.toString();if(ui=checkUI(),pageURL=location.href,ui>0){title=document.getElementById("main-title").innerHTML;var t=document.createElement("style"),i;i=`.ddlButton: visited {
                          color: white;
                      }
                      .ddlButton: hover {
                          opacity: 0.8;
                      }
                      .ddlButton: active {
                          opacity: 0.6;
                      }
                      .ddlButton {
                          font-family: "Google Sans",Roboto,Arial,sans-serif;
                          font-size: 1rem;
                          font-weight: 500;
                          padding: 0 10px;
                          color: white;
                          position: relative;
                          z-index: 0;
                          width: 100px;
                          cursor: pointer;
                      }
                      .ddlButton>a {
                          color: white;
                      }
                      .dropdown {
                          background-color:  #fff;
                          width: min-content;
                          border-radius: 8px;
                          box-shadow: 0 5px 20px rgba(0, 0, 0, 0.7);
                          padding: 8px;
                          z-index: 1000;
                      }
                      #buttonDropdown > .ddlButton:first-child{
                          border-radius: 8px 8px 0 0;
                      }
                      #buttonDropdown > .ddlButton:last-child{
                          border-radius: 0 0 8px 8px;
                      }`,t.textContent=i,document.body.appendChild(t)}(pageURL.includes("details?id=")||pageURL.includes("/store/search?q="))&&addButtons(),setInterval(checkReload,2e3)}catch(a){console.log("main(): "+a)}}function unredirect(){var e=document.body.children.length-1;parseInt(document.body.children[e].style.zIndex,10)>2&&(document.body.children[e].id==""?(document.body.children[e].style.zIndex="1",document.body.children[e-1].style.zIndex="-1000"):document.body.children[e].style.zIndex="-1000")}function waitForRemovingButtons(){if(pageURL!=location.href||isButtonVisible()===!1){if(title=document.getElementById("main-title").innerHTML,pageURL=location.href,wlButton=null,location.href.includes("details?id=")||location.href.includes("/store/search?q=")){if(ui>0&&document.getElementsByClassName("ddlButton").length>0)try{removePreviousCwiz()}catch(e){console.log(e+"; I was probably just trying to remove buttons that weren't there...")}addButtons()}}else setTimeout(waitForRemovingButtons,1e3)}function checkReload(){(pageURL!=location.href||isButtonVisible()===!1)&&waitForRemovingButtons()}function isButtonVisible(){var e=document.getElementsByClassName("ddlButton");if(e.length>0){for(var t=0;t<e.length;t++)if(e[t].offsetParent!=null)return!0;return!1}else return document.location.href.includes("play.google.com/store/apps/details")?(console.log("apppage//false"),!1):!0}function addButtons(){var e=-1,t=null,i=[];if(ui>0){for(t=get2022UIButtons();t.tagName!="C-WIZ";)t=t.parentNode;try{e=t.querySelector("meta[itemprop=price]").content}catch{console.error("Price not found. Maybe the app is already installed or not officially available?"),e=0}var a;a=t.parentNode;do a.tagName=="C-WIZ"&&(appCwiz=a),a=a.parentNode;while(a.tagName!="BODY")}else{document.getElementById("search-section").lastChild.remove();let c=document.getElementById("search-section"),l=document.createElement("SPAN");l.style="margin-top: 32px; float: left",l.textContent="or ",c.appendChild(l);let h=document.createElement("SPAN"),f=document.createElement("A");f.style="background-color: #FF8B14; font-weight: bold; text-decoration: none; padding: 1em; margin: 17px; float: left; color: white; cursor: pointer;",f.textContent="Search on APKMirror",f.className="rounded",f.id="apkMirrorBtn";let A="https://www.apkmirror.com/?post_type=app_release&searchtype=apk&s="+location.search.match(/id=(.*)/)[1].split("&",1);f.addEventListener("click",function(){window.open(A)}),h.appendChild(f),c.appendChild(h);let k=document.createElement("DIV");k.style="clear:both",c.appendChild(k),GM.xmlHttpRequest({method:"GET",url:"https://www.apkmirror.com/?post_type=app_release&searchtype=apk&s="+location.search.match(/id=(.*)/)[1].split("&",1),timeout:5e3,onload:function(E){if(new DOMParser().parseFromString(E.responseText,"text/html").getElementById("content").getElementsByClassName("appRow").length>0)f.textContent="Available on APKMirror";else{let y=f.cloneNode(!0);y.textContent="Not available on APKMirror",y.style.backgroundColor="#CCCCCC",y.style.cursor="not-allowed",f.parentNode.replaceChild(y,f)}}})}if(e==0){var b,p,o;location.href.includes("details?id=")?o=location.search.match(/id=(.*)/)[1].split("&",1):location.href.includes("/store/search?q=")&&(o=t.querySelector('[data-item-id^="%.@."]').getAttribute("data-item-id").match(/%\.@\.".+"/)[0].replace('%.@."',"").replace('"',""));var n="https://d.apkpure.com/b/APK/"+o+"?version=latest",r="https://apps.evozi.com/apk-downloader/?id="+o,s="http://apkfind.com/store/download?id="+o,u="https://www.apkmirror.com/?post_type=app_release&searchtype=apk&s="+o,m="https://apkleecher.com/download/dl.php?dl="+o,C="https://apkcombo.com/genericApp/"+o+"/download/apk",w="https://apkpremier.com/download/"+o.toString().replace(/[.]/g,"-"),x="https://web-api.aptoide.com/search?query="+o,v="https://apk.support/download-app/"+o;wlButton=document.createDocumentFragment();var d,g="",b;p=t.parentNode,g="ddlButton";let c=document.createElement("button");c.className=g,c.textContent="Download \u25BC",c.style.backgroundColor="#F55",c.style.borderRadius="8px";let l=document.createElement("div");l.id="buttonDropdown",l.style.position="absolute",l.style.display="none",l.style.marginTop="5px",l.className="dropdown",l.appendChild(createOptionButton("APK-DL",s,"#009688",o,!0,!1)),l.appendChild(createOptionButton("APKPure",n,"#24cd77",o,!0,!1)),l.appendChild(createOptionButton("APKCombo",C,"#00875f",o,!0,!0)),l.appendChild(createOptionButton("APKPremier",w,"#3740ff",o,!0,!1)),l.appendChild(createOptionButton("Evozi",r,"#286090",o,!1,!1)),l.appendChild(createOptionButton("APKMirror",u,"#FF8B14",o,!1,!1)),l.appendChild(createOptionButton("Aptoide",x,"#fe6446",o,!0,!1)),l.appendChild(createOptionButton("APKSupport",v,"#3740ff",o,!0,!0)),c.onclick=function(){l.style.display=l.style.display==="block"?"none":"block"},document.body.addEventListener("click",function(h){console.log(h.target.closest("#buttonDropdown")),!h.target.closest("#buttonDropdown")&&h.target!==c&&(l.style.display="none")}),p.appendChild(c),p.appendChild(l)}}function createOptionButton(e,t,i,a,p,o){let n=document.createElement("button");if(n.className="ddlButton",n.style.backgroundColor=i,!p||o){let r=document.createElement("A");r.href=t,r.textContent=e,n.appendChild(r)}else{let r=document.createElement("SPAN");r.textContent=e,n.appendChild(r)}return p?n.onclick=function(){return ddl(this,t,a),!1}:n.onclick=function(){return window.open(t),!1},n}function openLink(e){window.open(e.replace("http://","https://"),"_self")}function ddlFinalApk(e,t,i){return e!=""?(done[i]=0,GM.xmlHttpRequest({method:"GET",url:e,timeout:5e3,ontimeout:function(a){done[i]==0?t.firstChild.textContent="Retry":done[i]=0},onprogress:function(a){(a.finalUrl.includes("winudf.com")||a.finalUrl.includes("down-apk.com")||a.finalUrl.includes("/play-apps-download-default/"))&&done[i]==0&&(console.log("downloading file n."+i),done[i]=1,e.includes("apkpure")?(window.open(a.finalUrl,"_self"),t.onclick=function(){openLink(a.finalUrl)},t.firstChild.textContent="Ready!"):e.includes("apkpremier")?(window.open(a.finalUrl,"_self"),t.onclick=function(){openLink(a.finalUrl)},t.firstChild.textContent="Ready!"):(window.open(a.finalUrl,i),t.firstChild.textContent="APKCombo"))},onload:function(a){done[i]==0?t.firstChild.textContent="Retry":done[i]=0},onerror:function(){buttonError(t,"Offline!")}}),0):(buttonError(t,"Failed!"),-1)}function ddl(e,t,i){if(e.firstChild.textContent="Loading...",t.includes("apkfind"))try{var a=GM.xmlHttpRequest({method:"GET",url:t,onload:function(o){if(console.log(o),o.finalUrl.includes("/captcha?"))e.addEventListener("click",function(){window.open(o.finalUrl)}),e.firstChild.textContent="CAPTCHA",e.onclick=null;else if(o.finalUrl.includes("app/removed"))buttonError(e,"Removed!");else try{var n=new DOMParser().parseFromString(o.response,"text/html"),r="http:"+n.getElementsByClassName("mdl-button")[0].getAttribute("href");e.firstChild.textContent="Ready!",openLink(r),e.onclick=function(){openLink(r)}}catch(s){buttonError(e,"Failed!"),console.log(s)}},onerror:function(){buttonError(e,"Offline!")}})}catch(o){buttonError(e,"Failed!"),console.log(o)}else if(t.includes("apkpure")){if(ddlFinalApk(t,e,0)==-1)try{GM.xmlHttpRequest({method:"GET",url:t,onload:function(o){switch(o.status){case 410:buttonError(e,"Removed!");break;case 404:buttonError(e,"Not found!");break;default:var n=o.responseText.substr(o.responseText.indexOf("https://download.apkpure.com/b/"),o.responseText.length-1);n=n.substr(0,n.indexOf('"')),console.log(t),e.firstChild.textContent="Wait...",ddlFinalApk(n,e,0)}},onerror:function(){buttonError(e,"Offline!")}})}catch(o){buttonError(e,"Failed!"),console.log(o)}}else if(t.includes("apkcombo"))try{var p;GM.xmlHttpRequest({method:"POST",url:"https://apkcombo.com/checkin",headers:{Referer:t,Origin:"https://apkcombo.com"},onload:function(o){p=o.responseText,GM.xmlHttpRequest({method:"GET",url:t,onload:function(n){switch(n.status){case 410:buttonError(e,"Removed!");break;case 404:buttonError(e,"Not found!");break;default:try{var r,s=new DOMParser,u=s.parseFromString(n.responseText,"text/html"),m=u.getElementsByClassName("file-list")[0];if(m!==void 0){var C=m.getElementsByTagName("a");for(r=0;r<C.length;r++){let d=C[r].getAttribute("href");if(d.startsWith("/r2?u="))try{window.open(decodeURIComponent(d).split("?u=")[1])}catch(g){console.log(g),buttonError(e,"Error!")}else window.open(d+"&"+p)}e.firstChild.textContent="APKCombo"}else{var w=n.responseText.indexOf("/dl?token=")+4,x=n.responseText.indexOf('"',w),v=n.responseText.substring(w,x);t=n.finalUrl,GM.xmlHttpRequest({method:"POST",url:t.replace("/download/apk","/dl")+"?"+v,onload:function(d){var g=new DOMParser,b=g.parseFromString(d.responseText,"text/html");if(m=b.getElementsByClassName("file-list")[0],m!==null){var c=m.getElementsByTagName("a");for(r=0;r<c.length;r++)window.open(c[r].getAttribute("href")+"&"+p);e.firstChild.textContent="APKCombo"}else e.addEventListener("click",function(){window.open(t)}),e.firstChild.textContent="New tab >",e.onclick=null},onerror:function(d){buttonError(e,"Error!")}})}}catch(d){console.log(d)}}},onerror:function(){buttonError(e,"Offline!")}})}})}catch(o){buttonError(e,"Failed!"),console.log(o)}else if(t.includes("apkpremier"))try{GM.xmlHttpRequest({method:"POST",url:t,data:"cmd=apk&gc=0",headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(o){switch(o.status){case 410:buttonError(e,"Removed!");break;case 404:buttonError(e,"Not found!");break;default:let s=new DOMParser().parseFromString(o.responseText,"text/html").getElementsByClassName("bdlinks");if(o.responseText=="error capchar")e.addEventListener("click",function(){window.open(t)}),e.firstChild.textContent="CAPTCHA",e.onclick=null;else if(s.length>0){for(let u of s)window.open(u.firstElementChild.getAttribute("href"),"_self");e.firstChild.textContent="Ready!"}else e.firstChild.textContent="Failed!"}},onerror:function(){buttonError(e,"Offline!")}})}catch(o){buttonError(e,"Failed!"),console.log(o)}else if(t.includes("aptoide"))try{GM.xmlHttpRequest({method:"GET",url:t,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(o){switch(o.status){case 410:buttonError(e,"Removed!");break;case 404:buttonError(e,"Not found!");break;default:let n=JSON.parse(o.responseXML);if(n.datalist.total>0){let r=t.split("?query=")[1];for(let s of n.datalist.list)if(s.package===r){if(s.aab)for(let u of s.aab.splits)window.open(u.path);s.obb&&window.open(s.obb.main.path),openLink(n.datalist.list[0].file.path),e.firstChild.textContent="Ready!"}e.firstChild.textContent!="Ready!"&&buttonError(e,"Not found!")}else e.firstChild.textContent="Failed!"}},onerror:function(){buttonError(e,"Offline!")}})}catch(o){buttonError(e,"Failed!"),console.log(o)}else if(t.includes("apk.support"))try{GM.xmlHttpRequest({method:"POST",url:t,data:"cmd=csapk&pkg="+i+"&arch=default&tbi=default&device_id=&model=default&language=en&dpi=480&av=default",headers:{Referer:t,Origin:"https://apk.support","Content-Type":"application/x-www-form-urlencoded"},onload:function(o){if(o.responseXML){let n=o.responseXML.querySelectorAll("[href*='.androidcontents.com/']");if(n.length==0&&(n=o.responseXML.querySelectorAll("[href*='.googleapis.com/download/']")),n.length>0){e.firstChild.textContent="Ready!";for(let r of n)window.open(r)}else buttonError(e,"Not found!")}},onerror:function(o){buttonError(e,"Error!")}})}catch(o){console.log(o)}}function get2022UIButtons(){var e=[];if(e=document.querySelectorAll('[data-item-id^="%.@."]'),e.length==0){e=document.querySelectorAll('[data-p^="%.@.["]');for(let t of e)if(t.querySelector("[fill-rule=evenodd]")&&t.getAttribute("data-p").includes('",7]]'))return t}return console.log("Install buttons:"),console.log(e),e[0]}function checkUI(){var e=0;try{document.getElementsByTagName("header").length>0?e=5:e=0}catch(t){console.error('The user interface of Google Play Store was not recognized by "Direct Download from Google Play" script. This might result in unexpected behaviour of the page. Please report the error to the author on Greasyfork. Error: '+t)}return console.log("PLAY STORE INTERFACE: "+e),e}function removePreviousCwiz(){appCwiz.parentNode.removeChild(appCwiz)}function buttonError(e,t){e.firstChild.textContent=t,e.style.backgroundColor="#CCCCCC",e.onclick=null}async function setUseGS(e){useGS=e,GM.setValue("useGS",e)}
