// ==UserScript==
// @name                Selection and Copying Restorer (Universal)
// @version             1.21.0.2
// @namespace           https://greasyfork.org/users/371179
// @author              CY Fung
// @supportURL          https://github.com/cyfung1031/userscript-supports
// @run-at              document-start
// @match               http://*/*
// @match               https://*/*
// @exclude             /^https?://\S+\.(txt|png|jpg|jpeg|gif|xml|svg|manifest|log|ini)[^\/]*$/
// @exclude             https://github.dev/*
// @exclude             https://vscode.dev/*
// @exclude             https://www.photopea.com/*
// @exclude             https://www.google.com/maps/*
// @exclude             https://docs.google.com/*
// @exclude             https://drive.google.com/*
// @exclude             https://mail.google.com/*
// @exclude             https://www.dropbox.com/*
// @exclude             https://outlook.live.com/mail/*
// @exclude             https://www.terabox.com/*
// @exclude             https://leetcode.cn/*
// @icon                https://raw.githubusercontent.com/cyfung1031/userscript-supports/main/icons/selection-copier.png
// @grant               GM_registerMenuCommand
// @grant               GM_unregisterMenuCommand
// @grant               GM.setValue
// @grant               GM.getValue
// @grant               GM_addValueChangeListener
// @grant               unsafeWindow
// @inject-into         page

// @compatible          firefox Violentmonkey
// @compatible          firefox Tampermonkey
// @compatible          chrome Violentmonkey
// @compatible          chrome Tampermonkey
// @compatible          opera Violentmonkey
// @compatible          opera Tampermonkey
// @compatible          safari Stay
// @compatible          edge Violentmonkey
// @compatible          edge Tampermonkey
// @compatible          brave Violentmonkey
// @compatible          brave Tampermonkey


// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Selection20and20Copying20Restorer2028Universal29.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Selection20and20Copying20Restorer2028Universal29.meta.js
// ==/UserScript==
(async function(Z){"use strict";const{console:O}=Z,A=new Proxy({},{get(e,n){return e[n]||O[n]},set(e,n,o){return e[n]=o.bind(O),!0}});for(const e of["log","debug","dir"])A[e]=O[e];const g=typeof unsafeWindow<"u"?unsafeWindow:window;if(!(g instanceof Window))return;const b=(async()=>{})().constructor,B=g.getSelection.bind(g)||Error()(),D=g.requestAnimationFrame.bind(g)||Error()(),$=g.getComputedStyle.bind(g)||Error()(),j=new WeakMap,M=e=>{let n=j.get(e);return n||(n=$(e),j.set(e,n)),n},T=HTMLElement.prototype.focus;let ee=16;for(;!document||!document.documentElement;)if(await new b(D),--ee<0)return;const q="Selection and Copying Restorer (Universal)",R=()=>{},U=await(async()=>(await b.resolve(),{}))()||{},z={gm_remain_focus_on_mousedown:["https://codi.link"],gm_no_custom_context_menu:["https://www.youtube.com","https://m.youtube.com","https://accounts.youtube.com","https://github.dev","https://vscode.dev","https://www.photopea.com","https://www.google.com","https://docs.google.com","https://drive.google.com","https://www.dropbox.com","https://www.terabox.com","https://outlook.live.com","https://mail.yahoo.co.jp","https://gmail.com","https://www.gmail.com","https://chat.openai.com","https://openai.com","https://github.com","https://www.github.com"],gm_highlight_color_check:["https://www.youtube.com","https://m.youtube.com","https://accounts.youtube.com","https://github.dev","https://vscode.dev","https://www.photopea.com","https://www.google.com","https://docs.google.com","https://drive.google.com","https://www.dropbox.com","https://www.terabox.com","https://outlook.live.com","https://mail.yahoo.co.jp","https://gmail.com","https://www.gmail.com","https://chat.openai.com","https://openai.com","https://github.com","https://www.github.com","https://facebook.com","https://www.facebook.com","https://twitter.com","https://www.twitter.com","https://x.com"]};let te=function*(...e){for(let n of e)yield*n};const V=(()=>{const e={},n=te(Object.keys(U),Object.keys(z));for(const o of n){if(e[o])continue;const r=e[o]=new Set,i=z[o];if(i&&i.length>=1)for(const u of i)r.add(u);const a=U[o];if(a&&a.length>=1)for(const u of a)u.charAt(0)==="~"?r.delete(u.substring(1)):r.add(u)}return new Proxy(e,{get(o,r){if(!t[r])return!1;const i=o[r];return!(i&&i.has(location.origin))},set(o,r,i){return!1}})})(U);let H=0;function ne(){let e;try{let n={$nil:R};n?.$nil(),n=null,n?.$nil(),e=!0}catch{}return!!e}ne()||A.warn(`${q}: Browser version before 2020-01-01 is not recommended. Please update to the latest version.`);function G(){if("_b1850"in t)return t._b1850;let e=0;return document.createAttribute("z").addEventListener("nil",R,{get passive(){e|=1},get once(){e|=2}}),t._b1850=e}function Y(){return(G()&3)===3}function X(){return(G()&1)===1}function oe(){try{return window.self!==window.top}catch{return!0}}function J(){const e=window.getSelection();return e.rangeCount?e.getRangeAt(0).cloneRange():!1}const re=typeof WeakRef=="function"?e=>e?new WeakRef(e):null:e=>e||null,Q=e=>e&&e.deref?e.deref():e,L=()=>!1;let w=null;const t={utSelectionColorHack:"msmtwejkzrqa",utTapHighlight:"xfcklblvkjsj",utLpSelection:"gykqyzwufxpz",utHoverBlock:"meefgeibrtqx",utNonEmptyElmPrevElm:"jttkfplemwzo",utHoverTextWrap:"oseksntfvucn",utAltPage:"vzhwnfgxnool",ksFuncReplacerCounter:"___dqzadwpujtct___",ksEventReturnValue:" ___ndjfujndrlsx___",ksSetData:"___rgqclrdllmhr___",ksNonEmptyPlainText:"___grpvyosdjhuk___",eh_capture_passive:()=>X()?t._eh_capture_passive=t._eh_capture_passive||{capture:!0,passive:!0}:!0,eh_capture_active:()=>X()?t._eh_capture_passive=t._eh_capture_passive||{capture:!0,passive:!1}:!0,mAlert_DOWN:R,mAlert_UP:R,gm_no_custom_context_menu:!0,gm_highlight_color_check:!0,lpKeyPressing:!1,lpKeyPressingPromise:b.resolve(),weakMapFuncReplaced:new WeakMap,ksFuncReplacerCounterId:0,isStackCheckForFuncReplacer:!1,isGlobalEventCheckForFuncReplacer:!1,enableReturnValueReplacment:!1,rangeOnKeyDown:null,eyEvts:["keydown","keyup","copy","contextmenu","select","selectstart","dragstart","beforecopy"],delayMouseUpTasks:0,isNum:e=>e>0||e<0||e===0,getNodeType:e=>e instanceof Node?e.nodeType:-1,isAnySelection:function(){const e=B();return e?typeof e.isCollapsed=="boolean"?!e.isCollapsed:e.toString().length>0:null},updateIsWindowEventSupported:function(){let e=document.createElement("noscript");e.onclick=function(n){t.isGlobalEventCheckForFuncReplacer=window.event===n},e.dispatchEvent(new Event("click")),e=null},createCSSElement:function(e,n){const o=document.createElement("style");return o.textContent=e,n&&n.appendChild(o),o},createFakeAlert:function(e){if(typeof e!="function")return null;function n(o){n.__isDisabled__()?A.log("alert msg disabled: ",o):e.apply(this,arguments)}return n.toString=e.toString.bind(e),n},createFuncReplacer:function(e){const n=++t.ksFuncReplacerCounterId,o=function(r){const i=e.apply(this,arguments);if(i===!1){if(!this||!r)return!1;const a="on"+r.type,u=this[a];if(typeof u!="function"||u[t.ksFuncReplacerCounter]!==n)return!1;if(r.cancelable!==!1&&t.shouldDenyPreventDefault(r)){if(t.isGlobalEventCheckForFuncReplacer===!0&&window.event!==r)return!1;if(t.isStackCheckForFuncReplacer===!0){let c=new Error().stack;if(c.indexOf(`
`)===c.lastIndexOf(`
`)===!1)return!1}return!0}}return i};return o[t.ksFuncReplacerCounter]=n,o.toString=e.toString.bind(e),t.weakMapFuncReplaced.set(e,o),o},onceCssHighlightSelection:async()=>{if(document.documentElement.hasAttribute(t.utLpSelection))return;t.onceCssHighlightSelection=null,await b.resolve();const e=[...document.querySelectorAll("a,p,div,span,b,i,strong,li")].filter(u=>u.childElementCount===0),n=e.length?e[e.length>>1]:document.body;await b.resolve();let r=$(n,"::selection").getPropertyValue("background-color")||"";(r.length>9&&/^rgba\(\d+,\s*\d+,\s*\d+,\s*0\)$/.test(r)||(M(document.body).getPropertyValue("background-color")||"")===r)&&document.documentElement.setAttribute(t.utSelectionColorHack,""),await b.resolve();let a=M(n).getPropertyValue("-webkit-tap-highlight-color")||"";a.length>9&&/^rgba\(\d+,\s*\d+,\s*\d+,\s*0\)$/.test(a)&&document.documentElement.setAttribute(t.utTapHighlight,""),document.documentElement.setAttribute(t.utTapHighlight,"")},clipDataProcess:function(e){if(!e)return;const n=Q(e[t.ksSetData]);if(!n||n.clipboardData!==e)return;const o=e[t.ksNonEmptyPlainText];if(!o||n.cancelable===!1||n.defaultPrevented===!0)return;const r=t.rangeOnKeyDown||0;let i=!1;if(typeof r.compareBoundaryPoints=="function"){const c=J();c&&r.compareBoundaryPoints(Range.START_TO_END,c)===0&&c.collapsed&&(i=!0)}let a=null,u=!0;if(!i){let c=B();if(!c)return;let f=c.toString(),h=f.trim();if(f.length>0&&f.length<o.length){let d=h.replace(/[\r\n\t\b\x20\xA0\u200b\uFEFF\u3000]+/g,""),E=o.replace(/[\r\n\t\b\x20\xA0\u200b\uFEFF\u3000]+/g,"").indexOf(d),l=E>=0&&E<o.length/2+1;if(l){let s=t.getNodeType(c.anchorNode),_=t.getNodeType(c.focusNode),p=s===3&&_===3;p||(p=c.anchorNode===c.focusNode&&s===1),l=l&&p}l&&(u=!1,a={msg:"copy event - clipboardData replacement is NOT allowed as the text node(s) is/are selected.",oldText:h,newText:o},u=!1)}u&&(h?a={msg:"copy event - clipboardData replacement is allowed and the selection is not empty",oldText:h,newText:o}:a={msg:"copy event - clipboardData replacement is allowed and the selection is empty",oldText:h,newText:o})}u&&(t.bypass=!0,n.preventDefault(),t.bypass=!1),a&&A.log(a)},shouldDenyPreventDefault:function(e){if(!e||t.bypass)return!1;let n=t.eyEvts.indexOf(e.type);const o=e.target;switch(n){case 6:return w===null&&(w=L()),w||t.enableDragging?!1:o instanceof Element&&o.hasAttribute("draggable")?(t.enableDragging=!0,!1):!0;case 3:if(!V.gm_no_custom_context_menu||(w===null&&(w=L()),w))return!1;if(o instanceof Element){switch(o.nodeName){case"IMG":case"SPAN":case"P":case"BODY":case"HTML":case"A":case"B":case"I":case"PRE":case"CODE":case"CENTER":case"SMALL":case"SUB":case"SAMP":return!0;case"VIDEO":case"AUDIO":return!!t.gm_native_video_audio_contextmenu}if((o.textContent||"").trim().length===0&&o.querySelector("video, audio"))return!1}return!0;case-1:return!1;case 0:case 1:return w===null&&(w=L()),w?!1:e.keyCode===67&&(e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&t.isAnySelection()===!0;case 2:if(w===null&&(w=L()),w||!(o instanceof Node)&&!(o instanceof Window)&&!(o instanceof Document)||o instanceof HTMLTextAreaElement||o instanceof HTMLInputElement||o instanceof HTMLElement&&o.closest("[contenteditable]")||o.parentNode instanceof HTMLElement&&o.parentNode.closest("[contenteditable]"))return!1;if(!("clipboardData"in e&&"setData"in DataTransfer.prototype)||e.cancelable===!1||e.defaultPrevented===!0)return!0;const r=Q(e.clipboardData[t.ksSetData]);return r&&r!==e||(e.clipboardData[t.ksSetData]=re(e),t.clipDataProcess(e.clipboardData)),!0;default:return!0}},enableSelectClickCopy:function(){(function(n){DataTransfer.prototype.setData=function(){return arguments[0]==="text/plain"&&typeof arguments[1]=="string"&&(arguments[1].trim().length>0?this[t.ksNonEmptyPlainText]=arguments[1]:this[t.ksNonEmptyPlainText]&&(arguments[1]=this[t.ksNonEmptyPlainText])),t.clipDataProcess(this),n.apply(this,arguments)}})(DataTransfer.prototype.setData),Object.defineProperties(DataTransfer.prototype,{[t.ksSetData]:{value:null,writable:!0,enumerable:!1,configurable:!0},[t.ksNonEmptyPlainText]:{value:null,writable:!0,enumerable:!1,configurable:!0}}),Event.prototype.preventDefault=function(n){function o(){this.cancelable!==!1&&!t.shouldDenyPreventDefault(this)&&n.call(this)}return o.toString=n.toString.bind(n),o}(Event.prototype.preventDefault),(()=>{const n=Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(Event.prototype,"returnValue"):{},{get:o,set:r}=n;if(o&&r){const i=new Set(t.eyEvts);Object.defineProperty(Event.prototype,"returnValue",{get(){const a=this.type;return i.has(a)?t.ksEventReturnValue in this?this[t.ksEventReturnValue]:!0:o.call(this)},set(a){const u=this.type;if(!i.has(u))return r.call(this,a);const c=!!a;c===!1&&this.preventDefault(),this[t.ksEventReturnValue]!==!1&&(this[t.ksEventReturnValue]=c)},enumerable:!0,configurable:!0})}else Object.defineProperty(Event.prototype,"returnValue",{get(){return t.ksEventReturnValue in this?this[t.ksEventReturnValue]:!0},set(i){i===!1&&this.preventDefault(),this[t.ksEventReturnValue]=i},enumerable:!0,configurable:!0})})(),t.enableReturnValueReplacment=!0;let e=g;if(e){let n=e.alert;if(typeof n=="function"){let o=t.createFakeAlert(n);if(o){let r=0;o.__isDisabled__=()=>r>+new Date,t.mAlert_DOWN=()=>r=+new Date+50,t.mAlert_UP=()=>r=+new Date+20,e.alert=o}o=null}n=null}e=null},lpCheckPointer:function(e){return!!(e instanceof Element&&e.matches("*:hover")&&M(e).getPropertyValue("cursor")==="pointer"&&e.textContent)},eventCancel:function(e,n){t.bypass=!0,!n||e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),t.bypass=!1},lpHoverBlocks:[],lpKeyAltLastPressAt:0,lpKeyAltPressInterval:0,noPlayingVideo:function(){let e=!0;for(const n of document.querySelectorAll("video[src]"))if(n.paused===!1){e=!1;break}return e},lpKeyDown:e=>{if(!t.gm_lp_enable)return;if(e.key==="Alt"&&e.altKey&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey){t.lpKeyAltLastPressAt=+new Date;let o=e.target;if(t.lpKeyPressing===!1&&o instanceof Node&&o.parentNode&&!e.repeat&&t.noPlayingVideo()){t.lpKeyPressing=!0,document.documentElement.setAttribute(t.utAltPage,"");const r=t.rootHTML(o);if(r){let i=null,a=new WeakMap;t.lpKeyPressingPromise=t.lpKeyPressingPromise.then(()=>{for(const u of t.lpHoverBlocks)u.removeAttribute(t.utNonEmptyElmPrevElm),u.removeAttribute(t.utHoverTextWrap);t.lpHoverBlocks.length=0}).then(()=>{i=new WeakMap;const u=[...r.querySelectorAll("*:not(button, textarea, input, script, noscript, style, link, img, br)")].filter(c=>c.childElementCount===0&&(c.textContent||"").trim().length>0);for(const c of u)i.set(c,1);return u}).then(u=>{let c=[],f=[],h=d=>{if(a.get(d)!==null)return;const m=[...d.children].some(E=>{const l=M(E).getPropertyValue("z-index")||"";return l.length>0?t.isNum(+l):!1});a.set(d,m),m&&(t.lpHoverBlocks.push(d),d.setAttribute(t.utHoverTextWrap,""))};for(const d of u){let m=d,E=1;for(;;){let l=m.previousElementSibling,s=!1;for(;l&&!(i.get(l)>0);)!l.matches("button, textarea, input, script, noscript, style, link, img, br")&&(l.textContent||"").length===0&&l.clientWidth*l.clientHeight>0&&(c.push(l),s=!0),l=l.previousElementSibling;if(s&&!a.has(m.parentNode)&&(a.set(m.parentNode,null),f.push(b.resolve(m.parentNode).then(h))),m=m.parentNode,!m||m===r||(E++,i.get(m)>0))break;i.set(m,E)}}i=null,b.all(f).then(()=>{f.length=0,f=null,h=null;for(const d of c){let m=d.parentNode;a.get(m)===!0&&(t.lpHoverBlocks.push(d),d.setAttribute(t.utNonEmptyElmPrevElm,""))}c.length=0,c=null,a=null})})}}}else t.lpKeyPressing===!0&&t.lpCancelKeyPressAlt()},lpCancelKeyPressAlt:()=>{t.lpKeyPressing=!1,document.documentElement.removeAttribute(t.utAltPage),t.lpKeyPressingPromise=t.lpKeyPressingPromise.then(()=>{for(const e of t.lpHoverBlocks)e.removeAttribute(t.utNonEmptyElmPrevElm),e.removeAttribute(t.utHoverTextWrap);t.lpHoverBlocks.length=0}),setTimeout(function(){t.lpMouseActive===1&&(t.lpMouseUpClear(),t.lpMouseActive=0)},32)},lpKeyUp:e=>{t.gm_lp_enable&&t.lpKeyPressing===!0&&t.lpCancelKeyPressAlt()},lpAltRoots:[],lpMouseDown:e=>{if(t.gm_lp_enable&&(t.lpMouseActive=0,e.altKey&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&e.button===0&&e.target instanceof Node&&t.noPlayingVideo())){t.lpMouseActive=1,t.eventCancel(e,!1);const n=t.rootHTML(e.target);t.lpAltRoots.push(n),n.setAttribute(t.utLpSelection,"")}},lpMouseUpClear:function(){for(const e of t.lpAltRoots)e.removeAttribute(t.utLpSelection);t.lpAltRoots.length=0,typeof t.onceCssHighlightSelection=="function"&&V.gm_highlight_color_check&&D(t.onceCssHighlightSelection)},lpMouseUp:e=>{t.gm_lp_enable&&t.lpMouseActive===1&&(t.lpMouseActive=2,t.eventCancel(e,!1),t.lpMouseUpClear())},lpClick:e=>{t.gm_lp_enable&&t.lpMouseActive===2&&t.eventCancel(e,!1)},lpEnable:function(){const e=t.eh_capture_passive();document.addEventListener("keydown",t.lpKeyDown,e),document.addEventListener("keyup",t.lpKeyUp,e),document.addEventListener("mousedown",t.lpMouseDown,e),document.addEventListener("mouseup",t.lpMouseUp,e),document.addEventListener("click",t.lpClick,e)},rootHTML:e=>{if(!(e instanceof Node))return null;if(!e.ownerDocument)return e;let n=e.getRootNode?e.getRootNode():null;if(!n){let o=e;for(let r;r=o.parentNode;)o=r;n=o}return n=n.querySelector("html")||e.ownerDocument.documentElement||null,n},customCSSPerSite:{"https://www.suto.co.kr":`
                #no_copy::after {
                    pointer-events: none;
                }
            `},injectCSSRules:()=>{const e=`

            html {
                --sac-user-select: auto;
            }
            [role="slider"], input, textarea, video[src], :empty {
                --sac-user-select: nil;
            }
            label:not(:empty) {
                --sac-user-select: auto;
            }

            html, html *,
            html *[style], html *[class] {
                -webkit-touch-callout: default !important; -moz-user-select: var(--sac-user-select) !important; -webkit-user-select: var(--sac-user-select) !important; user-select: var(--sac-user-select) !important;
            }

            html *:hover, html *:link, html *:visited, html *:active {
                -webkit-touch-callout: default !important; -moz-user-select: var(--sac-user-select) !important; -webkit-user-select: var(--sac-user-select) !important; user-select: var(--sac-user-select) !important;
            }

            html *::before, html *::after {
                -webkit-touch-callout: default !important; -moz-user-select: auto !important; -webkit-user-select: auto !important; user-select: auto !important;
            }

            *:hover>img[src]{pointer-events:auto !important;}

            [${t.utSelectionColorHack}] :not(input):not(textarea)::selection{ background-color: Highlight !important; color: HighlightText !important;}
            [${t.utSelectionColorHack}] :not(input):not(textarea)::-moz-selection{ background-color: Highlight !important; color: HighlightText !important;}
            [${t.utTapHighlight}] *{ -webkit-tap-highlight-color: rgba(0, 0, 0, 0.18) !important;}

            [${t.utHoverTextWrap}]>[${t.utNonEmptyElmPrevElm}]{pointer-events:none !important;}
            [${t.utHoverTextWrap}]>*{z-index:inherit !important;}

            html[${t.utLpSelection}] *:hover, html[${t.utLpSelection}] *:hover * { cursor:text !important;}
            html[${t.utLpSelection}] :not(input):not(textarea)::selection {background-color: rgba(255, 156, 179, 0.5) !important;}
            html[${t.utLpSelection}] :not(input):not(textarea)::-moz-selection {background-color: rgba(255, 156, 179, 0.5) !important;}

            img[${t.utHoverBlock}="4"]{display:none !important;}
            [${t.utHoverBlock}="7"]{padding:0 !important;overflow:hidden !important;}
            [${t.utHoverBlock}="7"]>img[${t.utHoverBlock}="4"]:first-child{
                display:inline-block !important;
                position: relative !important;
                top: auto !important;
                left: auto !important;
                bottom: auto !important;
                right: auto !important;
                opacity: 0 !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                height: 100% !important;
                outline: 0 !important;
                border: 0 !important;
                box-sizing: border-box !important;
                transform: initial !important;
                -moz-user-select: none !important;
                -webkit-user-select: none !important;
                user-select: none !important;
                z-index:1 !important;
                float: left !important;
                cursor:inherit !important;
                pointer-events:inherit !important;
                border-radius: inherit !important;
                background:none !important;
            }

            html[${t.utAltPage}] *::before, html[${t.utAltPage}] *::after {
                pointer-events: none !important;
            }

            ${t.customCSSPerSite[location.origin]||""}

            `.trim();t.createCSSElement(e,document.documentElement)},overrideComputedStyle:()=>{if(typeof g.getComputedStyle!="function"||typeof g.getComputedStyle591=="function")return;const e=g.getComputedStyle591=g.getComputedStyle;g.getComputedStyle=function(o,r=void 0){return(this||0).getComputedStyle591?this.getComputedStyle591(o,r):e.call(g,o,r)};const n=typeof g.CSSStyleDeclaration=="function"?g.CSSStyleDeclaration.prototype:null;n&&typeof n.getPropertyValue=="function"&&typeof n.getPropertyValue591!="function"&&(n.getPropertyValue591=n.getPropertyValue,n.getPropertyValue=function(o){let r=this.getPropertyValue591(o);return o==="userSelect"&&(r==="auto"||r==="")&&(r="none"),r}),n&&Object.defineProperty(n,"userSelect",{get(){return"none"}})},disableHoverBlock:()=>{const e=new WeakMap;function n(l){let s=e.get(l);return s||e.set(l,s={}),s}function o(l,s){let _={x:l.left,y:l.top},p={x:l.right,y:l.bottom},x={x:s.left,y:s.top},C={x:s.right,y:s.bottom},K=Math.abs(_.x-p.x)*Math.abs(_.y-p.y),N=Math.abs(x.x-C.x)*Math.abs(x.y-C.y),y=Math.min(p.x,C.x)-Math.max(_.x,x.x),S=Math.min(p.y,C.y)-Math.max(_.y,x.y),P=0;return y>0&&S>0&&(P=y*S),{area1:K,area2:N,areaI:P}}function r(l,s){s.dispatchEvent(new l.constructor(l.type,l)),l.type!=="wheel"&&l.preventDefault(),l.stopPropagation()}const i=new WeakMap;let a=[];const u=async l=>{await b.resolve();for(const s of a)s.elm===l&&(s.lastTime=+new Date)};function c(){for(const p of a)if(p.lastTime+800<+new Date)return p.lastTime=+new Date,p.elm;let l=document.createElement("img");l.setAttribute("title","\u3000"),l.setAttribute("alt","\u3000"),l.onerror=function(){this.parentNode instanceof Node&&this.parentNode.removeChild(this)},l.setAttribute(t.utHoverBlock,"4");const s=function(p){this===p.target&&(p.button!==2&&r(p,this.parentNode),u(this))};l.addEventListener("click",s,!0),l.addEventListener("mousedown",s,!0),l.addEventListener("mouseup",s,!0),l.addEventListener("mousemove",s,!0),l.addEventListener("mouseover",s,!0),l.addEventListener("mouseout",s,!0),l.addEventListener("mouseenter",s,!0),l.addEventListener("mouseleave",s,!0);let _={elm:l,lastTime:+new Date,cid_fade:0};return a.push(_),l}const f=new WeakMap;let h=null,d=0,m=0;const E=async l=>{if(!t.gm_disablehover_enable||(h=l.target,d=+new Date,m))return;m=1;do await new b(y=>setTimeout(y,82));while(+new Date-d<30);m=0;const s=h;if(await b.resolve(),!s||!s.parentNode)return;if(i.get(s)){let y=null;if(s.getAttribute(t.utHoverBlock)==="7"&&(y=f.get(s))&&s.querySelector(`[${t.utHoverBlock}]`)===null){let S=c();S.parentNode!==s&&(S.setAttribute("src",y),s.insertBefore(S,s.firstChild))}return}if(i.set(s,1),await b.resolve(),!(s instanceof Element)||"|SVG|IMG|HTML|BODY|VIDEO|AUDIO|BR|HEAD|NOSCRIPT|SCRIPT|STYLE|TEXTAREA|AREA|INPUT|FORM|BUTTON|".indexOf(`|${s.nodeName}|`)>=0)return;const _=s.clientWidth*s.clientHeight;if(!(_>0))return;let p=null;const x=M(s),C=x.getPropertyValue("background-image")||"";let K=null;if(C.length>8&&(K=/^\s*url\s*\("?([^"\)]+\b(\.gif|\.png|\.jpeg|\.jpg|\.webp)\b[^"\)]*)"?\)\s*$/i.exec(C))){if((s.textContent||"").trim().length>0)return;p=K[1]}else{if(!(x.getPropertyValue("position")==="absolute"&&+x.getPropertyValue("z-index")>0)||(s.textContent||"").trim().length>0)return;let y=[];for(const v of document.querySelectorAll("img[src]")){const k=n(v);if(!k.area){const W=v.clientWidth*v.clientHeight;W>0&&(k.area=W)}k.area>0&&_>k.area*.9&&y.push(v)}let S=0,P=0;for(const v of y){const k=s.compareDocumentPosition(v);if(k&8||k&16)return;if(k&2)P++;else if(k&4)break;S++}let F=P-1,I=P;F<0&&(F=0),I>y.length-1&&(I=y.length-1);for(let v=F;v<=I;v++){const k=y[v],{area1:W,area2:se,areaI:le}=o(s.getBoundingClientRect(),k.getBoundingClientRect());if(le>.9*se){p=k.getAttribute("src");break}}}if(typeof p!="string")return;let N=c();N.parentNode!==s&&(N.setAttribute("src",p),s.insertBefore(N,s.firstChild),f.set(s,p),s.setAttribute(t.utHoverBlock,"7"))};document.addEventListener("mouseenter",E,t.eh_capture_passive())},acrAuxDown:e=>{if(t.gm_prevent_aux_click_enable&&e.button===1){let n=t.dmmMouseUpLast>t.dmmMouseDownLast&&e.timeStamp-t.dmmMouseUpLast<40;t.dmmMouseDownLast=e.timeStamp,n&&t.eventCancel(e,!0)}},acrAuxUp:e=>{if(t.gm_prevent_aux_click_enable&&e.button===1){let n=t.dmmMouseDownLast>t.dmmMouseUpLast&&e.timeStamp-t.dmmMouseDownLast<40;t.dmmMouseUpLast=e.timeStamp,n&&(t.dmmMouseUpCancel=e.timeStamp,t.eventCancel(e,!0))}},acrAuxClick:e=>{t.gm_prevent_aux_click_enable&&e.button===1&&e.timeStamp-t.dmmMouseUpCancel<40&&t.eventCancel(e,!0)},mousedownFocus:e=>{H=Date.now()+4},mouseupFocus:e=>{H=0},MenuEnable:class{constructor(n,o,r,i){this.h=null,this.textToEnable=n,this.textToDisable=o,this.callback=r,this.gx=this.gx.bind(this)}unregister(){this.h!==null&&(GM_unregisterMenuCommand(this.h),this.h=null)}register(n){typeof n=="string"&&(this.showText=n),n=this.showText,typeof n=="string"&&(this.h=GM_registerMenuCommand(n,this.gx))}a(n){if(this.enabled===n.bEnable)return;this.enabled=n.bEnable,this.unregister();let o=0;if(t.gm_status_fn_store&&t.gm_status_fn_store.indexOf(this)>=0){let r=t.gm_status_fn_store,i=r.indexOf(this),a=r.length;if(i>=0&&i<=a-2){for(let u=i+1;u<a;u++)r[u].unregister();this.register(n.bText);for(let u=i+1;u<a;u++)r[u].register();o=1}}o||this.register(n.bText),this.callback(this.enabled,n.byUserInput)}enableNow(n){this.a({bEnable:!0,bText:this.textToDisable,byUserInput:n})}gx(){this.enabled?this.disableNow(!0):this.enableNow(!0)}disableNow(n){this.a({bEnable:!1,bText:this.textToEnable,byUserInput:n})}toggle(n,o){n?this.enableNow(o):this.disableNow(o)}},gm_status_fn:async function(e,n,o,r){const i=e+"$menuEnable";function a(c){t[e]=c;const f=t[i];f&&f.toggle(c),r(c)}const u=await GM.getValue(e,!1);if(a(!!u),GM_addValueChangeListener(e,function(c,f,h,d){f===h||h===t[e]||a(h)}),!oe()){t.gm_status_fn_store=t.gm_status_fn_store||[],t[i]=new t.MenuEnable(n,o,f=>{GM.setValue(e,!!f)}),t.gm_status_fn_store.push(t[i]);const c=await GM.getValue(e,!1);t[i].toggle(!!c)}},copyRangeCheckKeyDown(e){if(e.isTrusted&&(e.key==="Control"||e.key==="Meta")){if(!(B()+"")){t.rangeOnKeyDown=!1;return}t.rangeOnKeyDown=!0}else e.isTrusted&&(e.code==="KeyC"&&t.rangeOnKeyDown===!0||e.key==="Copy")&&(t.rangeOnKeyDown=J())},copyRangeCheckKeyUp(e){e.isTrusted&&(e.key==="Control"||e.key==="Meta")&&(t.rangeOnKeyDown=!1)},genericEventHandlerLevel2:e=>{t.gm_absolute_mode&&(e.stopPropagation(),e.stopImmediatePropagation());const n=(e||0).type;if(n==="keydown"?t.copyRangeCheckKeyDown(e):n==="keyup"&&t.copyRangeCheckKeyUp(e),n&&t.enableReturnValueReplacment===!0){let o=e.target;const r="on"+n;let i=99;for(;o instanceof Node&&!(--i<4);){const a=o[r];if(typeof a=="function"){if(a[t.ksFuncReplacerCounter]>0)break;o[r]=t.weakMapFuncReplaced.get(a)||t.createFuncReplacer(a)}o=o.parentNode}}n==="contextmenu"&&e.defaultPrevented!==!0&&t.mainListenerPress(e)},genericEventHandlerLevel1:e=>{t.gm_absolute_mode&&(e.stopPropagation(),e.stopImmediatePropagation());const n=(e||0).type;n==="mousedown"?(t.mousedownFocus(e),t.acrAuxDown(e),e.defaultPrevented!==!0&&t.mainListenerPress(e)):n==="mouseup"&&(t.mouseupFocus(e),t.acrAuxUp(e),e.defaultPrevented!==!0&&t.mainListenerRelease(e))},eventsInjection:function(){for(const e of["keydown","keyup","copy","contextmenu","select","selectstart","dragstart","beforecopy"])document.addEventListener(e,t.genericEventHandlerLevel2,!0);for(const e of["cut","paste","mouseup","mousedown","drag","select"])document.addEventListener(e,t.genericEventHandlerLevel1,!0);document.addEventListener("auxclick",t.acrAuxClick,!0)},delayMouseUpTasksHandler:()=>{if(t.delayMouseUpTasks>0){const e=t.delayMouseUpTasks;t.delayMouseUpTasks=0,(e&1)===1&&t.mAlert_UP(),(e&2)===2&&t.enableDragging===!0&&(t.enableDragging=!1)}},mainListenerPress:e=>{t.onceCssHighlightSelection&&D(t.onceCssHighlightSelection);const n=e.type==="contextmenu";(e.button===2||n)&&t.mAlert_DOWN(),n&&t.delayMouseUpTasks===0&&(t.delayMouseUpTasks|=1,D(t.delayMouseUpTasksHandler))},mainListenerRelease:e=>{t.delayMouseUpTasks===0&&(e.button===2&&(t.delayMouseUpTasks|=1),t.enableDragging===!0&&(t.delayMouseUpTasks|=2),t.delayMouseUpTasks>0&&D(t.delayMouseUpTasksHandler))}};if(t.eventsInjection(),t.enableSelectClickCopy(),t.injectCSSRules(),location.host==="novelpia.com"&&t.overrideComputedStyle(),Y()&&t.lpEnable(),t.disableHoverBlock(),A.log(`userscript running - ${q}`),t.updateIsWindowEventSupported(),typeof GM_registerMenuCommand=="function"&&typeof GM_unregisterMenuCommand=="function"&&(Y()&&t.gm_status_fn("gm_lp_enable","To Enable `Enhanced build-in Alt Text Selection`","To Disable `Enhanced build-in Alt Text Selection`",()=>{}),t.gm_status_fn("gm_disablehover_enable","To Enable `Hover on Image`","To Disable `Hover on Image`",()=>{}),t.gm_status_fn("gm_prevent_aux_click_enable","To Enable `Repetitive AuxClick Prevention`","To Disable `Repetitive AuxClick Prevention`",()=>{}),t.gm_status_fn("gm_absolute_mode","To Enable `Absolute Mode`","To Disable `Absolute Mode`",()=>{}),t.gm_status_fn("gm_remain_focus_on_mousedown","To Enable `Remain Focus On MouseDown`","To Disable `Remain Focus On MouseDown`",()=>{}),t.gm_status_fn("gm_native_video_audio_contextmenu","To Enable Native Video Audio Context Menu","To Disable Native Video Audio Context Menu",()=>{})),typeof T=="function"&&HTMLElement.prototype.focus===T&&T.length===0){const e=HTMLElement.prototype.focus=function(){if(!(H&&V.gm_remain_focus_on_mousedown&&H>Date.now()))return T.apply(this,arguments)};e.toString=T.toString.bind(T)}})({console});
